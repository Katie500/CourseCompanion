(window.webpackJsonp=window.webpackJsonp||[]).push([[40],{"./bundles/sf-image-editor.js":function(t,e,i){"use strict";i.r(e);i("./modules/sf-image-editor.js")},"./modules/sf-image-editor.js":function(t,e){function i(t){return(i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}window.sfBlazor=window.sfBlazor||{},window.sfBlazor.ImageEditor=function(){"use strict";var t,e,s=(t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)},function(e,i){function s(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(s.prototype=i.prototype,new s)}),a=(function(t){function e(){return null!==t&&t.apply(this,arguments)||this}s(e,t)}(sf.base.ChildProperty),function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.degree=0,e.isUndoRedo=!1,e.dragCanvas=!1,e.dragElement="",e.keyHistory="",e.tempKeyHistory="",e.mouseDownPoint={x:0,y:0},e.previousPoint={x:0,y:0},e.dragPoint={startX:0,startY:0,endX:0,endY:0},e.diffPoint={x:0,y:0},e.oldPoint={},e.objColl=[],e.undoRedoColl=[],e.isImageLoaded=!1,e.strokeSettings={strokeColor:"#fff",fillColor:"",strokeWidth:null},e.tempStrokeSettings={strokeColor:"#fff",fillColor:"",strokeWidth:null},e.textSettings={text:"Enter Text",fontFamily:"Arial",fontSize:null,fontRatio:null,bold:!1,italic:!1,underline:!1},e.tempTextSettings={text:"Enter Text",fontFamily:"Arial",fontSize:null,fontRatio:null,bold:!1,italic:!1,underline:!1},e.toolbarHeight=46,e.togglePan=!1,e.disablePan=!1,e.currFlipState="",e.touchEndPoint={},e.undoRedoStep=0,e.togglePen=!1,e.currentToolbar="main",e.textStartPoints={x:0,y:0},e.fontSizeColl=[],e.textRow=1,e.activeObj={activePoint:{startX:0,startY:0,endX:0,endY:0,width:0,height:0},flipObjColl:[],triangle:[],triangleRatio:[]},e.tempActiveObj={activePoint:{startX:0,startY:0,endX:0,endY:0,width:0,height:0},flipObjColl:[],triangle:[],triangleRatio:[]},e.currObjType={shape:"",isDragging:!1,isActiveObj:!1,isText:!1,isInitialText:!1,isLine:!1,isInitialLine:!1,isCustomCrop:!1,isZoomed:!1,isUndoZoom:!1,isUndoAction:!1,isFiltered:!1,isSave:!1},e.defToolbarItems=[],e.isTimer=!1,e.isFirstMove=!1,e.startTouches=[],e.tempTouches=[],e.adjustmentLevel={brightness:0,contrast:0,hue:0,opacity:100,saturation:0,blur:0,exposure:0,sharpen:!1,bw:!1},e.tempAdjustmentLevel={brightness:0,contrast:0,hue:0,opacity:100,saturation:0,blur:0,exposure:0,sharpen:!1,bw:!1},e.adjustmentValue="",e.initialAdjustmentValue="",e.tempAdjustmentValue="",e.currentFilter="",e.tempFilter="",e.canvasFilter="brightness(1) contrast(100%) hue-rotate(0deg) saturate(100%) opacity(1) blur(0px) sepia(0%) grayscale(0%) invert(0%)",e.tempUndoRedoStep=0,e.zoomFactor=0,e.tempZoomFactor=0,e.destLeft=0,e.destTop=0,e.srcLeft=0,e.srcTop=0,e.cropDestPoints={startX:0,startY:0,width:0,height:0},e.flipColl=[],e.isReverseRotate=!1,e.isReverseFlip=!1,e.isPreventDragging=!1,e.isRotateZoom=!1,e.rotateFlipColl=[],e.isCircleCrop=!1,e.rotatedDestPoints={startX:0,startY:0,width:0,height:0},e.croppedDegree=0,e.isFreehandDrawingPoint=!1,e.isFreehandDrawEditing=!1,e.tempFreeHandDrawEditingStyles={strokeColor:null,fillColor:null,strokeWidth:null},e.totalPannedInternalPoint={x:0,y:0},e.totalPannedClientPoint={x:0,y:0},e.totalPannedPoint={x:0,y:0},e.isCropTab=!1,e.cropZoomFactor=0,e.defaultZoomFactor=0,e.fileName="",e.isBrightnessAdjusted=!1,e.isInitialLoading=!1,e.freehandDrawObj={lastWidth:0,lastVelocity:0,time:0,pointX:0,pointY:0},e.points=[],e.pointColl={},e.pointCounter=0,e.freehandCounter=0,e.isFreehandDrawing=!1,e.tempFreehandCounter=0,e.selectedFreehandColor="#42a5f5",e.isFreehandDrawCustomized=!1,e.isShapeInserted=!1,e.isAllowCropPan=!1,e.cropObj={cropZoom:0,defaultZoom:0,totalPannedPoint:{x:0,y:0},totalPannedClientPoint:{x:0,y:0},totalPannedInternalPoint:{x:0,y:0},tempFlipPanPoint:{x:0,y:0},activeObj:{},rotateFlipColl:[],degree:0,currFlipState:"",destPoints:{startX:0,startY:0,width:0,height:0},srcPoints:{startX:0,startY:0,width:0,height:0},filter:""},e.afterCropActions=[],e.isCancelAction=!1,e.isFreehandPointMoved=!1,e.isTouch=!1,e.freehandDownPoint={x:0,y:0},e.tempFlipPanPoint={x:0,y:0},e.currentFreehandDrawIndex=0,e.tempCurrentFreehandDrawIndex=0,e.preventZoomBtn=!1,e.cancelObjColl=[],e.cancelPointColl=[],e.rotatedFlipCropSelection=!1,e.currentMouseMovePoint={x:0,y:0},e}return s(e,t),e.prototype.initializeImageEditor=function(t,e){this.element=t;var i=this.element.querySelector(".e-canvas-wrapper");i.style.height=this.element.offsetHeight-this.toolbarHeight+"px",i.style.width=this.element.offsetWidth+"px",i.style.position="relative",i.style.overflow="hidden",i.style.margin="0 auto",this.lowerCanvas=this.element.querySelector(".e-lower-canvas"),this.upperCanvas=this.element.querySelector(".e-upper-canvas"),this.textArea=this.element.querySelector(".e-textbox"),this.inMemoryCanvas=this.createElement("canvas",{id:this.element.id+"_inMemoryCanvas",attrs:{name:"canvasImage"}}),this.upperCanvas.width=this.lowerCanvas.width=this.inMemoryCanvas.width=this.element.offsetWidth,this.upperCanvas.height=this.lowerCanvas.height=this.inMemoryCanvas.height=this.element.offsetHeight-this.toolbarHeight,this.upperCanvas.style.position=this.lowerCanvas.style.position=this.textArea.style.position="absolute",this.baseImg=this.createElement("img",{id:this.element.id+"_orgImg",attrs:{name:"Image",crossorigin:"anonymous"}}),this.textArea.style.backgroundColor="transparent",this.textArea.style.display="none",this.textArea.style.resize="none",this.lowerContext=this.lowerCanvas.getContext("2d"),this.baseImg=this.createElement("img",{id:this.element.id+"_orgImg",attrs:{name:"Image",crossorigin:"anonymous"}}),this.upperCanvas.style.cursor="default",this.upperContext=this.upperCanvas.getContext("2d"),this.inMemoryContext=this.inMemoryCanvas.getContext("2d"),e&&(this.dotnetRef=e),this.prerender(),this.wireEvent(),this.lowerContext.filter=this.initialAdjustmentValue=this.adjustmentValue="brightness(1) contrast(100%) hue-rotate(0deg) saturate(100%) opacity(1) blur(0px) sepia(0%) grayscale(0%) invert(0%)",this.element&&sf.popups.createSpinner({target:this.element}),this.updateFinetunes(),this.lowerContext.filter=this.canvasFilter=this.initialAdjustmentValue=this.adjustmentValue=this.getDefaultFilter()},e.prototype.prerender=function(){this.element.id=this.element.id||sf.base.getUniqueID("ej2-image-editor"),sf.base.Browser.isDevice&&this.element.classList.add("e-device"),this.themeColl={Bootstrap5:{primaryColor:"#0d6efd",secondaryColor:"#fff"},Bootstrap5Dark:{primaryColor:"#0d6efd",secondaryColor:"#fff"},Tailwind:{primaryColor:"#4f46e5",secondaryColor:"#fff"},TailwindDark:{primaryColor:"#22d3ee",secondaryColor:"#fff"},Fluent:{primaryColor:"#0078d4",secondaryColor:"#fff"},FluentDark:{primaryColor:"#0078d4",secondaryColor:"#fff"},Bootstrap4:{primaryColor:"#007bff",secondaryColor:"#fff"},Bootstrap:{primaryColor:"#317ab9",secondaryColor:"#fff"},BootstrapDark:{primaryColor:"#317ab9",secondaryColor:"#fff"},Material:{primaryColor:"#e3165b",secondaryColor:"#fff"},MaterialDark:{primaryColor:"#00b0ff",secondaryColor:"#fff"},Fabric:{primaryColor:"#0078d6",secondaryColor:"#fff"},FabricDark:{primaryColor:"#0074cc",secondaryColor:"#fff"},Highcontrast:{primaryColor:"#000000",secondaryColor:"#fff"}},this.defaultLocale={Crop:"Crop",ZoomIn:"Zoom In",ZoomOut:"Zoom Out",Undo:"Undo",Redo:"Redo",Transform:"Transform",Annotation:"Annotation",Finetune:"Finetune",Brightness:"Brightness",Contrast:"Contrast",Hue:"Hue",Saturation:"Saturation",Opacity:"Opacity",Blur:"Blur",Sharpen:"Sharpen",Exposure:"Exposure",Filter:"Filter",Default:"Default",Chrome:"Chrome",Cold:"Cold",Warm:"Warm",Grayscale:"Grayscale",BlackAndWhite:"Black and White",Sepia:"Sepia",Invert:"Invert",Text:"Add Text",Pen:"Pen",Reset:"Reset",Save:"Save",Select:"Select",RotateLeft:"Rotate Left",RotateRight:"Rotate Right",HorizontalFlip:"Horizontal Flip",VerticalFlip:"Vertical Flip",OK:"OK",Cancel:"Cancel",FillColor:"Fill Color",StrokeColor:"Stroke Color",StrokeWidth:"Stroke Width",FontFamily:"Font Family",FontStyle:"Font Style",FontSize:"Font Size",FontColor:"Font Color",Pan:"Pan",Move:"Move",Load:"Load",Custom:"Custom",Square:"Square",Circle:"Circle",Ellipse:"Ellipse",Rectangle:"Rectangle",Line:"Line",Arrow:"Arrow",Bold:"Bold",Italic:"Italic",BoldItalic:"Bold Italic",XSmall:"X-Small",Small:"Small",Medium:"Medium",Large:"Large",XLarge:"X-Large",ABC:"ABC",Browse:"Browse",Duplicate:"Duplicate",Remove:"Remove",EditText:"Edit Text"},this.l10n=new sf.base.L10n("image-editor",this.defaultLocale,this.locale)},e.prototype.getModuleName=function(){return"image-editor"},e.prototype.getPersistData=function(){return this.addOnPersist([])},e.prototype.onPropertyChanged=function(t,e){for(var i=0,s=Object.keys(t);i<s.length;i++){switch(s[i]){case"cssClass":this.cssClass&&sf.base.removeClass([this.element],this.cssClass.replace(/\s+/g," ").trim().split(" ")),e&&sf.base.addClass([this.element],e.replace(/\s+/g," ").trim().split(" "));break;case"disabled":e?(this.element.classList.add("e-disabled"),this.unwireEvent()):(this.element.classList.remove("e-disabled"),this.wireEvent());break;case"height":this.element.style.height=e;break;case"width":this.element.style.width=e;break;case"theme":e&&(this.updateTheme(),this.upperContext.strokeStyle=this.themeColl[this.theme].primaryColor,this.upperContext.fillStyle=this.themeColl[this.theme].secondaryColor);break;case"finetuneSettings":e&&(this.finetuneSettings=e,this.updateFinetunes());break;case"locale":e&&this.l10n.setLocale(e);break;case"allowUndoRedo":this.allowUndoRedo=!!e}}},e.prototype.destroy=function(){var e=[];this.element.removeAttribute("tabindex"),this.cssClass&&(e=e.concat(this.cssClass.replace(/\s+/g," ").trim().split(" "))),sf.base.removeClass([this.element],e),this.element.getAttribute("class")||this.element.removeAttribute("class"),this.destroySubComponents(),this.unwireEvent(),t.prototype.destroy.call(this),this.element.innerHTML=""},e.prototype.getDefaultFilter=function(){return"brightness(1) contrast(100%) hue-rotate(0deg) saturate(100%) opacity(1) blur(0px) sepia(0%) grayscale(0%) invert(0%)"},e.prototype.updateFinetunes=function(){this.finetuneSettings&&(this.finetuneSettings.brightness&&(this.adjustmentLevel.brightness=this.finetuneSettings.brightness.defaultValue,this.tempAdjustmentLevel.brightness=this.finetuneSettings.brightness.defaultValue),this.finetuneSettings.contrast&&(this.adjustmentLevel.contrast=this.finetuneSettings.contrast.defaultValue,this.tempAdjustmentLevel.contrast=this.finetuneSettings.contrast.defaultValue),this.finetuneSettings.hue&&(this.adjustmentLevel.hue=this.finetuneSettings.hue.defaultValue,this.tempAdjustmentLevel.hue=this.finetuneSettings.hue.defaultValue),this.finetuneSettings.saturation&&(this.adjustmentLevel.saturation=this.finetuneSettings.saturation.defaultValue,this.tempAdjustmentLevel.saturation=this.finetuneSettings.saturation.defaultValue),this.finetuneSettings.exposure&&(this.adjustmentLevel.exposure=this.finetuneSettings.exposure.defaultValue,this.tempAdjustmentLevel.exposure=this.finetuneSettings.exposure.defaultValue),this.finetuneSettings.opacity&&(this.adjustmentLevel.opacity=this.finetuneSettings.opacity.defaultValue,this.tempAdjustmentLevel.opacity=this.finetuneSettings.opacity.defaultValue),this.finetuneSettings.blur&&(this.adjustmentLevel.blur=this.finetuneSettings.blur.defaultValue,this.tempAdjustmentLevel.blur=this.finetuneSettings.blur.defaultValue),this.isInitialLoading=!0)},e.prototype.initializeFilter=function(){this.setBrightness(this.adjustmentLevel.brightness),this.setContrast(this.adjustmentLevel.contrast),this.setHue(this.adjustmentLevel.hue),this.setSaturation(this.adjustmentLevel.saturation),this.setExposure(this.adjustmentLevel.exposure),this.setOpacity(this.adjustmentLevel.opacity),this.setBlur(this.adjustmentLevel.blur)},e.prototype.wireEvent=function(){sf.base.EventHandler.add(document,"keydown",this.keyDownEventHandler,this),sf.base.EventHandler.add(document,"keypress",this.keyUpEventHandler,this),sf.base.EventHandler.add(this.upperCanvas,"mousedown",this.mouseDownEventHandler,this),sf.base.EventHandler.add(this.upperCanvas,"mousemove",this.mouseMoveEventHandler,this),sf.base.EventHandler.add(this.upperCanvas,"mouseup",this.mouseUpEventHandler,this),sf.base.EventHandler.add(document,"mouseup",this.mouseUpEventHandler,this),sf.base.EventHandler.add(this.lowerCanvas,"mousedown",this.canvasMouseDownHandler,this),sf.base.EventHandler.add(this.lowerCanvas,"mousemove",this.canvasMouseMoveHandler,this),sf.base.EventHandler.add(this.lowerCanvas,"mouseup",this.canvasMouseUpHandler,this),sf.base.EventHandler.add(document,"mouseup",this.canvasMouseUpHandler,this),sf.base.EventHandler.add(this.upperCanvas,"touchstart",this.touchStartHandler,this),sf.base.EventHandler.add(this.lowerCanvas,"touchstart",this.touchStartHandler,this),sf.base.EventHandler.add(this.upperCanvas,"dblclick",this.findTextPoint,this),sf.base.EventHandler.add(this.textArea,"mousedown",this.findTextPoint,this),sf.base.EventHandler.add(this.lowerCanvas,"mousewheel DOMMouseScroll",this.handleScroll,this),sf.base.EventHandler.add(this.upperCanvas,"mousewheel DOMMouseScroll",this.handleScroll,this),window.addEventListener("resize",this.windowResizeHandler.bind(this)),sf.base.Browser.isIos||"safari"===sf.base.Browser.info.name||screen.orientation.addEventListener("change",this.screenOrientation.bind(this))},e.prototype.unwireEvent=function(){sf.base.EventHandler.remove(document,"keydown",this.keyDownEventHandler),sf.base.EventHandler.remove(document,"keypress",this.keyUpEventHandler),sf.base.EventHandler.remove(this.upperCanvas,"mousedown",this.mouseDownEventHandler),sf.base.EventHandler.remove(this.upperCanvas,"mousemove",this.mouseMoveEventHandler),sf.base.EventHandler.remove(this.upperCanvas,"mouseup",this.mouseUpEventHandler),sf.base.EventHandler.remove(document,"mouseup",this.mouseUpEventHandler),sf.base.EventHandler.remove(this.lowerCanvas,"mousedown",this.canvasMouseDownHandler),sf.base.EventHandler.remove(this.lowerCanvas,"mousemove",this.canvasMouseMoveHandler),sf.base.EventHandler.remove(this.lowerCanvas,"mouseup",this.canvasMouseUpHandler),sf.base.EventHandler.remove(document,"mouseup",this.canvasMouseUpHandler)},e.prototype.destroySubComponents=function(){for(var t=this.element.querySelectorAll("input.e-control"),e=this.element.querySelectorAll("button.e-control"),i=0,s=t.length;i<s;i++)t[i].classList.contains("e-color-picker")&&(sf.base.getComponent(t[i],"color-picker").destroy(),sf.base.detach(sf.base.select("input#"+t[i].id,this.element)));for(i=0,s=e.length;i<s;i++)e[i].classList.contains("e-dropdown-btn")?(sf.base.getComponent(e[i],"dropdown-btn").destroy(),sf.base.detach(sf.base.select("button#"+e[i].id,this.element))):e[i].classList.contains("e-btn")&&(sf.base.getComponent(e[i],"btn").destroy(),sf.base.detach(sf.base.select("button#"+e[i].id,this.element)))},e.prototype.updateTheme=function(){""!==this.theme&&(this.theme=this.toPascalCase(this.theme))},e.prototype.toPascalCase=function(t){var e=[];sf.base.isNullOrUndefined(t)||(e=t.toLowerCase().split("-"));for(var i=0;i<e.length;i++)e[i]=e[i].charAt(0).toUpperCase()+e[i].slice(1);return e.join("")},e.prototype.createCanvas=function(){this.element.style.boxSizing="border-box";var t=this.toolbarHeight;this.element.style.width=this.width,this.element.style.height=this.height;var e=this.element.appendChild(this.createElement("div",{id:this.element.id+"_canvasWrapper",className:"e-canvas-wrapper",attrs:{style:"height:"+(this.element.offsetHeight-t-2)+"px; width:"+(this.element.offsetWidth-2)+"px; position: relative; overflow: hidden; margin: 0 auto;"}}));this.lowerCanvas=e.appendChild(this.createElement("canvas",{id:this.element.id+"_lowerCanvas",attrs:{name:"canvasImage"}})),this.upperCanvas=e.appendChild(this.createElement("canvas",{id:this.element.id+"_upperCanvas",attrs:{name:"canvasImage"}})),this.inMemoryCanvas=this.createElement("canvas",{id:this.element.id+"_inMemoryCanvas",attrs:{name:"canvasImage"}}),this.textArea=e.appendChild(this.createElement("textarea",{id:this.element.id+"_textArea",className:"e-textarea",attrs:{name:"textArea"}})),this.textArea.setAttribute("spellcheck","false"),this.lowerCanvas.style.width=this.upperCanvas.style.width=this.inMemoryCanvas.style.width="100%",this.lowerCanvas.style.height=this.upperCanvas.style.height=this.inMemoryCanvas.style.height="100%",this.upperCanvas.style.position=this.lowerCanvas.style.position=this.textArea.style.position="absolute",this.textArea.style.backgroundColor="transparent",this.textArea.style.display="none",this.textArea.style.resize="none",this.lowerContext=this.lowerCanvas.getContext("2d"),this.baseImg=this.createElement("img",{id:this.element.id+"_orgImg",attrs:{name:"Image",crossorigin:"anonymous"}}),this.upperCanvas.style.cursor="default",this.upperCanvas.style.display="none",this.upperContext=this.upperCanvas.getContext("2d"),this.inMemoryContext=this.inMemoryCanvas.getContext("2d")},e.prototype.cropSelectedState=function(){sf.base.isNullOrUndefined(this.activeObj.shape)||"crop"!==this.activeObj.shape.split("-")[0]||this.okBtn()},e.prototype.performTransformation=function(t){var e=this.defaultZoomFactor,i=this.isUndoRedo,s=sf.base.extend({},this.cropObj,{},!0);if(0!==this.defaultZoomFactor&&(this.transformCurrentObj=this.getCurrentObj(),this.transformCurrentObj.objColl=sf.base.extend([],this.objColl,null,!0),this.transformCurrentObj.pointColl=sf.base.extend({},this.pointColl,null,!0),this.transformCurrentObj.afterCropActions=sf.base.extend([],this.afterCropActions,[],!0),this.isUndoRedo=!0,this.defaultZoomFactor>0?this.zoom(-this.defaultZoomFactor):this.zoom(Math.abs(this.defaultZoomFactor)),this.isUndoRedo=i),this.updateTransform(t),0!==e){this.isUndoRedo=!0,this.zoom(e),this.isUndoRedo=i;var a="";"rotateleft"===t||"rotateright"===t?a="rotate":"horizontalflip"!==t&&"verticalflip"!==t||(a="flip"),this.updateUndoRedoColl(a,this.transformCurrentObj,this.transformCurrentObj.objColl,this.transformCurrentObj.pointColl,s),this.transformCurrentObj=null}},e.prototype.updateTransform=function(t){switch(t.toLowerCase()){case"rotateleft":this.rotate(-90);break;case"rotateright":this.rotate(90);break;case"horizontalflip":this.flip("Horizontal");break;case"verticalflip":this.flip("Vertical")}},e.prototype.pushActItemIntoObj=function(){if("none"===this.textArea.style.display)this.objColl.push(this.activeObj);else{var t=sf.base.extend({},this.activeObj,{},!0);this.setTextBoxStylesToActObj(),this.objColl.push(this.activeObj),this.activeObj=t}},e.prototype.getFontSizes=function(){var t,e=[];this.fontSizeColl=[],t=0===this.degree||this.degree%180==0?this.destWidth/25:this.destHeight/25;for(var i=1;i<=10;i++)this.fontSizeColl.push({text:(i*Math.round(t/2)).toString()}),e.push({text:i.toString()});return e},e.prototype.getTextAreaWidth=function(t){var e,i=this.activeObj.textSettings.bold,s=this.activeObj.textSettings.italic;switch(t){case"default":this.activeObj.textSettings.bold=!1,this.activeObj.textSettings.italic=!1;break;case"bold":this.activeObj.textSettings.bold=!0,this.activeObj.textSettings.italic=!1;break;case"italic":this.activeObj.textSettings.bold=!1,this.activeObj.textSettings.italic=!0;break;case"bolditalic":this.activeObj.textSettings.bold=!0,this.activeObj.textSettings.italic=!0}return this.updateFontStyles(),e="none"===this.textArea.style.display?this.upperContext.measureText(this.activeObj.keyHistory).width+.5*this.activeObj.textSettings.fontSize:this.upperContext.measureText(this.textArea.value).width+.5*this.activeObj.textSettings.fontSize,this.activeObj.textSettings.bold=i,this.activeObj.textSettings.italic=s,e},e.prototype.updateUndoRedoObj=function(t){if(this.allowUndoRedo){this.objColl.push(this.activeObj);var e=sf.base.extend({},this.cropObj,{},!0),i=this.getCurrentObj();i.objColl=sf.base.extend([],this.objColl,[],!0),i.pointColl=sf.base.extend([],this.pointColl,[],!0),i.afterCropActions=sf.base.extend([],this.afterCropActions,[],!0),this.undoRedoColl.push({operation:"shapeTransform",previousObj:i,currentObj:i,previousObjColl:t,currentObjColl:i.objColl,previousPointColl:i.pointColl,currentPointColl:i.pointColl,previousCropObj:e,currentCropObj:e}),this.undoRedoStep++,this.redrawShape(this.objColl[this.objColl.length-1])}},e.prototype.updateObjColl=function(t,e){var i=sf.base.extend({},this.cropObj,{},!0),s=this.getCurrentObj();s.objColl=e,s.pointColl=sf.base.extend([],this.pointColl,[],!0),s.afterCropActions=sf.base.extend([],this.afterCropActions,[],!0);var a=this.activeObj.textSettings.bold,o=this.activeObj.textSettings.italic;switch(t){case"default":this.activeObj.textSettings.bold=!1,this.activeObj.textSettings.italic=!1;break;case"bold":this.activeObj.textSettings.bold=!0,this.activeObj.textSettings.italic=!1;break;case"italic":this.activeObj.textSettings.bold=!1,this.activeObj.textSettings.italic=!0;break;case"bolditalic":this.activeObj.textSettings.bold=!0,this.activeObj.textSettings.italic=!0}this.objColl.push(this.activeObj),this.updateUndoRedoColl("textAreaCustomization",s,s.objColl,s.pointColl,i),this.objColl.pop(),this.activeObj.textSettings.bold=a,this.activeObj.textSettings.italic=o},e.prototype.applyFontStyle=function(t){this.pushActItemIntoObj();var e=sf.base.extend([],this.objColl,[],!0);switch(this.objColl.pop(),"none"===this.textArea.style.display?this.updateFontRatio(this.activeObj):this.updateFontRatio(this.activeObj,!0),t){case"default":if("block"===this.textArea.style.display){var i=this.getTextAreaWidth(t);this.textArea.style.width=i+"px",this.textArea.style.fontWeight="normal",this.textArea.style.fontStyle="normal",this.updateObjColl(t,e)}else this.textSettings.bold=this.activeObj.textSettings.bold=!1,this.textSettings.italic=this.activeObj.textSettings.italic=!1,this.redrawText(),this.updateUndoRedoObj(e);break;case"bold":if("block"===this.textArea.style.display){i=this.getTextAreaWidth(t);this.textArea.style.width=i+"px",this.textArea.style.fontWeight="bold",this.textArea.style.fontStyle="normal",this.updateObjColl(t,e)}else this.textSettings.bold=this.activeObj.textSettings.bold=!0,this.textSettings.italic=this.activeObj.textSettings.italic=!1,this.redrawText(),this.updateUndoRedoObj(e);break;case"italic":if("block"===this.textArea.style.display){i=this.getTextAreaWidth(t);this.textArea.style.width=i+"px",this.textArea.style.fontWeight="normal",this.textArea.style.fontStyle="italic",this.updateObjColl(t,e)}else this.textSettings.bold=this.activeObj.textSettings.bold=!1,this.textSettings.italic=this.activeObj.textSettings.italic=!0,this.redrawText(),this.updateUndoRedoObj(e);break;case"bolditalic":if("block"===this.textArea.style.display){i=this.getTextAreaWidth(t);this.textArea.style.width=i+"px",this.textArea.style.fontWeight="bold",this.textArea.style.fontStyle="italic",this.updateObjColl(t,e)}else this.textSettings.bold=this.activeObj.textSettings.bold=!0,this.textSettings.italic=this.activeObj.textSettings.italic=!0,this.redrawText(),this.updateUndoRedoObj(e)}},e.prototype.refreshUndoRedoColl=function(){this.undoRedoColl=this.undoRedoColl.slice(0,this.undoRedoStep),this.isUndoRedo=this.currObjType.isUndoAction=!1,this.enableDisableToolbarBtn()},e.prototype.applyPreviewFilter=function(){sf.base.isNullOrUndefined(document.querySelector("#"+this.element.id+"_sliderWrapper"))&&!this.currObjType.isFiltered||(this.initialAdjustmentValue=this.canvasFilter=this.lowerContext.filter,this.currObjType.isFiltered=!1)},e.prototype.performCancel=function(){this.isFreehandDrawEditing?this.cancelFreehandDraw():"block"===this.textArea.style.display?(this.textArea.style.display="none",this.textArea.value="",this.textArea.style.transform="",this.activeObj.strokeSettings=this.tempStrokeSettings,this.activeObj.textSettings=this.tempTextSettings):!sf.base.isNullOrUndefined(document.querySelector("e-slider"))||this.currObjType.isFiltered?(this.lowerContext.filter=this.adjustmentValue=this.initialAdjustmentValue=this.tempAdjustmentValue,this.lowerContext.filter.split(" ").length>1&&"1"===this.lowerContext.filter.split(" ")[0].split("(")[1].split(")")[0]&&(this.isBrightnessAdjusted=!1),this.currentFilter=this.tempFilter,this.lowerContext.clearRect(0,0,this.lowerCanvas.width,this.lowerCanvas.height),this.redrawImgWithObj(),this.currObjType.isFiltered=!1,this.adjustmentLevel=sf.base.extend({},this.tempAdjustmentLevel,{},!0),this.undoRedoStep=this.tempUndoRedoStep,this.upperCanvas.style.cursor="default",this.currObjType.isCustomCrop=!1,this.tempStrokeSettings={strokeColor:"#fff",fillColor:"",strokeWidth:null}):(this.cancelItems(),this.togglePan=this.dragCanvas=!1),this.currentToolbar="main",this.enableDisableToolbarBtn()},e.prototype.applyShape=function(){sf.base.isNullOrUndefined(this.activeObj.shape)||"rectangle"!==this.activeObj.shape&&"ellipse"!==this.activeObj.shape&&"line"!==this.activeObj.shape&&"arrow"!==this.activeObj.shape&&"text"!==this.activeObj.shape||(this.redrawActObj(),this.refreshActiveObj(),this.currentToolbar="main")},e.prototype.applyFreehandDraw=function(){"#42a5f5"===this.pointColl[this.freehandDrawSelectedIndex].strokeColor&&(this.pointColl[this.freehandDrawSelectedIndex].strokeColor=this.tempFreeHandDrawEditingStyles.strokeColor),this.selectedFreehandColor="#42a5f5",this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),this.lowerContext.clearRect(0,0,this.lowerCanvas.width,this.lowerCanvas.height),this.renderImage(),sf.base.isNullOrUndefined(this.pointColl[this.freehandDrawSelectedIndex])||(this.pointColl[this.freehandDrawSelectedIndex].isSelected=!1),this.isFreehandDrawEditing=this.isFreehandDrawingPoint=!1,this.freehandDrawHoveredIndex=this.freehandDrawSelectedIndex=null},e.prototype.cancelFreehandDraw=function(){this.selectedFreehandColor="#42a5f5",this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height);for(var t=0;t<this.freehandCounter;t++)this.pointColl[t].strokeColor=this.tempFreeHandDrawEditingStyles.strokeColor,this.pointColl[t].strokeWidth=this.tempFreeHandDrawEditingStyles.strokeWidth;this.pointCounter=0,sf.base.isNullOrUndefined(this.pointColl[this.freehandDrawSelectedIndex])||(this.pointColl[this.freehandDrawSelectedIndex].isSelected=!1),this.freehandDrawHoveredIndex=this.freehandDrawSelectedIndex=this.freehandDrawSelectedId=null,this.isFreehandDrawEditing=this.isFreehandDrawingPoint=!1,this.tempFreeHandDrawEditingStyles={strokeColor:null,strokeWidth:null,fillColor:null}},e.prototype.setTempFilterProperties=function(){this.upperCanvas.style.display="block",this.cropSelectedState(),this.lowerContext.filter=this.initialAdjustmentValue,this.tempAdjustmentValue=this.lowerContext.filter,this.tempAdjustmentLevel=sf.base.extend({},this.adjustmentLevel,{},!0),this.tempFilter=this.currentFilter,this.tempUndoRedoStep=this.undoRedoStep},e.prototype.okBtn=function(){var t,e=!1;void 0!==this.activeObj.shape&&(t=this.activeObj.shape.split("-")),(void 0===t&&this.currObjType.isCustomCrop||void 0!==t&&"crop"===t[0])&&(e=!0);var i=this.element.querySelector(".e-contextual-toolbar-wrapper .e-toolbar-item.e-selected");i&&(this.currentFilter=i.children[0].children[0].id.replace("Canvas","")),e?this.crop():this.togglePen?this.freeHandDraw(!1):"block"===this.textArea.style.display?this.redrawActObj():!sf.base.isNullOrUndefined(document.querySelector("#"+this.element.id+"_sliderWrapper"))||this.currObjType.isFiltered?(this.initialAdjustmentValue=this.canvasFilter=this.lowerContext.filter,this.currObjType.isFiltered=!1):this.isFreehandDrawEditing?this.applyFreehandDraw():this.applyActObj(),this.isCropTab=!1,this.zoomFactor=this.defaultZoomFactor},e.prototype.updateBrightnessFilter=function(){var t=this.lowerContext.filter.split(" ");if(this.isBrightnessAdjusted&&t.length>0&&!sf.base.isNullOrUndefined(t[4])){var e=parseFloat(t[4].split("(")[1]);t[4]="opacity("+(e-.3)+")",this.lowerContext.filter=t.join(" ")}},e.prototype.isFreehandDrawIndex=function(t){for(var e=!1,i=0;i<this.freehandCounter;i++)if(parseInt(this.pointColl[i].id.split("_")[1],10)-1===t){e=!0;break}return e},e.prototype.deleteFreehandDraw=function(t,e){if(this.isFreehandDrawIndex(t)){this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height);var i=sf.base.extend({},this.pointColl,{},!0);this.pointColl={};var s=0;if(sf.base.isNullOrUndefined(e))for(var a=0;a<this.freehandCounter;a++)a!==t&&(this.pointColl[s]=i[a],s++);else for(a=0;a<this.freehandCounter;a++)parseInt(i[a].id.split("_")[1],10)-1!==t&&(this.pointColl[s]=i[a],s++);this.freehandCounter-=1,this.freehandDrawHoveredIndex=this.freehandDrawSelectedIndex=null,this.isFreehandDrawEditing=this.isFreehandDrawingPoint=!1,this.renderImage()}},e.prototype.callUndo=function(){this.currObjType.isFiltered=!1,0===this.zoomFactor&&(this.dragCanvas=this.togglePan=!1),this.togglePen&&(this.togglePen=!1,this.upperCanvas.style.cursor="default",this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height)),this.undo()},e.prototype.callRedo=function(){this.currObjType.isFiltered=!1,0===this.zoomFactor&&(this.dragCanvas=this.togglePan=!1),this.redo()},e.prototype.iterateObjColl=function(){for(var t=0;t<this.objColl.length;t++)this.apply(this.objColl[t].shape,this.objColl[t]),this.refreshActiveObj()},e.prototype.updateAdjustment=function(t,e,i){this.lowerContext.clearRect(0,0,this.lowerCanvas.width,this.lowerCanvas.height);var s,a,o=this.lowerContext.filter.split(" "),r=[];void 0!==o[4]&&(s=parseFloat(o[4].split("(")[1])),void 0!==o[0]&&(a=parseFloat(o[0].split("(")[1]));var n,h,l,c,d,p=this.getFilterValue(this.adjustmentLevel.brightness),v=this.getFilterValue(this.adjustmentLevel.saturation);if("brightness"!==t&&"contrast"!==t&&"hue"!==t&&"saturation"!==t&&"exposure"!==t&&"opacity"!==t&&"blur"!==t&&sf.base.isNullOrUndefined(i)&&(this.adjustmentLevel.sharpen||this.adjustmentLevel.bw)){this.isUndoRedo=!0;var b=this.lowerContext.filter;this.lowerContext.filter="none",this.iterateObjColl(),this.freehandRedraw(this.lowerContext),this.lowerContext.filter=b,this.isUndoRedo=!1}switch(1!==p&&(o[4]="opacity("+(s-.3)+")"),t){case"brightness":100!==parseFloat(o[3].split("(")[1])&&(e+=.1),o[0]="brightness("+e+")",this.adjustmentValue=o.join(" ");break;case"contrast":o[1]="contrast("+e+"%)",this.adjustmentValue=o.join(" ");break;case"hue":o[2]="hue-rotate("+e+"deg)",this.adjustmentValue=o.join(" ");break;case"saturation":o[3]="saturate("+e+"%)",1!==v&&(o[0]="brightness("+(a+.1)+")"),this.adjustmentValue=o.join(" ");break;case"opacity":1!==parseFloat(o[0].split("(")[1])&&(e-=.2),o[4]="opacity("+e+")",this.adjustmentValue=o.join(" ");break;case"blur":o[5]="blur("+e+"px)",this.adjustmentValue=o.join(" ");break;case"exposure":1!==p&&(o[4]="opacity("+(s-.3)+")"),e>1?(e-=1,e+=p):e<1&&(e=p-(e=1-e)),o[0]="brightness("+e+")",this.adjustmentValue=o.join(" ");break;case"chrome":n=this.getSaturationFilterValue(this.adjustmentLevel.saturation),e=(n*=100)+.4*n,o[3]="saturate("+e+"%)",r=this.adjustmentValue.split(" "),o[0]=r[0],o[1]=r[1],o[2]=r[2],o[4]=r[4],o[5]=r[5],o[6]="sepia(0%)",o[7]="grayscale(0%)",o[8]="invert(0%)";break;case"cold":h=this.getFilterValue(this.adjustmentLevel.brightness),e=.9*(h*=100),o[0]="brightness("+e+"%)",c=this.getFilterValue(this.adjustmentLevel.contrast),e=(c*=100)+.5*c,o[1]="contrast("+e+"%)",d=this.getSaturationFilterValue(this.adjustmentLevel.saturation),e=d*=100,o[3]="saturate("+e+"%)",r=this.adjustmentValue.split(" "),o[2]=r[2],o[4]=r[4],o[5]=r[5],o[6]="sepia(0%)",o[7]="grayscale(0%)",o[8]="invert(0%)";break;case"warm":l=this.getSaturationFilterValue(this.adjustmentLevel.saturation),e=(l*=100)+.4*l,o[3]="saturate("+e+"%)",o[6]="sepia(25%)",r=this.adjustmentValue.split(" "),o[0]=r[0],o[1]=r[1],o[2]=r[2],o[4]=r[4],o[5]=r[5],o[7]="grayscale(0%)",o[8]="invert(0%)";break;case"grayscale":o[7]="grayscale(100%)",r=this.adjustmentValue.split(" "),o[0]=r[0],o[1]=r[1],o[2]=r[2],o[3]=r[3],o[4]=r[4],o[5]=r[5],o[6]="sepia(0%)",o[8]="invert(0%)";break;case"sepia":o[6]="sepia(100%)",r=this.adjustmentValue.split(" "),o[0]=r[0],o[1]=r[1],o[2]=r[2],o[3]=r[3],o[4]=r[4],o[5]=r[5],o[7]="grayscale(0%)",o[8]="invert(0%)";break;case"invert":o[8]="invert(100%)",r=this.adjustmentValue.split(" "),o[0]=r[0],o[1]=r[1],o[2]=r[2],o[3]=r[3],o[4]=r[4],o[5]=r[5],o[6]="sepia(0%)",o[7]="grayscale(0%)"}if("sharpen"!==t&&"blackandwhite"!==t){sf.base.isNullOrUndefined(i)&&("default"===t&&(o=this.getDefaultCurrentFilter(o)),this.lowerContext.filter=o.join(" ")),o=this.setTempFilterValue(p,i,o,t),this.isRotateZoom=!0,this.updateCurrentTransformedState("initial"),this.lowerContext.drawImage(this.baseImg,this.srcLeft,this.srcTop,this.srcWidth,this.srcHeight,this.destLeft,this.destTop,this.destWidth,this.destHeight),this.updateCurrentTransformedState("reverse"),this.isRotateZoom=!1,1!==p?o[4]="opacity("+s+")":1!==v&&(o[0]="brightness("+a+")"),"exposure"===t&&1!==p&&(o[0]="brightness("+a+")"),"saturation"===t&&1!==v&&(o[0]="brightness("+a+")"),o=this.setTempFilterValue(p,i,o,t),sf.base.isNullOrUndefined(i)&&(this.lowerContext.filter=this.initialAdjustmentValue=o.join(" "));var u=this.lowerContext.filter;this.lowerContext.filter=this.getDefaultFilter(),this.iterateObjColl(),this.freehandRedraw(this.lowerContext),this.lowerContext.filter=u,(!sf.base.isNullOrUndefined(this.currSelectionPoint)&&"crop-circle"===this.currSelectionPoint.shape||this.isCircleCrop)&&this.cropCircle(this.lowerContext),this.isBrightnessAdjusted=1!==p}return o.join(" ")},e.prototype.autoEnablePan=function(){0===this.zoomFactor?(this.dragCanvas=this.togglePan=!1,this.pan(!1),this.disablePan=!1):this.disablePan?this.disablePan&&this.pan(!1):this.pan(!0)},e.prototype.setTempFilterValue=function(t,e,i,s){if(e&&1!==t){var a=this.lowerContext.filter.split(" ");a[4]=i[4],this.lowerContext.filter=a.join(" ")}else e&&"default"===s&&(i=this.getDefaultCurrentFilter(i));return i},e.prototype.getDefaultCurrentFilter=function(t){var e=this.adjustmentValue.split(" ");return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]="sepia(0%)",t[7]="grayscale(0%)",t[8]="invert(0%)",t},e.prototype.getCurrAdjustmentValue=function(t){var e;switch(t){case"brightness":e=this.adjustmentLevel.brightness;break;case"contrast":e=this.adjustmentLevel.contrast;break;case"hue":e=this.adjustmentLevel.hue;break;case"saturation":e=this.adjustmentLevel.saturation;break;case"opacity":e=this.adjustmentLevel.opacity;break;case"blur":e=this.adjustmentLevel.blur;break;case"exposure":e=this.adjustmentLevel.exposure}return e},e.prototype.setCurrAdjustmentValue=function(t,e){var i=this,s={finetune:this.toPascalCase(t),value:e,cancel:!1};this.dotnetRef.invokeMethodAsync("OnFinetuneValueChange",s).then((function(){if(!s.cancel)switch(t){case"brightness":i.setBrightness(e);break;case"contrast":i.setContrast(e);break;case"hue":i.setHue(e);break;case"saturation":i.setSaturation(e);break;case"opacity":i.setOpacity(e);break;case"blur":i.setBlur(e);break;case"exposure":i.setExposure(e)}}))},e.prototype.cancelPan=function(){this.applyActObj();var t=this.element.querySelector(".e-img-pan .e-btn");sf.base.isNullOrUndefined(t)||t.classList.remove("e-selected-btn"),this.pan(!1)},e.prototype.setCurrSelectionPoints=function(t){if(this.srcLeft=0,this.srcTop=0,this.srcWidth=this.baseImg.width,this.srcHeight=this.baseImg.height,this.destLeft=this.cropDestPoints.startX,this.destTop=this.cropDestPoints.startY,this.destWidth=this.cropDestPoints.width,this.destHeight=this.cropDestPoints.height,this.lowerContext.clearRect(0,0,this.lowerCanvas.width,this.lowerCanvas.height),t&&this.setDestinationPoints(),this.currentTransformedState("initial"),0!==this.croppedDegree||0!==this.degree||sf.base.isNullOrUndefined(this.currSelectionPoint)||"crop-circle"===this.currSelectionPoint.shape||"crop-square"===this.currSelectionPoint.shape||(this.destLeft=this.cropDestPoints.startX,this.destTop=this.cropDestPoints.startY,this.destWidth=this.cropDestPoints.width,this.destHeight=this.cropDestPoints.height),0===this.degree&&(this.destLeft+=this.totalPannedInternalPoint.x,this.destTop+=this.totalPannedInternalPoint.y),this.updateBrightnessFilter(),this.lowerContext.drawImage(this.baseImg,this.srcLeft,this.srcTop,this.srcWidth,this.srcHeight,this.destLeft,this.destTop,this.destWidth,this.destHeight),this.currentTransformedState("reverse",null,null,!0),sf.base.isNullOrUndefined(this.cropObj.activeObj.shape)){var e=this.lowerContext.filter;this.lowerContext.filter="none",this.iterateObjColl(),this.freehandRedraw(this.lowerContext),this.lowerContext.filter=e,this.currSelectionPoint=null}else{if(this.cropObj.cropZoom>0){var i=this.isUndoRedo;this.isUndoRedo=!0;var s=sf.base.extend([],this.objColl,null,!0),a=sf.base.extend([],this.pointColl,null,!0);this.objColl=[],this.pointColl=[],this.freehandCounter=0,this.zoom(this.cropObj.cropZoom),this.objColl=s,this.pointColl=a,this.freehandCounter=this.pointColl.length,this.isUndoRedo=i,this.currSelectionPoint=sf.base.extend({},this.cropObj.activeObj,null,!0),""!==this.cropObj.currFlipState&&(this.cropObj.totalPannedPoint.x+=this.cropObj.tempFlipPanPoint.x,this.cropObj.totalPannedPoint.y+=this.cropObj.tempFlipPanPoint.y)}var o={startX:this.destLeft,startY:this.destTop,width:this.destWidth,height:this.destHeight};this.destLeft=this.currSelectionPoint.activePoint.startX,this.destTop=this.currSelectionPoint.activePoint.startY,this.destWidth=this.currSelectionPoint.activePoint.width,this.destHeight=this.currSelectionPoint.activePoint.height,this.zoomObjColl(),this.zoomFreehandDrawColl(),this.destLeft=o.startX,this.destTop=o.startY,this.destWidth=o.width,this.destHeight=o.height,this.updatePannedRegion(),this.updateObjAndFreeHandDrawColl();var r=sf.base.extend([],this.objColl,null,!0),n=sf.base.extend([],this.pointColl,null,!0);this.objColl=[],this.pointColl=[],this.freehandCounter=0,this.setCurrentObj();var h=sf.base.extend({},this.activeObj,null,!0);this.refreshActiveObj(),this.objColl=r,this.pointColl=n,this.freehandCounter=this.pointColl.length,this.zoomObjColl(),this.zoomFreehandDrawColl(),this.currSelectionPoint=null,0===this.degree&&this.drawPannImage({x:0,y:0}),this.activeObj=h,this.drawObject("duplicate")}},e.prototype.updatePannedRegion=function(){var t=0===this.degree?this.cropObj.totalPannedPoint:this.cropObj.totalPannedClientPoint;this.currFlipState===this.cropObj.currFlipState||"horizontal"===this.currFlipState&&""===this.cropObj.currFlipState||"vertical"===this.currFlipState&&""===this.cropObj.currFlipState?(this.panObjColl(-t.x,-t.y,""),this.panFreehandDrawColl(-t.x,-t.y,"")):""===this.currFlipState&&"horizontal"===this.cropObj.currFlipState?(this.panObjColl(t.x,-t.y,""),this.panFreehandDrawColl(t.x,-t.y,"")):""===this.currFlipState&&"vertical"===this.cropObj.currFlipState&&(this.panObjColl(-t.x,t.y,""),this.panFreehandDrawColl(-t.x,t.y,""))},e.prototype.updateObjAndFreeHandDrawColl=function(){for(var t=0;t<this.objColl.length;t++)this.objColl[t].imageRatio={startX:(this.objColl[t].activePoint.startX-this.destLeft)/this.destWidth,startY:(this.objColl[t].activePoint.startY-this.destTop)/this.destHeight,endX:(this.objColl[t].activePoint.endX-this.destLeft)/this.destWidth,endY:(this.objColl[t].activePoint.endY-this.destTop)/this.destHeight,width:this.destWidth/this.objColl[t].activePoint.width,height:this.destHeight/this.objColl[t].activePoint.height},this.refreshActiveObj();for(var e=0;e<this.freehandCounter;e++){this.points=sf.base.extend([],this.pointColl[e].points,[]),this.pointCounter=0;for(var i=this.points.length,s=0;s<i;s++)this.points[s].ratioX=(this.points[s].x-this.destLeft)/this.destWidth,this.points[s].ratioY=(this.points[s].y-this.destTop)/this.destHeight}},e.prototype.cancelItems=function(){var t,e=!1;if(void 0!==this.activeObj.shape&&(t=this.activeObj.shape.split("-")),(void 0===t&&this.currObjType.isCustomCrop||void 0!==t&&"crop"===t[0])&&(e=!0),e&&this.isCropTab&&(this.isCropTab=!1,this.zoomFactor=this.defaultZoomFactor),this.togglePen){this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),this.togglePen=!1,this.upperCanvas.style.cursor="default";var i=sf.base.extend([],this.pointColl,[],!0);this.pointColl={};for(var s=0;s<this.tempFreehandCounter;s++)this.pointColl[s]=i[s];this.freehandCounter=this.tempFreehandCounter,this.currentFreehandDrawIndex=this.tempCurrentFreehandDrawIndex}else if("text"===this.activeObj.shape)sf.base.isNullOrUndefined(this.activeObj.currIndex)?(this.refreshActiveObj(),this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height)):(this.activeObj.strokeSettings=this.tempStrokeSettings,this.activeObj.textSettings=this.tempTextSettings,"Enter Text"===this.activeObj.keyHistory&&this.activeObj.activePoint.startX===this.textStartPoints.x&&this.activeObj.activePoint.startY===this.textStartPoints.y?(this.refreshActiveObj(),this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),this.textSettings=this.tempTextSettings,this.strokeSettings=this.tempStrokeSettings,this.drawShapeText(),this.applyActObj()):(this.redrawText(),this.redrawShape(this.activeObj),e||void 0===this.activeObj.topLeftCircle||this.applyActObj(),this.clearSelection())),this.tempTextSettings={text:"Enter Text",fontFamily:"Arial",fontSize:null,fontRatio:null,bold:!1,italic:!1,underline:!1};else if("rectangle"===this.activeObj.shape||"ellipse"===this.activeObj.shape||"line"===this.activeObj.shape||"arrow"===this.activeObj.shape)sf.base.isNullOrUndefined(this.activeObj.currIndex)?(this.refreshActiveObj(),this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height)):(this.activeObj.strokeSettings=this.tempStrokeSettings,this.redrawShape(this.activeObj),this.applyActObj());else if(this.zoomFactor!==this.tempZoomFactor||e&&sf.base.isNullOrUndefined(this.currSelectionPoint)){var a=this.cropZoomFactor-this.tempZoomFactor;if(this.zoomFactor=this.cropZoomFactor,sf.base.isNullOrUndefined(this.cropObj.activeObj.shape)&&(0===this.degree&&0===this.totalPannedPoint.x&&0===this.totalPannedPoint.y||0!==this.degree&&0===this.totalPannedInternalPoint.x&&0===this.totalPannedInternalPoint.y&&0===this.totalPannedClientPoint.x&&0===this.totalPannedClientPoint.y))return this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),this.refreshActiveObj(),a>0?this.zoom(-a):this.zoom(Math.abs(a)),this.cropZoomFactor=this.tempZoomFactor,this.currObjType.isCustomCrop=!1,this.upperCanvas.style.cursor="default",this.currObjType.isCustomCrop=!1,void(this.tempStrokeSettings={strokeColor:"#fff",fillColor:"",strokeWidth:null});if(sf.base.isNullOrUndefined(this.cropObj.activeObj.shape)){if(0===this.degree){var o=sf.base.extend({},this.activeObj,{});this.destLeft+=-this.totalPannedPoint.x,this.destTop+=-this.totalPannedPoint.y,this.drawPannImage({x:-this.totalPannedPoint.x,y:-this.totalPannedPoint.y}),this.updateFlipPan(o),this.totalPannedPoint={x:0,y:0}}else this.totalPannedClientPoint={x:-this.totalPannedClientPoint.x,y:-this.totalPannedClientPoint.y},this.totalPannedInternalPoint={x:-this.totalPannedInternalPoint.x,y:-this.totalPannedInternalPoint.y},this.rotatePan(!0),this.totalPannedClientPoint={x:0,y:0},this.totalPannedInternalPoint={x:0,y:0},this.currentPannedPoint={x:0,y:0};this.refreshActiveObj(),this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),a>0?this.zoom(-a):this.zoom(Math.abs(a)),this.cropZoomFactor=this.tempZoomFactor}else{this.isCancelAction=!0,this.objColl=[],this.pointColl=[];var r=this.freehandCounter;this.freehandCounter=0;var n=sf.base.extend({},this.cropObj,{}),h=sf.base.extend([],this.afterCropActions,{},!0);this.setCurrentObj(),this.cropImg(),this.cropObj=n,this.afterCropActions=h,this.objColl=sf.base.extend([],this.cancelObjColl,[],!0),this.pointColl=sf.base.extend([],this.cancelPointColl,[],!0),this.freehandCounter=r,this.iterateObjColl(),this.freehandRedraw(this.lowerContext),this.clearOuterCanvas(this.lowerContext),this.isCircleCrop&&this.cropCircle(this.lowerContext),this.isCancelAction=!1}this.zoomFactor=this.defaultZoomFactor,this.enableDisableToolbarBtn()}else this.refreshActiveObj(),this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height);this.upperCanvas.style.cursor="default",this.currObjType.isCustomCrop=!1,this.tempStrokeSettings={strokeColor:"#fff",fillColor:"",strokeWidth:null}},e.prototype.freehandDownHandler=function(t,e){this.freehandDrawObj.time=(new Date).getTime(),this.isFreehandDrawing=!0,"mousedown"===t.type?this.freehandDownPoint={x:t.clientX,y:t.clientY}:this.freehandDownPoint={x:t.touches[0].clientX,y:t.touches[0].clientY},this.isFreehandPointMoved=!1,sf.base.EventHandler.add(e,"mousemove touchmove",this.freehandMoveHandler,this)},e.prototype.freehandUpHandler=function(t,e,i){var s=e.getBoundingClientRect();sf.base.EventHandler.remove(e,"mousemove touchmove",this.freehandMoveHandler),0===this.points.length&&("mouseup"===t.type?this.processPoint(t.clientX-s.left,t.clientY-s.top,!0,i):this.isFreehandPointMoved||this.processPoint(this.freehandDownPoint.x-s.left,this.freehandDownPoint.y-s.top,!0,i)),i.closePath();var a=sf.base.extend({},this.cropObj,{},!0),o=this.getCurrentObj();o.objColl=sf.base.extend([],this.objColl,[],!0),o.pointColl=sf.base.extend([],this.pointColl,[],!0),o.afterCropActions=sf.base.extend([],this.afterCropActions,[],!0),this.pointColl[this.freehandCounter]={},this.pointColl[this.freehandCounter].points=sf.base.extend([],this.points),this.pointColl[this.freehandCounter].strokeColor=this.activeObj.strokeSettings.strokeColor,this.pointColl[this.freehandCounter].strokeWidth=this.penStrokeWidth,this.pointColl[this.freehandCounter].flipState=this.currFlipState,this.pointColl[this.freehandCounter].id="pen_"+(this.currentFreehandDrawIndex+1),this.points=[],this.pointCounter=0,this.freehandCounter++,this.currentFreehandDrawIndex++,this.isFreehandDrawing=!1,this.updateUndoRedoColl("freehanddraw",o,o.objColl,o.pointColl,a)},e.prototype.freehandMoveHandler=function(t){this.isFreehandPointMoved=!0;var e,i,s=this.upperCanvas.getBoundingClientRect();"mousemove"===t.type?(e=t.clientX-s.left,i=t.clientY-s.top):(e=t.touches[0].clientX-s.left,i=t.touches[0].clientY-s.top),this.isFreehandDrawing&&this.processPoint(e,i,!1,this.upperContext)},e.prototype.processPoint=function(t,e,i,s){var a,o,r,n,h=this.point(t,e,(new Date).getTime()),l=!!(h=this.points.length>0&&this.points[this.points.length-1])&&this.distanceTo(h)<=5;if(!h||!h||!l||i){if(this.freehandDrawObj.time=(new Date).getTime(),this.points.push({x:t,y:e,ratioX:(t-this.destLeft)/this.destWidth,ratioY:(e-this.destTop)/this.destHeight,time:this.freehandDrawObj.time}),this.points.length>3){a=this.calcCurveControlPoints(this.points[this.pointCounter+0],this.points[this.pointCounter+1],this.points[this.pointCounter+2]).controlPoint2,o=this.calcCurveControlPoints(this.points[this.pointCounter+1],this.points[this.pointCounter+2],this.points[this.pointCounter+3]).controlPoint1,r=this.points[this.pointCounter+1],n=this.points[this.pointCounter+2];var c=.5,d=5;sf.base.isNullOrUndefined(this.penStrokeWidth)||(c=d=this.penStrokeWidth),this.startDraw(s,a,o,r,n,c,d),this.pointCounter++}if(i){a=o=r=n={x:t,y:e,time:(new Date).getTime()};c=.5,d=5;sf.base.isNullOrUndefined(this.penStrokeWidth)||(c=d=this.penStrokeWidth),this.startDraw(s,a,o,r,n,c,d)}}},e.prototype.calcCurveControlPoints=function(t,e,i){e||(e=t),i||(i=e);var s=t.x-e.x,a=t.y-e.y,o=e.x-i.x,r=e.y-i.y,n=(t.x+e.x)/2,h=(t.y+e.y)/2,l=(e.x+i.x)/2,c=(e.y+i.y)/2,d=Math.sqrt(s*s+a*a),p=Math.sqrt(o*o+r*r),v=p/(d+p),b=l+(n-l)*v,u=c+(h-c)*v,C=e.x-b,f=e.y-u;return{controlPoint1:this.point(n+C,h+f,0),controlPoint2:this.point(l+C,c+f,0)}},e.prototype.point=function(t,e,i){return this.freehandDrawObj.pointX=t,this.freehandDrawObj.pointY=e,{x:this.freehandDrawObj.pointX,y:this.freehandDrawObj.pointY,time:i}},e.prototype.startDraw=function(t,e,i,s,a,o,r){var n;n=.7*(n=this.pointVelocity(s))+(1-.7)*this.freehandDrawObj.lastVelocity;var h=Math.max(r/1.7,o);this.drawCurve(this.freehandDrawObj.time,h,t,e,i,s,a,r),this.freehandDrawObj.lastVelocity=n,this.freehandDrawObj.time=h},e.prototype.pointVelocity=function(t){return this.freehandDrawObj.time!==t.time?this.distanceTo(t)/(this.freehandDrawObj.time-t.time):0},e.prototype.distanceTo=function(t){return Math.sqrt(Math.pow(this.freehandDrawObj.pointX-t.x,2)+Math.pow(this.freehandDrawObj.pointY-t.y,2))},e.prototype.drawCurve=function(t,e,i,s,a,o,r,n){var h,l,c,d,p,v,b,u,C,f,j=e-t,g=this.bezierLength(s,a,o,r),O=2*Math.ceil(g);for(i.beginPath(),l=0;l<O;l++)p=(d=(c=l/O)*c)*c,C=(u=(b=(v=1-c)*v)*v)*o.x,C+=3*b*c*s.x,C+=3*v*d*a.x,C+=p*r.x,f=u*o.y,f+=3*b*c*s.y,f+=3*v*d*a.y,f+=p*r.y,h=Math.min(t+p*j,n),this.drawArc(C,f,h,i);i.closePath(),i.fill()},e.prototype.bezierLength=function(t,e,i,s){var a,o,r,n,h,l,c,d,p=0;for(a=0;a<=10;a++)o=a/10,r=this.bezierPoint(o,i.x,t.x,e.x,s.x),n=this.bezierPoint(o,i.y,t.y,e.y,s.y),a>0&&(c=r-h,d=n-l,p+=Math.sqrt(c*c+d*d)),h=r,l=n;return p},e.prototype.bezierPoint=function(t,e,i,s,a){return e*(1-t)*(1-t)*(1-t)+3*i*(1-t)*(1-t)*t+3*s*(1-t)*t*t+a*t*t*t},e.prototype.drawArc=function(t,e,i,s){(t>this.destLeft&&e>this.destTop&&t<this.destLeft+this.destWidth&&e<this.destTop+this.destHeight||s!==this.lowerContext&&s!==this.upperContext)&&(s.moveTo(t,e),s.arc(t,e,i,0,2*Math.PI,!1))},e.prototype.freehandRedraw=function(t,e){var i=t.filter;t.filter="none",sf.base.isNullOrUndefined(e)||(this.pointColl[this.freehandCounter]={},this.pointColl[this.freehandCounter].points=e,this.pointColl[this.freehandCounter].strokeColor=this.activeObj.strokeSettings.strokeColor,this.pointColl[this.freehandCounter].strokeWidth=this.penStrokeWidth,this.pointColl[this.freehandCounter].flipState=this.currFlipState,this.freehandCounter++);for(var s=0;s<this.freehandCounter;s++){this.points=sf.base.extend([],this.pointColl[s].points),this.pointCounter=0;var a=this.points.length,o=void 0,r=void 0,n=void 0,h=void 0,l=void 0,c=void 0;a>0&&(t.fillStyle=this.pointColl[s].strokeColor,l=c=this.penStrokeWidth=this.pointColl[s].strokeWidth),1===a&&(o=r=n=h=this.points[0],this.startDraw(t,o,r,n,h,l,c));for(var d=0;d<a-3;d++)this.points[d+1]&&this.points[d+2]&&this.points[d+2]&&(o=this.calcCurveControlPoints(this.points[d+0],this.points[d+1],this.points[d+2]).controlPoint2,r=this.calcCurveControlPoints(this.points[d+1],this.points[d+2],this.points[d+3]).controlPoint1,n=this.points[d+1],h=this.points[d+2],this.startDraw(t,o,r,n,h,l,c));t.closePath()}t.filter=i},e.prototype.redrawImgWithObj=function(){this.lowerContext.filter=this.canvasFilter,this.getCurrentFlipState(),this.isCircleCrop&&this.cropCircle(this.lowerContext);var t=this.lowerContext.filter;this.lowerContext.filter=this.getDefaultFilter(),this.iterateObjColl(),this.freehandRedraw(this.lowerContext),this.lowerContext.filter=t},e.prototype.updateFreehandDrawColorChange=function(){sf.base.isNullOrUndefined(this.freehandDrawSelectedIndex)||sf.base.isNullOrUndefined(this.pointColl[this.freehandDrawSelectedIndex])||"#42a5f5"!==this.pointColl[this.freehandDrawSelectedIndex].strokeColor||(this.pointColl[this.freehandDrawSelectedIndex].strokeColor=this.tempFreeHandDrawEditingStyles.strokeColor)},e.prototype.setPenStroke=function(t){switch(parseInt(t,10)){case 1:this.penStrokeWidth=1;break;case 2:this.penStrokeWidth=2;break;case 3:this.penStrokeWidth=3;break;case 4:this.penStrokeWidth=4;break;case 5:this.penStrokeWidth=5}},e.prototype.getPenStroke=function(t){var e="";return 1===t?e=this.l10n.getConstant("XSmall"):2===t?e=this.l10n.getConstant("Small"):3===t?e=this.l10n.getConstant("Medium"):4===t?e=this.l10n.getConstant("Large"):5===t&&(e=this.l10n.getConstant("XLarge")),e},e.prototype.getCurrentCanvasData=function(){var t=this.lowerContext.filter;this.lowerContext.filter="none";var e=sf.base.extend([],this.objColl,null,!0);this.objColl=[],this.renderImage();var i=this.lowerContext.getImageData(this.destLeft,this.destTop,this.destWidth,this.destHeight);return this.objColl=e,this.iterateObjColl(),this.lowerContext.filter=t,i},e.prototype.createCanvasFilter=function(){var t=this.getCurrentCanvasData();this.inMemoryCanvas.width=t.width,this.inMemoryCanvas.height=t.height,this.inMemoryContext.putImageData(t,0,0);var e=document.querySelector("#"+this.element.id+"_defaultCanvas"),i=e.getContext("2d");e.style.width="100px",e.style.height="100px",i.filter=this.updateAdjustment("default",null,!0),i.drawImage(this.inMemoryCanvas,0,0,300,150);var s=document.querySelector("#"+this.element.id+"_chromeCanvas");i=s.getContext("2d"),s.style.width="100px",s.style.height="100px",i.filter=this.updateAdjustment("chrome",null,!0),i.drawImage(this.inMemoryCanvas,0,0,300,150);var a=document.querySelector("#"+this.element.id+"_coldCanvas");i=a.getContext("2d"),a.style.width="100px",a.style.height="100px",i.filter=this.updateAdjustment("cold",null,!0),i.drawImage(this.inMemoryCanvas,0,0,300,150);var o=document.querySelector("#"+this.element.id+"_warmCanvas");i=o.getContext("2d"),o.style.width="100px",o.style.height="100px",i.filter=this.updateAdjustment("warm",null,!0),i.drawImage(this.inMemoryCanvas,0,0,300,150);var r=document.querySelector("#"+this.element.id+"_grayscaleCanvas");i=r.getContext("2d"),r.style.width="100px",r.style.height="100px",i.filter=this.updateAdjustment("grayscale",null,!0),i.drawImage(this.inMemoryCanvas,0,0,300,150);var n=document.querySelector("#"+this.element.id+"_sepiaCanvas");i=n.getContext("2d"),n.style.width="100px",n.style.height="100px",i.filter=this.updateAdjustment("sepia",null,!0),i.drawImage(this.inMemoryCanvas,0,0,300,150);var h=document.querySelector("#"+this.element.id+"_invertCanvas");i=h.getContext("2d"),h.style.width="100px",h.style.height="100px",i.filter=this.updateAdjustment("invert",null,!0),i.drawImage(this.inMemoryCanvas,0,0,300,150)},e.prototype.callUpdateCurrentTransformedState=function(){var t=sf.base.extend([],this.objColl,[],!0),e=sf.base.extend({},this.activeObj,{},!0);this.objColl=[],this.refreshActiveObj(),this.isRotateZoom=!0,this.updateCurrentTransformedState("initial"),0===this.degree&&this.rotateFlipColl.length>0&&(this.destLeft+=this.totalPannedPoint.x,this.destTop+=this.totalPannedPoint.y),this.destLeft+=this.totalPannedInternalPoint.x,this.destTop+=this.totalPannedInternalPoint.y;var i=this.lowerContext.filter;0===this.degree&&this.setDestPointsForFlipState(),this.updateBrightnessFilter(),this.lowerContext.drawImage(this.baseImg,this.srcLeft,this.srcTop,this.srcWidth,this.srcHeight,this.destLeft,this.destTop,this.destWidth,this.destHeight),this.updateCurrentTransformedState("reverse"),0===this.degree&&this.rotateFlipColl.length>0&&(this.destLeft+=this.totalPannedPoint.x,this.destTop+=this.totalPannedPoint.y),this.isRotateZoom=!1,this.objColl=t;var s=this.togglePen;this.togglePen=!1,this.lowerContext.filter="none",this.iterateObjColl(),this.destLeft+=this.totalPannedInternalPoint.x,this.destTop+=this.totalPannedInternalPoint.y,this.freehandRedraw(this.lowerContext),this.destLeft-=this.totalPannedInternalPoint.x,this.destTop-=this.totalPannedInternalPoint.y,this.togglePen=s,this.lowerContext.filter=i,this.activeObj=e},e.prototype.updateCurrentTransformedState=function(t,e,i){this.rotateFlipColl.length>0&&("initial"===t&&(this.reverseTransformedState(),sf.base.isNullOrUndefined(e)&&this.setDestinationPoints()),this.currentTransformedState(t,null,null,i)),(this.isCircleCrop||!sf.base.isNullOrUndefined(this.currSelectionPoint)&&"crop-circle"===this.currSelectionPoint.shape)&&(i&&(this.destLeft+=this.totalPannedClientPoint.x,this.destTop+=this.totalPannedClientPoint.y),this.cropCircle(this.lowerContext),i&&(this.destLeft-=this.totalPannedClientPoint.x,this.destTop-=this.totalPannedClientPoint.y))},e.prototype.reverseTransformedState=function(){this.lowerContext.setTransform(1,0,0,1,0,0)},e.prototype.currentTransformedState=function(t,e,i,s){i=i||this.lowerContext,"initial"===t?this.iterateRotateFlipColl(i,t):"reverse"===t&&(this.iterateRotateFlipColl(i,t),this.setClientTransformedDimension(e),(this.isCircleCrop||!sf.base.isNullOrUndefined(this.currSelectionPoint)&&"crop-circle"===this.currSelectionPoint.shape&&sf.base.isNullOrUndefined(s))&&(s&&(this.destLeft+=this.totalPannedClientPoint.x,this.destTop+=this.totalPannedClientPoint.y),this.cropCircle(this.lowerContext),s&&(this.destLeft-=this.totalPannedClientPoint.x,this.destTop-=this.totalPannedClientPoint.y)))},e.prototype.iterateRotateFlipColl=function(t,e){if("initial"===e)for(var i=0;i<this.rotateFlipColl.length;i++)this.setTransform(t,this.rotateFlipColl[i]);else if("reverse"===e)for(i=this.rotateFlipColl.length-1;i>=0;i--)this.setTransform(t,this.rotateFlipColl[i],!0)},e.prototype.setTransform=function(t,e,i){switch(i&&90===e?e=-90:i&&-90===e&&(e=90),"horizontal"===e&&this.degree%90==0&&this.degree%180!=0?e="vertical":"vertical"===e&&this.degree%90==0&&this.degree%180!=0&&(e="horizontal"),this.isReverseRotate=this.isReverseFlip=!0,sf.base.isNullOrUndefined(i)&&t.clearRect(0,0,t.canvas.width,t.canvas.height),e){case 90:case-90:t.translate(t.canvas.width/2,t.canvas.height/2),t.rotate(Math.PI/180*e),t.translate(-t.canvas.width/2,-t.canvas.height/2);break;case"horizontal":t.translate(t.canvas.width,0),t.scale(-1,1);break;case"vertical":t.translate(0,t.canvas.height),t.scale(1,-1)}this.isReverseRotate=this.isReverseFlip=!1},e.prototype.isObjInsideCropRegion=function(t){var e=!1;return(t.activePoint.startX>=this.destLeft&&t.activePoint.endX<=this.destLeft+this.destWidth||t.activePoint.startX<=this.destLeft&&t.activePoint.endX>=this.destLeft||t.activePoint.startX<=this.destLeft+this.destWidth&&t.activePoint.endX>=this.destLeft+this.destWidth||t.activePoint.startY>=this.destTop&&t.activePoint.endY<=this.destTop+this.destHeight||t.activePoint.startY<=this.destTop&&t.activePoint.endY>=this.destTop||t.activePoint.startY<=this.destTop+this.destHeight&&t.activePoint.endY>=this.destTop+this.destHeight)&&(e=!0),e},e.prototype.panFreehandDrawColl=function(t,e,i){for(var s=0;s<this.freehandCounter;s++){this.points=sf.base.extend([],this.pointColl[s].points,[]),this.pointCounter=0;for(var a=this.points.length,o=0;o<a;o++)""===i||"vertical"===i?this.points[o].x+=t:this.points[o].x-=t,""===i||"horizontal"===i?this.points[o].y+=e:this.points[o].y-=e}this.freehandRedraw(this.lowerContext)},e.prototype.panObjColl=function(t,e,i){for(var s=0;s<this.objColl.length;s++){""===i||"vertical"===i?(this.objColl[s].activePoint.startX+=t,this.objColl[s].activePoint.endX+=t):(this.objColl[s].activePoint.startX-=t,this.objColl[s].activePoint.endX-=t),""===i||"horizontal"===i?(this.objColl[s].activePoint.startY+=e,this.objColl[s].activePoint.endY+=e):(this.objColl[s].activePoint.startY-=e,this.objColl[s].activePoint.endY-=e),this.objColl[s].activePoint.width=this.objColl[s].activePoint.endX-this.objColl[s].activePoint.startX,this.objColl[s].activePoint.height=this.objColl[s].activePoint.endY-this.objColl[s].activePoint.startY,this.updateActiveObject(this.objColl[s].activePoint,this.objColl[s]),this.updateTrianglePoints(this.objColl[s]);var a=this.lowerContext.filter;this.lowerContext.filter="none",this.apply(this.objColl[s].shape,this.objColl[s]),this.lowerContext.filter=a,this.refreshActiveObj()}},e.prototype.cropObjColl=function(){if(this.objColl.length>0)for(var t=0;t<this.objColl.length;t++)this.objColl[t].imageRatio={startX:(this.objColl[t].activePoint.startX-this.activeObj.activePoint.startX)/this.activeObj.activePoint.width,startY:(this.objColl[t].activePoint.startY-this.activeObj.activePoint.startY)/this.activeObj.activePoint.height,endX:(this.objColl[t].activePoint.endX-this.activeObj.activePoint.startX)/this.activeObj.activePoint.width,endY:(this.objColl[t].activePoint.endY-this.activeObj.activePoint.startY)/this.activeObj.activePoint.height,width:this.activeObj.activePoint.width/this.objColl[t].activePoint.width,height:this.activeObj.activePoint.height/this.objColl[t].activePoint.height},"text"===this.objColl[t].shape&&(this.objColl[t].textSettings.fontRatio=this.objColl[t].activePoint.width/this.objColl[t].textSettings.fontSize)},e.prototype.cropFreehandDrawColl=function(){for(var t=0;t<this.freehandCounter;t++){this.points=sf.base.extend([],this.pointColl[t].points,[]),this.pointCounter=0;for(var e=this.points.length,i=0;i<e;i++)this.points[i].ratioX=(this.points[i].x-this.activeObj.activePoint.startX)/this.activeObj.activePoint.width,this.points[i].ratioY=(this.points[i].y-this.activeObj.activePoint.startY)/this.activeObj.activePoint.height}},e.prototype.hoverFreehandraw=function(t,e){var i=this.upperContext,s=-1;s=this.freehandDrawHoveredIndex>-1?this.freehandDrawHoveredIndex:this.freehandDrawSelectedIndex,this.points=sf.base.extend([],this.pointColl[s].points),this.pointCounter=0;var a,o,r,n,h,l,c=this.points.length;i.fillStyle=t||"#42a5f5",i.strokeStyle="#fff",h=l=this.penStrokeWidth=e||this.pointColl[s].strokeWidth,1===c&&(a=o=r=n=this.points[0],this.startDraw(i,a,o,r,n,h,l));for(var d=0;d<c-3;d++)this.points[d+1]&&this.points[d+2]&&this.points[d+2]&&(a=this.calcCurveControlPoints(this.points[d+0],this.points[d+1],this.points[d+2]).controlPoint2,o=this.calcCurveControlPoints(this.points[d+1],this.points[d+2],this.points[d+3]).controlPoint1,r=this.points[d+1],n=this.points[d+2],this.startDraw(i,a,o,r,n,h,l));i.closePath()},e.prototype.pointsHorizontalFlip=function(){for(var t=0;t<this.freehandCounter;t++)if(this.pointColl[t].shapeFlip!==this.currFlipState){this.points=sf.base.extend([],this.pointColl[t].points,[]),this.pointCounter=0;for(var e=this.points.length,i=0;i<e;i++)this.points[i].x<=this.destLeft+this.destWidth/2?this.points[i].x=this.destLeft+this.destWidth-(this.points[i].x-this.destLeft):this.points[i].x>=this.destLeft+this.destWidth/2&&(this.points[i].x=this.destLeft+(this.destLeft+this.destWidth-this.points[i].x)),this.points[i].ratioX=(this.points[i].x-this.destLeft)/this.destWidth,this.points[i].ratioY=(this.points[i].y-this.destTop)/this.destHeight;this.pointColl[t].shapeFlip=this.currFlipState}},e.prototype.pointsVerticalFlip=function(){for(var t=0;t<this.freehandCounter;t++)if(this.pointColl[t].shapeFlip!==this.currFlipState){this.points=sf.base.extend([],this.pointColl[t].points,[]),this.pointCounter=0;for(var e=this.points.length,i=0;i<e;i++)this.points[i].y<=this.destTop+this.destHeight/2?this.points[i].y=this.destTop+this.destHeight-(this.points[i].y-this.destTop):this.points[i].y>=this.destTop+this.destHeight/2&&(this.points[i].y=this.destTop+(this.destTop+this.destHeight-this.points[i].y)),this.points[i].ratioX=(this.points[i].x-this.destLeft)/this.destWidth,this.points[i].ratioY=(this.points[i].y-this.destTop)/this.destHeight;this.pointColl[t].shapeFlip=this.currFlipState}},e.prototype.flipFreehandrawColl=function(t){if("horizontal"===t.toLowerCase())this.pointsHorizontalFlip();else if("vertical"===t.toLowerCase())this.pointsVerticalFlip();else{this.pointsHorizontalFlip();for(var e=0;e<this.freehandCounter;e++)this.pointColl[e].shapeFlip="";this.pointsVerticalFlip()}},e.prototype.rotateFreehandDrawColl=function(){for(var t=0;t<this.freehandCounter;t++){this.points=sf.base.extend([],this.pointColl[t].points,[]),this.pointCounter=0;for(var e=this.points.length,i=0;i<e;i++)this.points[i].y=this.destTop+this.destHeight*this.points[i].ratioX,this.points[i].x=this.destLeft+this.destWidth-this.destWidth*this.points[i].ratioY}for(t=0;t<this.freehandCounter;t++){this.points=sf.base.extend([],this.pointColl[t].points,[]),this.pointCounter=0;for(e=this.points.length,i=0;i<e;i++)this.points[i].ratioX=(this.points[i].x-this.destLeft)/this.destWidth,this.points[i].ratioY=(this.points[i].y-this.destTop)/this.destHeight}},e.prototype.zoomFreehandDrawColl=function(t){for(var e=0;e<this.freehandCounter;e++){this.points=sf.base.extend([],this.pointColl[e].points,[]),this.pointCounter=0;for(var i=this.points.length,s=0;s<i;s++)this.points[s].x=this.zoomX(this.points[s].ratioX),this.points[s].y=this.zoomY(this.points[s].ratioY)}sf.base.isNullOrUndefined(t)&&this.freehandRedraw(this.lowerContext)},e.prototype.zoomX=function(t){return t*this.destWidth+this.destLeft},e.prototype.zoomY=function(t){return t*this.destHeight+this.destTop},e.prototype.zoomObjColl=function(t){for(var e=0;e<this.objColl.length;e++)if(this.objColl[e].activePoint.startX=this.objColl[e].imageRatio.startX*this.destWidth+this.destLeft,this.objColl[e].activePoint.startY=this.objColl[e].imageRatio.startY*this.destHeight+this.destTop,this.objColl[e].activePoint.endX=this.objColl[e].imageRatio.endX*this.destWidth+this.destLeft,this.objColl[e].activePoint.endY=this.objColl[e].imageRatio.endY*this.destHeight+this.destTop,this.objColl[e].activePoint.width=this.objColl[e].activePoint.endX-this.objColl[e].activePoint.startX,this.objColl[e].activePoint.height=this.objColl[e].activePoint.endY-this.objColl[e].activePoint.startY,"text"===this.objColl[e].shape&&this.updateFontSize(this.objColl[e]),this.updateActiveObject(this.objColl[e].activePoint,this.objColl[e]),this.updateTrianglePoints(this.objColl[e]),sf.base.isNullOrUndefined(t)){var i=this.lowerContext.filter;this.lowerContext.filter="none",this.apply(this.objColl[e].shape,this.objColl[e]),this.refreshActiveObj(),this.lowerContext.filter=i}},e.prototype.calcRatio=function(){var t,e;return 0===this.degree||this.degree%180==0?(t=this.baseImg.width/this.destWidth,e=this.baseImg.height/this.destHeight):(t=this.baseImg.height/this.destWidth,e=this.baseImg.width/this.destHeight),{width:t,height:e}},e.prototype.drawCustomSelection=function(t){this.currObjType.isCustomCrop=!0,this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),this.currObjType.shape=this.activeObj.shape=t.toLowerCase(),0===this.zoomFactor?this.destLeft>=0&&this.destTop>=0?(this.activeObj.activePoint.startX=this.destLeft,this.activeObj.activePoint.startY=this.destTop,this.activeObj.activePoint.endX=this.destLeft+this.destWidth,this.activeObj.activePoint.endY=this.destTop+this.destHeight):this.destLeft>=0?(this.activeObj.activePoint.startX=this.destLeft,this.activeObj.activePoint.startY=7.5,this.activeObj.activePoint.endX=this.destLeft+this.destWidth,this.activeObj.activePoint.endY=this.lowerCanvas.height-15):this.destTop>=0?(this.activeObj.activePoint.startX=7.5,this.activeObj.activePoint.startY=this.destTop,this.activeObj.activePoint.endX=this.lowerCanvas.width-15,this.activeObj.activePoint.endY=this.destTop+this.destHeight):(this.activeObj.activePoint.startX=7.5,this.activeObj.activePoint.startY=7.5,this.activeObj.activePoint.endX=this.lowerCanvas.width-15,this.activeObj.activePoint.endY=this.lowerCanvas.height-15):(this.destLeft>0?this.activeObj.activePoint.startX=this.destLeft:this.activeObj.activePoint.startX=7.5,this.destTop>0?this.activeObj.activePoint.startY=this.destTop:this.activeObj.activePoint.startY=7.5,this.destLeft+this.destWidth+15<this.lowerCanvas.width?this.activeObj.activePoint.endX=this.destLeft+this.destWidth-15:this.activeObj.activePoint.endX=this.lowerCanvas.width-15,this.destTop+this.destHeight+15<this.lowerCanvas.height?this.activeObj.activePoint.endY=this.destTop+this.destHeight-15:this.activeObj.activePoint.endY=this.lowerCanvas.height-15),this.activeObj.activePoint.startX<this.destLeft&&(this.activeObj.activePoint.startX=this.destLeft),this.activeObj.activePoint.startY<this.destTop&&(this.activeObj.activePoint.startY=this.destTop),this.activeObj.activePoint.endX>this.destLeft+this.destWidth&&(this.activeObj.activePoint.endX=this.destLeft+this.destWidth),this.activeObj.activePoint.endY>this.destTop+this.destHeight&&(this.activeObj.activePoint.endY=this.destTop+this.destHeight),this.activeObj.activePoint.startX===this.destLeft&&this.destLeft+this.destWidth>this.lowerCanvas.clientWidth&&(this.activeObj.activePoint.endX=this.lowerCanvas.clientWidth-15),this.activeObj.activePoint.startY===this.destTop&&this.destTop+this.destHeight>this.lowerCanvas.clientHeight&&(this.activeObj.activePoint.endY=this.lowerCanvas.clientHeight-15),this.activeObj.activePoint.width=this.activeObj.activePoint.endX-this.activeObj.activePoint.startX,this.activeObj.activePoint.height=this.activeObj.activePoint.endY-this.activeObj.activePoint.startY,this.updateActiveObject(this.activeObj.activePoint,this.activeObj),this.drawObject("duplicate",this.activeObj,null,null,!0)},e.prototype.clearOuterCanvas=function(t){var e=this.destLeft,i=this.destTop;if(""!==this.currFlipState&&(this.destLeft=this.lowerCanvas.clientWidth-(this.destWidth+this.destLeft),this.destTop=this.lowerCanvas.clientHeight-(this.destHeight+this.destTop)),this.destWidth<this.lowerCanvas.width){var s=this.destLeft>0?this.destLeft:0;t.clearRect(0,0,s,this.lowerCanvas.height),t.clearRect(this.destLeft+this.destWidth,0,s,this.lowerCanvas.height)}if(this.destHeight<this.lowerCanvas.height){var a=this.destTop>0?this.destTop:0;t.clearRect(0,0,this.lowerCanvas.width,a),t.clearRect(0,this.destTop+this.destHeight,this.lowerCanvas.width,a)}""!==this.currFlipState&&(this.destLeft=e,this.destTop=i)},e.prototype.cropCircle=function(t,e,i){i&&""!==this.currFlipState&&this.setTransform(t,this.currFlipState),t.globalCompositeOperation="destination-in",t.beginPath(),sf.base.isNullOrUndefined(e)?t.arc(this.destLeft+this.destWidth/2,this.destTop+this.destHeight/2,this.destWidth/2,0,2*Math.PI):t.arc(this.destWidth/2,this.destHeight/2,this.destWidth/2,0,2*Math.PI),t.closePath(),t.fill(),t.restore(),t.globalCompositeOperation="source-over",this.currObjType.isActiveObj=this.isCircleCrop=!0,i&&""!==this.currFlipState&&this.setTransform(t,this.currFlipState)},e.prototype.updateCropObj=function(){this.afterCropActions=[];var t=this.getCurrentObj();this.cropObj=sf.base.extend({},t,{},!0)},e.prototype.setCurrentObj=function(t){var e=!!t;t=t||this.cropObj,this.cropZoomFactor=t.cropZoom,this.defaultZoomFactor=t.defaultZoom,e&&(sf.base.isNullOrUndefined(t.activeObj.shape)||"crop"!==t.activeObj.shape.split("-")[0])?this.zoomFactor=t.defaultZoom:this.zoomFactor=t.cropZoom,this.totalPannedPoint=sf.base.extend({},t.totalPannedPoint,{},!0),this.totalPannedClientPoint=sf.base.extend({},t.totalPannedClientPoint,{},!0),this.totalPannedInternalPoint=sf.base.extend({},t.totalPannedInternalPoint,{},!0),this.tempFlipPanPoint=sf.base.extend({},t.tempFlipPanPoint,{},!0),this.rotateFlipColl=sf.base.extend([],t.rotateFlipColl,[],!0),this.degree=t.degree,this.currFlipState=t.currFlipState,this.destLeft=t.destPoints.startX,this.destTop=t.destPoints.startY,this.destWidth=t.destPoints.width,this.destHeight=t.destPoints.height,this.srcLeft=t.srcPoints.startX,this.srcTop=t.srcPoints.startY,this.srcWidth=t.srcPoints.width,this.srcHeight=t.srcPoints.height,this.lowerContext.filter=t.filter,this.lowerContext.filter.split(" ").length>1&&("1"===this.lowerContext.filter.split(" ")[0].split("(")[1].split(")")[0]?this.isBrightnessAdjusted=!1:this.isBrightnessAdjusted=!0);var i=this.isCircleCrop,s=sf.base.extend({},this.currSelectionPoint,{},!0);this.currSelectionPoint=null,this.isCircleCrop=!1,this.drawCropSelectionImage(t,!1),0!==this.degree&&(this.currentPannedPoint={x:this.totalPannedClientPoint.x,y:this.totalPannedClientPoint.y},this.rotatePan()),this.activeObj=sf.base.extend({},t.activeObj,{},!0),this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),0!==this.activeObj.activePoint.width&&0!==this.activeObj.activePoint.height&&this.drawObject("duplicate");var a=sf.base.extend({},t.activeObj,{},!0),o=!1;this.afterCropActions=this.alignRotateFlipColl(this.afterCropActions);var r=sf.base.extend([],this.afterCropActions,[],!0);if(!e&&r.length>0){o=!0;for(var n=0;n<r.length;n++)this.degree%90!=0||this.degree%180==0||"horizontalflip"!==r[n]&&"verticalflip"!==r[n]||(this.rotatedFlipCropSelection=!0),this.updateTransform(r[n]),"horizontalflip"!==r[n]&&"verticalflip"!==r[n]||1===r.length&&(this.activeObj=sf.base.extend({},this.cropObj.activeObj,{},!0),this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),this.drawObject("duplicate"));a=sf.base.extend({},this.activeObj,{},!0),this.totalPannedPoint={x:0,y:0},this.totalPannedClientPoint={x:0,y:0},this.totalPannedInternalPoint={x:0,y:0},this.activeObj=a,this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),0!==this.activeObj.activePoint.width&&0!==this.activeObj.activePoint.height&&this.drawObject("duplicate"),t.degree!==this.degree&&(this.cropZoomFactor=this.zoomFactor=0),this.updateObjAndFreeHandDrawColl(),this.rotatedFlipCropSelection&&(this.rotatedFlipCropSelection=!1)}this.afterCropActions=r,this.isCancelAction||o||(this.updateObjAndFreeHandDrawColl(),this.zoomFreehandDrawColl(),this.destLeft=t.destPoints.startX,this.destTop=t.destPoints.startY),this.activeObj=a,this.isCircleCrop=i,this.currSelectionPoint=s},e.prototype.drawCropSelectionImage=function(t,e){var i=this.lowerContext.filter;this.upperContext.clearRect(0,0,this.lowerCanvas.width,this.lowerCanvas.height),this.lowerContext.clearRect(0,0,this.lowerCanvas.width,this.lowerCanvas.height),this.reverseTransformedState(),e?this.updateCurrentTransformedState("initial"):this.iterateRotateFlipColl(this.lowerContext,"initial"),this.setDestPointsForFlipState(),this.updateBrightnessFilter(),this.lowerContext.drawImage(this.baseImg,this.srcLeft,this.srcTop,this.srcWidth,this.srcHeight,this.destLeft,this.destTop,this.destWidth,this.destHeight),e?this.updateCurrentTransformedState("reverse"):this.iterateRotateFlipColl(this.lowerContext,"reverse"),this.destLeft=this.cropObj.destPoints.startX,this.destTop=this.cropObj.destPoints.startY;var s=sf.base.extend({},t.activeObj,{},!0);if(this.lowerContext.filter="none",this.isCancelAction)this.zoomObjColl(),this.zoomFreehandDrawColl();else{this.destLeft=t.destPoints.startX,this.destTop=t.destPoints.startY,this.destWidth=t.destPoints.width,this.destHeight=t.destPoints.height,this.srcLeft=t.srcPoints.startX,this.srcTop=t.srcPoints.startY,this.srcWidth=t.srcPoints.width,this.srcHeight=t.srcPoints.height;var a={startX:this.destLeft,startY:this.destTop,width:this.destWidth,height:this.destHeight};this.destLeft=t.activeObj.activePoint.startX,this.destTop=t.activeObj.activePoint.startY,this.destWidth=t.activeObj.activePoint.width,this.destHeight=t.activeObj.activePoint.height,this.zoomObjColl(),this.zoomFreehandDrawColl(),this.destLeft=a.startX,this.destTop=a.startY,this.destWidth=a.width,this.destHeight=a.height}this.activeObj=s,this.lowerContext.filter=i},e.prototype.cropImg=function(t){if(sf.base.isNullOrUndefined(t)&&(this.croppedDegree=this.degree),sf.base.isNullOrUndefined(t)&&0!==this.degree)this.updateCropObj(),this.currDestinationPoint={startX:this.destLeft,startY:this.destTop,width:this.destWidth,height:this.destHeight},this.rotateCrop();else if(sf.base.isNullOrUndefined(t)&&""!==this.currFlipState)this.updateCropObj(),this.currDestinationPoint={startX:this.destLeft,startY:this.destTop,width:this.destWidth,height:this.destHeight},this.flipCrop();else{this.tempZoomFactor=this.zoomFactor;var e=this.calcRatio();!sf.base.isNullOrUndefined(t)&&t||(this.updateCropObj(),this.resetPanPoints(),this.updateImageRatioForActObj(),this.currDestinationPoint={startX:this.destLeft,startY:this.destTop,width:this.destWidth,height:this.destHeight},this.currSelectionPoint=sf.base.extend({},this.activeObj,{},!0),this.cropDestPoints={startX:this.destLeft,startY:this.destTop,width:this.destWidth,height:this.destHeight});var i=this.calcMaxDimension(this.activeObj.activePoint.width*e.width,this.activeObj.activePoint.height*e.height);this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),this.lowerContext.clearRect(0,0,this.lowerCanvas.width,this.lowerCanvas.height),this.srcLeft=this.activeObj.activePoint.startX*e.width-this.destLeft*e.width,this.srcTop=this.activeObj.activePoint.startY*e.height-this.destTop*e.height,this.srcWidth=this.activeObj.activePoint.width*e.width,this.srcHeight=this.activeObj.activePoint.height*e.height,this.destLeft=(this.lowerCanvas.clientWidth-i.width)/2,this.destTop=(this.lowerCanvas.clientHeight-i.height)/2,this.destWidth=i.width,this.destHeight=i.height;var s=this.lowerContext.filter;this.updateBrightnessFilter(),this.lowerContext.drawImage(this.baseImg,this.srcLeft,this.srcTop,this.srcWidth,this.srcHeight,this.destLeft,this.destTop,this.destWidth,this.destHeight),this.lowerContext.filter="none";var a=sf.base.extend({},this.activeObj,{},!0);this.cropObjColl(),this.zoomObjColl();for(var o=0;o<this.objColl.length;o++)this.isObjInsideCropRegion(this.objColl[o])&&(this.apply(this.objColl[o].shape,this.objColl[o]),this.refreshActiveObj());this.activeObj=a,this.cropFreehandDrawColl(),this.zoomFreehandDrawColl(),this.clearOuterCanvas(this.lowerContext),this.clearOuterCanvas(this.upperContext),"crop-circle"===this.currSelectionPoint.shape?this.cropCircle(this.lowerContext):this.isCircleCrop=!1,this.lowerContext.filter=s,this.refreshActiveObj(),this.currObjType.isCustomCrop=!1,this.pan(!1),this.defaultZoomFactor=0}},e.prototype.updateImageRatioForActObj=function(){this.activeObj.imageRatio={startX:(this.activeObj.activePoint.startX-this.destLeft)/this.destWidth,startY:(this.activeObj.activePoint.startY-this.destTop)/this.destHeight,endX:(this.activeObj.activePoint.endX-this.destLeft)/this.destWidth,endY:(this.activeObj.activePoint.endY-this.destTop)/this.destHeight,width:this.destWidth/this.activeObj.activePoint.width,height:this.destHeight/this.activeObj.activePoint.height}},e.prototype.drawImgToCanvas=function(t){this.lowerContext.clearRect(0,0,this.lowerCanvas.width,this.lowerCanvas.height),this.destWidth=t.width,this.destHeight=t.height,this.isInitialLoading&&(this.initializeFilter(),this.isInitialLoading=!1);var e=this.lowerContext.filter;this.updateBrightnessFilter(),this.lowerContext.drawImage(this.baseImg,this.srcLeft,this.srcTop,this.srcWidth,this.srcHeight,this.destLeft,this.destTop,this.destWidth,this.destHeight),(!sf.base.isNullOrUndefined(this.currSelectionPoint)&&"crop-circle"===this.currSelectionPoint.shape||this.isCircleCrop)&&this.cropCircle(this.lowerContext),this.lowerContext.filter=e},e.prototype.limitPan=function(){this.activeObj.activePoint&&(this.destLeft>this.activeObj.activePoint.startX&&(this.destLeft=this.activeObj.activePoint.startX),this.destTop>this.activeObj.activePoint.startY&&(this.destTop=this.activeObj.activePoint.startY),this.destLeft+this.destWidth<this.activeObj.activePoint.endX&&(this.destLeft=this.activeObj.activePoint.endX-this.destWidth),this.destTop+this.destHeight<this.activeObj.activePoint.endY&&(this.destTop=this.activeObj.activePoint.endY-this.destHeight))},e.prototype.updatePanPoints=function(t){var e=this.destLeft,i=this.destTop,s=this.panMove.x-this.tempPanMove.x,a=this.panMove.y-this.tempPanMove.y;if(""===t)this.destLeft+=s,this.destTop+=a,this.limitPan();else if("horizontal"===t){var o=sf.base.extend({},this.activeObj,{},!0);this.updateFlipActiveObj(t),s=this.tempPanMove.x-this.panMove.x,this.destLeft+=s,this.destTop+=a,this.limitPan(),this.activeObj=o}else if("vertical"===t){o=sf.base.extend({},this.activeObj,{},!0);this.updateFlipActiveObj(t),a=this.tempPanMove.y-this.panMove.y,this.destLeft+=s,this.destTop+=a,this.limitPan(),this.activeObj=o}else if("horizontalVertical"===t){o=sf.base.extend({},this.activeObj,{},!0);this.updateFlipActiveObj(t),s=this.tempPanMove.x-this.panMove.x,this.destLeft+=s,this.destTop-=a,this.limitPan(),this.activeObj=o}else if("verticalHorizontal"===t){o=sf.base.extend({},this.activeObj,{},!0);this.updateFlipActiveObj(t),a=this.tempPanMove.y-this.panMove.y,this.destLeft-=s,this.destTop+=a,this.limitPan(),this.activeObj=o}return{x:this.destLeft-e,y:this.destTop-i}},e.prototype.setCurrentPanRegion=function(t,e){var i=t;return""===t?"horizontal"===e?i="horizontal":"vertical"===e&&(i="vertical"):"horizontal"===t?"horizontal"===e?i="horizontalVertical":"vertical"===e?i="verticalHorizontal":90===e?i="vertical":-90===e&&(i="horizontal"):"vertical"===t?"horizontal"===e?i="horizontalVertical":"vertical"===e?i="verticalHorizontal":90===e?i="horizontal":-90===e&&(i="vertical"):"horizontal"===e?i="vertical":"vertical"===e&&(i="horizontal"),i},e.prototype.getCurrentPanRegion=function(){var t="";this.rotateFlipColl=this.alignRotateFlipColl(this.rotateFlipColl,!0);for(var e=0;e<this.rotateFlipColl.length;e++)t=this.setCurrentPanRegion(t,this.rotateFlipColl[e]);return t},e.prototype.drawPannImage=function(t){var e={startX:this.destLeft,startY:this.destTop,width:this.destWidth,height:this.destHeight};this.lowerContext.clearRect(0,0,this.lowerCanvas.width,this.lowerCanvas.height),this.updateCurrentTransformedState("initial"),this.destLeft=e.startX,this.destTop=e.startY,this.destWidth=e.width,this.destHeight=e.height,this.setDestPointsForFlipState(),this.updateBrightnessFilter(),this.lowerContext.drawImage(this.baseImg,this.srcLeft,this.srcTop,this.srcWidth,this.srcHeight,this.destLeft,this.destTop,this.destWidth,this.destHeight),(!sf.base.isNullOrUndefined(this.currSelectionPoint)&&"crop-circle"===this.currSelectionPoint.shape||this.isCircleCrop)&&this.cropCircle(this.lowerContext,null,!0),this.updateCurrentTransformedState("reverse"),this.destLeft=e.startX,this.destTop=e.startY,this.destWidth=e.width,this.destHeight=e.height,this.lowerContext.filter="none",this.panObjColl(t.x,t.y,""),this.panFreehandDrawColl(t.x,t.y,""),this.isCircleCrop&&this.cropCircle(this.lowerContext,null,!0)},e.prototype.drawPannedImage=function(t,e){var i=this,s={startPoint:this.panDown,endPoint:this.panMove,cancel:!1};this.dotnetRef.invokeMethodAsync("PanEventAsync","OnPan",s).then((function(){if(!s.cancel){var a=!1;if(sf.base.isNullOrUndefined(i.activeObj.shape)&&(a=!0,i.activeObj.activePoint={startX:i.destLeft,startY:i.destTop,endX:i.destLeft+i.destWidth,endY:i.destTop+i.destHeight},i.activeObj.activePoint.startX<0&&(i.activeObj.activePoint.startX=0),i.activeObj.activePoint.startY<0&&(i.activeObj.activePoint.startY=0),i.activeObj.activePoint.endX>i.lowerCanvas.width&&(i.activeObj.activePoint.endX=i.lowerCanvas.width),i.activeObj.activePoint.endY>i.lowerCanvas.height&&(i.activeObj.activePoint.endY=i.lowerCanvas.height),i.activeObj.activePoint.width=i.activeObj.activePoint.endX-i.activeObj.activePoint.startX,i.activeObj.activePoint.height=i.activeObj.activePoint.endY-i.activeObj.activePoint.startY,i.activeObj.shape="crop-custom",i.activeObj.strokeSettings=i.strokeSettings,i.updateActiveObject(i.activeObj.activePoint,i.activeObj),i.isCropTab=!0),0===i.degree){var o=void 0;o=sf.base.isNullOrUndefined(t)&&sf.base.isNullOrUndefined(e)?i.updatePanPoints(""):{x:t,y:e},i.totalPannedPoint.x+=o.x,i.totalPannedPoint.y+=o.y;var r=sf.base.extend({},i.activeObj,{},!0),n=i.lowerContext.filter;i.drawPannImage(o),i.lowerContext.filter=n,i.tempPanMove=sf.base.extend({},i.panMove,{},!0),i.activeObj=sf.base.extend({},r,{},!0),i.upperContext.clearRect(0,0,i.upperCanvas.width,i.upperCanvas.height),sf.base.isNullOrUndefined(i.activeObj.shape)||i.drawObject("duplicate",i.activeObj)}else{var h=i.currFlipState;i.isCropTab=!0,sf.base.isNullOrUndefined(t)&&sf.base.isNullOrUndefined(e)?i.currentPannedPoint=i.updatePanPoints(""):i.currentPannedPoint={x:t,y:e},i.currFlipState=h,i.rotatePan(),i.isCropTab=!1,i.tempPanMove=sf.base.extend({},i.panMove,{},!0)}a&&(i.refreshActiveObj(),i.isCropTab=!1,i.upperContext.clearRect(0,0,i.upperCanvas.width,i.upperCanvas.height))}}))},e.prototype.updateFlipPan=function(t){if(""!==this.currFlipState){var e=this.lowerContext.filter;this.refreshActiveObj(),this.rotatedFlip(),this.lowerContext.filter="none",this.freehandRedraw(this.lowerContext),this.lowerContext.filter=e,this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),sf.base.isNullOrUndefined(t)||this.drawObject("duplicate",t)}},e.prototype.updateFlipActiveObj=function(t){"horizontal"===t?(this.activeObj.activePoint.startX>this.lowerCanvas.width/2?this.activeObj.activePoint.endX=this.lowerCanvas.width/2-(this.activeObj.activePoint.startX-this.lowerCanvas.width/2):this.activeObj.activePoint.endX=this.lowerCanvas.width/2+(this.lowerCanvas.width/2-this.activeObj.activePoint.startX),this.activeObj.activePoint.startX=this.activeObj.activePoint.endX-this.activeObj.activePoint.width):"vertical"===t?(this.activeObj.activePoint.startX>this.lowerCanvas.width/2?this.activeObj.activePoint.endY=this.lowerCanvas.height/2-(this.activeObj.activePoint.startY-this.lowerCanvas.height/2):this.activeObj.activePoint.endY=this.lowerCanvas.height/2+(this.lowerCanvas.height/2-this.activeObj.activePoint.startY),this.activeObj.activePoint.startY=this.activeObj.activePoint.endY-this.activeObj.activePoint.height):"verticalHorizontal"!==t&&"horizontalVertical"!==t||(this.activeObj.activePoint.startX>this.lowerCanvas.width/2?(this.activeObj.activePoint.endX=this.lowerCanvas.width/2-(this.activeObj.activePoint.startX-this.lowerCanvas.width/2),this.activeObj.activePoint.endY=this.lowerCanvas.height/2-(this.activeObj.activePoint.startY-this.lowerCanvas.height/2)):(this.activeObj.activePoint.endX=this.lowerCanvas.width/2+(this.lowerCanvas.width/2-this.activeObj.activePoint.startX),this.activeObj.activePoint.endY=this.lowerCanvas.height/2+(this.lowerCanvas.height/2-this.activeObj.activePoint.startY)),this.activeObj.activePoint.startX=this.activeObj.activePoint.endX-this.activeObj.activePoint.width,this.activeObj.activePoint.startY=this.activeObj.activePoint.endY-this.activeObj.activePoint.height),this.updateActiveObject(this.activeObj.activePoint,this.activeObj)},e.prototype.resetPanPoints=function(){this.totalPannedPoint={x:0,y:0},this.totalPannedClientPoint={x:0,y:0},this.totalPannedInternalPoint={x:0,y:0}},e.prototype.flipCrop=function(){this.isReverseFlip=!0,this.totalPannedPoint.x+=this.tempFlipPanPoint.x,this.totalPannedPoint.y+=this.tempFlipPanPoint.y;var t=this.currFlipState,e=this.flipColl;if(this.flipColl=[],this.updateImageRatioForActObj(),this.objColl.push(this.activeObj),this.zoomFactor>0){for(var i=this.zoomFactor,s=this.isUndoRedo,a=0;a<10*i;a++)this.isUndoRedo=!0,this.zoom(-.1);this.isUndoRedo=s,this.resetPanPoints()}this.currSelectionPoint=sf.base.extend({},this.objColl[this.objColl.length-1],{},!0),this.lowerContext.clearRect(0,0,this.lowerCanvas.width,this.lowerCanvas.height),this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height);var o=this.lowerContext.filter;this.updateBrightnessFilter(),this.lowerContext.drawImage(this.baseImg,this.srcLeft,this.srcTop,this.srcWidth,this.srcHeight,this.destLeft,this.destTop,this.destWidth,this.destHeight);for(a=0;a<this.objColl.length;a++)this.objColl[a].shapeFlip="";for(a=0;a<this.freehandCounter;a++)this.pointColl[a].shapeFlip="";this.redrawObj(this.getCurrentPanRegion()),this.flipFreehandrawColl(this.getCurrentPanRegion()),this.activeObj=sf.base.extend({},this.objColl[this.objColl.length-1],{},!0),this.objColl.pop(),this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),this.drawObject("duplicate"),this.cropImg(!0),this.isReverseRotate=!0,this.reverseTransformedState(),this.setDestinationPoints(),this.currentTransformedState("initial"),this.updateBrightnessFilter(),this.lowerContext.drawImage(this.baseImg,this.srcLeft,this.srcTop,this.srcWidth,this.srcHeight,this.destLeft,this.destTop,this.destWidth,this.destHeight),this.lowerContext.filter=o,this.isRotateZoom=!1,this.updateCurrentTransformedState("reverse"),this.currFlipState=t,this.flipColl=e,this.lowerContext.filter="none";for(a=0;a<this.objColl.length;a++)this.objColl[a].shapeFlip="";for(a=0;a<this.freehandCounter;a++)this.pointColl[a].shapeFlip="";this.redrawObj(this.getCurrentPanRegion()),this.flipFreehandrawColl(this.getCurrentPanRegion()),this.zoomObjColl(),this.zoomFreehandDrawColl(),this.lowerContext.filter=o,(!sf.base.isNullOrUndefined(this.currSelectionPoint)&&"crop-circle"===this.currSelectionPoint.shape||this.isCircleCrop)&&this.cropCircle(this.lowerContext),this.refreshActiveObj(),this.clearOuterCanvas(this.lowerContext),this.clearOuterCanvas(this.upperContext),this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),this.isReverseFlip=!1,this.resetPanPoints(),this.tempFlipPanPoint={x:0,y:0}},e.prototype.rotateCrop=function(){var t="";sf.base.isNullOrUndefined(this.activeObj.shape)||(t=this.activeObj.shape);var e=this.degree;this.degree%90==0&&this.degree%180!=0&&(this.rotatedDestPoints.startX=this.destLeft,this.rotatedDestPoints.startY=this.destTop,this.rotatedDestPoints.width=this.destWidth,this.rotatedDestPoints.height=this.destHeight,this.rotatedDestPoints.startX-=this.totalPannedClientPoint.x,this.rotatedDestPoints.startY-=this.totalPannedClientPoint.y),this.updateImageRatioForActObj(),this.currSelectionPoint=sf.base.extend({},this.activeObj,{},!0),this.objColl.push(this.activeObj),this.activeObj=sf.base.extend({},this.objColl[this.objColl.length-1],{},!0),this.reverseTransformedState(),this.setClientTransformedDimension(),this.lowerContext.clearRect(0,0,this.lowerCanvas.width,this.lowerCanvas.height);var i=this.lowerContext.filter;this.updateBrightnessFilter(),this.lowerContext.drawImage(this.baseImg,this.srcLeft,this.srcTop,this.srcWidth,this.srcHeight,this.destLeft,this.destTop,this.destWidth,this.destHeight),this.lowerContext.filter=i;var s=0;90===e||-270===e?s=3:180===e||-180===e?s=2:270!==e&&-90!==e||(s=1);for(var a=0;a<s;a++)this.rotateObjColl(),this.rotateFreehandDrawColl();var o=sf.base.extend({},this.objColl[this.objColl.length-1],{},!0);if(""!==this.currFlipState){for(a=0;a<this.objColl.length;a++)this.objColl[a].shapeFlip="";for(a=0;a<this.freehandCounter;a++)this.pointColl[a].shapeFlip="";var r=this.getCurrentCropState("initial");this.redrawObj(r),this.flipFreehandrawColl(r)}this.zoomObjColl(),this.zoomFreehandDrawColl(),o=sf.base.extend({},this.objColl[this.objColl.length-1],{},!0),this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),this.drawObject("duplicate",o),this.objColl.pop(),this.degree=0,this.cropImg(!0),this.isReverseRotate=!0,this.reverseTransformedState(),this.degree=e,this.setDestinationPoints(),this.currentTransformedState("initial"),this.updateBrightnessFilter(),this.lowerContext.drawImage(this.baseImg,this.srcLeft,this.srcTop,this.srcWidth,this.srcHeight,this.destLeft,this.destTop,this.destWidth,this.destHeight),this.lowerContext.filter=i,this.currentTransformedState("reverse"),s=0,90===e||-270===e?s=1:180===e||-180===e?s=2:270!==e&&-90!==e||(s=3);for(a=0;a<s;a++)this.rotateObjColl(),this.rotateFreehandDrawColl();if(""!==this.getCurrentPanRegion()){for(a=0;a<this.objColl.length;a++)this.objColl[a].shapeFlip="";for(a=0;a<this.freehandCounter;a++)this.pointColl[a].shapeFlip="";r=this.getCurrentCropState("reverse");this.redrawObj(r),this.flipFreehandrawColl(r)}this.isReverseRotate=!1,"crop-circle"===t&&this.cropCircle(this.lowerContext),this.lowerContext.filter="none";for(a=0;a<this.objColl.length;a++)this.isObjInsideCropRegion(this.objColl[a])&&(this.apply(this.objColl[a].shape,this.objColl[a]),this.refreshActiveObj());this.zoomFreehandDrawColl(),this.lowerContext.filter=i,this.clearOuterCanvas(this.lowerContext),this.clearOuterCanvas(this.upperContext),"crop-circle"===t&&this.cropCircle(this.lowerContext),this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),this.resetPanPoints()},e.prototype.getCurrentCropState=function(t,e){var i="",s=[];if("initial"===t)if(180===this.degree||-180===this.degree)i=this.flipColl.length>1?this.getCurrentPanRegion():this.currFlipState;else{for(var a=0;a<this.rotateFlipColl.length;a++)"number"==typeof this.rotateFlipColl[a]?s.push("number"):"string"==typeof this.rotateFlipColl[a]&&s.push("string");s.length>1&&"string"===s[s.length-1]&&"number"===s[s.length-2]?"horizontal"===this.currFlipState?i="vertical":"vertical"===this.currFlipState&&(i="horizontal"):s.length>1&&"number"===s[s.length-1]&&"string"===s[s.length-2]&&(i=this.flipColl.length>1?this.getCurrentPanRegion():this.currFlipState)}else i=this.getCurrentPanRegion(),!e&&this.isInitialRotate()||-90!==this.degree&&-270!==this.degree||("horizontal"===i?i="vertical":"vertical"===i&&(i="horizontal"));return""===i&&(i=this.flipColl.length>1?this.getCurrentPanRegion():this.currFlipState),i},e.prototype.isInitialRotate=function(){var t=!1;return this.rotateFlipColl.length>0&&"number"==typeof this.rotateFlipColl[0]&&(t=!0),t},e.prototype.updateRotatePanPoints=function(){var t="";t=this.isInitialRotate()&&this.degree<0?this.getCurrentCropState("reverse",!0):this.getCurrentPanRegion(),this.degree%90==0&&this.degree%180!=0?90===this.degree||-90===this.degree&&("horizontal"===t||"vertical"===t)||-270===this.degree&&(""===t||"verticalHorizontal"===t||"horizontalVertical"===t)?""===t?(this.destLeft+=this.currentPannedPoint.y,this.destTop-=this.currentPannedPoint.x):"horizontal"===t?(this.destLeft+=this.currentPannedPoint.y,this.destTop+=this.currentPannedPoint.x):"vertical"===t?(this.destLeft-=this.currentPannedPoint.y,this.destTop-=this.currentPannedPoint.x):(this.destLeft-=this.currentPannedPoint.y,this.destTop+=this.currentPannedPoint.x):270!==this.degree&&(-270!==this.degree||"horizontal"!==t&&"vertical"!==t)&&(-90!==this.degree||""!==t&&"verticalHorizontal"!==t&&"horizontalVertical"!==t)||(""===t?(this.destLeft-=this.currentPannedPoint.y,this.destTop+=this.currentPannedPoint.x):"horizontal"===t?(this.destLeft-=this.currentPannedPoint.y,this.destTop-=this.currentPannedPoint.x):"vertical"===t?(this.destLeft+=this.currentPannedPoint.y,this.destTop+=this.currentPannedPoint.x):(this.destLeft+=this.currentPannedPoint.y,this.destTop-=this.currentPannedPoint.x)):180!==this.degree&&-180!==this.degree||(""===t?(this.destLeft-=this.currentPannedPoint.x,this.destTop-=this.currentPannedPoint.y):"horizontal"===t?(this.destLeft+=this.currentPannedPoint.x,this.destTop-=this.currentPannedPoint.y):"vertical"===t?(this.destLeft-=this.currentPannedPoint.x,this.destTop+=this.currentPannedPoint.y):(this.destLeft+=this.currentPannedPoint.x,this.destTop+=this.currentPannedPoint.y))},e.prototype.rotatePan=function(t,e){this.isReverseRotate=!0;var i,s=this.degree;sf.base.isNullOrUndefined(this.activeObj.activePoint)||sf.base.isNullOrUndefined(this.activeObj.shape)||(i=sf.base.extend({},this.activeObj,{},!0));var a=sf.base.extend([],this.objColl,[],!0),o=sf.base.extend([],this.pointColl,[],!0);this.objColl=[],this.pointColl=[],this.freehandCounter=0,this.refreshActiveObj(),this.isRotateZoom=!0,this.updateCurrentTransformedState("initial");var r=this.destLeft,n=this.destTop;this.isCropTab&&(this.destLeft+=this.totalPannedInternalPoint.x,this.destTop+=this.totalPannedInternalPoint.y),this.updateRotatePanPoints(),this.isCropTab&&(this.totalPannedInternalPoint.x=this.destLeft-r,this.totalPannedInternalPoint.y=this.destTop-n);var h=this.lowerContext.filter;this.updateBrightnessFilter(),this.lowerContext.drawImage(this.baseImg,this.srcLeft,this.srcTop,this.srcWidth,this.srcHeight,this.destLeft,this.destTop,this.destWidth,this.destHeight),this.isRotateZoom=!1,this.updateCurrentTransformedState("reverse",!0,!0);var l=this.destLeft,c=this.destTop;this.destLeft+=this.totalPannedClientPoint.x,this.destTop+=this.totalPannedClientPoint.y,this.destLeft+=this.currentPannedPoint.x,this.destTop+=this.currentPannedPoint.y,this.totalPannedClientPoint.x=this.destLeft-l,this.totalPannedClientPoint.y=this.destTop-c,this.objColl=a,this.pointColl=o,this.freehandCounter=this.pointColl.length,this.degree=s,this.lowerContext.filter="none",t&&(e?(this.totalPannedClientPoint.x=-this.totalPannedClientPoint.x,this.totalPannedClientPoint.y=-this.totalPannedClientPoint.y,this.currentPannedPoint=sf.base.extend({},this.totalPannedClientPoint,{},!0),this.totalPannedClientPoint={x:0,y:0},this.destLeft+=this.currentPannedPoint.x,this.destTop+=this.currentPannedPoint.y):this.currentPannedPoint=sf.base.extend({},this.totalPannedClientPoint,{},!0)),this.panObjColl(this.currentPannedPoint.x,this.currentPannedPoint.y,""),this.panFreehandDrawColl(this.currentPannedPoint.x,this.currentPannedPoint.y,""),this.lowerContext.filter=h,this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),this.activeObj=sf.base.extend({},i,{},!0),sf.base.isNullOrUndefined(this.activeObj.activePoint)||this.drawObject("duplicate",this.activeObj,null,null,!0),this.isReverseRotate=!1},e.prototype.rotateZoom=function(t){var e=Math.pow(10,1);Math.round(this.zoomFactor*e)/e==.1&&-.1===t?this.zoomFactor=0:this.zoomFactor+=t,this.isCropTab?this.cropZoomFactor=this.zoomFactor:this.defaultZoomFactor=this.zoomFactor;var i=sf.base.extend([],this.objColl,[],!0),s=sf.base.extend({},this.activeObj,{},!0);this.objColl=[],this.refreshActiveObj(),this.updateCurrentTransformedState("initial"),this.isRotateZoom=!0,this.setDestinationPoints();var a=this.lowerContext.filter;this.updateBrightnessFilter(),this.lowerContext.drawImage(this.baseImg,this.srcLeft,this.srcTop,this.srcWidth,this.srcHeight,this.destLeft,this.destTop,this.destWidth,this.destHeight),this.lowerContext.filter=a,this.isRotateZoom=!1,this.updateCurrentTransformedState("reverse"),this.objColl=i,this.activeObj=s},e.prototype.drawZoomImgToCanvas=function(t,e){var i=Math.pow(10,1);Math.round(this.zoomFactor*i)/i==.1&&-.1===t?this.zoomFactor=0:this.zoomFactor+=t,this.isCropTab?this.cropZoomFactor=this.zoomFactor:this.defaultZoomFactor=this.zoomFactor;var s={width:0,height:0};this.isCropTab?s=this.cropZoom(t,e):((s=this.calcMaxDimension(this.srcWidth,this.srcHeight)).width+=s.width*this.zoomFactor,s.height+=s.height*this.zoomFactor,this.destLeft=(this.lowerCanvas.clientWidth-s.width)/2,this.destTop=(this.lowerCanvas.clientHeight-s.height)/2),this.drawImgToCanvas(s)},e.prototype.cropZoom=function(t,e){var i=this.destLeft,s=this.destTop,a={width:0,height:0};return 0===this.srcLeft||0===this.srcTop?a=sf.base.isNullOrUndefined(e)?this.setZoomDimension(t,null):this.setZoomDimension(t,e):((a=this.degree%90==0&&this.degree%180!=0?this.calcMaxDimension(this.srcHeight,this.srcWidth):this.calcMaxDimension(this.srcWidth,this.srcHeight)).width+=a.width*this.zoomFactor,a.height+=a.height*this.zoomFactor),this.destLeft=i-(a.width-this.destWidth)/2,this.destTop=s-(a.height-this.destHeight)/2,i=this.destLeft,s=this.destTop,sf.base.isNullOrUndefined(e)||(this.destLeft>e.activePoint.startX&&(this.destLeft=e.activePoint.startX,0===this.degree&&(this.totalPannedPoint.x-=i-this.destLeft)),this.destTop>e.activePoint.startY&&(this.destTop=e.activePoint.startY,0===this.degree&&(this.totalPannedPoint.y-=s-this.destTop)),this.destLeft+a.width<e.activePoint.endX&&(this.destLeft=e.activePoint.endX-a.width,0===this.degree&&(this.totalPannedPoint.x-=i-this.destLeft)),this.destTop+a.height<e.activePoint.endY&&(this.destTop=e.activePoint.endY-a.height,0===this.degree&&(this.totalPannedPoint.y-=s-this.destTop))),a},e.prototype.updateCanvas=function(){var t={fileName:this.fileName,fileType:this.fileType};this.srcWidth=this.baseImg.width,this.srcHeight=this.baseImg.height;var e=this.calcMaxDimension(this.srcWidth,this.srcHeight);this.destLeft=(this.lowerCanvas.clientWidth-e.width)/2,this.destTop=(this.lowerCanvas.clientHeight-e.height)/2,this.drawImgToCanvas(e),this.cropDestPoints={startX:this.destLeft,startY:this.destTop,width:this.destWidth,height:this.destHeight};var i=this.lowerContext.filter;this.lowerContext.filter="none",this.iterateObjColl(),this.zoomFreehandDrawColl(),this.lowerContext.filter=i,this.destWidth>0&&this.destHeight>0&&(this.isImageLoaded=!0),this.isUndoRedo&&""!==this.currFlipState&&this.flip(this.toPascalCase(this.currFlipState)),this.disabled&&this.element.setAttribute("class","e-disabled"),this.dotnetRef.invokeMethodAsync("FileOpenEventAsync","FileOpened",t)},e.prototype.imageOnLoad=function(t){var e=this;this.baseImg.src=t,this.baseImg.onload=function(){e.lowerContext.drawImage(e.baseImg,0,0,e.lowerCanvas.width,e.lowerCanvas.height),sf.popups.hideSpinner(e.element),e.element.style.opacity="1",e.updateCanvas(),e.currObjType.isUndoZoom&&(e.currObjType.isUndoZoom=!1,e.lowerCanvas.style.display="block"),e.updateToolbar(e.element.id,e.element,"imageLoaded"),e.isUndoRedo=!1}},e.prototype.refreshActiveObj=function(){this.activeObj={},this.activeObj.activePoint={startX:0,startY:0,endX:0,endY:0,width:0,height:0},this.activeObj.triangle=[],this.activeObj.triangleRatio=[],this.activeObj.flipObjColl=[],this.activeObj.strokeSettings=this.strokeSettings,this.activeObj.textSettings=this.textSettings},e.prototype.redrawText=function(){this.activeObj.textSettings.bold&&(this.upperContext.font="bold "+this.activeObj.textSettings.fontSize+"px "+this.activeObj.textSettings.fontFamily),this.activeObj.textSettings.italic&&(this.upperContext.font="bold "+this.activeObj.textSettings.fontSize+"px "+this.activeObj.textSettings.fontFamily),this.activeObj.textSettings.bold&&this.activeObj.textSettings.italic&&(this.upperContext.font="italic bold "+this.activeObj.textSettings.fontSize+"px "+this.activeObj.textSettings.fontFamily),this.activeObj.textSettings.bold||this.activeObj.textSettings.italic||(this.upperContext.font=this.activeObj.textSettings.fontSize+"px "+this.activeObj.textSettings.fontFamily);var t=this.activeObj.keyHistory.split("\n"),e="block"===this.textArea.style.display?this.getMaxText(!0):this.getMaxText(),i=this.upperContext.measureText(e).width+.5*this.activeObj.textSettings.fontSize,s=t.length*(this.activeObj.textSettings.fontSize+.25*this.activeObj.textSettings.fontSize);this.setTextSelection(i,s),this.updateActiveObject(this.activeObj.activePoint,this.activeObj),this.redrawShape(this.activeObj)},e.prototype.setTextSelection=function(t,e){var i=this.degree;(i=0===this.activeObj.shapeDegree?this.degree:this.degree-this.activeObj.shapeDegree)<0&&(i=360+i);for(var s=0;s<this.activeObj.flipObjColl.length;s++)0===i?"horizontal"===this.activeObj.flipObjColl[s].toLowerCase()?this.activeObj.activePoint={startX:this.activeObj.activePoint.endX-t,startY:this.activeObj.activePoint.startY,endX:this.activeObj.activePoint.endX,endY:this.activeObj.activePoint.startY+(e||0)}:"vertical"===this.activeObj.flipObjColl[s].toLowerCase()?(this.activeObj.activePoint.startY=this.activeObj.activePoint.endY-e,this.activeObj.activePoint={startX:this.activeObj.activePoint.startX,startY:this.activeObj.activePoint.startY,endX:this.activeObj.activePoint.startX+(t||0),endY:this.activeObj.activePoint.endY}):this.activeObj.activePoint={startX:this.activeObj.activePoint.startX,startY:this.activeObj.activePoint.startY,endX:this.activeObj.activePoint.startX+(t||0),endY:this.activeObj.activePoint.startY+(e||0)}:90===i?"vertical"===this.activeObj.flipObjColl[s].toLowerCase()?(this.activeObj.activePoint.startX=this.activeObj.activePoint.endX-e,this.activeObj.activePoint={startX:this.activeObj.activePoint.startX,startY:this.activeObj.activePoint.endY-t,endX:this.activeObj.activePoint.endX,endY:this.activeObj.activePoint.endY}):"horizontal"===this.activeObj.flipObjColl[s].toLowerCase()?(this.activeObj.activePoint.endX=this.activeObj.activePoint.startX+e,this.activeObj.activePoint={startX:this.activeObj.activePoint.startX,startY:this.activeObj.activePoint.startY,endX:this.activeObj.activePoint.endX,endY:this.activeObj.activePoint.startY+(t||0)}):(this.activeObj.activePoint.startX=this.activeObj.activePoint.endX-e,this.activeObj.activePoint={startX:this.activeObj.activePoint.startX,startY:this.activeObj.activePoint.startY,endX:this.activeObj.activePoint.endX,endY:this.activeObj.activePoint.startY+(t||0)}):180===i?"horizontal"===this.activeObj.flipObjColl[s].toLowerCase()?(this.activeObj.activePoint.startY=this.activeObj.activePoint.endY-e,this.activeObj.activePoint={startX:this.activeObj.activePoint.startX,startY:this.activeObj.activePoint.startY,endX:this.activeObj.activePoint.startX+t,endY:this.activeObj.activePoint.endY}):"vertical"===this.activeObj.flipObjColl[s].toLowerCase()?(this.activeObj.activePoint.endY=this.activeObj.activePoint.startY+e,this.activeObj.activePoint={endX:this.activeObj.activePoint.endX,endY:this.activeObj.activePoint.endY,startX:this.activeObj.activePoint.endX-(t||0),startY:this.activeObj.activePoint.startY}):this.activeObj.activePoint={endX:this.activeObj.activePoint.endX,endY:this.activeObj.activePoint.endY,startX:this.activeObj.activePoint.endX-(t||0),startY:this.activeObj.activePoint.endY-(e||0)}:270===i&&("vertical"===this.activeObj.flipObjColl[s].toLowerCase()?this.activeObj.activePoint={startX:this.activeObj.activePoint.startX,startY:this.activeObj.activePoint.startY,endX:this.activeObj.activePoint.startX+e,endY:this.activeObj.activePoint.startY+(t||0)}:"horizontal"===this.activeObj.flipObjColl[s].toLowerCase()?(this.activeObj.activePoint.startX=this.activeObj.activePoint.endX-e,this.activeObj.activePoint={startX:this.activeObj.activePoint.startX,startY:this.activeObj.activePoint.endY-(t||0),endX:this.activeObj.activePoint.endX,endY:this.activeObj.activePoint.endY}):(this.activeObj.activePoint.endX=this.activeObj.activePoint.startX+e,this.activeObj.activePoint={startX:this.activeObj.activePoint.startX,startY:this.activeObj.activePoint.endY-(t||0),endX:this.activeObj.activePoint.endX,endY:this.activeObj.activePoint.endY}));0===this.activeObj.flipObjColl.length&&(0===i?this.activeObj.activePoint={startX:this.activeObj.activePoint.startX,startY:this.activeObj.activePoint.startY,endX:this.activeObj.activePoint.startX+(t||0),endY:this.activeObj.activePoint.startY+(e||0)}:90===i?(this.activeObj.activePoint.startX=this.activeObj.activePoint.endX-e,this.activeObj.activePoint={startX:this.activeObj.activePoint.startX,startY:this.activeObj.activePoint.startY,endX:this.activeObj.activePoint.endX,endY:this.activeObj.activePoint.startY+(t||0)}):180===i?this.activeObj.activePoint={endX:this.activeObj.activePoint.endX,endY:this.activeObj.activePoint.endY,startX:this.activeObj.activePoint.endX-(t||0),startY:this.activeObj.activePoint.endY-(e||0)}:270===i&&(this.activeObj.activePoint.endX=this.activeObj.activePoint.startX+e,this.activeObj.activePoint={startX:this.activeObj.activePoint.startX,startY:this.activeObj.activePoint.endY-(t||0),endX:this.activeObj.activePoint.endX,endY:this.activeObj.activePoint.endY})),this.activeObj.activePoint.width=this.activeObj.activePoint.endX-this.activeObj.activePoint.startX,this.activeObj.activePoint.height=this.activeObj.activePoint.endY-this.activeObj.activePoint.startY,360!==this.degree&&-360!==this.degree||(this.degree=0)},e.prototype.getCurrentObj=function(){var t={cropZoom:0,defaultZoom:0,totalPannedPoint:{x:0,y:0},totalPannedClientPoint:{x:0,y:0},totalPannedInternalPoint:{x:0,y:0},tempFlipPanPoint:{x:0,y:0},activeObj:{},rotateFlipColl:[],degree:0,currFlipState:"",destPoints:{startX:0,startY:0,width:0,height:0},srcPoints:{startX:0,startY:0,width:0,height:0},filter:""};return t.cropZoom=this.cropZoomFactor,t.defaultZoom=this.defaultZoomFactor,t.totalPannedPoint=sf.base.extend({},this.totalPannedPoint,{},!0),t.totalPannedClientPoint=sf.base.extend({},this.totalPannedClientPoint,{},!0),t.totalPannedInternalPoint=sf.base.extend({},this.totalPannedInternalPoint,{},!0),t.tempFlipPanPoint=sf.base.extend({},this.tempFlipPanPoint,{},!0),t.activeObj=sf.base.extend({},this.activeObj,{},!0),t.rotateFlipColl=sf.base.extend([],this.rotateFlipColl,[],!0),t.degree=this.degree,t.currFlipState=this.currFlipState,t.destPoints={startX:this.destLeft,startY:this.destTop,endX:0,endY:0,width:this.destWidth,height:this.destHeight},t.srcPoints={startX:this.srcLeft,startY:this.srcTop,endX:0,endY:0,width:this.srcWidth,height:this.srcHeight},t.filter=this.lowerContext.filter,t},e.prototype.updateUndoRedoColl=function(t,e,i,s,a,o,r,n){if(!this.isInitialLoading&&this.allowUndoRedo){this.currObjType.isUndoAction&&this.refreshUndoRedoColl(),this.undoRedoStep++;var h=this.getCurrentObj();h.objColl=sf.base.extend([],this.objColl,[],!0),h.pointColl=sf.base.extend([],this.pointColl,[],!0),h.afterCropActions=sf.base.extend([],this.afterCropActions,[],!0),this.undoRedoColl.push({operation:t,previousObj:e,currentObj:h,previousObjColl:i,currentObjColl:h.objColl,previousPointColl:s,currentPointColl:h.pointColl,previousCropObj:a,currentCropObj:sf.base.extend({},this.cropObj,{},!0),previousText:o,currentText:r,filter:n}),this.undoRedoColl.length>16&&(this.undoRedoColl.splice(0,1),this.undoRedoStep--),this.enableDisableToolbarBtn()}},e.prototype.fileSelect=function(t,e){sf.popups.showSpinner(this.element),this.element.style.opacity="0.5";var i=e.target.files[0];this.isImageLoaded&&(this.isImageLoaded=!1,this.reset()),sf.base.isNullOrUndefined(this.toolbarTemplate)&&(this.reset(),this.update()),this.fileName=t.value.split("\\")[t.value.split("\\").length-1],this.fileName=this.fileName.split(".")[0];var s=window.URL.createObjectURL(i);this.imageOnLoad(s.toString()),t.value=""},e.prototype.findTextPoint=function(t){if("text"===this.activeObj.shape){this.textArea.style.transformOrigin="0 0";var e=void 0,i="";if((e=0===this.activeObj.shapeDegree?this.degree:this.degree-this.activeObj.shapeDegree)<0&&(e=360+e),this.activeObj.flipObjColl.length>0)for(var s=0;s<this.activeObj.flipObjColl.length;s++)i+=0!==e&&e%90==0&&180!==e?"horizontal"===this.activeObj.flipObjColl[s].toLowerCase()?"scale(1, -1)":"scale(-1, 1)":"horizontal"===this.activeObj.flipObjColl[s].toLowerCase()?"scale(-1, 1)":"scale(1, -1)",("horizontal"===this.activeObj.flipObjColl[s].toLowerCase()||"vertical"===this.activeObj.flipObjColl[s].toLowerCase())&&(this.textArea.style.transform="rotate("+e+"deg)"+i);else this.textArea.style.transform="rotate("+e+"deg)";this.findTextTarget(t)}},e.prototype.getStrokeWidth=function(t){var e;switch(parseInt(t,10)/2){case 1:e=this.l10n.getConstant("XSmall");break;case 2:e=this.l10n.getConstant("Small");break;case 3:e=this.l10n.getConstant("Medium");break;case 4:e=this.l10n.getConstant("Large");break;case 5:e=this.l10n.getConstant("XLarge")}return e},e.prototype.setTimer=function(t){!this.isTimer&&this.timer>10&&(this.findTextPoint(t),sf.base.Browser.isDevice&&this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height))},e.prototype.targetTouches=function(t){return[{x:t[0].pageX,y:t[0].pageY},{x:t[1].pageX,y:t[1].pageY}]},e.prototype.calculateScale=function(t,e){var i=this.getDistance(t[0],t[1]);return this.getDistance(e[0],e[1])/i},e.prototype.getDistance=function(t,e){var i=0,s=0;return sf.base.isNullOrUndefined(t)||sf.base.isNullOrUndefined(e)||(i=t.x-e.x,s=t.y-e.y),Math.sqrt(i*i+s*s)},e.prototype.setXYPoints=function(t){var e,i;t.preventDefault(),"mousedown"===t.type?(e=t.clientX,i=t.clientY):(this.touchEndPoint.x=e=t.touches[0].clientX,this.touchEndPoint.y=i=t.touches[0].clientY);var s=this.lowerCanvas.getBoundingClientRect();return{x:e-=s.left,y:i-=s.top}},e.prototype.touchStartHandler=function(t){t.preventDefault(),2===t.touches.length?this.isFirstMove=!0:(this.timer=setTimeout(this.setTimer.bind(this),1e3,t),this.mouseDownEventHandler(t)),sf.base.EventHandler.add(this.lowerCanvas,"touchend",this.mouseUpEventHandler,this),sf.base.EventHandler.add(this.lowerCanvas,"touchmove",this.mouseMoveEventHandler,this),sf.base.EventHandler.add(this.upperCanvas,"touchend",this.mouseUpEventHandler,this),sf.base.EventHandler.add(this.upperCanvas,"touchmove",this.mouseMoveEventHandler,this)},e.prototype.isShapeTouch=function(t,e){var i=!1;if("touchstart"===t.type){this.redrawActObj();var s=this.setXYPoints(t),a=s.x,o=s.y;i=this.findTargetObj(a,o,e)}return i},e.prototype.isFreehandDrawTouch=function(t,e){var i=!1;if("touchstart"===t.type&&!e){this.redrawActObj();var s=this.setXYPoints(t),a=s.x,o=s.y;this.setCursor(a,o),this.isFreehandDrawingPoint&&(i=!0)}return i},e.prototype.selectFreehandDraw=function(t){if(this.isFreehandDrawEditing=!0,!sf.base.isNullOrUndefined(t)||0===t){if(!this.isFreehandDrawIndex(t))return;this.freehandDrawSelectedIndex=this.freehandDrawHoveredIndex=t,this.hoverFreehandraw(),this.upperCanvas.style.cursor="pointer"}this.freehandDrawSelectedIndex=this.freehandDrawHoveredIndex,this.pointColl[this.freehandDrawSelectedIndex].isSelected=!0,this.freehandDrawSelectedId=this.pointColl[this.freehandDrawSelectedIndex].id,"#42a5f5"!==this.pointColl[this.freehandDrawHoveredIndex].strokeColor&&(this.tempFreeHandDrawEditingStyles.strokeColor=this.pointColl[this.freehandDrawHoveredIndex].strokeColor),this.tempFreeHandDrawEditingStyles.strokeWidth=this.pointColl[this.freehandDrawHoveredIndex].strokeWidth,this.isFreehandDrawEditing||this.okBtn()},e.prototype.mouseDownEventHandler=function(t){if("touchstart"===t.type&&(this.isTouch=!0),"touchstart"!==t.type||t.currentTarget!==this.lowerCanvas||this.isImageLoaded){var e,i=!1,s=!0;if(void 0!==this.activeObj.shape&&(e=this.activeObj.shape.split("-")),void 0!==e&&"crop"===e[0]&&(i=!0),i&&(this.dragCanvas=this.togglePan=!0),i&&this.dragCanvas){var a=(h=this.setXYPoints(t)).x,o=h.y;this.setCursor(a,o),"move"!==this.upperCanvas.style.cursor&&"crosshair"!==this.upperCanvas.style.cursor&&"default"!==this.upperCanvas.style.cursor&&"grab"!==this.upperCanvas.style.cursor&&(s=!1)}var r=this.isShapeTouch(t,i),n=this.isFreehandDrawTouch(t,i);if(!this.isImageLoaded||r||this.togglePen||i||this.updateToolbar(this.element.id,this.element,"imageLoaded"),!this.dragCanvas||!s||"grab"!==this.upperCanvas.style.cursor&&!this.isTouch||r||n||this.togglePen){var h;a=(h=this.setXYPoints(t)).x,o=h.y;if(this.redrawActObj(a,o),this.isFreehandDrawingPoint||this.isFreehandDrawCustomized&&!this.togglePen){if(!sf.base.isNullOrUndefined(this.freehandDrawSelectedIndex)&&this.freehandDrawSelectedIndex!==this.freehandDrawHoveredIndex){var l=this.freehandDrawHoveredIndex;if(this.okBtn(),this.isFreehandDrawCustomized=!1,this.freehandDrawHoveredIndex=l,this.freehandDrawHoveredIndex>-1){var c="#fff"===this.pointColl[this.freehandDrawHoveredIndex].strokeColor?"#42a5f5":this.pointColl[this.freehandDrawHoveredIndex].strokeColor;this.hoverFreehandraw(c,this.pointColl[this.freehandDrawHoveredIndex].strokeWidth)}}if(!sf.base.isNullOrUndefined(this.freehandDrawHoveredIndex)&&this.freehandDrawHoveredIndex>-1)this.selectFreehandDraw();else if(this.freehandDrawSelectedIndex){this.okBtn();c=this.pointColl[this.freehandDrawSelectedIndex].strokeColor;this.hoverFreehandraw(c,this.pointColl[this.freehandDrawSelectedIndex].strokeWidth)}}else this.isFreehandDrawEditing&&this.cancelFreehandDraw(),this.isFreehandDrawEditing=!1,("crosshair"===this.upperCanvas.style.cursor||sf.base.Browser.isDevice&&this.togglePen)&&(this.togglePen?(sf.base.isNullOrUndefined(this.activeObj.strokeSettings)&&(this.activeObj.strokeSettings=this.strokeSettings),sf.base.isNullOrUndefined(this.penStrokeWidth)&&(this.penStrokeWidth=2),this.upperContext.strokeStyle=this.activeObj.strokeSettings.strokeColor,this.upperContext.fillStyle=this.activeObj.strokeSettings.strokeColor,this.freehandDownHandler(t,this.upperCanvas)):(this.refreshActiveObj(),this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height)),this.currObjType.isActiveObj=!1,this.dragElement="",this.dragPoint.startX=this.dragPoint.startY=this.dragPoint.endX=this.dragPoint.endY=0),"crosshair"!==this.upperCanvas.style.cursor&&"touchstart"===t.type.toLowerCase()||this.currObjType.isActiveObj&&"default"!==this.upperCanvas.style.cursor&&!this.togglePen?(this.currObjType.isUndoAction&&this.refreshUndoRedoColl(),this.findTarget(a,o,t.type)):""!==this.currObjType.shape&&!this.currObjType.isCustomCrop||this.togglePen||"default"===this.upperCanvas.style.cursor||this.setActivePoint(a,o),sf.base.isNullOrUndefined(this.activeObj)||("rectangle"===this.activeObj.shape||"ellipse"===this.activeObj.shape?this.updateToolbar(this.element.id,this.element,"rectangle"):"line"===this.activeObj.shape||"arrow"===this.activeObj.shape?this.updateToolbar(this.element.id,this.element,"line"):"text"===this.activeObj.shape&&this.updateToolbar(this.element.id,this.element,"text"),this.updateColorToolbar(this.element,this.activeObj.strokeSettings))}else this.isFreehandDrawEditing&&this.applyFreehandDraw(),this.applyShape(),this.canvasMouseDownHandler(t);this.isShapeInserted=!1,this.tempActiveObj=sf.base.extend({},this.activeObj,{},!0)}},e.prototype.mouseMoveEventHandler=function(t){if(t.preventDefault(),"touchmove"!==t.type||2!==t.touches.length){var e,i;"none"===this.textArea.style.display&&(this.isTimer=!0),"mousemove"===t.type?(e=t.clientX,i=t.clientY):(this.touchEndPoint.x=e=t.touches[0].clientX,this.touchEndPoint.y=i=t.touches[0].clientY);var s=this.lowerCanvas.getBoundingClientRect();e-=s.left,i-=s.top,this.canvasMouseMoveHandler(t);var a,o=!1;void 0!==this.activeObj.shape&&(a=this.activeObj.shape.split("-")),void 0!==a&&"crop"===a[0]&&(o=!0),o&&this.zoomFactor>0&&this.enableDisableToolbarBtn(),(this.currObjType.isActiveObj&&(void 0!==this.activeObj.activePoint||this.objColl.length>0)&&!this.dragCanvas||void 0!==this.activeObj.activePoint)&&""===this.dragElement&&(this.setCursor(e,i),sf.base.isNullOrUndefined(this.activeObj.activePoint)||0!==this.activeObj.activePoint.width||"default"===this.upperCanvas.style.cursor||"move"===this.upperCanvas.style.cursor||"crosshair"===this.upperCanvas.style.cursor||"grab"===this.upperCanvas.style.cursor||"pointer"===this.upperCanvas.style.cursor||(this.upperCanvas.style.cursor="move"),this.findTarget(e,i,t.type)),this.currObjType.isDragging&&(this.upperContext.clearRect(0,0,this.lowerCanvas.width,this.lowerCanvas.height),this.updateActivePoint(e,i,o),this.updateTrianglePoints(this.activeObj),this.isPreventDragging?(this.activeObj.activePoint.startX>this.destLeft&&this.activeObj.activePoint.endX<this.destLeft+this.destWidth&&this.activeObj.activePoint.startY>this.destTop&&this.activeObj.activePoint.endY<this.destTop+this.destHeight&&(this.isPreventDragging=!1),this.drawObject("duplicate",null,null,null,!0)):this.drawObject("duplicate"),o&&(this.dragCanvas=this.togglePan=!0))}else{if(this.isFirstMove)this.startTouches=this.targetTouches(t.touches),this.tempTouches=[],this.tempTouches.push({x:t.touches[0].clientX||t.touches[0].pageX-this.lowerCanvas.offsetLeft,y:t.touches[0].clientY||t.touches[0].pageY-this.lowerCanvas.offsetTop}),this.tempTouches.push({x:t.touches[1].clientX||t.touches[1].pageX-this.lowerCanvas.offsetLeft,y:t.touches[1].clientY||t.touches[1].pageY-this.lowerCanvas.offsetTop});else{var r=t.touches[0].clientX||t.touches[0].pageX-this.lowerCanvas.offsetLeft,n=t.touches[0].clientY||t.touches[0].pageY-this.lowerCanvas.offsetTop,h=t.touches[1].clientX||t.touches[1].pageX-this.lowerCanvas.offsetLeft,l=t.touches[1].clientY||t.touches[1].pageY-this.lowerCanvas.offsetTop,c={x:r<h?h-(h-r)/2:r-(r-h)/2,y:n<l?l-(l-n)/2:n-(n-l)/2};this.currentMouseMovePoint.x!==c.x&&this.currentMouseMovePoint.y!==c.y&&(this.performPointZoom(c.x,c.y,t),this.tempTouches=[],this.tempTouches.push({x:t.touches[0].clientX||t.touches[0].pageX-this.lowerCanvas.offsetLeft,y:t.touches[0].clientY||t.touches[0].pageY-this.lowerCanvas.offsetTop}),this.tempTouches.push({x:t.touches[1].clientX||t.touches[1].pageX-this.lowerCanvas.offsetLeft,y:t.touches[1].clientY||t.touches[1].pageY-this.lowerCanvas.offsetTop}),this.currentMouseMovePoint.x=c.x,this.currentMouseMovePoint.y=c.y)}this.isFirstMove=!1}},e.prototype.mouseUpEventHandler=function(t){var e,i;"touchstart"===t.type&&(this.isTouch=!1),t.preventDefault(),this.togglePan&&this.canvasMouseUpHandler(t),"mouseup"===t.type?(e=t.clientX,i=t.clientY):(e=this.touchEndPoint.x,i=this.touchEndPoint.y);var s=this.lowerCanvas.getBoundingClientRect();e-=s.left,i-=s.top,"touchend"===t.type&&(this.startTouches=this.tempTouches=[],this.isFirstMove=!1,"none"===this.textArea.style.display&&(this.isTimer=!1,this.timer=0));var a,o=!1;if(void 0!==this.activeObj.shape&&(a=this.activeObj.shape.split("-")),void 0!==a&&"crop"===a[0]&&(o=!0),t.currentTarget===this.upperCanvas){this.currObjType.shape=this.currObjType.shape.toLowerCase();var r=sf.base.extend({},this.cropObj,{},!0),n=this.getCurrentObj();n.objColl=sf.base.extend([],this.objColl,[],!0),n.pointColl=sf.base.extend([],this.pointColl,[],!0),n.afterCropActions=sf.base.extend([],this.afterCropActions,[],!0),this.togglePen||o||(sf.base.isNullOrUndefined(this.tempObjColl)||0===this.activeObj.activePoint.width||(this.objColl.push(this.activeObj),JSON.stringify(this.activeObj.activePoint)!==JSON.stringify(this.tempActiveObj.activePoint)&&this.updateUndoRedoColl("shapeTransform",n,this.tempObjColl,n.pointColl,r),this.redrawShape(this.objColl[this.objColl.length-1]),this.tempObjColl=void 0),this.isFreehandDrawEditing||(this.applyCurrActObj(e,i),sf.base.isNullOrUndefined(this.activeObj.shape)&&this.isImageLoaded&&this.updateToolbar(this.element.id,this.element,"imageLoaded")))}this.togglePen&&t.currentTarget===this.upperCanvas?this.freehandUpHandler(t,this.upperCanvas,this.upperContext):this.currObjType.shape="",this.dragElement="",this.currObjType.isInitialLine=this.currObjType.isDragging=!1,this.oldPoint.x=void 0,this.oldPoint.y=void 0,sf.base.isNullOrUndefined(this.activeObj.shape)||this.updateToolbar(this.element.id,this.element,this.activeObj.shape)},e.prototype.keyDownEventHandler=function(t){var e,i=this,s={},a={fileName:this.fileName,fileType:this.fileType,cancel:!1};switch(t.key){case t.ctrlKey&&"s":this.trigger("beforeSave",a,(function(t){a.cancel||i.export(t.fileType,t.fileName)})),t.preventDefault(),t.stopImmediatePropagation();break;case t.ctrlKey&&"z":this.allowUndoRedo&&this.callUndo();break;case t.ctrlKey&&"y":this.allowUndoRedo&&this.callRedo();break;case"Delete":if(this.isFreehandDrawEditing){this.updateFreehandDrawColorChange();var o=sf.base.extend({},this.cropObj,{},!0),r=this.getCurrentObj();r.objColl=sf.base.extend([],this.objColl,[],!0),r.pointColl=sf.base.extend([],this.pointColl,[],!0),r.afterCropActions=sf.base.extend([],this.afterCropActions,[],!0),this.deleteFreehandDraw(parseInt(this.freehandDrawSelectedId.split("_")[1],10)-1,!0),this.updateUndoRedoColl("deleteFreehandDrawing",r,r.objColl,r.pointColl,o)}else if("none"===this.textArea.style.display){this.objColl.push(this.activeObj);var n=sf.base.extend({},this.cropObj,{},!0),h=this.getCurrentObj();h.objColl=sf.base.extend([],this.objColl,[],!0),h.pointColl=sf.base.extend([],this.pointColl,[],!0),h.afterCropActions=sf.base.extend([],this.afterCropActions,[],!0),this.objColl.pop(),s={action:"delete",previousShapeSettings:this.updatePreviousShapeSettings(),currentShapeSettings:null},this.keyHistory="",this.clearSelection(),this.dotnetRef.invokeMethodAsync("ShapeEventAsync","OnShape",s).then((function(){i.updateUndoRedoColl("deleteObj",h,h.objColl,h.pointColl,n)}))}break;case"Escape":this.togglePan?this.pan(!1):"block"===this.textArea.style.display?this.redrawActObj():this.performCancel();break;case"Enter":void 0!==this.activeObj.shape&&(e=this.activeObj.shape.split("-")),void 0!==this.activeObj.horTopLine&&void 0!==this.activeObj.shape&&"crop"===e[0]&&this.crop();break;default:sf.base.Browser.isDevice&&"block"===this.textArea.style.display&&setTimeout(this.textKeyDown.bind(this),1,t)}},e.prototype.keyUpEventHandler=function(t){"block"===this.textArea.style.display&&t.target.id===this.element.id+"_textArea"&&setTimeout(this.textKeyDown.bind(this),1,t)},e.prototype.canvasMouseDownHandler=function(t){var e,i;t.preventDefault(),"mousedown"===t.type?(e=t.offsetX||t.pageX-this.lowerCanvas.offsetLeft,i=t.offsetY||t.pageY-this.lowerCanvas.offsetTop):(e=t.touches[0].clientX||t.touches[0].pageX-this.lowerCanvas.offsetLeft,i=t.touches[0].clientY||t.touches[0].pageY-this.lowerCanvas.offsetTop);var s=this.lowerCanvas.getBoundingClientRect();e-=s.left,i-=s.top,this.panDown={x:e,y:i},sf.base.isNullOrUndefined(this.tempPanMove)&&(this.tempPanMove={x:e,y:i},this.panStartObj=this.getCurrentObj(),this.panStartObj.objColl=sf.base.extend([],this.objColl,[],!0),this.panStartObj.pointColl=sf.base.extend([],this.pointColl,[],!0),this.panStartObj.afterCropActions=this.afterCropActions)},e.prototype.canvasMouseMoveHandler=function(t){var e,i;this.dragCanvas?this.lowerCanvas.style.cursor="grab":(this.dragCanvas=this.togglePan=!1,this.lowerCanvas.style.cursor=this.upperCanvas.style.cursor="default"),"mousemove"===t.type?(e=t.offsetX||t.pageX-this.lowerCanvas.offsetLeft,i=t.offsetY||t.pageY-this.lowerCanvas.offsetTop):(e=t.touches[0].clientX||t.touches[0].pageX-this.lowerCanvas.offsetLeft,i=t.touches[0].clientY||t.touches[0].pageY-this.lowerCanvas.offsetTop);var s=this.lowerCanvas.getBoundingClientRect();e-=s.left,i-=s.top,this.panMove={x:e,y:i},this.panDown&&this.panMove&&this.togglePan&&this.dragCanvas&&this.drawPannedImage()},e.prototype.canvasMouseUpHandler=function(t){if(t.preventDefault(),this.togglePan){var e=!1,i=void 0;if(void 0!==this.activeObj.shape&&(i=this.activeObj.shape.split("-")),void 0!==i&&"crop"===i[0]&&(e=!0),this.panDown&&this.panMove&&this.togglePan&&this.dragCanvas){var s=sf.base.extend({},this.cropObj,{},!0);e||this.updateUndoRedoColl("pan",this.panStartObj,this.panStartObj.objColl,this.panStartObj.pointColl,s),this.panDown=null,this.panMove=null,this.tempPanMove=null,this.panStartObj=null}}this.currObjType.isDragging=!1},e.prototype.handleScroll=function(t){var e,i,s=!1;"mousewheel"===t.type&&(e=t.clientX,i=t.clientY);var a=this.lowerCanvas.getBoundingClientRect();e-=a.left,i-=a.top,e>this.destLeft&&e<this.destLeft+this.destWidth&&i>this.destTop&&i<this.destTop+this.destHeight&&(s=!0),t.stopPropagation(),!0===t.ctrlKey&&s?t.preventDefault():s&&(this.isCropTab||this.okBtn(),this.performPointZoom(e,i,t))},e.prototype.performPointZoom=function(t,e,i){var s=this.getCurrentObj();if(s.objColl=sf.base.extend([],this.objColl,[],!0),s.pointColl=sf.base.extend([],this.pointColl,[],!0),s.afterCropActions=sf.base.extend([],this.afterCropActions,[],!0),this.pointZoom={x:t,y:e},"mousewheel"===i.type)i.wheelDelta>0?this.zoom(.1):this.zoom(-.1);else{var a=this.calculateScale(this.startTouches,this.targetTouches(i.touches));this.startTouches=this.targetTouches(i.touches),a>1?this.zoom(.1):a<1&&this.zoom(-.1)}},e.prototype.adjustPanning=function(t){if(0!==t.activePoint.width&&0!==t.activePoint.height){var e=this.destLeft,i=this.destTop,s={x:0,y:0};if(this.destLeft>t.activePoint.startX?s.x=this.destLeft-t.activePoint.startX:this.destLeft+this.destWidth<t.activePoint.startX+t.activePoint.width&&(s.x=this.destLeft+this.destWidth-(t.activePoint.startX+t.activePoint.width)),this.destTop>t.activePoint.startY?s.y=this.destTop-t.activePoint.startY:this.destTop+this.destHeight<t.activePoint.startY+t.activePoint.height&&(s.y=this.destTop+this.destHeight-(t.activePoint.startY+t.activePoint.height)),0===this.degree)this.destLeft-=s.x,this.destTop-=s.y,this.drawZoomPanImage(this.destLeft-e,this.destTop-i);else{var a=this.isCropTab;this.isCropTab=!0;var o=sf.base.extend([],this.objColl,[],!0),r=sf.base.extend([],this.pointColl,[],!0);this.objColl=[],this.pointColl=[],this.freehandCounter=0,this.destLeft-=s.x,this.destTop-=s.y,this.currentPannedPoint={x:this.destLeft-e,y:this.destTop-i},this.rotatePan(),this.isCropTab=a,this.objColl=o,this.pointColl=r,this.freehandCounter=this.pointColl.length,this.panObjColl(this.currentPannedPoint.x,this.currentPannedPoint.y,""),this.panFreehandDrawColl(this.currentPannedPoint.x,this.currentPannedPoint.y,"")}}},e.prototype.drawZoomPanImage=function(t,e){this.panObjColl(t,e,""),this.panFreehandDrawColl(t,e,""),this.renderImage(!0);var i=this.calcMaxDimension(this.srcWidth,this.srcHeight);i.width+=i.width*this.zoomFactor,i.height+=i.height*this.zoomFactor,this.totalPannedPoint.x+=t,this.totalPannedPoint.y+=e,this.tempFlipPanPoint={x:0,y:0}},e.prototype.textKeyDown=function(t){"\r"===String.fromCharCode(t.which)&&(this.textRow+=1),this.textArea.setAttribute("rows",this.textRow.toString()),this.textArea.style.height="auto",this.textArea.style.height=this.textArea.scrollHeight+"px",this.setTextBoxWidth(t),sf.base.Browser.isDevice&&(this.textArea.style.width=parseFloat(this.textArea.style.width)+this.textArea.style.fontSize+"px");var e=this.textArea.value.split("\n");this.textRow=e.length,this.textArea.setAttribute("rows",this.textRow.toString())},e.prototype.adjustToScreen=function(){var t;(sf.base.isNullOrUndefined(this.element.querySelector("#"+this.element.id+"_contextualToolbar"))||this.element.querySelector("#"+this.element.id+"_contextualToolbar").parentElement.classList.contains("e-hide"))&&(sf.base.isNullOrUndefined(this.element.querySelector("#"+this.element.id+"_headWrapper"))||this.element.querySelector("#"+this.element.id+"_headWrapper").parentElement.classList.contains("e-hide"))||this.okBtn();var e=!1;void 0!==this.activeObj.shape&&(t=this.activeObj.shape.split("-")),void 0!==t&&"crop"===t[0]&&(e=!0,this.updateImageRatioForActObj(),this.objColl.push(this.activeObj),this.refreshActiveObj()),"block"===this.textArea.style.display&&this.redrawActObj();var i=this.lowerContext.filter;this.update(),this.applyActObj(),this.refreshActiveObj(),this.lowerContext.filter=this.initialAdjustmentValue=i,this.isImageLoaded&&(sf.popups.showSpinner(this.element),this.element.style.opacity="0.5"),this.lowerContext.clearRect(0,0,this.lowerCanvas.width,this.lowerCanvas.height),this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height);var s=document.querySelector("#"+this.element.id+"_canvasWrapper");sf.base.isNullOrUndefined(s)||(s.style.width=this.element.offsetWidth+"px",s.style.height=this.element.offsetHeight+"px",sf.base.Browser.isDevice?s.style.height=parseFloat(s.style.height)-2*this.toolbarHeight-3+"px":s.style.height=parseFloat(s.style.height)-this.toolbarHeight-3+"px");var a=this.calcMaxDimension(this.srcWidth,this.srcHeight);if(this.defaultZoomFactor>0&&(a.width+=a.width*this.defaultZoomFactor,a.height+=a.height*this.defaultZoomFactor),this.destLeft=(this.lowerCanvas.clientWidth-a.width)/2,this.destTop=(this.lowerCanvas.clientHeight-a.height)/2,0===this.degree&&""===this.currFlipState)this.defaultZoomFactor>0&&(this.destLeft+=this.totalPannedPoint.x,this.destTop+=this.totalPannedPoint.y),this.drawImgToCanvas(a);else{this.drawImgToCanvas(a),this.updateCurrentTransformedState("initial");var o=this.lowerContext.filter;this.updateBrightnessFilter(),this.lowerContext.drawImage(this.baseImg,this.srcLeft,this.srcTop,this.srcWidth,this.srcHeight,this.destLeft,this.destTop,this.destWidth,this.destHeight),this.lowerContext.filter=o,this.updateCurrentTransformedState("reverse")}(this.zoomObjColl(),this.zoomFreehandDrawColl(),this.isCircleCrop&&this.cropCircle(this.lowerContext),sf.popups.hideSpinner(this.element),this.element.style.opacity="1",this.defToolbarItems.length>0&&!sf.base.isNullOrUndefined(document.getElementById(this.element.id+"_toolbar")))&&sf.base.getComponent(this.element.id+"_toolbar","toolbar").refreshOverflow();if(this.refreshActiveObj(),this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),e&&(this.activeObj=sf.base.extend({},this.objColl[this.objColl.length-1],null,!0),this.objColl.pop(),this.drawObject("duplicate",this.activeObj)),(0!==this.degree||""!==this.currFlipState)&&this.defaultZoomFactor>0){var r=sf.base.extend({},this.totalPannedPoint,null,!0),n=sf.base.extend({},this.totalPannedInternalPoint,null,!0),h=sf.base.extend({},this.totalPannedClientPoint,null,!0);this.zoom(.1),this.zoom(-.1),0===this.degree?(this.destLeft+=r.x,this.destTop+=r.y,this.totalPannedPoint=r,this.updateFlipPan()):(this.totalPannedInternalPoint=n,this.totalPannedClientPoint=h,this.currentPannedPoint={x:0,y:0},this.isCropTab=!0,this.rotatePan(),this.isCropTab=!1)}else 0!==this.degree&&this.cropZoomFactor>0&&(this.zoomFactor=this.cropZoomFactor=0,this.enableDisableToolbarBtn())},e.prototype.screenOrientation=function(){sf.base.Browser.isDevice&&setTimeout(this.adjustToScreen.bind(this),100)},e.prototype.windowResizeHandler=function(){sf.base.Browser.isDevice||this.adjustToScreen()},e.prototype.updatePreviousShapeSettings=function(){var t=[];return"text"!==this.activeObj.shape||sf.base.isNullOrUndefined(this.activeObj.textSettings)||(this.activeObj.textSettings.bold&&t.push("bold"),this.activeObj.textSettings.italic&&t.push("italic"),this.activeObj.textSettings.underline&&t.push("underline")),{id:sf.base.isNullOrUndefined(this.activeObj.currIndex)?null:this.activeObj.currIndex,type:this.toPascalCase(this.activeObj.shape),startX:this.activeObj.activePoint.startX,startY:this.activeObj.activePoint.startY,width:this.activeObj.activePoint.width,height:this.activeObj.activePoint.height,strokeColor:sf.base.isNullOrUndefined(this.activeObj.strokeSettings)?null:this.activeObj.strokeSettings.strokeColor,strokeWidth:sf.base.isNullOrUndefined(this.activeObj.strokeSettings)?null:this.activeObj.strokeSettings.strokeWidth,fillColor:sf.base.isNullOrUndefined(this.activeObj.strokeSettings)?null:this.activeObj.strokeSettings.fillColor,radius:"ellipse"===this.activeObj.shape?this.activeObj.activePoint.width/2:null,length:"line"===this.activeObj.shape||"arrow"===this.activeObj.shape?this.activeObj.activePoint.width:null,text:"text"===this.activeObj.shape?sf.base.isNullOrUndefined(this.activeObj.keyHistory)?null:this.activeObj.keyHistory:null,fontSize:"text"===this.activeObj.shape?sf.base.isNullOrUndefined(this.activeObj.textSettings)?null:this.activeObj.textSettings.fontSize:null,fontStyle:"text"===this.activeObj.shape?t:null,color:"text"===this.activeObj.shape?sf.base.isNullOrUndefined(this.activeObj.strokeSettings)?null:this.activeObj.strokeSettings.strokeColor:null}},e.prototype.setZoomDimension=function(t,e){var i={width:0,height:0};return(i=this.degree%90==0&&this.degree%180!=0?this.calcMaxDimension(this.srcHeight,this.srcWidth):this.calcMaxDimension(this.srcWidth,this.srcHeight)).width+=i.width*this.zoomFactor,i.height+=i.height*this.zoomFactor,this.destLeft+=(this.destWidth-i.width)/2,this.destTop+=(this.destHeight-i.height)/2,t<0&&!sf.base.isNullOrUndefined(e)?(this.destLeft>e.activePoint.startX&&(this.destLeft=e.activePoint.startX),this.destTop>e.activePoint.startY&&(this.destTop=e.activePoint.startY),this.destLeft+i.width<e.activePoint.startX+e.activePoint.width&&(this.destLeft=this.destLeft+(e.activePoint.startX+e.activePoint.width)-(this.destLeft+i.width)),this.destTop+i.height<e.activePoint.startY+e.activePoint.height&&(this.destTop=this.destTop+(e.activePoint.startY+e.activePoint.height)-(this.destTop+i.height))):t<0&&sf.base.isNullOrUndefined(e)&&(this.destLeft>0&&(this.destLeft=0),this.destTop>0&&(this.destTop=0),this.destLeft+i.width<this.lowerCanvas.width&&(this.destLeft=this.lowerCanvas.width-this.destWidth),this.destTop+i.height<this.lowerCanvas.height&&(this.destTop=this.lowerCanvas.height-this.destHeight)),i},e.prototype.applyCurrActObj=function(t,e){var i=!1,s=sf.base.extend({},this.activeObj,{},!0);if(!sf.base.isNullOrUndefined(s.activePoint)&&(t>=Math.floor(s.activePoint.startX)&&t<=Math.ceil(s.activePoint.endX)&&e>=Math.floor(s.activePoint.startY)&&e<=Math.ceil(s.activePoint.endY)&&(i=!0),!i&&(this.updateImageRatioForActObj(),void 0===this.activeObj.horTopLine||0===this.activeObj.horTopLine.startX||0===this.activeObj.horTopLine.endX||this.currObjType.isCustomCrop||""===this.currObjType.shape||this.objColl.push(sf.base.extend({},this.activeObj,{},!0)),"text"===this.activeObj.shape||"ellipse"===this.currObjType.shape||"rectangle"===this.currObjType.shape||"line"===this.currObjType.shape||"arrow"===this.activeObj.shape))){var a=this.lowerContext.filter;this.lowerContext.filter=this.getDefaultFilter();for(var o=0;o<this.objColl.length;o++)this.isObjInsideCropRegion(this.objColl[o])&&(this.apply(this.objColl[o].shape,this.objColl[o]),this.refreshActiveObj());this.zoomFreehandDrawColl(),this.lowerContext.filter=a,this.apply("shape"),this.clearOuterCanvas(this.lowerContext),this.clearOuterCanvas(this.upperContext),this.isCircleCrop&&this.cropCircle(this.lowerContext)}},e.prototype.updateTextFromTextArea=function(){if(this.activeObj.keyHistory!==this.textArea.value){var t=sf.base.extend({},this.cropObj,{},!0),e=this.getCurrentObj();e.objColl=sf.base.extend([],this.objColl,[],!0),e.pointColl=sf.base.extend([],this.pointColl,[],!0),e.afterCropActions=sf.base.extend([],this.afterCropActions,[],!0),this.updateUndoRedoColl("text",e,e.objColl,e.pointColl,t,this.activeObj.keyHistory,this.textArea.value)}this.activeObj.keyHistory=this.textArea.value,this.textArea.style.display="none",this.textArea.value="",this.updateFontStyles();var i=this.upperContext.measureText(this.activeObj.keyHistory).width+.5*this.activeObj.textSettings.fontSize,s=this.activeObj.textSettings.fontSize+.25*this.activeObj.textSettings.fontSize,a=this.activeObj.keyHistory.split("\n");if(a.length>1){s*=a.length;for(var o=[],r=0;r<a.length;r++)o.push(this.upperContext.measureText(a[r]).width+.5*this.activeObj.textSettings.fontSize);i=Math.max.apply(Math,o)}this.setTextSelection(i,s),this.updateActiveObject(this.activeObj.activePoint,this.activeObj),this.updateImageRatioForActObj()},e.prototype.setTextBoxStylesToActObj=function(){this.activeObj.textSettings.fontFamily=this.textArea.style.fontFamily,this.activeObj.strokeSettings.strokeColor=this.textArea.style.color,"bold"===this.textArea.style.fontWeight?this.activeObj.textSettings.bold=!0:this.activeObj.textSettings.bold=!1,"italic"===this.textArea.style.fontStyle?this.activeObj.textSettings.italic=!0:this.activeObj.textSettings.italic=!1,this.activeObj.textSettings.fontSize=parseFloat(this.textArea.style.fontSize)},e.prototype.redrawActObj=function(t,e){var i;void 0!==this.activeObj.shape&&(i=this.activeObj.shape.split("-")),void 0!==this.activeObj.horTopLine&&void 0!==this.activeObj.shape&&"crop"!==i[0]&&("block"===this.textArea.style.display?(this.setTextBoxStylesToActObj(),this.updateFontRatio(this.activeObj,!0),t&&e?t!==this.activeObj.activePoint.startX&&e!==this.activeObj.activePoint.startY&&(this.updateTextFromTextArea(),this.applyActObj()):(this.updateTextFromTextArea(),this.apply(this.activeObj.shape,this.activeObj),this.objColl.push(this.activeObj),this.refreshActiveObj(),this.textArea.style.transform="")):this.applyActObj())},e.prototype.setTextBoxPos=function(t,e,i,s,a){var o={x:s,y:a};return 0===e?"horizontal"===i.toLowerCase()?(o.x=t.activePoint.endX,o.y=t.activePoint.startY):"vertical"===i.toLowerCase()?(o.x=t.activePoint.startX,o.y=t.activePoint.endY):(o.x=t.activePoint.startX,o.y=t.activePoint.startY):90===e?"horizontal"===i.toLowerCase()?(o.x=t.activePoint.startX,o.y=t.activePoint.startY):"vertical"===i.toLowerCase()?(o.x=t.activePoint.endX,o.y=t.activePoint.endY):(o.x=t.activePoint.endX,o.y=t.activePoint.startY):180===e?"horizontal"===i.toLowerCase()?(o.x=t.activePoint.startX,o.y=t.activePoint.endY):"vertical"===i.toLowerCase()?(o.x=t.activePoint.endX,o.y=t.activePoint.startY):(o.x=t.activePoint.endX,o.y=t.activePoint.endY):270===e&&("horizontal"===i.toLowerCase()?(o.x=t.activePoint.endX,o.y=t.activePoint.endY):"vertical"===i.toLowerCase()?(o.x=t.activePoint.startX,o.y=t.activePoint.startY):(o.x=t.activePoint.startX,o.y=t.activePoint.endY)),o},e.prototype.setTextBoxPoints=function(t,e,i,s,a){var o={x:s,y:a};return 0===e?"horizontal"===t.flipObjColl[0].toLowerCase()?"horizontal"===i.toLowerCase()?(o.x=t.activePoint.startX,o.y=t.activePoint.startY):"vertical"===i.toLowerCase()&&(o.x=t.activePoint.endX,o.y=t.activePoint.endY):"horizontal"===i.toLowerCase()?(o.x=t.activePoint.endX,o.y=t.activePoint.endY):"vertical"===i.toLowerCase()&&(o.x=t.activePoint.endX,o.y=t.activePoint.startY):90===e?"horizontal"===t.flipObjColl[0].toLowerCase()?"horizontal"===i.toLowerCase()?(o.x=t.activePoint.endX,o.y=t.activePoint.endY):"vertical"===i.toLowerCase()&&(o.x=t.activePoint.startX,o.y=t.activePoint.endY):"horizontal"===i.toLowerCase()?(o.x=t.activePoint.startX,o.y=t.activePoint.endY):"vertical"===i.toLowerCase()&&(o.x=t.activePoint.startX,o.y=t.activePoint.startY):180===e?"horizontal"===t.flipObjColl[0].toLowerCase()?("horizontal"===i.toLowerCase()||"vertical"===i.toLowerCase())&&(o.x=t.activePoint.startX,o.y=t.activePoint.startY):"horizontal"===i.toLowerCase()?(o.x=t.activePoint.startX,o.y=t.activePoint.startY):"vertical"===i.toLowerCase()&&(o.x=t.activePoint.startX,o.y=t.activePoint.endY):270===e&&("horizontal"===t.flipObjColl[0].toLowerCase()?"horizontal"===i.toLowerCase()?(o.x=t.activePoint.startX,o.y=t.activePoint.startY):"vertical"===i.toLowerCase()&&(o.x=t.activePoint.endX,o.y=t.activePoint.startY):"horizontal"===i.toLowerCase()?(o.x=t.activePoint.endX,o.y=t.activePoint.startY):"vertical"===i.toLowerCase()&&(o.x=t.activePoint.endX,o.y=t.activePoint.endY)),o},e.prototype.findTextTarget=function(t){var e,i;if("dblclick"===t.type?(e=t.clientX,i=t.clientY):"touchstart"===t.type&&(this.touchEndPoint.x=e=t.touches[0].clientX,this.touchEndPoint.y=i=t.touches[0].clientY),this.preventZoomBtn=!0,this.preventZoomBtn=!1,sf.base.isNullOrUndefined(e)||sf.base.isNullOrUndefined(i)){if("block"===this.textArea.style.display&&""!==this.selectedText()&&"mousedown"===t.type){r=this.textArea.value;this.textArea.value+="a",this.textArea.value=r}}else{var s=this.lowerCanvas.getBoundingClientRect();e-=s.left,i-=s.top;var a=void 0,o="";(a=0===this.activeObj.shapeDegree?this.degree:this.degree-this.activeObj.shapeDegree)<0&&(a=360+a),o=""===this.activeObj.textFlip?this.activeObj.textFlip===this.currFlipState?"":this.currFlipState:this.activeObj.textFlip===this.currFlipState?"":""===this.currFlipState?this.activeObj.textFlip:this.currFlipState;var r=void 0;if("none"===this.textArea.style.display){r=sf.base.extend({},this.activeObj,{},!0);for(var n=0;n<this.objColl.length;n++)JSON.stringify(this.activeObj)===JSON.stringify(this.objColl[n])&&this.objColl.splice(n,1);this.refreshActiveObj(),this.lowerContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),this.redrawImgWithObj(),(!sf.base.isNullOrUndefined(this.currSelectionPoint)&&"crop-circle"===this.currSelectionPoint.shape||this.isCircleCrop)&&this.cropCircle(this.lowerContext),this.activeObj=r,this.updateFontStyles();var h=sf.base.extend({},this.activeObj,{},!0);if(e>=h.activePoint.startX-2*h.topLeftCircle.radius&&e<=h.activePoint.endX+2*h.topLeftCircle.radius&&i>=h.activePoint.startY-2*h.topLeftCircle.radius&&i<=h.activePoint.endY+2*h.topLeftCircle.radius){var l;if(this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),4===h.flipObjColl.length&&(h.flipObjColl=[],o=""),""===o&&h.flipObjColl.length>1&&(o=h.flipObjColl[h.flipObjColl.length-1]),h.flipObjColl.length<=1)e=(l=this.setTextBoxPos(h,a,o,e,i)).x,i=l.y;else e=(l=this.setTextBoxPoints(h,a,o,e,i)).x,i=l.y;this.textArea.style.display="block",this.textArea.style.left=e+"px",this.textArea.style.top=i+"px",this.textArea.style.fontFamily=h.textSettings.fontFamily,this.textArea.style.fontSize=h.textSettings.fontSize+"px",this.textArea.style.color=h.strokeSettings.strokeColor,this.textArea.style.fontWeight=h.textSettings.bold?"bold":"normal",this.textArea.style.fontStyle=h.textSettings.italic?"italic":"normal",this.textArea.style.border="2px solid "+this.themeColl[this.theme].primaryColor,this.textArea.value=h.keyHistory,this.textArea.style.overflow="hidden",this.textArea.style.height="auto",this.textArea.focus(),a%90==0&&a%180!=0&&0!==a?(this.zoomFactor,this.textArea.style.width=h.activePoint.height+"px",this.textArea.style.height=h.activePoint.width+"px"):(this.zoomFactor,this.textArea.style.width=h.activePoint.width+"px",this.textArea.style.height=h.activePoint.height+"px"),this.setTextBoxWidth(),this.flipColl.length<=1&&this.setTextBoxHeight()}else this.applyActObj()}}},e.prototype.selectedText=function(){var t=this.textArea.selectionStart,e=this.textArea.selectionEnd;return this.textArea.value.substring(t,e)},e.prototype.setTextBoxHeight=function(){var t,e,i="",s=sf.base.extend({},this.activeObj,{},!0);(e=0===s.shapeDegree?this.degree:this.degree-s.shapeDegree)<0&&(e=360+e),i=""===s.textFlip?s.textFlip===this.currFlipState?"":this.currFlipState:s.textFlip===this.currFlipState?"":""===this.currFlipState?s.textFlip:this.currFlipState,0===e?"vertical"===i.toLowerCase()?this.textArea.style.maxHeight=this.destHeight-(this.destHeight-parseFloat(this.textArea.style.top))+"px":(t=parseFloat(this.textArea.style.top)-this.destTop,this.textArea.style.maxHeight=this.destHeight-t+"px"):90===e?"horizontal"===i.toLowerCase()?this.textArea.style.maxHeight=this.destWidth-(parseFloat(this.textArea.style.left)-this.destLeft)+"px":this.textArea.style.maxHeight=parseFloat(this.textArea.style.left)-this.destLeft+"px":180===e?"vertical"===i.toLowerCase()?(t=parseFloat(this.textArea.style.top)-this.destTop,this.textArea.style.maxHeight=this.destHeight-t+"px"):this.textArea.style.maxHeight=parseFloat(this.textArea.style.top)-this.destTop+"px":270===e&&("horizontal"===i.toLowerCase()?this.textArea.style.maxHeight=parseFloat(this.textArea.style.left)-this.destLeft+"px":this.textArea.style.maxHeight=this.destWidth-(parseFloat(this.textArea.style.left)-this.destLeft)+"px")},e.prototype.setTextBoxWidth=function(t){var e=this.getMaxText(!0);"block"===this.textArea.style.display?this.updateFontStyles(!0):this.updateFontStyles();var i,s=this.upperContext.measureText(e).width+parseFloat(this.textArea.style.fontSize)/2,a=t?this.upperContext.measureText(String.fromCharCode(t.which)).width:0,o=sf.base.extend({},this.activeObj,{},!0),r="";(i=0===o.shapeDegree?this.degree:this.degree-o.shapeDegree)<0&&(i=360+i),r=o.shapeFlip!==this.currFlipState?"":this.currFlipState,(!sf.base.isNullOrUndefined(t)&&parseFloat(this.textArea.style.width)<s+a||sf.base.isNullOrUndefined(t))&&(0===i?"horizontal"===r.toLowerCase()?parseFloat(this.textArea.style.left)-this.destLeft-s-a>0&&(this.textArea.style.width=s+a+"px"):this.destWidth-(parseFloat(this.textArea.style.left)-this.destLeft)>s+a&&(this.textArea.style.width=s+a+"px"):90===i?"vertical"===r.toLowerCase()?parseFloat(this.textArea.style.top)-this.destTop-s-a>0&&(this.textArea.style.width=s+a+"px"):this.destWidth-(parseFloat(this.textArea.style.top)-this.destTop)>s+a&&(this.textArea.style.width=s+a+"px"):180===i?"horizontal"===r.toLowerCase()?this.destWidth-(parseFloat(this.textArea.style.left)-this.destLeft)>s+a&&(this.textArea.style.width=s+a+"px"):parseFloat(this.textArea.style.left)-this.destLeft-s-a>0&&(this.textArea.style.width=s+a+"px"):270===i&&("vertical"===r.toLowerCase()?this.destHeight-(parseFloat(this.textArea.style.top)-this.destTop)>s+a&&(this.textArea.style.width=s+a+"px"):parseFloat(this.textArea.style.top)-this.destTop-s-a>0&&(this.textArea.style.width=s+a+"px")))},e.prototype.setActivePoint=function(t,e){if(!sf.base.isNullOrUndefined(this.activeObj.activePoint))if(this.currObjType.isText){var i=t||0,s=e||this.activeObj.textSettings.fontSize;void 0===this.activeObj.textSettings.fontSize&&(this.activeObj.textSettings.fontSize=.1*Math.abs(this.baseImg.width-this.baseImg.height)),this.setTextSelection(i,s),this.mouseDownPoint.x=this.activeObj.activePoint.endX,this.mouseDownPoint.y=this.activeObj.activePoint.endY,void 0!==this.activeObj.horTopLine&&(this.activeObj.activePoint=sf.base.extend({},this.activeObj.activePoint,{},!0)),this.drawObject("duplicate")}else if(t&&e)this.activeObj.activePoint.startX=this.mouseDownPoint.x=t,this.activeObj.activePoint.startY=this.mouseDownPoint.y=e,this.currObjType.isDragging=!0;else{var a=this.activeObj;this.activeObj.activePoint={startX:a.horTopLine.startX,startY:a.horTopLine.startY,endX:a.horTopLine.endX,endY:a.horTopLine.endY},this.activeObj.activePoint.width=this.activeObj.activePoint.endX-this.activeObj.activePoint.startX,this.activeObj.activePoint.height=this.activeObj.activePoint.endY-this.activeObj.activePoint.startY}},e.prototype.setDragWidth=function(t){var e=t;if(e>=0)for(var i=0;i<e&&(t=e-i,this.activeObj.activePoint.startX+=t,this.activeObj.activePoint.endX+=t,!(this.activeObj.activePoint.startX>=this.destLeft&&this.activeObj.activePoint.endX<=this.destLeft+this.destWidth));i++)this.activeObj.activePoint.startX-=t,this.activeObj.activePoint.endX-=t;else for(i=1;i<Math.abs(e)&&(t=e+i,this.activeObj.activePoint.startX+=t,this.activeObj.activePoint.endX+=t,!(this.activeObj.activePoint.startX>=this.destLeft&&this.activeObj.activePoint.endX<=this.destLeft+this.destWidth));i++)this.activeObj.activePoint.startX-=t,this.activeObj.activePoint.endX-=t},e.prototype.setDragHeight=function(t){var e=t;if(e>=0)for(var i=1;i<e&&(t=e-i,this.activeObj.activePoint.startY+=t,this.activeObj.activePoint.endY+=t,!(this.activeObj.activePoint.startY>=this.destTop&&this.activeObj.activePoint.endY<=this.destTop+this.destHeight));i++)this.activeObj.activePoint.startY-=t,this.activeObj.activePoint.endY-=t;else for(i=0;i<Math.abs(e)&&(t=e+i,this.activeObj.activePoint.startY+=t,this.activeObj.activePoint.endY+=t,!(this.activeObj.activePoint.startY>=this.destTop&&this.activeObj.activePoint.endY<=this.destTop+this.destHeight));i++)this.activeObj.activePoint.startY-=t,this.activeObj.activePoint.endY-=t},e.prototype.triggerShapeChange=function(t,e,i){var s=this;this.activeObj.activePoint.width=this.activeObj.activePoint.endX-this.activeObj.activePoint.startX,this.activeObj.activePoint.height=this.activeObj.activePoint.endY-this.activeObj.activePoint.startY;var a=this.updatePreviousShapeSettings();t.currentShapeSettings=a,e.currentShapeSettings=a,"resize"===i?this.dotnetRef.invokeMethodAsync("ShapeEventAsync","OnShape",t).then((function(){s.updateShapeChangeEventArgs(t.currentShapeSettings)})):this.dotnetRef.invokeMethodAsync("ShapeEventAsync","OnShape",e).then((function(){s.updateShapeChangeEventArgs(e.currentShapeSettings)}))},e.prototype.updateActivePoint=function(t,e,i){var s=this.calcMaxDimension(this.activeObj.activePoint.width,this.activeObj.activePoint.height),a=this.updatePreviousShapeSettings(),o={action:"resize",previousShapeSettings:a},r={action:"move",previousShapeSettings:a};switch("text"===this.activeObj.shape&&""!==this.dragElement&&this.updateFontRatio(this.activeObj),this.dragElement.toLowerCase()){case"nw-resize":this.updateNWPoints(t,e,s),this.updateArrowDirection(this.activeObj),this.triggerShapeChange(o,r,"resize");break;case"n-resize":this.updateNPoints(t,e),this.updateArrowDirection(this.activeObj),this.triggerShapeChange(o,r,"resize");break;case"ne-resize":this.updateNEPoints(t,e,s),this.updateArrowDirection(this.activeObj),this.triggerShapeChange(o,r,"resize");break;case"w-resize":this.updateWPoints(t,e),this.updateArrowDirection(this.activeObj),this.triggerShapeChange(o,r,"resize");break;case"e-resize":this.updateEPoints(t,e),this.updateArrowDirection(this.activeObj),this.triggerShapeChange(o,r,"resize");break;case"sw-resize":this.updateSWPoints(t,e,s),this.updateArrowDirection(this.activeObj),this.triggerShapeChange(o,r,"resize");break;case"s-resize":this.updateSPoints(t,e),this.updateArrowDirection(this.activeObj),this.triggerShapeChange(o,r,"resize");break;case"se-resize":this.updateSEPoints(t,e,s),this.updateArrowDirection(this.activeObj),this.triggerShapeChange(o,r,"resize");break;default:if(!i&&!this.currObjType.isCustomCrop){if(this.dragPoint.startX){var n=this.dragPoint.endX-this.previousPoint.x,h=this.dragPoint.endY-this.previousPoint.y;this.activeObj.activePoint.startX+=n,this.activeObj.activePoint.endX+=n,this.activeObj.activePoint.startY+=h,this.activeObj.activePoint.endY+=h,!this.isPreventDragging&&(this.activeObj.activePoint.startX<this.destLeft||this.activeObj.activePoint.startY<this.destTop||this.activeObj.activePoint.endX>this.destLeft+this.destWidth||this.activeObj.activePoint.endY>this.destTop+this.destHeight)&&(this.activeObj.activePoint.startX-=n,this.activeObj.activePoint.endX-=n,this.activeObj.activePoint.startY-=h,this.activeObj.activePoint.endY-=h,this.setDragWidth(n),this.setDragHeight(h))}else this.activeObj.activePoint.startX=t<this.mouseDownPoint.x?t:this.mouseDownPoint.x,this.activeObj.activePoint.startY=e<this.mouseDownPoint.y?e:this.mouseDownPoint.y,t=t<this.mouseDownPoint.x?this.mouseDownPoint.x:t,e=e<this.mouseDownPoint.y?this.mouseDownPoint.y:e,this.activeObj.activePoint.endX=t,this.activeObj.activePoint.endY=e;this.triggerShapeChange(o,r,"move")}}},e.prototype.updateArrowDirection=function(t,e,i){"arrow"===t.shape&&(t.activePoint.width<0||t.activePoint.height<0||"horizontal"===e||"vertical"===e||90===i)&&("left"===t.triangleDirection&&(t.activePoint.width<0||"horizontal"===e)?t.triangleDirection="right":"right"===t.triangleDirection&&(t.activePoint.width<0||"horizontal"===e)?t.triangleDirection="left":"top"===t.triangleDirection&&(t.activePoint.height<0||"vertical"===e)?t.triangleDirection="bottom":"bottom"===t.triangleDirection&&(t.activePoint.height<0||"vertical"===e)&&(t.triangleDirection="top"),sf.base.isNullOrUndefined(i)||90!==i||("right"===t.triangleDirection?t.triangleDirection="bottom":"bottom"===t.triangleDirection?t.triangleDirection="left":"left"===t.triangleDirection?t.triangleDirection="top":"top"===t.triangleDirection&&(t.triangleDirection="right")))},e.prototype.preventDraggingInvertly=function(){this.isPreventDragging||(this.activeObj.activePoint.startX<this.destLeft&&(this.activeObj.activePoint.startX=this.destLeft),this.activeObj.activePoint.startY<this.destTop&&(this.activeObj.activePoint.startY=this.destTop),this.activeObj.activePoint.endX>this.destLeft+this.destWidth&&(this.activeObj.activePoint.endX=this.destLeft+this.destWidth),this.activeObj.activePoint.endY>this.destTop+this.destHeight&&(this.activeObj.activePoint.endY=this.destTop+this.destHeight))},e.prototype.updateNWPoints=function(t,e,i){var s,a,o,r,n=this.diffPoint.x,h=this.diffPoint.y,l=sf.base.extend({},this.activeObj,null,!0);if("text"===this.activeObj.shape)void 0===this.oldPoint.x&&void 0===this.oldPoint.y?(this.diffPoint.x=this.activeObj.activePoint.startX-t,this.diffPoint.y=this.activeObj.activePoint.startY-e):(this.diffPoint.x=this.oldPoint.x-t,this.diffPoint.y=this.oldPoint.y-e),this.oldPoint.x=t,this.oldPoint.y=e,r=(this.diffPoint.x<=n&&this.diffPoint.y>=h?Math.min(this.diffPoint.x,this.diffPoint.y):Math.max(this.diffPoint.x,this.diffPoint.y))/10,this.activeObj.activePoint.startX-=i.width/100*r,this.activeObj.activePoint.startY-=i.height/100*r,this.activeObj.activePoint.width=this.activeObj.activePoint.endX-this.activeObj.activePoint.startX,this.activeObj.activePoint.height=this.activeObj.activePoint.endY-this.activeObj.activePoint.startY,this.updateFontSize(this.activeObj);else{var c=void 0;if(void 0!==this.activeObj.shape&&(c=this.activeObj.shape.split("-")),"crop-custom"===this.activeObj.shape||void 0!==this.activeObj.shape&&"crop"!==c[0]){if(this.activeObj.activePoint.startX=t,this.activeObj.activePoint.startY=e,this.activeObj.activePoint.startX>this.activeObj.activePoint.endX){var d=this.activeObj.activePoint.startX;this.activeObj.activePoint.startX=this.activeObj.activePoint.endX,this.activeObj.activePoint.endX=d,this.dragElement="ne-resize"}if(this.activeObj.activePoint.startY>this.activeObj.activePoint.endY){d=this.activeObj.activePoint.startY;this.activeObj.activePoint.startY=this.activeObj.activePoint.endY,this.activeObj.activePoint.endY=d,this.dragElement="sw-resize"}this.preventDraggingInvertly()}else if(this.activeObj.activePoint.startX<t&&this.activeObj.activePoint.startY<e){s=t-this.activeObj.activePoint.startX,a=e-this.activeObj.activePoint.startY,o=Math.min(s,a);var p=this.getScaleRatio(o);this.activeObj.activePoint.startX+=p.x,this.activeObj.activePoint.startY+=p.y;var v=this.destLeft>0?this.destLeft:0,b=this.destTop>0?this.destTop:0;(this.activeObj.activePoint.startX<v||this.activeObj.activePoint.startY<b)&&(this.activeObj.activePoint.startX-=p.x,this.activeObj.activePoint.startY-=p.y)}else{s=this.activeObj.activePoint.startX-t,a=e-this.activeObj.activePoint.endY,o=Math.max(s,a);p=this.getScaleRatio(o);this.activeObj.activePoint.startX-=p.x,this.activeObj.activePoint.startY-=p.y;v=this.destLeft>0?this.destLeft:0;var u=this.destTop>0?this.destTop:0;(this.activeObj.activePoint.startX<v||this.activeObj.activePoint.startY<u)&&(this.activeObj.activePoint.startX+=p.x,this.activeObj.activePoint.startY+=p.y)}this.activeObj.activePoint.width=this.activeObj.activePoint.endX-this.activeObj.activePoint.startX,this.activeObj.activePoint.height=this.activeObj.activePoint.endY-this.activeObj.activePoint.startY,this.preventInverseResize(l)}},e.prototype.updateNPoints=function(t,e){var i,s,a;if("text"!==this.activeObj.shape){var o=void 0;if(void 0!==this.activeObj.shape&&(o=this.activeObj.shape.split("-")),"crop-custom"===this.activeObj.shape||void 0!==this.activeObj.shape&&"crop"!==o[0]){if(this.activeObj.activePoint.startY=e,this.activeObj.activePoint.height=this.activeObj.activePoint.endY-this.activeObj.activePoint.startY,this.activeObj.activePoint.startY>this.activeObj.activePoint.endY){var r=this.activeObj.activePoint.startY;this.activeObj.activePoint.startY=this.activeObj.activePoint.endY,this.activeObj.activePoint.endY=r,this.dragElement="s-resize"}this.preventDraggingInvertly()}else{if(this.activeObj.activePoint.endX>t&&this.activeObj.activePoint.startY<e){i=this.activeObj.activePoint.endX-t,s=e-this.activeObj.activePoint.startY,a=Math.min(i,s);var n=this.getScaleRatio(a);this.activeObj.activePoint.endX-=n.x,this.activeObj.activePoint.startY+=n.y,(this.activeObj.activePoint.endX>this.destLeft+this.destWidth||this.activeObj.activePoint.startY<this.destTop)&&(this.activeObj.activePoint.endX+=n.x,this.activeObj.activePoint.startY-=n.y)}else{i=t-this.activeObj.activePoint.endX,s=this.activeObj.activePoint.startY-e,a=Math.max(i,s);n=this.getScaleRatio(a);this.activeObj.activePoint.endX+=n.x,this.activeObj.activePoint.startY-=n.y,(this.activeObj.activePoint.endX>this.destLeft+this.destWidth||this.activeObj.activePoint.startY<this.destTop)&&(this.activeObj.activePoint.endX-=n.x,this.activeObj.activePoint.startY+=n.y)}this.activeObj.activePoint.width=this.activeObj.activePoint.endX-this.activeObj.activePoint.startX,this.activeObj.activePoint.height=this.activeObj.activePoint.endY-this.activeObj.activePoint.startY}}},e.prototype.updateNEPoints=function(t,e,i){var s,a,o,r,n=this.diffPoint.x,h=this.diffPoint.y,l=sf.base.extend({},this.activeObj,null,!0);if("text"===this.activeObj.shape)void 0===this.oldPoint.x&&void 0===this.oldPoint.y?(this.diffPoint.x=t-this.activeObj.activePoint.endX,this.diffPoint.y=this.activeObj.activePoint.startY-e):(this.diffPoint.x=t-this.oldPoint.x,this.diffPoint.y=this.oldPoint.y-e),this.oldPoint.x=t,this.oldPoint.y=e,r=(this.diffPoint.x<=n&&this.diffPoint.y>=h?Math.min(this.diffPoint.x,this.diffPoint.y):Math.max(this.diffPoint.x,this.diffPoint.y))/10,this.activeObj.activePoint.endX+=i.width/100*r,this.activeObj.activePoint.startY-=i.height/100*r,this.activeObj.activePoint.width=this.activeObj.activePoint.endX-this.activeObj.activePoint.startX,this.activeObj.activePoint.height=this.activeObj.activePoint.endY-this.activeObj.activePoint.startY,this.updateFontSize(this.activeObj);else{var c=void 0;if(void 0!==this.activeObj.shape&&(c=this.activeObj.shape.split("-")),this.currObjType.isCustomCrop||void 0!==this.activeObj.shape&&"crop"!==c[0]){if(this.activeObj.activePoint.endX=t,this.activeObj.activePoint.startY=e,this.activeObj.activePoint.endX<this.activeObj.activePoint.startX){var d=this.activeObj.activePoint.endX;this.activeObj.activePoint.endX=this.activeObj.activePoint.startX,this.activeObj.activePoint.startX=d,this.dragElement="nw-resize"}if(this.activeObj.activePoint.startY>this.activeObj.activePoint.endY){d=this.activeObj.activePoint.startY;this.activeObj.activePoint.startY=this.activeObj.activePoint.endY,this.activeObj.activePoint.endY=d,this.dragElement="se-resize"}this.preventDraggingInvertly()}else if(this.activeObj.activePoint.endX>t&&this.activeObj.activePoint.startY<e){s=this.activeObj.activePoint.endX-t,a=e-this.activeObj.activePoint.startY,o=Math.min(s,a);var p=this.getScaleRatio(o);this.activeObj.activePoint.endX-=p.x,this.activeObj.activePoint.startY+=p.y;var v=this.destLeft+this.destWidth<this.lowerCanvas.width?this.destLeft+this.destWidth:this.lowerCanvas.width,b=this.destTop>0?this.destTop:0;(this.activeObj.activePoint.endX>v||this.activeObj.activePoint.startY<b)&&(this.activeObj.activePoint.endX+=p.x,this.activeObj.activePoint.startY-=p.y)}else{s=t-this.activeObj.activePoint.endX,a=this.activeObj.activePoint.startY-e,o=Math.max(s,a);p=this.getScaleRatio(o);this.activeObj.activePoint.endX+=p.x,this.activeObj.activePoint.startY-=p.y;v=this.destLeft+this.destWidth<this.lowerCanvas.width?this.destLeft+this.destWidth:this.lowerCanvas.width,b=this.destTop>0?this.destTop:0;(this.activeObj.activePoint.endX>v||this.activeObj.activePoint.startY<b)&&(this.activeObj.activePoint.endX-=p.x,this.activeObj.activePoint.startY+=p.y)}this.activeObj.activePoint.width=this.activeObj.activePoint.endX-this.activeObj.activePoint.startX,this.activeObj.activePoint.height=this.activeObj.activePoint.endY-this.activeObj.activePoint.startY,this.preventInverseResize(l)}},e.prototype.updateWPoints=function(t,e){var i,s,a;if("text"!==this.activeObj.shape){var o=void 0;if(void 0!==this.activeObj.shape&&(o=this.activeObj.shape.split("-")),"crop-custom"===this.activeObj.shape||void 0!==this.activeObj.shape&&"crop"!==o[0]){if(this.activeObj.activePoint.startX=t,this.activeObj.activePoint.width=this.activeObj.activePoint.endX-this.activeObj.activePoint.startX,this.activeObj.activePoint.startX>this.activeObj.activePoint.endX){var r=this.activeObj.activePoint.startX;this.activeObj.activePoint.startX=this.activeObj.activePoint.endX,this.activeObj.activePoint.endX=r,this.dragElement="e-resize"}this.preventDraggingInvertly()}else{if(this.activeObj.activePoint.startX<t&&this.activeObj.activePoint.endY>e){i=t-this.activeObj.activePoint.startX,s=this.activeObj.activePoint.endY-e,a=Math.min(i,s);var n=this.getScaleRatio(a);this.activeObj.activePoint.startX+=n.x,this.activeObj.activePoint.endY-=n.y,(this.activeObj.activePoint.startX<this.destLeft||this.activeObj.activePoint.endY>this.destTop+this.destHeight)&&(this.activeObj.activePoint.startX-=n.x,this.activeObj.activePoint.endY+=n.y)}else{i=this.activeObj.activePoint.startX-t,s=e-this.activeObj.activePoint.endY,a=Math.max(i,s);n=this.getScaleRatio(a);this.activeObj.activePoint.startX-=n.x,this.activeObj.activePoint.endY+=n.y,(this.activeObj.activePoint.startX<this.destLeft||this.activeObj.activePoint.endY>this.destTop+this.destHeight)&&(this.activeObj.activePoint.startX+=n.x,this.activeObj.activePoint.endY-=n.y)}this.activeObj.activePoint.width=this.activeObj.activePoint.endX-this.activeObj.activePoint.startX,this.activeObj.activePoint.height=this.activeObj.activePoint.endY-this.activeObj.activePoint.startY}}},e.prototype.updateEPoints=function(t,e){var i,s,a;if("text"!==this.activeObj.shape){var o=void 0;if(void 0!==this.activeObj.shape&&(o=this.activeObj.shape.split("-")),"crop-custom"===this.activeObj.shape||void 0!==this.activeObj.shape&&"crop"!==o[0]){if(this.activeObj.activePoint.endX=t,this.activeObj.activePoint.width=this.activeObj.activePoint.endX-this.activeObj.activePoint.startX,this.activeObj.activePoint.endX<this.activeObj.activePoint.startX){var r=this.activeObj.activePoint.endX;this.activeObj.activePoint.endX=this.activeObj.activePoint.startX,this.activeObj.activePoint.startX=r,this.dragElement="w-resize"}this.preventDraggingInvertly()}else{if(this.activeObj.activePoint.endX>t&&this.activeObj.activePoint.endY>e){i=this.activeObj.activePoint.endX-t,s=this.activeObj.activePoint.endY-e,a=Math.min(i,s);var n=this.getScaleRatio(a);this.activeObj.activePoint.endX-=n.x,this.activeObj.activePoint.endY-=n.y,(this.activeObj.activePoint.endX>this.destLeft+this.destWidth||this.activeObj.activePoint.endY>this.destTop+this.destHeight)&&(this.activeObj.activePoint.endX+=n.x,this.activeObj.activePoint.endY+=n.y)}else{i=t-this.activeObj.activePoint.endX,s=e-this.activeObj.activePoint.endY,a=Math.max(i,s);n=this.getScaleRatio(a);this.activeObj.activePoint.endX+=n.x,this.activeObj.activePoint.endY+=n.y,(this.activeObj.activePoint.endX>this.destLeft+this.destWidth||this.activeObj.activePoint.endY>this.destTop+this.destHeight)&&(this.activeObj.activePoint.endX-=n.x,this.activeObj.activePoint.endY-=n.y)}this.activeObj.activePoint.width=this.activeObj.activePoint.endX-this.activeObj.activePoint.startX,this.activeObj.activePoint.height=this.activeObj.activePoint.endY-this.activeObj.activePoint.startY}}},e.prototype.updateSWPoints=function(t,e,i){var s,a,o,r,n=this.diffPoint.x,h=this.diffPoint.y,l=sf.base.extend({},this.activeObj,null,!0);if("text"===this.activeObj.shape)void 0===this.oldPoint.x&&void 0===this.oldPoint.y?(this.diffPoint.x=this.activeObj.activePoint.startX-t,this.diffPoint.y=e-this.activeObj.activePoint.endY):(this.diffPoint.x=this.oldPoint.x-t,this.diffPoint.y=e-this.oldPoint.y),this.oldPoint.x=t,this.oldPoint.y=e,r=(this.diffPoint.x<=n&&this.diffPoint.y>=h?Math.min(this.diffPoint.x,this.diffPoint.y):Math.max(this.diffPoint.x,this.diffPoint.y))/10,this.activeObj.activePoint.startX-=i.width/100*r,this.activeObj.activePoint.endY+=i.height/100*r,this.activeObj.activePoint.width=this.activeObj.activePoint.endX-this.activeObj.activePoint.startX,this.activeObj.activePoint.height=this.activeObj.activePoint.endY-this.activeObj.activePoint.startY,this.updateFontSize(this.activeObj);else{var c=void 0;if(void 0!==this.activeObj.shape&&(c=this.activeObj.shape.split("-")),"crop-custom"===this.activeObj.shape||void 0!==this.activeObj.shape&&"crop"!==c[0]){if(this.activeObj.activePoint.startX=t,this.activeObj.activePoint.endY=e,this.activeObj.activePoint.startX>this.activeObj.activePoint.endX){var d=this.activeObj.activePoint.startX;this.activeObj.activePoint.startX=this.activeObj.activePoint.endX,this.activeObj.activePoint.endX=d,this.dragElement="se-resize"}if(this.activeObj.activePoint.endY<this.activeObj.activePoint.startY){d=this.activeObj.activePoint.endY;this.activeObj.activePoint.endY=this.activeObj.activePoint.startY,this.activeObj.activePoint.startY=d,this.dragElement="nw-resize"}this.preventDraggingInvertly()}else if(this.activeObj.activePoint.startX<t&&this.activeObj.activePoint.endY>e){s=t-this.activeObj.activePoint.startX,a=this.activeObj.activePoint.endY-e,o=Math.min(s,a);var p=this.getScaleRatio(o);this.activeObj.activePoint.startX+=p.x,this.activeObj.activePoint.endY-=p.y;var v=this.destLeft>0?this.destLeft:0,b=this.destTop+this.destHeight<this.lowerCanvas.height?this.destTop+this.destHeight:this.lowerCanvas.height;(this.activeObj.activePoint.startX<v||this.activeObj.activePoint.endY>b)&&(this.activeObj.activePoint.startX-=p.x,this.activeObj.activePoint.endY+=p.y)}else{s=this.activeObj.activePoint.startX-t,a=e-this.activeObj.activePoint.endY,o=Math.max(s,a);p=this.getScaleRatio(o);this.activeObj.activePoint.startX-=p.x,this.activeObj.activePoint.endY+=p.y;v=this.destLeft>0?this.destLeft:0,b=this.destTop+this.destHeight<this.lowerCanvas.height?this.destTop+this.destHeight:this.lowerCanvas.height;(this.activeObj.activePoint.startX<v||this.activeObj.activePoint.endY>b)&&(this.activeObj.activePoint.startX+=p.x,this.activeObj.activePoint.endY-=p.y)}this.activeObj.activePoint.width=this.activeObj.activePoint.endX-this.activeObj.activePoint.startX,this.activeObj.activePoint.height=this.activeObj.activePoint.endY-this.activeObj.activePoint.startY,this.preventInverseResize(l)}},e.prototype.updateSPoints=function(t,e){var i,s,a;if("text"!==this.activeObj.shape){var o=void 0;if(void 0!==this.activeObj.shape&&(o=this.activeObj.shape.split("-")),"crop-custom"===this.activeObj.shape||void 0!==this.activeObj.shape&&"crop"!==o[0]){if(this.activeObj.activePoint.endY=e,this.activeObj.activePoint.height=this.activeObj.activePoint.endY-this.activeObj.activePoint.startY,this.activeObj.activePoint.endY<this.activeObj.activePoint.startY){var r=this.activeObj.activePoint.endY;this.activeObj.activePoint.endY=this.activeObj.activePoint.startY,this.activeObj.activePoint.startY=r,this.dragElement="n-resize"}this.preventDraggingInvertly()}else{if(this.activeObj.activePoint.endX>t&&this.activeObj.activePoint.endY>e){i=this.activeObj.activePoint.endX-t,s=this.activeObj.activePoint.endY-e,a=Math.min(i,s);var n=this.getScaleRatio(a);this.activeObj.activePoint.endX-=n.x,this.activeObj.activePoint.endY-=n.y,(this.activeObj.activePoint.endX>this.destLeft+this.destWidth||this.activeObj.activePoint.endY>this.destTop+this.destHeight)&&(this.activeObj.activePoint.endX+=n.x,this.activeObj.activePoint.endY+=n.y)}else{i=t-this.activeObj.activePoint.endX,s=e-this.activeObj.activePoint.endY,a=Math.max(i,s);n=this.getScaleRatio(a);this.activeObj.activePoint.endX+=n.x,this.activeObj.activePoint.endY+=n.x,(this.activeObj.activePoint.endX>this.destLeft+this.destWidth||this.activeObj.activePoint.endY>this.destTop+this.destHeight)&&(this.activeObj.activePoint.endX-=n.x,this.activeObj.activePoint.endY-=n.y)}this.activeObj.activePoint.width=this.activeObj.activePoint.endX-this.activeObj.activePoint.startX,this.activeObj.activePoint.height=this.activeObj.activePoint.endY-this.activeObj.activePoint.startY}}},e.prototype.updateSEPoints=function(t,e,i){var s,a,o,r,n=this.diffPoint.x,h=this.diffPoint.y,l=sf.base.extend({},this.activeObj,null,!0);if("text"===this.activeObj.shape)void 0===this.oldPoint.x&&void 0===this.oldPoint.y?(this.diffPoint.x=t-this.activeObj.activePoint.endX,this.diffPoint.y=e-this.activeObj.activePoint.endY):(this.diffPoint.x=t-this.oldPoint.x,this.diffPoint.y=e-this.oldPoint.y),this.oldPoint.x=t,this.oldPoint.y=e,r=(this.diffPoint.x>=n&&this.diffPoint.y>=h?Math.max(this.diffPoint.x,this.diffPoint.y):Math.min(this.diffPoint.x,this.diffPoint.y))/10,this.activeObj.activePoint.endX+=i.width/50*r,this.activeObj.activePoint.endY+=i.height/50*r,this.activeObj.activePoint.width=this.activeObj.activePoint.endX-this.activeObj.activePoint.startX,this.activeObj.activePoint.height=this.activeObj.activePoint.endY-this.activeObj.activePoint.startY,this.updateFontSize(this.activeObj);else{var c=void 0;if(void 0!==this.activeObj.shape&&(c=this.activeObj.shape.split("-")),"crop-custom"===this.activeObj.shape||void 0!==this.activeObj.shape&&"crop"!==c[0]){if(this.activeObj.activePoint.endX=t,this.activeObj.activePoint.endY=e,this.activeObj.activePoint.endX<this.activeObj.activePoint.startX){var d=this.activeObj.activePoint.endX;this.activeObj.activePoint.endX=this.activeObj.activePoint.startX,this.activeObj.activePoint.startX=d,this.dragElement="sw-resize"}if(this.activeObj.activePoint.endY<this.activeObj.activePoint.startY){d=this.activeObj.activePoint.endY;this.activeObj.activePoint.endY=this.activeObj.activePoint.startY,this.activeObj.activePoint.startY=d,this.dragElement="ne-resize"}this.preventDraggingInvertly()}else if(this.activeObj.activePoint.endX>t&&this.activeObj.activePoint.endY>e){s=this.activeObj.activePoint.endX-t,a=this.activeObj.activePoint.endY-e,o=Math.min(s,a);var p=this.getScaleRatio(o);this.activeObj.activePoint.endX-=p.x,this.activeObj.activePoint.endY-=p.y;var v=this.destLeft+this.destWidth<this.lowerCanvas.width?this.destLeft+this.destWidth:this.lowerCanvas.width,b=this.destTop+this.destHeight<this.lowerCanvas.height?this.destTop+this.destHeight:this.lowerCanvas.height;(this.activeObj.activePoint.endX>v||this.activeObj.activePoint.endY>b)&&(this.activeObj.activePoint.endX+=p.x,this.activeObj.activePoint.endY+=p.y)}else{s=t-this.activeObj.activePoint.endX,a=e-this.activeObj.activePoint.endY,o=Math.max(s,a);p=this.getScaleRatio(o);this.activeObj.activePoint.endX+=p.x,this.activeObj.activePoint.endY+=p.y;v=this.destLeft+this.destWidth<this.lowerCanvas.width?this.destLeft+this.destWidth:this.lowerCanvas.width,b=this.destTop+this.destHeight<this.lowerCanvas.height?this.destTop+this.destHeight:this.lowerCanvas.height;(this.activeObj.activePoint.endX>v||this.activeObj.activePoint.endY>b)&&(this.activeObj.activePoint.endX-=p.x,this.activeObj.activePoint.endY-=p.y)}this.activeObj.activePoint.width=this.activeObj.activePoint.endX-this.activeObj.activePoint.startX,this.activeObj.activePoint.height=this.activeObj.activePoint.endY-this.activeObj.activePoint.startY,this.preventInverseResize(l)}},e.prototype.updateFontRatio=function(t,e){var i;i=0===t.shapeDegree?this.degree:this.degree-t.shapeDegree,sf.base.isNullOrUndefined(e)?t.textSettings.fontRatio=0===i||180===i?t.activePoint.width/t.textSettings.fontSize:t.activePoint.height/t.textSettings.fontSize:e&&(t.textSettings.fontRatio=0===i||180===i?this.textArea.clientWidth/parseFloat(this.textArea.style.fontSize):this.textArea.clientHeight/parseFloat(this.textArea.style.fontSize))},e.prototype.updateFontSize=function(t){var e;e=0===t.shapeDegree?this.degree:this.degree-t.shapeDegree,t.textSettings.fontSize=0===e||180===e?t.activePoint.width/t.textSettings.fontRatio:t.activePoint.height/t.textSettings.fontRatio},e.prototype.preventInverseResize=function(t){this.activeObj.activePoint.width<0&&(this.activeObj.activePoint.width=0,this.activeObj.activePoint.startX=t.activePoint.startX,this.activeObj.activePoint.endX=t.activePoint.endX),this.activeObj.activePoint.height<0&&(this.activeObj.activePoint.height=0,this.activeObj.activePoint.startY=t.activePoint.startY,this.activeObj.activePoint.endY=t.activePoint.endY)},e.prototype.getScaleRatio=function(t){var e={x:t,y:t};if(!sf.base.isNullOrUndefined(this.activeObj.shape)&&"crop-custom"!==this.activeObj.shape&&"crop-circle"!==this.activeObj.shape&&"crop-square"!==this.activeObj.shape){var i=this.activeObj.shape.split("-");if(i.length>1){i=i[1].split(":");var s=t/parseInt(i[1],10);e.x=s*parseInt(i[0],10),e.y=s*parseInt(i[1],10)}}return e},e.prototype.getMaxText=function(t,e){var i;sf.base.isNullOrUndefined(e)&&(e=t?this.textArea.value:this.activeObj.keyHistory);for(var s=e.split("\n"),a=s[0].length,o=s[0],r=1;r<s.length;r++)(i=s[r].length)>a&&(o=s[r],a=i);return o},e.prototype.setDragLimit=function(){this.activeObj.activePoint&&(this.activeObj.activePoint.startX<this.destLeft?(this.activeObj.activePoint.startX=this.destLeft,this.activeObj.activePoint.endX=this.activeObj.activePoint.startX+this.activeObj.activePoint.width):this.activeObj.activePoint.endX>this.destLeft+this.destWidth&&(this.activeObj.activePoint.endX=this.destLeft+this.destWidth,this.activeObj.activePoint.startX=this.activeObj.activePoint.endX-this.activeObj.activePoint.width),this.activeObj.activePoint.startY<this.destTop?this.activeObj.activePoint.startY=this.destTop:this.activeObj.activePoint.endY>this.destTop+this.destHeight&&(this.activeObj.activePoint.endY=this.destTop+this.destHeight,this.activeObj.activePoint.startY=this.activeObj.activePoint.endY-this.activeObj.activePoint.height),this.activeObj.activePoint.width=this.activeObj.activePoint.endX-this.activeObj.activePoint.startX,this.activeObj.activePoint.height=this.activeObj.activePoint.endY-this.activeObj.activePoint.startY)},e.prototype.lineDraw=function(){this.activeObj.activePoint.height<10?(this.activeObj.activePoint.startY-=10,this.activeObj.activePoint.endY+=10,this.activeObj.lineDraw="horizontal"):this.activeObj.activePoint.width<10?(this.activeObj.activePoint.startX-=10,this.activeObj.activePoint.endX+=10,this.activeObj.lineDraw="vertical"):this.currObjType.isInitialLine&&(this.activeObj.lineDraw="normal",this.currObjType.isInitialLine=!1),this.activeObj.activePoint.width=this.activeObj.activePoint.endX-this.activeObj.activePoint.startX,this.activeObj.activePoint.height=this.activeObj.activePoint.endY-this.activeObj.activePoint.startY},e.prototype.shapeCircle=function(t,e,i){t.strokeStyle=this.themeColl[this.theme].primaryColor,t.clearRect(0,0,this.lowerCanvas.width,this.lowerCanvas.height),t.fillStyle="rgb(0, 0, 0, 0.5)",t.fillRect(0,0,this.lowerCanvas.width,this.lowerCanvas.height);var s=t.lineWidth;t.lineWidth=2,t.beginPath(),t.ellipse(this.activeObj.horTopLine.startX+e/2,this.activeObj.horTopLine.startY+i/2,e/2,i/2,0,0,2*Math.PI,!1),t.stroke(),t.closePath(),t.save(),t.beginPath(),t.arc((this.activeObj.activePoint.endX-this.activeObj.activePoint.startX)/2+this.activeObj.activePoint.startX,(this.activeObj.activePoint.endY-this.activeObj.activePoint.startY)/2+this.activeObj.activePoint.startY,this.activeObj.activePoint.width/2,0,2*Math.PI),t.closePath(),t.clip(),t.clearRect(0,0,this.lowerCanvas.width,this.lowerCanvas.height),t.restore(),t.lineWidth=s,this.drawOuterSelection(t,!0),this.currObjType.shape=""},e.prototype.drawOuterSelection=function(t,e){var i;t.lineWidth=.5,void 0!==this.activeObj.shape&&(i=this.activeObj.shape.split("-"));var s,a=sf.base.extend({},this.activeObj,{},!0);void 0!==this.activeObj.shape&&(i=this.activeObj.shape.split("-")),(void 0===i||"crop"!==i[0])&&void 0!==this.activeObj.shape||e||(this.upperContext.fillStyle="rgb(0, 0, 0, 0.5)",this.upperContext.fillRect(0,0,this.lowerCanvas.width,this.lowerCanvas.height),this.upperContext.clearRect(this.activeObj.activePoint.startX,this.activeObj.activePoint.startY,this.activeObj.activePoint.width,this.activeObj.activePoint.height)),t.strokeStyle=this.themeColl[this.theme].primaryColor,t.fillStyle=this.themeColl[this.theme].secondaryColor,(s=0===a.shapeDegree?this.degree:this.degree-a.shapeDegree)<0&&(s=360+s),"arrow"===this.activeObj.shape||"line"===this.activeObj.shape?(t.beginPath(),s%90==0&&s%180!=0?(t.moveTo(a.topCenterCircle.startX,a.topCenterCircle.startY),t.lineTo(a.bottomCenterCircle.startX,a.bottomCenterCircle.startY)):(t.moveTo(a.centerLeftCircle.startX,a.centerLeftCircle.startY),t.lineTo(a.centerRightCircle.startX,a.centerRightCircle.startY)),t.stroke()):(t.beginPath(),t.rect(a.activePoint.startX,a.activePoint.startY,a.activePoint.width,a.activePoint.height),t.stroke(),t.closePath(),t.lineWidth*=2,t.beginPath(),t.moveTo(a.topLeftCircle.startX,a.topLeftCircle.startY),t.arc(a.topLeftCircle.startX,a.topLeftCircle.startY,a.topLeftCircle.radius,0,2*Math.PI),t.moveTo(a.topRightCircle.startX,a.topRightCircle.startY),t.arc(a.topRightCircle.startX,a.topRightCircle.startY,a.topRightCircle.radius,0,2*Math.PI),t.moveTo(a.bottomLeftCircle.startX,a.bottomLeftCircle.startY),t.arc(a.bottomLeftCircle.startX,a.bottomLeftCircle.startY,a.bottomLeftCircle.radius,0,2*Math.PI),t.moveTo(a.bottomRightCircle.startX,a.bottomRightCircle.startY),t.arc(a.bottomRightCircle.startX,a.bottomRightCircle.startY,a.bottomRightCircle.radius,0,2*Math.PI),t.stroke(),t.fill(),t.closePath(),t.lineWidth/=2),void 0!==i&&"crop"===i[0]||"text"===this.activeObj.shape||this.drawCenterCircles(t,s),this.activeObj=sf.base.extend({},a,{},!0)},e.prototype.drawObject=function(t,e,i,s,a,o){var r;if(this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),"original"===t.toLowerCase()?r=this.lowerContext:"duplicate"===t.toLowerCase()?r=this.upperContext:sf.base.isNullOrUndefined(o)||(r=o),a||sf.base.isNullOrUndefined(this.activeObj.shape)||this.setDragLimit(),this.currObjType.isLine&&"original"!==t&&!e&&this.lineDraw(),"crop"===this.currObjType.shape.split("-")[0].toLowerCase()&&i&&this.drawCropRatio(),s&&(this.activeObj.activePoint.startX=s.startX,this.activeObj.activePoint.startY=s.startY,this.activeObj.activePoint.endX=s.endX,this.activeObj.activePoint.endY=s.endY,this.activeObj.activePoint.width=s.width,this.activeObj.activePoint.height=s.height),sf.base.isNullOrUndefined(this.activeObj.strokeSettings)&&(this.activeObj.strokeSettings=this.strokeSettings),sf.base.isNullOrUndefined(this.activeObj.strokeSettings.strokeWidth)&&(this.activeObj.strokeSettings.strokeWidth=4),e&&(this.activeObj=sf.base.extend({},e,{},!0)),this.updateActiveObject(),this.currObjType.isText&&(this.activeObj.keyHistory=this.keyHistory),"original"!==t.toLowerCase()){var n=!1;this.activeObj.shape&&"crop"===this.activeObj.shape.split("-")[0]&&(n=!0),n&&(this.upperContext.fillStyle="rgb(0, 0, 0, 0.5)",this.upperContext.fillRect(0,0,this.lowerCanvas.width,this.lowerCanvas.height),this.upperContext.clearRect(this.activeObj.activePoint.startX,this.activeObj.activePoint.startY,this.activeObj.activePoint.width,this.activeObj.activePoint.height)),r!==this.lowerContext&&r!==this.upperContext||this.drawOuterSelection(r)}this.currObjType.isActiveObj=!0,e?this.drawShapeObj(t,e.shape,o):""!==this.keyHistory&&this.currObjType.isText?this.drawShapeObj(t,"text",o):this.activeObj.shape?this.drawShapeObj(t,this.activeObj.shape,o):this.drawShapeObj(t,void 0,o),this.isAllowCropPan&&(this.isAllowCropPan=!1,this.tempPanMove=sf.base.extend({},this.panMove,{},!0),this.currentPannedPoint=this.updatePanPoints(this.getCurrentPanRegion()),this.rotatePan())},e.prototype.updateActiveObject=function(t,e,i,s,a){t=t||sf.base.extend({},this.activeObj.activePoint,{},!0),e=e||sf.base.extend({},this.activeObj,{},!0),t.width=t.endX-t.startX,t.height=t.endY-t.startY,s=s||0,a=a||0;var o=t.width/2,r=t.height/2;e.horTopLine={startX:t.startX+s,startY:t.startY-a,endX:t.endX+s,endY:t.endY+a},e.horBottomLine={startX:t.startX-s,startY:t.endY-a,endX:t.endX-s,endY:t.endY+a},e.verLeftLine={startX:t.startX+s,startY:t.startY-a,endX:t.startX-a,endY:t.endY-a},e.verRightLine={startX:t.endX+s,startY:t.startY+a,endX:t.endX-s,endY:t.endY+a},e.topLeftCircle={startX:t.startX,startY:t.startY,radius:e.horTopLine.endX?7.5:0},e.topCenterCircle={startX:t.startX+o,startY:t.startY,radius:e.horTopLine.endX?7.5:0},e.topRightCircle={startX:t.endX,startY:t.startY,radius:e.horTopLine.endX?7.5:0},e.centerLeftCircle={startX:t.startX,startY:t.startY+r,radius:e.horTopLine.endX?7.5:0},e.centerRightCircle={startX:t.endX,startY:t.startY+r,radius:e.horTopLine.endX?7.5:0},e.bottomLeftCircle={startX:t.startX,startY:t.endY,radius:e.horTopLine.endX?7.5:0},e.bottomCenterCircle={startX:t.startX+o,startY:t.endY,radius:e.horTopLine.endX?7.5:0},e.bottomRightCircle={startX:t.endX,startY:t.endY,radius:e.horTopLine.endX?7.5:0},e.activePoint=t,sf.base.isNullOrUndefined(i)&&(this.activeObj=sf.base.extend({},e,{},!0))},e.prototype.drawShapeObj=function(t,e,i){var s,a=void 0!==e?e:this.currObjType.shape;this.currObjType.shape=a,"original"===t.toLowerCase()?s=this.lowerContext:"duplicate"===t.toLowerCase()?s=this.upperContext:sf.base.isNullOrUndefined(i)||(s=i),"rectangle"!==this.currObjType.shape.toLowerCase()&&"ellipse"!==this.currObjType.shape.toLowerCase()&&"line"!==this.currObjType.shape.toLowerCase()&&"arrow"!==this.activeObj.shape||(this.activeObj.shape=this.currObjType.shape),s.strokeStyle=this.activeObj.strokeSettings.strokeColor,s.fillStyle="text"===e||"freehanddraw"===e?this.activeObj.strokeSettings.strokeColor:this.activeObj.strokeSettings.fillColor;var o=this.activeObj.activePoint.width/3,r=this.activeObj.activePoint.height/3,n=this.activeObj.activePoint.endX-this.activeObj.activePoint.startX,h=this.activeObj.activePoint.endY-this.activeObj.activePoint.startY;switch(this.currObjType.shape.toLowerCase()){case"rectangle":this.drawSquareLines(s),s===this.upperContext&&this.drawOuterSelection(s);break;case"ellipse":n=Math.abs(n),h=Math.abs(h),s.beginPath(),s.ellipse(this.activeObj.activePoint.startX+n/2,this.activeObj.activePoint.startY+h/2,n/2,h/2,0,0,2*Math.PI,!1),""!==this.activeObj.strokeSettings.fillColor&&(s.fillStyle=this.activeObj.strokeSettings.fillColor,s.fill()),s.ellipse(this.activeObj.activePoint.startX+n/2,this.activeObj.activePoint.startY+h/2,Math.abs(n/2-this.activeObj.strokeSettings.strokeWidth),Math.abs(h/2-this.activeObj.strokeSettings.strokeWidth),0,0,2*Math.PI,!1),s.fillStyle=this.activeObj.strokeSettings.strokeColor,s.fill("evenodd"),s.closePath(),s===this.upperContext&&this.drawOuterSelection(s);break;case"crop-circle":s===this.lowerContext&&(s=this.upperContext),this.shapeCircle(s,n,h);break;case"line":case"arrow":this.shapeLine(s,n,h),"arrow"===this.currObjType.shape.toLowerCase()&&this.shapeArrow(s),s===this.upperContext&&this.drawOuterSelection(s);break;case"text":this.shapeText(s);break;case"crop-square":case"crop-3:4":case"crop-4:3":case"crop-6:9":case"crop-9:6":case"crop-9:16":case"crop-16:9":s===this.lowerContext&&(s=this.upperContext),this.drawSelection(o,r),this.currObjType.shape="";break;default:this.drawSelection(o,r)}},e.prototype.shapeLine=function(t,e,i){var s,a,o,r,n;0===(n=0===this.activeObj.shapeDegree?this.degree:this.degree-this.activeObj.shapeDegree)||n%180==0?(s=this.activeObj.activePoint.startX,a=this.activeObj.activePoint.startY+i/2,o=this.activeObj.activePoint.endX,r=this.activeObj.activePoint.startY+i/2):(s=this.activeObj.activePoint.startX+e/2,a=this.activeObj.activePoint.startY,o=this.activeObj.activePoint.startX+e/2,r=this.activeObj.activePoint.endY);var h=t.lineWidth;switch(t.lineWidth=this.activeObj.strokeSettings.strokeWidth,t.beginPath(),this.activeObj.lineDraw.toLowerCase()){case"horizontal":case"vertical":t.moveTo(s,a),t.lineTo(o,r);break;case"normal":t.moveTo(this.activeObj.horTopLine.startX,this.activeObj.horTopLine.startY),t.lineTo(this.activeObj.horBottomLine.endX,this.activeObj.horBottomLine.endY)}t.stroke(),t.lineWidth=h},e.prototype.shapeArrow=function(t){var e=t.lineWidth;switch(t.lineWidth=this.activeObj.strokeSettings.strokeWidth,t.beginPath(),t.moveTo(this.activeObj.triangle[0].x,this.activeObj.triangle[0].y),t.lineTo(this.activeObj.triangle[1].x,this.activeObj.triangle[1].y),t.lineTo(this.activeObj.triangle[2].x,this.activeObj.triangle[2].y),t.lineTo(this.activeObj.triangle[0].x,this.activeObj.triangle[0].y),t.fillStyle=t.strokeStyle,t.fill(),this.activeObj.triangleDirection){case"right":t.moveTo(this.activeObj.triangle[0].x,this.activeObj.triangle[0].y-this.activeObj.strokeSettings.strokeWidth),t.lineTo(this.activeObj.triangle[1].x+this.activeObj.strokeSettings.strokeWidth,this.activeObj.triangle[1].y),t.lineTo(this.activeObj.triangle[2].x,this.activeObj.triangle[2].y+this.activeObj.strokeSettings.strokeWidth),t.lineTo(this.activeObj.triangle[0].x,this.activeObj.triangle[0].y-this.activeObj.strokeSettings.strokeWidth);break;case"left":t.moveTo(this.activeObj.triangle[0].x,this.activeObj.triangle[0].y-this.activeObj.strokeSettings.strokeWidth),t.lineTo(this.activeObj.triangle[1].x-this.activeObj.strokeSettings.strokeWidth,this.activeObj.triangle[1].y),t.lineTo(this.activeObj.triangle[2].x,this.activeObj.triangle[2].y+this.activeObj.strokeSettings.strokeWidth),t.lineTo(this.activeObj.triangle[0].x,this.activeObj.triangle[0].y-this.activeObj.strokeSettings.strokeWidth);break;case"top":t.moveTo(this.activeObj.triangle[0].x-this.activeObj.strokeSettings.strokeWidth,this.activeObj.triangle[0].y),t.lineTo(this.activeObj.triangle[1].x,this.activeObj.triangle[1].y-this.activeObj.strokeSettings.strokeWidth),t.lineTo(this.activeObj.triangle[2].x+this.activeObj.strokeSettings.strokeWidth,this.activeObj.triangle[2].y),t.lineTo(this.activeObj.triangle[0].x-this.activeObj.strokeSettings.strokeWidth,this.activeObj.triangle[0].y);break;case"bottom":t.moveTo(this.activeObj.triangle[0].x+this.activeObj.strokeSettings.strokeWidth,this.activeObj.triangle[0].y),t.lineTo(this.activeObj.triangle[1].x,this.activeObj.triangle[1].y+this.activeObj.strokeSettings.strokeWidth),t.lineTo(this.activeObj.triangle[2].x-this.activeObj.strokeSettings.strokeWidth,this.activeObj.triangle[2].y),t.lineTo(this.activeObj.triangle[0].x+this.activeObj.strokeSettings.strokeWidth,this.activeObj.triangle[0].y)}t.fillStyle=t.strokeStyle,t.fill("evenodd"),t.closePath(),t.lineWidth=e},e.prototype.shapeText=function(t){for(var e=this.activeObj.keyHistory.split("\n"),i=((this.activeObj.textSettings.fontSize+.25*this.activeObj.textSettings.fontSize)*e.length-this.activeObj.textSettings.fontSize*e.length)/e.length,s=0;s<e.length;s++){var a=e[s],o=(s+1)*this.activeObj.textSettings.fontSize*.85+s*i;-360===this.degree&&(this.degree=0),0===this.degree||180===this.degree?this.activeObj.textSettings.fontSize>this.activeObj.activePoint.height&&(this.activeObj.textSettings.fontSize=this.activeObj.activePoint.height-.1*this.activeObj.activePoint.height):this.activeObj.textSettings.fontSize>this.activeObj.activePoint.width&&(this.activeObj.textSettings.fontSize=this.activeObj.activePoint.width-.1*this.activeObj.activePoint.width),t.strokeStyle=this.activeObj.strokeSettings.strokeColor,t.fillStyle=this.activeObj.strokeSettings.strokeColor;var r="";this.activeObj.textSettings.bold&&(r="bold "),this.activeObj.textSettings.italic&&(r="italic "),this.activeObj.textSettings.bold&&this.activeObj.textSettings.italic&&(r="italic bold "),t.font=r+this.activeObj.textSettings.fontSize+"px "+this.activeObj.textSettings.fontFamily,4===this.activeObj.flipObjColl.length&&(this.activeObj.flipObjColl=[]);for(var n=0;n<this.activeObj.flipObjColl.length;n++)"horizontal"===this.activeObj.flipObjColl[n].toLowerCase()?(t.translate(t.canvas.width,0),t.scale(-1,1),this.updateActPoint("horizontal",t)):"vertical"===this.activeObj.flipObjColl[n].toLowerCase()&&(t.translate(0,t.canvas.height),t.scale(1,-1),this.updateActPoint("vertical",t));this.activeObj.shapeDegree!==this.degree?this.rotateText(t):t.fillText(a,this.activeObj.activePoint.startX+.1*this.activeObj.textSettings.fontSize,this.activeObj.activePoint.startY+o);for(var h=0;h<this.activeObj.flipObjColl.length;h++)"horizontal"===this.activeObj.flipObjColl[h].toLowerCase()?(t.translate(t.canvas.width,0),t.scale(-1,1),this.updateActPoint("horizontal",t)):"vertical"===this.activeObj.flipObjColl[h].toLowerCase()&&(t.translate(0,t.canvas.height),t.scale(1,-1),this.updateActPoint("vertical",t))}this.currObjType.isText=!1},e.prototype.updateActPoint=function(t,e){"horizontal"===t.toLowerCase()?this.activeObj.activePoint.startX<=e.canvas.width/2?(this.activeObj.activePoint.startX=e.canvas.width/2+(e.canvas.width/2-this.activeObj.activePoint.endX),this.activeObj.activePoint.endX=this.activeObj.activePoint.startX+this.activeObj.activePoint.width,this.updateActiveObject(this.activeObj.activePoint,this.activeObj)):this.activeObj.activePoint.startX>=e.canvas.width/2&&(this.activeObj.activePoint.startX=e.canvas.width-this.activeObj.activePoint.endX,this.activeObj.activePoint.endX=this.activeObj.activePoint.startX+this.activeObj.activePoint.width,this.updateActiveObject(this.activeObj.activePoint,this.activeObj)):"vertical"===t.toLowerCase()&&(this.activeObj.activePoint.startY<=e.canvas.height/2?(this.activeObj.activePoint.startY=e.canvas.height/2+(e.canvas.height/2-this.activeObj.activePoint.endY),this.activeObj.activePoint.endY=this.activeObj.activePoint.startY+this.activeObj.activePoint.height,this.updateActiveObject(this.activeObj.activePoint,this.activeObj)):this.activeObj.activePoint.startY>=e.canvas.height/2&&(this.activeObj.activePoint.startY=e.canvas.height-this.activeObj.activePoint.endY,this.activeObj.activePoint.endY=this.activeObj.activePoint.startY+this.activeObj.activePoint.height,this.updateActiveObject(this.activeObj.activePoint,this.activeObj)))},e.prototype.drawSquareLines=function(t){var e;void 0!==this.activeObj.shape&&(e=this.activeObj.shape.split("-")),"crop"===e[0]?t.strokeStyle="#fff":t.strokeStyle=this.activeObj.strokeSettings.strokeColor,t.beginPath(),t.rect(this.activeObj.activePoint.startX,this.activeObj.activePoint.startY,this.activeObj.activePoint.width,this.activeObj.activePoint.height),""!==this.activeObj.strokeSettings.fillColor&&(t.fillStyle=this.activeObj.strokeSettings.fillColor,t.fill()),t.rect(this.activeObj.activePoint.startX+this.activeObj.strokeSettings.strokeWidth,this.activeObj.activePoint.startY+this.activeObj.strokeSettings.strokeWidth,this.activeObj.activePoint.width-2*this.activeObj.strokeSettings.strokeWidth,this.activeObj.activePoint.height-2*this.activeObj.strokeSettings.strokeWidth),t.fillStyle=this.activeObj.strokeSettings.strokeColor,t.fill("evenodd"),t.closePath()},e.prototype.drawSelection=function(t,e){this.upperContext.strokeStyle=this.themeColl[this.theme].primaryColor,this.upperContext.beginPath(),this.activeObj.horTopInnerLine={startX:this.activeObj.activePoint.startX,startY:this.activeObj.activePoint.startY+e,endX:this.activeObj.activePoint.endX,endY:this.activeObj.activePoint.endY+e},this.activeObj.horBottomInnerLine={startX:this.activeObj.activePoint.startX,startY:this.activeObj.activePoint.startY+2*e,endX:this.activeObj.activePoint.endX,endY:this.activeObj.activePoint.endY+2*e},this.activeObj.verLeftInnerLine={startX:this.activeObj.activePoint.startX+t,startY:this.activeObj.activePoint.startY,endX:this.activeObj.activePoint.startX+t,endY:this.activeObj.activePoint.endY},this.activeObj.verRightInnerLine={startX:this.activeObj.activePoint.startX+2*t,startY:this.activeObj.activePoint.startY,endX:this.activeObj.activePoint.startX+2*t,endY:this.activeObj.activePoint.endY},this.upperContext.moveTo(this.activeObj.horTopInnerLine.startX,this.activeObj.horTopInnerLine.startY),this.upperContext.lineTo(this.activeObj.horTopInnerLine.endX,this.activeObj.horTopInnerLine.startY),this.upperContext.moveTo(this.activeObj.horBottomInnerLine.startX,this.activeObj.horBottomInnerLine.startY),this.upperContext.lineTo(this.activeObj.horBottomInnerLine.endX,this.activeObj.horBottomInnerLine.startY),this.upperContext.moveTo(this.activeObj.verLeftInnerLine.startX,this.activeObj.verLeftInnerLine.startY),this.upperContext.lineTo(this.activeObj.verLeftInnerLine.endX,this.activeObj.verLeftInnerLine.endY),this.upperContext.moveTo(this.activeObj.verRightInnerLine.startX,this.activeObj.verRightInnerLine.startY),this.upperContext.lineTo(this.activeObj.verRightInnerLine.endX,this.activeObj.verRightInnerLine.endY),this.upperContext.stroke(),this.upperContext.closePath()},e.prototype.drawCenterCircles=function(t,e){t.lineWidth*=2,t.beginPath(),"arrow"===this.activeObj.shape||"line"===this.activeObj.shape?e%90==0&&e%180!=0?(t.moveTo(this.activeObj.topCenterCircle.startX,this.activeObj.topCenterCircle.startY),t.arc(this.activeObj.topCenterCircle.startX,this.activeObj.topCenterCircle.startY,this.activeObj.topCenterCircle.radius,0,2*Math.PI),t.moveTo(this.activeObj.bottomCenterCircle.startX,this.activeObj.bottomCenterCircle.startY),t.arc(this.activeObj.bottomCenterCircle.startX,this.activeObj.bottomCenterCircle.startY,this.activeObj.bottomCenterCircle.radius,0,2*Math.PI)):(t.moveTo(this.activeObj.centerLeftCircle.startX,this.activeObj.centerLeftCircle.startY),t.arc(this.activeObj.centerLeftCircle.startX,this.activeObj.centerLeftCircle.startY,this.activeObj.centerLeftCircle.radius,0,2*Math.PI),t.moveTo(this.activeObj.centerRightCircle.startX,this.activeObj.centerRightCircle.startY),t.arc(this.activeObj.centerRightCircle.startX,this.activeObj.centerRightCircle.startY,this.activeObj.centerRightCircle.radius,0,2*Math.PI)):(t.moveTo(this.activeObj.topCenterCircle.startX,this.activeObj.topCenterCircle.startY),t.arc(this.activeObj.topCenterCircle.startX,this.activeObj.topCenterCircle.startY,this.activeObj.topCenterCircle.radius,0,2*Math.PI),t.moveTo(this.activeObj.centerLeftCircle.startX,this.activeObj.centerLeftCircle.startY),t.arc(this.activeObj.centerLeftCircle.startX,this.activeObj.centerLeftCircle.startY,this.activeObj.centerLeftCircle.radius,0,2*Math.PI),t.moveTo(this.activeObj.centerRightCircle.startX,this.activeObj.centerRightCircle.startY),t.arc(this.activeObj.centerRightCircle.startX,this.activeObj.centerRightCircle.startY,this.activeObj.centerRightCircle.radius,0,2*Math.PI),t.moveTo(this.activeObj.bottomCenterCircle.startX,this.activeObj.bottomCenterCircle.startY),t.arc(this.activeObj.bottomCenterCircle.startX,this.activeObj.bottomCenterCircle.startY,this.activeObj.bottomCenterCircle.radius,0,2*Math.PI)),t.stroke(),t.fill(),t.closePath(),t.lineWidth/=2},e.prototype.findTarget=function(t,e,i){if("mousedown"===i.toLowerCase()||"touchstart"===i.toLowerCase()){var s=!1;this.activeObj.shape&&"crop"===this.activeObj.shape.split("-")[0]&&(s=!0),this.findTargetObj(t,e,s),this.updateCursorStyles(t,e,i)}else switch(this.dragElement.toLowerCase()){case"nw-resize":this.activeObj.topLeftCircle.startX=t,this.activeObj.topLeftCircle.startY=e;break;case"n-resize":this.activeObj.topCenterCircle.startX=t,this.activeObj.topCenterCircle.startY=e;break;case"ne-resize":this.activeObj.topRightCircle.startX=t,this.activeObj.topRightCircle.startY=e;break;case"w-resize":this.activeObj.centerLeftCircle.startX=t,this.activeObj.centerLeftCircle.startY=e;break;case"e-resize":this.activeObj.centerRightCircle.startX=t,this.activeObj.centerRightCircle.startY=e;break;case"sw-resize":this.activeObj.bottomLeftCircle.startX=t,this.activeObj.bottomLeftCircle.startY=e;break;case"s-resize":this.activeObj.bottomCenterCircle.startX=t,this.activeObj.bottomCenterCircle.startY=e;break;case"se-resize":this.activeObj.bottomRightCircle.startX=t,this.activeObj.bottomRightCircle.startY=e;break;default:this.dragPoint.startX&&this.dragPoint.startY&&(this.previousPoint.x=this.dragPoint.endX,this.previousPoint.y=this.dragPoint.endY,this.dragPoint.endX=t,this.dragPoint.endY=e)}},e.prototype.findTargetObj=function(t,e,i){var s,a=this;if(0!==this.objColl.length&&!this.currObjType.isCustomCrop&&!i){for(var o=0,r=void 0,n=0;n<this.objColl.length;n++){var h=sf.base.extend({},this.objColl[n],{},!0);t>=h.activePoint.startX-2*h.topLeftCircle.radius&&t<=h.activePoint.endX+2*h.topLeftCircle.radius&&e>=h.activePoint.startY-2*h.topLeftCircle.radius&&e<=h.activePoint.endY+2*h.topLeftCircle.radius&&(this.isTouch||"move"===this.upperCanvas.style.cursor||"grab"===this.upperCanvas.style.cursor||this.isShapeInserted?(0===o||o>t-h.activePoint.startX)&&(o=t-this.objColl[n].activePoint.startX,r=n):this.objColl[n].currIndex===this.tempActiveObj.currIndex&&(r=n))}if(sf.base.isNullOrUndefined(r))this.refreshActiveObj(),s=!1;else{this.tempObjColl=sf.base.extend([],this.objColl,[],!0),this.currObjType.isCustomCrop=!1,this.activeObj=sf.base.extend({},this.objColl[r],{},!0);var l=sf.base.extend({},this.objColl[r],{},!0);if(this.objColl.splice(r,1),0===this.degree){this.lowerContext.clearRect(0,0,this.lowerCanvas.width,this.lowerCanvas.height),this.updateBrightnessFilter(),this.lowerContext.drawImage(this.baseImg,this.srcLeft,this.srcTop,this.srcWidth,this.srcHeight,this.destLeft,this.destTop,this.destWidth,this.destHeight);var c=this.lowerContext.filter;this.lowerContext.filter="none",this.iterateObjColl(),this.activeObj=sf.base.extend({},c,{},!0),this.freehandRedraw(this.lowerContext),this.lowerContext.filter=c,this.getCurrentFlipState()}else this.callUpdateCurrentTransformedState(),this.freehandRedraw(this.lowerContext);this.clearOuterCanvas(this.lowerContext),(!sf.base.isNullOrUndefined(this.currSelectionPoint)&&"crop-circle"===this.currSelectionPoint.shape||this.isCircleCrop)&&this.cropCircle(this.lowerContext),this.setActivePoint(),this.activeObj=sf.base.extend({},l,{},!0),this.tempStrokeSettings=sf.base.extend({},this.activeObj.strokeSettings,{},!0),this.tempTextSettings=sf.base.extend({},this.activeObj.textSettings,{},!0);var d=this.updatePreviousShapeSettings(),p={action:"select",previousShapeSettings:d,currentShapeSettings:d};this.dotnetRef.invokeMethodAsync("ShapeEventAsync","OnShape",p).then((function(){a.updateShapeChangeEventArgs(p.currentShapeSettings),a.activeObj.activePoint&&(a.drawObject("duplicate",a.activeObj,null,null,!0),(a.activeObj.activePoint.startX<a.destLeft||a.activeObj.activePoint.endX>a.destLeft+a.destWidth||a.activeObj.activePoint.startY<a.destTop||a.activeObj.activePoint.endY>a.destTop+a.destHeight)&&(a.isPreventDragging=!0))})),s=!0}}return s},e.prototype.getCurrentFlipState=function(){if(0!==this.rotateFlipColl.length){var t=sf.base.extend({},this.totalPannedInternalPoint,{},!0);this.callUpdateCurrentTransformedState(),this.totalPannedInternalPoint=t}else this.callUpdateCurrentTransformedState()},e.prototype.rotateDegree=function(t){this.lowerContext.save(),this.lowerContext.clearRect(0,0,this.lowerCanvas.width,this.lowerCanvas.height),this.lowerContext.translate(this.lowerCanvas.width/2,this.lowerCanvas.height/2),this.lowerContext.rotate(Math.PI/180*t),this.lowerContext.translate(-this.lowerCanvas.width/2,-this.lowerCanvas.height/2);var e=this.lowerContext.filter;this.updateBrightnessFilter(),this.lowerContext.drawImage(this.baseImg,this.srcLeft,this.srcTop,this.srcWidth,this.srcHeight,this.destLeft,this.destTop,this.destWidth,this.destHeight),this.lowerContext.filter=e,this.lowerContext.translate(this.lowerCanvas.width/2,this.lowerCanvas.height/2),this.lowerContext.rotate(Math.PI/180*-t),this.lowerContext.translate(-this.lowerCanvas.width/2,-this.lowerCanvas.height/2),this.lowerContext.restore()},e.prototype.updateCursorStyles=function(t,e,i){var s=!1;""===this.activeObj.keyHistory||void 0!==this.activeObj.shape||this.currObjType.isCustomCrop||this.currObjType.isLine||!this.currObjType.isText||(this.activeObj.shape="text");var a,o=sf.base.extend({},this.activeObj,{},!0);sf.base.isNullOrUndefined(o.topLeftCircle)||((a=0===o.shapeDegree?this.degree:this.degree-o.shapeDegree)<0&&(a=360+a),t>=o.topLeftCircle.startX-2*o.topLeftCircle.radius&&t<=o.topLeftCircle.startX+2*o.topLeftCircle.radius&&e>=o.topLeftCircle.startY-2*o.topLeftCircle.radius&&e<=o.topLeftCircle.startY+2*o.topLeftCircle.radius&&"nw-resize"!==this.dragElement?(o.topLeftCircle.startX=o.topLeftCircle.startY=0,this.upperCanvas.style.cursor="nw-resize",s=!0,this.dragElement=this.upperCanvas.style.cursor):t>=o.topCenterCircle.startX-2*o.topLeftCircle.radius&&t<=o.topCenterCircle.startX+2*o.topLeftCircle.radius&&e>=o.topCenterCircle.startY-2*o.topLeftCircle.radius&&e<=o.topCenterCircle.startY+2*o.topLeftCircle.radius&&"n-resize"!==this.dragElement?(o.topCenterCircle.startX=o.topCenterCircle.startY=0,this.upperCanvas.style.cursor="n-resize",s=!0,this.dragElement=this.upperCanvas.style.cursor):t>=o.topRightCircle.startX-2*o.topLeftCircle.radius&&t<=o.topRightCircle.startX+2*o.topLeftCircle.radius&&e>=o.topRightCircle.startY-2*o.topLeftCircle.radius&&e<=o.topRightCircle.startY+2*o.topLeftCircle.radius&&"ne-resize"!==this.dragElement?(o.topRightCircle.startX=o.topRightCircle.startY=0,this.upperCanvas.style.cursor="ne-resize",s=!0,this.dragElement=this.upperCanvas.style.cursor):t>=o.centerLeftCircle.startX-2*o.topLeftCircle.radius&&t<=o.centerLeftCircle.startX+2*o.topLeftCircle.radius&&e>=o.centerLeftCircle.startY-2*o.topLeftCircle.radius&&e<=o.centerLeftCircle.startY+2*o.topLeftCircle.radius&&"w-resize"!==this.dragElement?(o.centerLeftCircle.startX=o.centerLeftCircle.startY=0,this.upperCanvas.style.cursor="w-resize",s=!0,this.dragElement=this.upperCanvas.style.cursor):t>=o.centerRightCircle.startX-2*o.topLeftCircle.radius&&t<=o.centerRightCircle.startX+2*o.topLeftCircle.radius&&e>=o.centerRightCircle.startY-2*o.topLeftCircle.radius&&e<=o.centerRightCircle.startY+2*o.topLeftCircle.radius&&"e-resize"!==this.dragElement?(o.centerRightCircle.startX=o.centerRightCircle.startY=0,this.upperCanvas.style.cursor="e-resize",s=!0,this.dragElement=this.upperCanvas.style.cursor):t>=o.bottomLeftCircle.startX-2*o.topLeftCircle.radius&&t<=o.bottomLeftCircle.startX+2*o.topLeftCircle.radius&&e>=o.bottomLeftCircle.startY-2*o.topLeftCircle.radius&&e<=o.bottomLeftCircle.startY+2*o.topLeftCircle.radius&&"sw-resize"!==this.dragElement?(o.bottomLeftCircle.startX=o.bottomLeftCircle.startY=0,this.upperCanvas.style.cursor="sw-resize",s=!0,this.dragElement=this.upperCanvas.style.cursor):t>=o.bottomCenterCircle.startX-2*o.topLeftCircle.radius&&t<=o.bottomCenterCircle.startX+2*o.topLeftCircle.radius&&e>=o.bottomCenterCircle.startY-2*o.topLeftCircle.radius&&e<=o.bottomCenterCircle.startY+2*o.topLeftCircle.radius&&"s-resize"!==this.dragElement?(o.bottomCenterCircle.startX=o.bottomCenterCircle.startY=0,this.upperCanvas.style.cursor="s-resize",s=!0,this.dragElement=this.upperCanvas.style.cursor):t>=o.bottomRightCircle.startX-2*o.topLeftCircle.radius&&t<=o.bottomRightCircle.startX+2*o.topLeftCircle.radius&&e>=o.bottomRightCircle.startY-2*o.topLeftCircle.radius&&e<=o.bottomRightCircle.startY+2*o.topLeftCircle.radius&&"se-resize"!==this.dragElement?(o.bottomRightCircle.startX=o.bottomRightCircle.startY=0,this.upperCanvas.style.cursor="se-resize",s=!0,this.dragElement=this.upperCanvas.style.cursor):(this.dragPoint.startX=this.previousPoint.x=this.dragPoint.endX=t,this.dragPoint.startY=this.previousPoint.y=this.dragPoint.endY=e),"arrow"!==o.shape&&"line"!==o.shape||(a%90==0&&a%180!=0?"sw-resize"===this.upperCanvas.style.cursor||"se-resize"===this.upperCanvas.style.cursor?t>=o.bottomCenterCircle.startX-2*o.topLeftCircle.radius&&t<=o.bottomCenterCircle.startX+2*o.topLeftCircle.radius&&e>=o.bottomCenterCircle.startY-2*o.topLeftCircle.radius&&e<=o.bottomCenterCircle.startY+2*o.topLeftCircle.radius&&"s-resize"!==this.dragElement&&(o.bottomCenterCircle.startX=o.bottomCenterCircle.startY=0,this.upperCanvas.style.cursor="s-resize",s=!0,this.dragElement=this.upperCanvas.style.cursor):"nw-resize"!==this.upperCanvas.style.cursor&&"ne-resize"!==this.upperCanvas.style.cursor||t>=o.topCenterCircle.startX-2*o.topLeftCircle.radius&&t<=o.topCenterCircle.startX+2*o.topLeftCircle.radius&&e>=o.topCenterCircle.startY-2*o.topLeftCircle.radius&&e<=o.topCenterCircle.startY+2*o.topLeftCircle.radius&&"n-resize"!==this.dragElement&&(o.topCenterCircle.startX=o.topCenterCircle.startY=0,this.upperCanvas.style.cursor="n-resize",s=!0,this.dragElement=this.upperCanvas.style.cursor):"nw-resize"===this.upperCanvas.style.cursor||"sw-resize"===this.upperCanvas.style.cursor?t>=o.centerLeftCircle.startX-2*o.topLeftCircle.radius&&t<=o.centerLeftCircle.startX+2*o.topLeftCircle.radius&&e>=o.centerLeftCircle.startY-2*o.topLeftCircle.radius&&e<=o.centerLeftCircle.startY+2*o.topLeftCircle.radius&&"w-resize"!==this.dragElement&&(o.centerLeftCircle.startX=o.centerLeftCircle.startY=0,this.upperCanvas.style.cursor="w-resize",s=!0,this.dragElement=this.upperCanvas.style.cursor):"ne-resize"!==this.upperCanvas.style.cursor&&"se-resize"!==this.upperCanvas.style.cursor||t>=o.centerRightCircle.startX-2*o.topLeftCircle.radius&&t<=o.centerRightCircle.startX+2*o.topLeftCircle.radius&&e>=o.centerRightCircle.startY-2*o.topLeftCircle.radius&&e<=o.centerRightCircle.startY+2*o.topLeftCircle.radius&&"e-resize"!==this.dragElement&&(o.centerRightCircle.startX=o.centerRightCircle.startY=0,this.upperCanvas.style.cursor="e-resize",s=!0,this.dragElement=this.upperCanvas.style.cursor),"nw-resize"!==this.upperCanvas.style.cursor&&"ne-resize"!==this.upperCanvas.style.cursor&&"sw-resize"!==this.upperCanvas.style.cursor&&"se-resize"!==this.upperCanvas.style.cursor||(this.updateCursorStylesForArrow(t,e),s=!1),a%90==0&&a%180!=0?"w-resize"!==this.upperCanvas.style.cursor&&"e-resize"!==this.upperCanvas.style.cursor||(this.updateCursorStylesForArrow(t,e),s=!1):"n-resize"!==this.upperCanvas.style.cursor&&"s-resize"!==this.upperCanvas.style.cursor||(this.updateCursorStylesForArrow(t,e),s=!1)),this.previousPoint.x=this.previousPoint.y=this.diffPoint.x=this.diffPoint.y=0,"touchstart"===i?(s||t>=o.activePoint.startX&&t<=o.activePoint.endX&&e>=o.activePoint.startY&&e<=o.activePoint.endY)&&(this.currObjType.isDragging=!0):this.currObjType.isDragging=!0)},e.prototype.updateCursorStylesForArrow=function(t,e){this.upperCanvas.style.cursor="move",this.dragElement="",this.dragPoint.startX=this.previousPoint.x=this.dragPoint.endX=t,this.dragPoint.startY=this.previousPoint.y=this.dragPoint.endY=e},e.prototype.drawCropRatio=function(){var t,e,i,s;switch(this.zoomFactor>0&&!sf.base.isNullOrUndefined(this.currentSelectionPoint)?(this.destLeft+this.destLeft+this.destWidth<=this.lowerCanvas.clientWidth?(i=this.destWidth,this.destLeft<0&&(i+=2*this.destLeft)):i=this.lowerCanvas.clientWidth,this.destTop+this.destTop+this.destHeight<=this.lowerCanvas.clientHeight?(s=this.destHeight,this.destTop<0&&(s+=2*this.destTop)):s=this.lowerCanvas.clientHeight,0!==this.degree&&(this.isAllowCropPan=!0)):(i=this.destWidth,s=this.destHeight,this.destLeft<0&&(i+=this.destLeft),this.destTop<0&&(s+=this.destTop),"crop-square"!==this.currObjType.shape.toLowerCase()&&"crop-circle"!==this.currObjType.shape.toLowerCase()&&(this.destLeft+this.destWidth>this.lowerCanvas.width&&(i-=this.destLeft+this.destWidth-this.lowerCanvas.width),this.destTop+this.destHeight>this.lowerCanvas.height&&(s-=this.destTop+this.destHeight-this.lowerCanvas.height))),this.currObjType.shape.toLowerCase()){case"crop-square":case"crop-circle":this.setDragDirection(i,s),i===this.destWidth&&s===this.destHeight&&(this.activeObj.activePoint.startX+=this.destLeft,this.activeObj.activePoint.startY+=this.destTop,this.activeObj.activePoint.endX+=this.destLeft,this.activeObj.activePoint.endY+=this.destTop),this.lowerCanvas.width>this.lowerCanvas.height?(this.activeObj.activePoint.height=this.activeObj.activePoint.endY-this.activeObj.activePoint.startY,this.activeObj.activePoint.width=this.activeObj.activePoint.height,this.activeObj.activePoint.endX=this.activeObj.activePoint.startX+this.activeObj.activePoint.width):(this.activeObj.activePoint.width=this.activeObj.activePoint.endX-this.activeObj.activePoint.startX,this.activeObj.activePoint.height=this.activeObj.activePoint.width,this.activeObj.activePoint.endY=this.activeObj.activePoint.startY+this.activeObj.activePoint.height);break;case"crop-3:2":t=3,e=2;break;case"crop-4:3":t=4,e=3;break;case"crop-5:4":t=5,e=4;break;case"crop-7:5":t=7,e=5;break;case"crop-16:9":t=16,e=9}if(void 0!==t&&void 0!==e&&(this.calcShapeRatio(t,e,i,s),i===this.destWidth&&s===this.destHeight&&this.updatePoints()),!sf.base.isNullOrUndefined(this.currentSelectionPoint)){if(this.activeObj.activePoint.startX<this.currentSelectionPoint.activePoint.startX){var a=this.currentSelectionPoint.activePoint.startX-this.activeObj.activePoint.startX;this.activeObj.activePoint.startX+=a,this.activeObj.activePoint.endX+=a}if(this.activeObj.activePoint.startY<this.currentSelectionPoint.activePoint.startY){a=this.currentSelectionPoint.activePoint.startY-this.activeObj.activePoint.startY;this.activeObj.activePoint.startY+=a,this.activeObj.activePoint.endY+=a}if(this.activeObj.activePoint.endX>this.currentSelectionPoint.activePoint.endX){a=this.activeObj.activePoint.endX-this.currentSelectionPoint.activePoint.endX;this.activeObj.activePoint.startX-=a,this.activeObj.activePoint.endX-=a}if(this.activeObj.activePoint.endY>this.currentSelectionPoint.activePoint.endY){a=this.activeObj.activePoint.endY-this.currentSelectionPoint.activePoint.endY;this.activeObj.activePoint.startY-=a,this.activeObj.activePoint.endY-=a}this.activeObj.activePoint.startX=(this.lowerCanvas.clientWidth-this.activeObj.activePoint.width)/2,this.activeObj.activePoint.startY=(this.lowerCanvas.clientHeight-this.activeObj.activePoint.height)/2,this.activeObj.activePoint.endX=this.activeObj.activePoint.startX+this.activeObj.activePoint.width,this.activeObj.activePoint.endY=this.activeObj.activePoint.startY+this.activeObj.activePoint.height}if(0===this.zoomFactor){if(this.activeObj.activePoint.startX<this.destLeft){a=this.destLeft-this.activeObj.activePoint.startX+7.5;this.activeObj.activePoint.startX+=a,this.activeObj.activePoint.endX+=a}if(this.activeObj.activePoint.startY<this.destTop){a=this.destTop-this.activeObj.activePoint.startY+7.5;this.activeObj.activePoint.startY+=a,this.activeObj.activePoint.endY+=a}this.activeObj.activePoint.width=this.activeObj.activePoint.endX-this.activeObj.activePoint.startX,this.activeObj.activePoint.height=this.activeObj.activePoint.endY-this.activeObj.activePoint.startY}},e.prototype.setDragDirection=function(t,e){this.destWidth>this.destHeight?(this.activeObj.activePoint.startX=this.dragPoint.startX=t/2-e/2+7.5,this.activeObj.activePoint.startY=this.dragPoint.startY=e/2-e/2+7.5,this.activeObj.activePoint.endX=t/2+e/2-7.5,this.activeObj.activePoint.endY=e/2+e/2-7.5):(this.activeObj.activePoint.startY=this.dragPoint.startX=e/2-t/2+7.5,this.activeObj.activePoint.endY=e/2+t/2-7.5,this.activeObj.activePoint.startX=this.dragPoint.startX=7.5,this.activeObj.activePoint.endX=t-7.5)},e.prototype.updatePoints=function(){this.activeObj.activePoint.startX+=this.destLeft,this.activeObj.activePoint.startY+=this.destTop,this.activeObj.activePoint.endX+=this.destLeft,this.activeObj.activePoint.endY+=this.destTop,this.activeObj.activePoint.width=this.activeObj.activePoint.endX-this.activeObj.activePoint.startX,this.activeObj.activePoint.height=this.activeObj.activePoint.endY-this.activeObj.activePoint.startY},e.prototype.calcShapeRatio=function(t,e,i,s){for(var a=i,o=s,r=a>=o?a:o,n=r*(t/e),h=r,l=this.getScale(n,a),c=[],d=0;d<2;d++)0===d?c.push(n*l):c.push(h*l);n=c[0],h=c[1];var p=this.getScale(h,o),v=[];for(d=0;d<2;d++)0===d?v.push(n*p):v.push(h*p);n=v[0],h=v[1],this.activeObj.activePoint.width=n,this.activeObj.activePoint.height=h,this.activeObj.activePoint.startX=7.5+(this.dragPoint.startX=(a-n)/2),this.activeObj.activePoint.startY=7.5+(this.dragPoint.startY=(o-h)/2),this.activeObj.activePoint.endX=(a-n)/2+n-7.5,this.activeObj.activePoint.endY=(o-h)/2+h-7.5,this.activeObj.activePoint.startX<this.destLeft&&this.destLeft+this.destWidth>this.lowerCanvas.clientWidth&&(this.activeObj.activePoint.startX=this.destLeft,this.activeObj.activePoint.endX=this.activeObj.activePoint.startX+n),this.activeObj.activePoint.startY<this.destTop&&this.destTop+this.destHeight>this.lowerCanvas.clientHeight&&(this.activeObj.activePoint.startY=this.destTop,this.activeObj.activePoint.endY=this.activeObj.activePoint.startY+h),this.activeObj.activePoint.width=this.activeObj.activePoint.endX-this.activeObj.activePoint.startX,this.activeObj.activePoint.height=this.activeObj.activePoint.endY-this.activeObj.activePoint.startY},e.prototype.getScale=function(t,e){return t>e?e/t:1},e.prototype.calcMaxDimension=function(t,e){var i=this.element.clientWidth,s=this.element.clientHeight-this.toolbarHeight;s=sf.base.Browser.isDevice?s-this.toolbarHeight:s;var a=(i-=30)/t,o=(s-=30)/e,r=Math.min(t,i),n=Math.min(e,s);return a<1&&a<o?(r=t*a,n=e*a):o<1&&o<a&&(r=t*o,n=e*o),{width:r,height:n}},e.prototype.setMaximumDimension=function(t,e){var i,s;t%90==0&&t%180!=0?(i=this.baseImg.height,s=this.baseImg.width):t%180!=0&&0!==t||(i=this.baseImg.width,s=this.baseImg.height),e.width=i,e.height=s;var a=this.calcMaxDimension(i,s);e.style.maxWidth=a.width+"px",e.style.maxHeight=a.height+"px"},e.prototype.setCursor=function(t,e){var i,s=!1;if(void 0!==this.activeObj.horTopLine){void 0!==this.activeObj.shape&&(i=this.activeObj.shape.split("-")),(void 0===i&&this.currObjType.isCustomCrop||void 0!==i&&"crop"===i[0])&&(s=!0),!s&&this.togglePan&&(this.lowerCanvas.style.cursor=this.upperCanvas.style.cursor="grab");var a=this.upperCanvas.style.cursor,o=sf.base.extend({},this.activeObj,{},!0),r=void 0;(r=0===o.shapeDegree?this.degree:this.degree-o.shapeDegree)<0&&(r=360+r),t>=o.topLeftCircle.startX-2*o.topLeftCircle.radius&&t<=o.topLeftCircle.startX+2*o.topLeftCircle.radius&&e>=o.topLeftCircle.startY-2*o.topLeftCircle.radius&&e<=o.topLeftCircle.startY+2*o.topLeftCircle.radius?this.upperCanvas.style.cursor="nw-resize":t>=o.topCenterCircle.startX-2*o.topLeftCircle.radius&&t<=o.topCenterCircle.startX+2*o.topLeftCircle.radius&&e>=o.topCenterCircle.startY-2*o.topLeftCircle.radius&&e<=o.topCenterCircle.startY+2*o.topLeftCircle.radius?this.upperCanvas.style.cursor="n-resize":t>=o.topRightCircle.startX-2*o.topLeftCircle.radius&&t<=o.topRightCircle.startX+2*o.topLeftCircle.radius&&e>=o.topRightCircle.startY-2*o.topLeftCircle.radius&&e<=o.topRightCircle.startY+2*o.topLeftCircle.radius?this.upperCanvas.style.cursor="ne-resize":t>=o.centerLeftCircle.startX-2*o.topLeftCircle.radius&&t<=o.centerLeftCircle.startX+2*o.topLeftCircle.radius&&e>=o.centerLeftCircle.startY-2*o.topLeftCircle.radius&&e<=o.centerLeftCircle.startY+2*o.topLeftCircle.radius?this.upperCanvas.style.cursor="w-resize":t>=o.centerRightCircle.startX-2*o.topLeftCircle.radius&&t<=o.centerRightCircle.startX+2*o.topLeftCircle.radius&&e>=o.centerRightCircle.startY-2*o.topLeftCircle.radius&&e<=o.centerRightCircle.startY+2*o.topLeftCircle.radius?this.upperCanvas.style.cursor="e-resize":t>=o.bottomLeftCircle.startX-2*o.topLeftCircle.radius&&t<=o.bottomLeftCircle.startX+2*o.topLeftCircle.radius&&e>=o.bottomLeftCircle.startY-2*o.topLeftCircle.radius&&e<=o.bottomLeftCircle.startY+2*o.topLeftCircle.radius?this.upperCanvas.style.cursor="sw-resize":t>=o.bottomCenterCircle.startX-2*o.topLeftCircle.radius&&t<=o.bottomCenterCircle.startX+2*o.topLeftCircle.radius&&e>=o.bottomCenterCircle.startY-2*o.topLeftCircle.radius&&e<=o.bottomCenterCircle.startY+2*o.topLeftCircle.radius?this.upperCanvas.style.cursor="s-resize":t>=o.bottomRightCircle.startX-2*o.topLeftCircle.radius&&t<=o.bottomRightCircle.startX+2*o.topLeftCircle.radius&&e>=o.bottomRightCircle.startY-2*o.topLeftCircle.radius&&e<=o.bottomRightCircle.startY+2*o.topLeftCircle.radius?this.upperCanvas.style.cursor="se-resize":t>=o.activePoint.startX&&t<=o.activePoint.endX&&e>=o.activePoint.startY&&e<=o.activePoint.endY?this.upperCanvas.style.cursor=s?"grab":"move":(this.currObjType.isCustomCrop&&(this.upperCanvas.style.cursor="crosshair"),this.upperCanvas.style.cursor="default"),"arrow"!==o.shape&&"line"!==o.shape||(r%90==0&&r%180!=0?"sw-resize"===this.upperCanvas.style.cursor||"se-resize"===this.upperCanvas.style.cursor?t>=o.bottomCenterCircle.startX-2*o.topLeftCircle.radius&&t<=o.bottomCenterCircle.startX+2*o.topLeftCircle.radius&&e>=o.bottomCenterCircle.startY-2*o.topLeftCircle.radius&&e<=o.bottomCenterCircle.startY+2*o.topLeftCircle.radius&&(this.upperCanvas.style.cursor="s-resize"):"nw-resize"!==this.upperCanvas.style.cursor&&"ne-resize"!==this.upperCanvas.style.cursor||t>=o.topCenterCircle.startX-2*o.topLeftCircle.radius&&t<=o.topCenterCircle.startX+2*o.topLeftCircle.radius&&e>=o.topCenterCircle.startY-2*o.topLeftCircle.radius&&e<=o.topCenterCircle.startY+2*o.topLeftCircle.radius&&(this.upperCanvas.style.cursor="n-resize"):"nw-resize"===this.upperCanvas.style.cursor||"sw-resize"===this.upperCanvas.style.cursor?t>=o.centerLeftCircle.startX-2*o.topLeftCircle.radius&&t<=o.centerLeftCircle.startX+2*o.topLeftCircle.radius&&e>=o.centerLeftCircle.startY-2*o.topLeftCircle.radius&&e<=o.centerLeftCircle.startY+2*o.topLeftCircle.radius&&(this.upperCanvas.style.cursor="w-resize"):"ne-resize"!==this.upperCanvas.style.cursor&&"se-resize"!==this.upperCanvas.style.cursor||t>=o.centerRightCircle.startX-2*o.topLeftCircle.radius&&t<=o.centerRightCircle.startX+2*o.topLeftCircle.radius&&e>=o.centerRightCircle.startY-2*o.topLeftCircle.radius&&e<=o.centerRightCircle.startY+2*o.topLeftCircle.radius&&(this.upperCanvas.style.cursor="e-resize"),"nw-resize"!==this.upperCanvas.style.cursor&&"ne-resize"!==this.upperCanvas.style.cursor&&"sw-resize"!==this.upperCanvas.style.cursor&&"se-resize"!==this.upperCanvas.style.cursor||(this.upperCanvas.style.cursor="move"),r%90==0&&r%180!=0?"w-resize"!==this.upperCanvas.style.cursor&&"e-resize"!==this.upperCanvas.style.cursor||(this.upperCanvas.style.cursor="move"):"n-resize"!==this.upperCanvas.style.cursor&&"s-resize"!==this.upperCanvas.style.cursor||(this.upperCanvas.style.cursor="move")),"default"===a&&"default"===this.upperCanvas.style.cursor&&s&&(this.upperCanvas.style.cursor="grab"),"grab"===a&&"default"===this.upperCanvas.style.cursor&&(this.upperCanvas.style.cursor="grab")}else this.togglePan&&!this.togglePen?this.lowerCanvas.style.cursor=this.upperCanvas.style.cursor="grab":this.currObjType.isCustomCrop||this.togglePen?this.upperCanvas.style.cursor="crosshair":this.upperCanvas.style.cursor="default";if("default"===this.upperCanvas.style.cursor||"grab"===this.upperCanvas.style.cursor){a=this.upperCanvas.style.cursor;this.objColl.length>0&&("grab"!==this.upperCanvas.style.cursor||!s)&&this.setCursorFromObj(t,e,this.objColl),"grab"===a&&"default"===this.upperCanvas.style.cursor&&(this.upperCanvas.style.cursor="grab")}"default"!==this.upperCanvas.style.cursor&&"grab"!==this.upperCanvas.style.cursor||sf.base.isNullOrUndefined(this.pointColl[0])||"grab"===this.upperCanvas.style.cursor&&s||this.setCursorForFreehandDrawing(t,e)},e.prototype.setCursorForFreehandDrawing=function(t,e){var i=!1;this.freehandDrawHoveredIndex=-1;for(var s=0;s<this.freehandCounter;s++){this.points=sf.base.extend([],this.pointColl[s].points,[]),this.pointCounter=0;for(var a=this.points.length,o=0;o<a;o++)if(0!==o){var r=!1;if(sf.base.isNullOrUndefined(this.points[o-1])||sf.base.isNullOrUndefined(this.points[o])||(r=this.isInside(t,e,this.points[o-1].x,this.points[o-1].y,this.points[o].x,this.points[o].y)),r){this.isFreehandDrawingPoint=!0,this.freehandDrawHoveredIndex=s,this.hoverFreehandraw(),this.upperCanvas.style.cursor="pointer",i=!0;break}if(!this.isFreehandDrawEditing||this.pointColl[s].isSelected){if(this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),sf.base.isNullOrUndefined(this.activeObj.shape)||"none"!==this.textArea.style.display||this.drawObject("duplicate",this.activeObj),this.isFreehandDrawEditing){var n=this.pointColl[s].strokeColor=this.selectedFreehandColor;this.hoverFreehandraw(n,this.pointColl[s].strokeWidth)}else this.freehandDrawHoveredIndex=null;this.isFreehandDrawingPoint=!1}}else{if(t>this.points[o].x-this.pointColl[s].strokeWidth&&t<this.points[o].x+this.pointColl[s].strokeWidth&&e>this.points[o].y-this.pointColl[s].strokeWidth&&e<this.points[o].y+this.pointColl[s].strokeWidth){this.isFreehandDrawingPoint=!0,this.freehandDrawHoveredIndex=s,this.hoverFreehandraw(),this.upperCanvas.style.cursor="pointer",i=!0;break}if(!this.isFreehandDrawEditing||this.pointColl[s].isSelected){if(this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),sf.base.isNullOrUndefined(this.activeObj.shape)||"none"!==this.textArea.style.display||this.drawObject("duplicate",this.activeObj),this.isFreehandDrawEditing){n="#fff"===this.pointColl[s].strokeColor?"#42a5f5":this.pointColl[s].strokeColor;this.hoverFreehandraw(n,this.pointColl[s].strokeWidth)}this.isFreehandDrawingPoint=!1}}if(i)break}},e.prototype.setCursorFromObj=function(t,e,i){for(var s=0;s<i.length;s++){var a=sf.base.extend({},i[s],{},!0);if(t>=a.topLeftCircle.startX-2*a.topLeftCircle.radius&&t<=a.topLeftCircle.startX+2*a.topLeftCircle.radius&&e>=a.topLeftCircle.startY-2*a.topLeftCircle.radius&&e<=a.topLeftCircle.startY+2*a.topLeftCircle.radius){this.upperCanvas.style.cursor="nw-resize";break}if(t>=a.topCenterCircle.startX-2*a.topLeftCircle.radius&&t<=a.topCenterCircle.startX+2*a.topLeftCircle.radius&&e>=a.topCenterCircle.startY-2*a.topLeftCircle.radius&&e<=a.topCenterCircle.startY+2*a.topLeftCircle.radius){this.upperCanvas.style.cursor="n-resize";break}if(t>=a.topRightCircle.startX-2*a.topLeftCircle.radius&&t<=a.topRightCircle.startX+2*a.topLeftCircle.radius&&e>=a.topRightCircle.startY-2*a.topLeftCircle.radius&&e<=a.topRightCircle.startY+2*a.topLeftCircle.radius){this.upperCanvas.style.cursor="ne-resize";break}if(t>=a.centerLeftCircle.startX-2*a.topLeftCircle.radius&&t<=a.centerLeftCircle.startX+2*a.topLeftCircle.radius&&e>=a.centerLeftCircle.startY-2*a.topLeftCircle.radius&&e<=a.centerLeftCircle.startY+2*a.topLeftCircle.radius){this.upperCanvas.style.cursor="w-resize";break}if(t>=a.centerRightCircle.startX-2*a.topLeftCircle.radius&&t<=a.centerRightCircle.startX+2*a.topLeftCircle.radius&&e>=a.centerRightCircle.startY-2*a.topLeftCircle.radius&&e<=a.centerRightCircle.startY+2*a.topLeftCircle.radius){this.upperCanvas.style.cursor="e-resize";break}if(t>=a.bottomLeftCircle.startX-2*a.topLeftCircle.radius&&t<=a.bottomLeftCircle.startX+2*a.topLeftCircle.radius&&e>=a.bottomLeftCircle.startY-2*a.topLeftCircle.radius&&e<=a.bottomLeftCircle.startY+2*a.topLeftCircle.radius){this.upperCanvas.style.cursor="sw-resize";break}if(t>=a.bottomCenterCircle.startX-2*a.topLeftCircle.radius&&t<=a.bottomCenterCircle.startX+2*a.topLeftCircle.radius&&e>=a.bottomCenterCircle.startY-2*a.topLeftCircle.radius&&e<=a.bottomCenterCircle.startY+2*a.topLeftCircle.radius){this.upperCanvas.style.cursor="s-resize";break}if(t>=a.bottomRightCircle.startX-2*a.topLeftCircle.radius&&t<=a.bottomRightCircle.startX+2*a.topLeftCircle.radius&&e>=a.bottomRightCircle.startY-2*a.topLeftCircle.radius&&e<=a.bottomRightCircle.startY+2*a.topLeftCircle.radius){this.upperCanvas.style.cursor="se-resize";break}if(t>=a.activePoint.startX&&t<=a.activePoint.endX&&e>=a.activePoint.startY&&e<=a.activePoint.endY){this.upperCanvas.style.cursor="move";break}this.currObjType.isCustomCrop&&(this.upperCanvas.style.cursor="crosshair"),this.upperCanvas.style.cursor="default"}},e.prototype.isInside=function(t,e,i,s,a,o){var r=Math.min(i,a),n=Math.max(i,a),h=Math.min(s,o),l=Math.max(s,o);return r<=t&&t<=n&&h<=e&&e<=l},e.prototype.downloadImg=function(t,e){var i=document.createElement("a");i.href=t,i.target="_parent",i.download=e,(document.body||document.documentElement).appendChild(i),i.click(),i.parentNode.removeChild(i)},e.prototype.toSVGImg=function(t){sf.popups.showSpinner(this.element),this.element.style.opacity="0.5";var e=this.exportChangesToCanvas(),i=e.toDataURL();sf.popups.hideSpinner(this.element),this.element.style.opacity="1";var s=document.createElementNS("http://www.w3.org/2000/svg","svg");s.setAttribute("width",e.style.maxWidth),s.setAttribute("height",e.style.maxHeight);var a=document.createElementNS("http://www.w3.org/2000/svg","image");a.setAttributeNS(null,"height",e.height.toString()),a.setAttributeNS(null,"width",e.width.toString()),a.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",i),s.appendChild(a);var o='<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="'+e.width+'" height="'+e.height+'">',r=s.innerHTML,n="data:image/svg+xml;base64,"+btoa(o+r+"</svg>");return null===t?n:(this.downloadImg(n,t+".svg"),null)},e.prototype.toBlobFn=function(t,e){var i=this;sf.popups.showSpinner(this.element),this.element.style.opacity="0.5",this.exportChangesToCanvas().toBlob((function(s){var a=URL.createObjectURL(s);i.downloadImg(a,t+"."+e),sf.popups.hideSpinner(i.element),i.element.style.opacity="1"}),"image/png")},e.prototype.exportChangesToCanvas=function(){var t,e=this.calcRatio(),i=this.lowerContext.filter;if("none"!==this.lowerContext.filter){var s=this.lowerContext.filter.split(" "),a=parseFloat(s[5].split("(")[1]);a*=(e.width+e.height)/2,s[5]="blur("+a+"px)",this.lowerContext.filter=s.join(" ")}var o=this.createElement("canvas",{id:this.element.id+"_tempCanvas",attrs:{name:"canvasImage"}}),r=o.getContext("2d");if(r.filter=this.lowerContext.filter,sf.base.isNullOrUndefined(this.currSelectionPoint)){o.width=this.baseImg.width,o.height=this.baseImg.height,t=this.calcMaxDimension(this.baseImg.width,this.baseImg.height),o.style.maxWidth=t.width+"px",o.style.maxHeight=t.height+"px",r.filter=this.lowerContext.filter;var n=this.lowerContext.filter;this.updateBrightnessFilter(),r.drawImage(this.baseImg,this.srcLeft,this.srcTop,this.srcWidth,this.srcHeight,0,0,this.baseImg.width,this.baseImg.height),this.lowerContext.filter=n}else{o.width=this.destWidth,o.height=this.destHeight,r.filter=this.lowerContext.filter;n=this.lowerContext.filter;this.updateBrightnessFilter(),r.drawImage(this.baseImg,this.srcLeft,this.srcTop,this.srcWidth,this.srcHeight,0,0,this.destWidth,this.destHeight),this.lowerContext.filter=n}if(0===this.degree&&""===this.currFlipState||(this.updateSaveContext(r),this.exportTransformedImage(r)),this.objColl.length>0){n=r.filter;r.filter="none";for(var h=sf.base.extend([],this.objColl,[],!0),l=0;l<this.objColl.length;l++)this.objColl[l].activePoint.startX-=this.destLeft,this.objColl[l].activePoint.startY-=this.destTop,this.objColl[l].activePoint.endX-=this.destLeft,this.objColl[l].activePoint.endY-=this.destTop,this.objColl[l].activePoint.width=this.objColl[l].activePoint.endX-this.objColl[l].activePoint.startX,this.objColl[l].activePoint.height=this.objColl[l].activePoint.endY-this.objColl[l].activePoint.startY,sf.base.isNullOrUndefined(this.currSelectionPoint)&&(this.objColl[l].activePoint.startX*=e.width,this.objColl[l].activePoint.startY*=e.height,this.objColl[l].activePoint.endX*=e.width,this.objColl[l].activePoint.endY*=e.height,this.objColl[l].activePoint.width=this.objColl[l].activePoint.endX-this.objColl[l].activePoint.startX,this.objColl[l].activePoint.height=this.objColl[l].activePoint.endY-this.objColl[l].activePoint.startY,this.objColl[l].strokeSettings.strokeWidth*=(e.width+e.height)/2,"text"===this.objColl[l].shape&&(this.objColl[l].textSettings.fontSize*=(e.width+e.height)/2)),this.drawObject("saveContext",this.objColl[l],null,null,!0,r);r.filter=n,this.refreshActiveObj(),this.objColl=h}if(this.freehandCounter>0){for(var c=sf.base.extend({},this.pointColl,{},!0),d=0;d<this.freehandCounter;d++){this.points=sf.base.extend([],this.pointColl[d].points,[]),this.pointCounter=0;var p=this.points.length;if(sf.base.isNullOrUndefined(this.currSelectionPoint)){this.pointColl[d].strokeWidth*=(e.width+e.height)/2;for(var v=0;v<p;v++)this.points[v].x=(this.points[v].x-this.destLeft)*e.width,this.points[v].y=(this.points[v].y-this.destTop)*e.height}else for(v=0;v<p;v++)this.points[v].x-=this.destLeft,this.points[v].y-=this.destTop}this.freehandRedraw(r),this.pointColl=c}return this.isCircleCrop&&this.cropCircle(r,!0),this.lowerContext.filter=i,o},e.prototype.exportTransformedImage=function(t){for(var e=this.degree,i=0;i<this.rotateFlipColl.length;i++)"number"==typeof this.rotateFlipColl[i]?this.exportRotate(t,this.rotateFlipColl[i]):"horizontal"===this.rotateFlipColl[i]?this.exportHorizontalFlip(t):"vertical"===this.rotateFlipColl[i]&&this.exportVerticalFlip(t);this.degree=e},e.prototype.exportRotate=function(t,e){sf.base.isNullOrUndefined(this.currSelectionPoint)?(this.setMaximumDimension(this.degree,t.canvas),t.translate(t.canvas.width/2,t.canvas.height/2),t.rotate(Math.PI/180*e),t.drawImage(this.inMemoryCanvas,this.srcLeft,this.srcTop,this.srcWidth,this.srcHeight,-t.canvas.height/2,-t.canvas.width/2,t.canvas.height,t.canvas.width)):(t.translate(t.canvas.width/2,t.canvas.height/2),t.rotate(Math.PI/180*e),t.drawImage(this.inMemoryCanvas,-t.canvas.height/2,-t.canvas.width/2,t.canvas.height,t.canvas.width)),this.updateSaveContext(t)},e.prototype.exportHorizontalFlip=function(t){t.translate(t.canvas.width,0),t.scale(-1,1),t.drawImage(this.inMemoryCanvas,0,0),this.updateSaveContext(t)},e.prototype.exportVerticalFlip=function(t){t.translate(0,t.canvas.height),t.scale(1,-1),t.drawImage(this.inMemoryCanvas,0,0),this.updateSaveContext(t)},e.prototype.updateSaveContext=function(t){t.setTransform(1,0,0,1,0,0);var e=t.getImageData(0,0,t.canvas.width,t.canvas.height);this.inMemoryCanvas.width=e.width,this.inMemoryCanvas.height=e.height,this.inMemoryContext.putImageData(e,0,0)},e.prototype.addLetter=function(t){if("none"===this.textArea.style.display&&(this.currObjType.isText||"text"===this.activeObj.shape)){"Backspace"===t?this.keyHistory=this.keyHistory.slice(0,-1):this.keyHistory+=t,this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),this.updateFontStyles();var e=this.upperContext.measureText(this.keyHistory+this.tempKeyHistory).width+.5*this.activeObj.textSettings.fontSize,i=this.activeObj.textSettings.fontSize+.25*this.activeObj.textSettings.fontSize;this.upperContext.fillText(this.keyHistory+this.tempKeyHistory,this.activeObj.activePoint.startX,this.activeObj.activePoint.startY+this.activeObj.textSettings.fontSize),this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),this.currObjType.isText=!0,this.setActivePoint(e,i)}},e.prototype.updateFontStyles=function(t){this.upperContext.strokeStyle=this.activeObj.strokeSettings.strokeColor,this.upperContext.fillStyle=this.activeObj.strokeSettings.strokeColor;var e="";this.activeObj.textSettings.bold&&(e="bold "),this.activeObj.textSettings.italic&&(e="italic "),this.activeObj.textSettings.bold&&this.activeObj.textSettings.italic&&(e="italic bold ");var i=t?parseFloat(this.textArea.style.fontSize):this.activeObj.textSettings.fontSize,s="block"===this.textArea.style.display?this.textArea.style.fontFamily:this.activeObj.textSettings.fontFamily;this.upperContext.font=e+i+"px "+s},e.prototype.textFlipDegree=function(t,e,i){for(var s=this.activeObj.keyHistory.split("\n"),a=(this.activeObj.textSettings.fontSize*s.length-this.activeObj.textSettings.fontSize*s.length)/s.length,o=.85*this.activeObj.textSettings.fontSize+a,r=0;r<s.length;r++){var n=s[r];r>0&&(1===r&&(o-=.85*this.activeObj.textSettings.fontSize),o+=this.activeObj.textSettings.fontSize+.15*this.activeObj.textSettings.fontSize),t.fillText(n,e+.15*this.activeObj.textSettings.fontSize,i+o+(r>0?.25*this.activeObj.textSettings.fontSize:.35*-this.activeObj.textSettings.fontSize))}},e.prototype.rotateText=function(t){var e,i=this.activeObj.activePoint.startX,s=this.activeObj.activePoint.startY;if((e=0===this.activeObj.shapeDegree?this.degree:this.degree-this.activeObj.shapeDegree)<0&&(e=360+e),e%360!=0||-360===this.degree&&""!==this.currFlipState)e%90==0&&e%180!=0?(t.translate(this.lowerCanvas.width/2,this.lowerCanvas.height/2),t.rotate(Math.PI/180*e),t.translate(-this.lowerCanvas.height/2,-this.lowerCanvas.width/2),e%90==0&&e%270!=0?(s=this.lowerCanvas.width-this.activeObj.activePoint.endX+.4*this.activeObj.textSettings.fontSize,i=this.activeObj.activePoint.startY):e%270==0&&(i=this.lowerCanvas.height-this.activeObj.activePoint.endY,s=this.activeObj.activePoint.startX+.4*this.activeObj.textSettings.fontSize),this.textFlipDegree(t,i,s),t.translate(this.lowerCanvas.height/2,this.lowerCanvas.width/2),t.rotate(Math.PI/180*-e),t.translate(-this.lowerCanvas.width/2,-this.lowerCanvas.height/2)):(t.translate(this.lowerCanvas.width/2,this.lowerCanvas.height/2),t.rotate(Math.PI/180*e),i=this.lowerCanvas.width-this.activeObj.activePoint.endX,s=this.lowerCanvas.height-this.activeObj.activePoint.endY+.4*this.activeObj.textSettings.fontSize,t.translate(-this.lowerCanvas.width/2,-this.lowerCanvas.height/2),this.textFlipDegree(t,i,s),t.translate(this.lowerCanvas.width/2,this.lowerCanvas.height/2),t.rotate(Math.PI/180*-e),t.translate(-this.lowerCanvas.width/2,-this.lowerCanvas.height/2));else{i=this.activeObj.activePoint.startX+.15*this.activeObj.textSettings.fontSize,s=this.activeObj.activePoint.startY+(this.activeObj.activePoint.endY-this.activeObj.activePoint.startY);for(var a=this.activeObj.keyHistory.split("\n"),o=0;o<a.length;o++)s=this.activeObj.activePoint.startY+(o*this.activeObj.textSettings.fontSize+.25*this.activeObj.textSettings.fontSize),t.fillText(a[o],i,s)}360!==this.degree&&-360!==this.degree||(this.degree=0)},e.prototype.redrawObj=function(t){if(this.objColl.length>0)if("horizontal"===t||"vertical"===t||"Horizontal"===t||"Vertical"===t||"horizontalVertical"===t||"verticalHorizontal"===t)this.updateCurrentActiveObjPoint(t.toLowerCase());else if("number"==typeof t){this.updateCurrentActiveObjPoint(t);var e=this.lowerContext.filter;this.lowerContext.filter=this.getDefaultFilter();for(var i=0;i<this.objColl.length;i++){"crop"!==this.objColl[i].shape.split("-")[0]&&this.apply(this.objColl[i].shape,this.objColl[i])}this.lowerContext.filter=e}},e.prototype.updateCurrentActiveObjPoint=function(t){for(var e,i=0;i<this.objColl.length;i++)if(this.activeObj.shape===this.objColl[i].shape&&this.activeObj.activePoint.startX===this.objColl[i].activePoint.startX&&this.activeObj.activePoint.startY===this.objColl[i].activePoint.startY&&this.activeObj.activePoint.endX===this.objColl[i].activePoint.endX&&this.activeObj.activePoint.endY===this.objColl[i].activePoint.endY&&this.activeObj.currIndex===this.objColl[i].currIndex){e=i;break}if("horizontal"===t||"vertical"===t||"Horizontal"===t||"Vertical"===t||"horizontalvertical"===t||"verticalhorizontal"===t){if("horizontal"===t||"Horizontal"===t)for(var s=0;s<this.objColl.length;s++)this.objColl[s].shapeFlip!==this.currFlipState&&(this.objColl[s].activePoint.startX<=this.destLeft+this.destWidth/2?(this.objColl[s].activePoint.endX=this.destLeft+this.destWidth-(this.objColl[s].activePoint.startX-this.destLeft),this.objColl[s].activePoint.startX=this.objColl[s].activePoint.endX-this.objColl[s].activePoint.width,this.updateActiveObject(this.objColl[s].activePoint,this.objColl[s])):this.objColl[s].activePoint.startX>=this.destLeft+this.destWidth/2&&(this.objColl[s].activePoint.startX=this.destLeft+(this.destLeft+this.destWidth-this.objColl[s].activePoint.endX),this.objColl[s].activePoint.endX=this.objColl[s].activePoint.startX+this.objColl[s].activePoint.width,this.updateActiveObject(this.objColl[s].activePoint,this.objColl[s])),this.objColl[s].shapeFlip=this.currFlipState,this.updateArrowDirection(this.objColl[s],"horizontal"),this.updateTrianglePoints(this.objColl[s]),this.objColl[s].imageRatio={startX:(this.objColl[s].activePoint.startX-this.destLeft)/this.destWidth,startY:(this.objColl[s].activePoint.startY-this.destTop)/this.destHeight,endX:(this.objColl[s].activePoint.endX-this.destLeft)/this.destWidth,endY:(this.objColl[s].activePoint.endY-this.destTop)/this.destHeight,width:this.destWidth/this.objColl[s].activePoint.width,height:this.destHeight/this.objColl[s].activePoint.height});else if("vertical"===t||"Vertical"===t)for(s=0;s<this.objColl.length;s++)this.objColl[s].shapeFlip!==this.currFlipState&&(this.objColl[s].activePoint.startY<=this.destTop+this.destHeight/2?(this.objColl[s].activePoint.endY=this.destTop+this.destHeight-(this.objColl[s].activePoint.startY-this.destTop),this.objColl[s].activePoint.startY=this.objColl[s].activePoint.endY-this.objColl[s].activePoint.height,this.updateActiveObject(this.objColl[s].activePoint,this.objColl[s])):this.objColl[s].activePoint.startY>=this.lowerCanvas.height/2&&(this.objColl[s].activePoint.startY=this.destTop+(this.destTop+this.destHeight-this.objColl[s].activePoint.endY),this.objColl[s].activePoint.endY=this.objColl[s].activePoint.startY+this.objColl[s].activePoint.height,this.updateActiveObject(this.objColl[s].activePoint,this.objColl[s])),this.objColl[s].shapeFlip=this.currFlipState,this.updateArrowDirection(this.objColl[s],"horizontal"),this.updateTrianglePoints(this.objColl[s]),this.objColl[s].imageRatio={startX:(this.objColl[s].activePoint.startX-this.destLeft)/this.destWidth,startY:(this.objColl[s].activePoint.startY-this.destTop)/this.destHeight,endX:(this.objColl[s].activePoint.endX-this.destLeft)/this.destWidth,endY:(this.objColl[s].activePoint.endY-this.destTop)/this.destHeight,width:this.destWidth/this.objColl[s].activePoint.width,height:this.destHeight/this.objColl[s].activePoint.height});else if("verticalhorizontal"===t||"horizontalvertical"===t)for(s=0;s<this.objColl.length;s++)this.objColl[s].shapeFlip!==this.currFlipState&&(this.objColl[s].activePoint.startX<=this.destLeft+this.destWidth/2?(this.objColl[s].activePoint.endX=this.destLeft+this.destWidth-(this.objColl[s].activePoint.startX-this.destLeft),this.objColl[s].activePoint.startX=this.objColl[s].activePoint.endX-this.objColl[s].activePoint.width,this.updateActiveObject(this.objColl[s].activePoint,this.objColl[s])):this.objColl[s].activePoint.startX>=this.destLeft+this.destWidth/2&&(this.objColl[s].activePoint.startX=this.destLeft+(this.destLeft+this.destWidth-this.objColl[s].activePoint.endX),this.objColl[s].activePoint.endX=this.objColl[s].activePoint.startX+this.objColl[s].activePoint.width,this.updateActiveObject(this.objColl[s].activePoint,this.objColl[s])),this.objColl[s].activePoint.startY<=this.destTop+this.destHeight/2?(this.objColl[s].activePoint.endY=this.destTop+this.destHeight-(this.objColl[s].activePoint.startY-this.destTop),this.objColl[s].activePoint.startY=this.objColl[s].activePoint.endY-this.objColl[s].activePoint.height,this.updateActiveObject(this.objColl[s].activePoint,this.objColl[s])):this.objColl[s].activePoint.startY>=this.lowerCanvas.height/2&&(this.objColl[s].activePoint.startY=this.destTop+(this.destTop+this.destHeight-this.objColl[s].activePoint.endY),this.objColl[s].activePoint.endY=this.objColl[s].activePoint.startY+this.objColl[s].activePoint.height,this.updateActiveObject(this.objColl[s].activePoint,this.objColl[s])),this.objColl[s].shapeFlip=this.currFlipState,this.updateArrowDirection(this.objColl[s],"horizontal"),this.updateTrianglePoints(this.objColl[s]),this.objColl[s].imageRatio={startX:(this.objColl[s].activePoint.startX-this.destLeft)/this.destWidth,startY:(this.objColl[s].activePoint.startY-this.destTop)/this.destHeight,endX:(this.objColl[s].activePoint.endX-this.destLeft)/this.destWidth,endY:(this.objColl[s].activePoint.endY-this.destTop)/this.destHeight,width:this.destWidth/this.objColl[s].activePoint.width,height:this.destHeight/this.objColl[s].activePoint.height});void 0!==e&&(this.activeObj=sf.base.extend({},this.objColl[e],{},!0))}else if(90===t)this.rotateObjColl();else if(-90===t)for(s=0;s<3;s++)this.rotateObjColl();else if("number"==typeof t)if(t>0)this.rotateObjColl();else for(s=0;s<3;s++)this.rotateObjColl()},e.prototype.rotateObjColl=function(){for(var t=0;t<this.objColl.length;t++)this.objColl[t].activePoint.startY=this.destTop+this.destHeight*this.objColl[t].imageRatio.startX,this.objColl[t].activePoint.endY=this.destTop+this.destHeight*this.objColl[t].imageRatio.endX,this.objColl[t].activePoint.startX=this.destLeft+this.destWidth-this.destWidth*this.objColl[t].imageRatio.endY,this.objColl[t].activePoint.endX=this.destLeft+this.destWidth-this.destWidth*this.objColl[t].imageRatio.startY,this.objColl[t].activePoint.width=this.objColl[t].activePoint.endX-this.objColl[t].activePoint.startX,this.objColl[t].activePoint.height=this.objColl[t].activePoint.endY-this.objColl[t].activePoint.startY,this.updateFontSize(this.objColl[t]),"arrow"===this.objColl[t].shape&&(this.updateArrowDirection(this.objColl[t],null,90),this.updateTrianglePoints(this.objColl[t]));for(t=0;t<this.objColl.length;t++)this.updateActiveObject(this.objColl[t].activePoint,this.objColl[t]);for(t=0;t<this.objColl.length;t++)this.objColl[t].imageRatio={startX:(this.objColl[t].activePoint.startX-this.destLeft)/this.destWidth,startY:(this.objColl[t].activePoint.startY-this.destTop)/this.destHeight,endX:(this.objColl[t].activePoint.endX-this.destLeft)/this.destWidth,endY:(this.objColl[t].activePoint.endY-this.destTop)/this.destHeight,width:this.destWidth/this.objColl[t].activePoint.width,height:this.destHeight/this.objColl[t].activePoint.height}},e.prototype.redrawShape=function(t){for(var e=0;e<this.objColl.length;e++)if(JSON.stringify(t)===JSON.stringify(this.objColl[e])){this.objColl.splice(e,1);break}this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),this.isPreventDragging?(this.activeObj.activePoint.startX>this.destLeft&&(this.isPreventDragging=!1),this.drawObject("duplicate",null,null,null,!0)):this.drawObject("duplicate",null,null,null,!0)},e.prototype.applyActObj=function(){var t=!1;if(void 0!==this.activeObj.shape&&"text"===this.activeObj.shape&&""===this.activeObj.keyHistory)this.refreshActiveObj(),this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height);else{var e=void 0,i=!1;if(void 0!==this.activeObj.shape&&(e=this.activeObj.shape.split("-")),(void 0===e&&this.currObjType.isCustomCrop||void 0!==e&&"crop"===e[0])&&(i=!0),!sf.base.isNullOrUndefined(this.activeObj.shape)&&!i){for(var s=0;s<this.objColl.length;s++)if(JSON.stringify(this.activeObj)===JSON.stringify(this.objColl[s])){t=!0;break}if(!t){sf.base.isNullOrUndefined(this.activeObj.currIndex)&&(this.activeObj.currIndex="shape_"+(this.objColl.length+1)),this.updateImageRatioForActObj();var a=this.activeObj.currIndex.split("_"),o=this.objColl.splice(0,parseInt(a[1],10)-1);o.push(sf.base.extend({},this.activeObj,{},!0));for(s=0;s<this.objColl.length;s++)o.push(this.objColl[s]);this.objColl=o,o=[],this.refreshActiveObj(),this.lowerContext.clearRect(0,0,this.lowerCanvas.width,this.lowerCanvas.height),this.redrawImgWithObj(),this.clearOuterCanvas(this.lowerContext),this.clearOuterCanvas(this.upperContext),this.currObjType.shape="",this.refreshActiveObj(),this.isCircleCrop&&this.cropCircle(this.lowerContext)}}}},e.prototype.apply=function(t,e,i){if(!this.disabled)if(this.togglePen&&!this.currObjType.isCustomCrop){var s=this.destLeft,a=this.destTop,o=this.destWidth,r=this.destHeight;this.callUpdateCurrentTransformedState();var n=this.lowerContext.filter;this.lowerContext.filter="none",this.togglePen=!1,this.iterateObjColl(),this.freehandRedraw(this.lowerContext),this.togglePen=!1,(this.isCircleCrop||!sf.base.isNullOrUndefined(this.currSelectionPoint)&&"crop-circle"===this.currSelectionPoint.shape)&&this.cropCircle(this.lowerContext),this.destLeft=s,this.destTop=a,this.destWidth=o,this.destHeight=r,this.lowerContext.filter=n}else i=i||"original",this.currObjType.shape=void 0!==t?t:this.currObjType.shape,""!==this.currObjType.shape&&(this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),this.drawObject(i,e),this.activeObj.shape=this.currObjType.shape.toLowerCase(),t||""===this.currObjType.shape||this.currObjType.isCustomCrop||this.objColl.push(sf.base.extend({},this.activeObj,{},!0)),this.keyHistory="")},e.prototype.setCenterPoints=function(t,e,i){var s,a;t&&e&&i?(s=e,a=i):(s=this.activeObj.activePoint.width,a=this.activeObj.activePoint.height),this.activeObj.activePoint.startX=this.lowerCanvas.width/2-s/2,this.activeObj.activePoint.startY=this.lowerCanvas.height/2-a/2,this.activeObj.activePoint.endX=this.lowerCanvas.width/2+s/2,this.activeObj.activePoint.endY=this.lowerCanvas.height/2+a/2,t&&e&&i&&(this.textStartPoints.x=this.activeObj.activePoint.startX,this.textStartPoints.y=this.activeObj.activePoint.startY)},e.prototype.updateTriangleRatio=function(t){t.triangleRatio=[],t.triangleRatio.push({x:(t.triangle[0].x-this.destLeft)/this.destWidth,y:(t.triangle[0].y-this.destTop)/this.destHeight}),t.triangleRatio.push({x:(t.triangle[1].x-this.destLeft)/this.destWidth,y:(t.triangle[1].y-this.destTop)/this.destHeight}),t.triangleRatio.push({x:(t.triangle[2].x-this.destLeft)/this.destWidth,y:(t.triangle[2].y-this.destTop)/this.destHeight})},e.prototype.updateTrianglePoints=function(t){if("arrow"===t.shape){var e=void 0,i=void 0;switch((e=0===t.shapeDegree?this.degree:this.degree-t.shapeDegree)<0&&(e=360+e),i=e%90==0&&e%180!=0?t.activePoint.width:t.activePoint.height,t.triangle=[],t.triangleDirection){case"right":t.triangle.push({x:t.activePoint.endX-i,y:t.activePoint.startY}),t.triangle.push({x:t.activePoint.endX,y:t.activePoint.startY+i/2}),t.triangle.push({x:t.activePoint.endX-i,y:t.activePoint.endY});break;case"left":t.triangle.push({x:t.activePoint.startX+i,y:t.activePoint.startY}),t.triangle.push({x:t.activePoint.startX,y:t.activePoint.startY+i/2}),t.triangle.push({x:t.activePoint.startX+i,y:t.activePoint.endY});break;case"top":t.triangle.push({x:t.activePoint.startX,y:t.activePoint.startY+i}),t.triangle.push({x:t.activePoint.startX+i/2,y:t.activePoint.startY}),t.triangle.push({x:t.activePoint.startX+i,y:t.activePoint.startY+i});break;case"bottom":t.triangle.push({x:t.activePoint.endX,y:t.activePoint.endY-i}),t.triangle.push({x:t.activePoint.endX-i/2,y:t.activePoint.endY}),t.triangle.push({x:t.activePoint.endX-i,y:t.activePoint.endY-i})}this.updateTriangleRatio(t)}},e.prototype.drawShape=function(t,e,i,s,a,o,r){var n=this;if(!this.disabled&&this.isImageLoaded){this.redrawActObj();var h=sf.base.extend([],this.objColl,[],!0);if(this.togglePen=!1,this.keyHistory="",this.upperCanvas.style.display="block",this.refreshActiveObj(),this.currObjType.shape=t,"freehanddraw"!==this.currObjType.shape.toLowerCase()&&""!==this.currObjType.shape.toLowerCase()){this.activeObj.shape=this.currObjType.shape.toLowerCase(),this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),sf.base.isNullOrUndefined(this.activeObj.strokeSettings)&&(this.activeObj.strokeSettings=this.strokeSettings),this.activeObj.strokeSettings.strokeWidth=e||this.activeObj.strokeSettings.strokeWidth,this.activeObj.strokeSettings.strokeColor=i||this.activeObj.strokeSettings.strokeColor,this.activeObj.strokeSettings.fillColor=s||this.activeObj.strokeSettings.fillColor;var l=this.destWidth>100?100:this.destWidth/2,c=this.destHeight>100?100:this.destHeight/2;this.activeObj.activePoint.width=l,this.activeObj.activePoint.height=c,"line"===this.currObjType.shape.toLowerCase()||"arrow"===this.currObjType.shape.toLowerCase()?(this.activeObj.lineDraw="horizontal",this.activeObj.activePoint.height/=2,this.activeObj.activePoint.height-=20,"arrow"===this.currObjType.shape.toLowerCase()&&(this.activeObj.activePoint.width+=50)):"rectangle"===this.currObjType.shape.toLowerCase()&&(this.activeObj.activePoint.width+=this.activeObj.activePoint.width/2),"ellipse"===this.currObjType.shape.toLowerCase()&&o&&(this.activeObj.activePoint.width=2*o,this.activeObj.activePoint.height=2*r),o&&r&&(this.activeObj.activePoint.width=o,this.activeObj.activePoint.height=r),sf.base.isNullOrUndefined(a)?this.setCenterPoints():(this.activeObj.activePoint.startX=a.x,this.activeObj.activePoint.startY=a.y,this.activeObj.activePoint.endX=this.activeObj.activePoint.startX+this.activeObj.activePoint.width,this.activeObj.activePoint.endY=this.activeObj.activePoint.startY+this.activeObj.activePoint.height),"arrow"===this.currObjType.shape.toLowerCase()&&(this.activeObj.triangleDirection="right",this.updateTrianglePoints(this.activeObj)),this.currObjType.isDragging=this.currObjType.isCustomCrop=!1,this.activeObj.shapeDegree=this.degree,this.activeObj.shapeFlip=this.currFlipState,this.activeObj.textFlip=this.currFlipState,this.activeObj.flipObjColl=[];var d=this.updatePreviousShapeSettings(),p={action:"insert",previousShapeSettings:d,currentShapeSettings:d};this.dotnetRef.invokeMethodAsync("ShapeEventAsync","OnShape",p).then((function(){n.updateShapeChangeEventArgs(p.currentShapeSettings),n.drawObject("duplicate"),n.isShapeInserted=!0,n.updateUndoRedoObj(h)}))}}},e.prototype.drawShapeText=function(t,e,i,s,a,o,r,n){var h=this;if(!this.disabled&&this.isImageLoaded){"freehanddraw"===this.currObjType.shape&&(this.apply(),this.upperCanvas.style.cursor="default",this.currObjType.shape=""),this.togglePen=!1,this.redrawActObj();var l=this.getCurrentObj();l.objColl=sf.base.extend([],this.objColl,[],!0),l.pointColl=sf.base.extend([],this.pointColl,[],!0),l.afterCropActions=sf.base.extend([],this.afterCropActions,[],!0),this.keyHistory="",this.refreshActiveObj(),this.activeObj.shape="text",this.currObjType.isCustomCrop=!1,this.currObjType.isText=this.currObjType.isInitialText=!0,this.upperCanvas.style.display="block",this.currObjType.shape=this.activeObj.shape="text",sf.base.isNullOrUndefined(this.activeObj.textSettings)&&(this.activeObj.textSettings=this.textSettings),sf.base.isNullOrUndefined(this.activeObj.strokeSettings)&&(this.activeObj.strokeSettings=this.strokeSettings),this.activeObj.strokeSettings.strokeColor=o||this.activeObj.strokeSettings.strokeColor,this.activeObj.textSettings.text=t||this.activeObj.textSettings.text,this.activeObj.textSettings.fontFamily=e||this.activeObj.textSettings.fontFamily,this.activeObj.textSettings.text=t||this.activeObj.textSettings.text,this.activeObj.textSettings.fontFamily=e||this.activeObj.textSettings.fontFamily,this.activeObj.textSettings.fontSize=i||this.activeObj.textSettings.fontSize,this.activeObj.textSettings.bold=s||this.activeObj.textSettings.bold,this.activeObj.textSettings.italic=a||this.activeObj.textSettings.italic,sf.base.isNullOrUndefined(this.activeObj.textSettings.fontSize)&&(this.lowerCanvas.width>this.lowerCanvas.height?this.activeObj.textSettings.fontSize=Math.floor(this.lowerCanvas.width/20):this.activeObj.textSettings.fontSize=Math.floor(this.lowerCanvas.height/20),this.activeObj.textSettings.fontSize<20&&(this.activeObj.textSettings.fontSize=20)),this.destWidth<100?this.activeObj.textSettings.fontSize=Math.floor(this.destWidth/20):this.destHeight<100&&(this.activeObj.textSettings.fontSize=Math.floor(this.destHeight/20)),this.activeObj.shapeDegree=this.degree,this.activeObj.shapeFlip=this.currFlipState,this.activeObj.flipObjColl=[],this.updateFontStyles();var c=this.upperContext.measureText(this.activeObj.textSettings.text).width+.5*this.activeObj.textSettings.fontSize,d=this.activeObj.textSettings.fontSize+.25*this.activeObj.textSettings.fontSize;sf.base.isNullOrUndefined(r)||sf.base.isNullOrUndefined(n)?this.setCenterPoints(!0,c,d):(this.activeObj.activePoint.startX=r,this.activeObj.activePoint.startY=n,this.activeObj.activePoint.endX=this.activeObj.activePoint.startX+c,this.activeObj.activePoint.endY=this.activeObj.activePoint.startY+d);var p=this.updatePreviousShapeSettings(),v={action:"insert",previousShapeSettings:p,currentShapeSettings:p};this.dotnetRef.invokeMethodAsync("ShapeEventAsync","OnShape",v).then((function(){h.updateShapeChangeEventArgs(v.currentShapeSettings),h.addLetter(h.activeObj.textSettings.text),h.activeObj.textFlip=h.currFlipState,h.updateFontRatio(h.activeObj),h.objColl.push(h.activeObj);var t=sf.base.extend({},h.cropObj,{},!0);h.updateUndoRedoColl("shapeTransform",l,l.objColl,l.pointColl,t),h.redrawShape(h.objColl[h.objColl.length-1]),h.isShapeInserted=!0}))}},e.prototype.updateShapeChangeEventArgs=function(t){switch(this.activeObj.currIndex=t.id,this.activeObj.activePoint.startX=t.startX,this.activeObj.activePoint.startY=t.startY,this.activeObj.activePoint.width=t.width,this.activeObj.activePoint.height=t.height,this.activeObj.strokeSettings.strokeColor=t.strokeColor,this.activeObj.strokeSettings.fillColor=t.fillColor,this.activeObj.shape){case"ellipse":this.activeObj.activePoint.width=t.radius/2;break;case"line":case"arrow":this.activeObj.activePoint.width=t.length;break;case"text":this.activeObj.keyHistory=t.text,this.activeObj.textSettings.fontSize=t.fontSize,this.activeObj.strokeSettings.strokeColor=t.color}if("text"===this.activeObj.shape&&!sf.base.isNullOrUndefined(this.activeObj.textSettings))for(var e=0;e<t.fontStyle.length;e++)"bold"===t.fontStyle[e]?this.activeObj.textSettings.bold=!0:"italic"===t.fontStyle[e]?this.activeObj.textSettings.italic=!0:"underline"===t.fontStyle[e]&&(this.activeObj.textSettings.underline=!0)},e.prototype.getObjDetails=function(t){var e={};return e.id=t.currIndex,e.type=this.toPascalCase(t.shape),e.startX=t.activePoint.startX,e.startY=t.activePoint.startY,"rectangle"===t.shape?(e.width=t.activePoint.width,e.height=t.activePoint.height,e.strokeColor=t.strokeSettings.strokeColor,e.fillColor=t.strokeSettings.fillColor,e.strokeWidth=t.strokeSettings.strokeWidth):"ellipse"===t.shape?(e.radius=t.activePoint.width/2,e.strokeColor=t.strokeSettings.strokeColor,e.fillColor=t.strokeSettings.fillColor,e.strokeWidth=t.strokeSettings.strokeWidth):"line"===t.shape||"arrow"===t.shape?(e.length=t.activePoint.width,e.strokeColor=t.strokeSettings.strokeColor,e.strokeWidth=t.strokeSettings.strokeWidth):"text"===t.shape&&(e.text=t.keyHistory,e.fontSize=t.textSettings.fontSize,e.color=t.strokeSettings.strokeColor,e.fontStyle=[],t.textSettings.bold&&e.fontStyle.push("bold"),t.textSettings.italic&&e.fontStyle.push("italic")),e},e.prototype.getFreehandDrawDetails=function(t){var e={};return e.id=this.pointColl[t].id,e.type="FreehandDraw",e.points=sf.base.extend([],this.pointColl[t].points),e.strokeColor=this.pointColl[t].strokeColor,e.strokeWidth=this.pointColl[t].strokeWidth,e},e.prototype.isPointsInRange=function(t,e){var i=!1;return!sf.base.isNullOrUndefined(t)&&!sf.base.isNullOrUndefined(e)&&t>=0&&e>=0&&t<=this.lowerCanvas.width&&e<=this.lowerCanvas.width&&(i=!0),i},e.prototype.clearActObj=function(){"none"===this.textArea.style.display&&(this.refreshActiveObj(),this.applyActObj(),this.refreshActiveObj(),this.currObjType.isCustomCrop=!1)},e.prototype.applyPenDraw=function(){"freehanddraw"===this.currObjType.shape&&(this.apply(),this.upperCanvas.style.cursor="default",this.currObjType.shape=""),this.clearActObj()},e.prototype.drawRotatedImage=function(t){0===t?this.degree=0:this.degree+=t,360!==this.degree&&-360!==this.degree||(this.degree=0),this.setDestinationPoints();var e=sf.base.extend([],this.objColl,[],!0),i=sf.base.extend({},this.activeObj,{},!0);if(this.objColl=[],this.refreshActiveObj(),this.isReverseRotate||this.updateCurrentTransformedState("initial"),this.rotateDegree(t),this.isReverseRotate||(this.updateCurrentTransformedState("reverse"),this.rotateFlipColl.push(t)),1===this.rotateFlipColl.length&&this.setClientTransformedDimension(),this.objColl=sf.base.extend([],e,[],!0),this.activeObj=sf.base.extend({},i,{},!0),this.isCircleCrop&&this.cropCircle(this.lowerContext),this.redrawObj(t),this.refreshActiveObj(),t>0)this.rotateFreehandDrawColl();else for(var s=0;s<3;s++)this.rotateFreehandDrawColl();this.freehandRedraw(this.lowerContext),this.updateCurrSelectionPoint(t)},e.prototype.updateCurrSelectionPoint=function(t){if(!sf.base.isNullOrUndefined(this.currSelectionPoint)&&!sf.base.isNullOrUndefined(this.currDestinationPoint)){var e=sf.base.extend({},this.activeObj,{},!0),i=sf.base.extend([],this.objColl,[],!0),s={startX:this.srcLeft,startY:this.srcTop,width:this.srcWidth,height:this.srcHeight},a={startX:this.destLeft,startY:this.destTop,width:this.destWidth,height:this.destHeight};this.objColl=[],this.objColl.push(sf.base.extend({},this.currSelectionPoint,{},!0)),this.srcLeft=0,this.srcTop=0,this.srcWidth=this.baseImg.width,this.srcHeight=this.baseImg.height,this.destLeft=this.currDestinationPoint.startX,this.destTop=this.currDestinationPoint.startY,this.destWidth=this.currDestinationPoint.width,this.destHeight=this.currDestinationPoint.height,"number"==typeof t&&(this.setDestinationPoints(),this.setClientTransformedDimension()),this.objColl[0].shapeFlip="",this.redrawObj(t),this.currSelectionPoint=sf.base.extend({},this.objColl[0],{},!0),this.currDestinationPoint={startX:this.destLeft,startY:this.destTop,width:this.destWidth,height:this.destHeight},this.objColl=i,this.activeObj=e,this.srcLeft=s.startX,this.srcTop=s.startY,this.srcWidth=s.width,this.srcHeight=s.height,this.destLeft=a.startX,this.destTop=a.startY,this.destWidth=a.width,this.destHeight=a.height}},e.prototype.setClientTransformedDimension=function(t){if(this.degree%90==0&&this.degree%180!=0){this.destLeft=(this.lowerCanvas.width-this.destHeight)/2,this.destTop=(this.lowerCanvas.height-this.destWidth)/2;var e=this.destWidth;this.destWidth=this.destHeight,this.destHeight=e}else sf.base.isNullOrUndefined(t)&&(this.destLeft=(this.lowerCanvas.width-this.destWidth)/2,this.destTop=(this.lowerCanvas.height-this.destHeight)/2)},e.prototype.popForDefaultTransformedState=function(t){for(var e=0,i=0,s=0,a=0,o=0;o<t.length;o++)90===t[o]||"rotateRight"===t[o]?(i=0,s=0,a=0,4===++e&&(t.pop(),t.pop(),t.pop(),t.pop())):-90===t[o]||"rotateLeft"===t[o]?(e=0,s=0,a=0,4===++i&&(t.pop(),t.pop(),t.pop(),t.pop())):"horizontal"===t[o]||"horizontalflip"===t[o]?(i=0,e=0,a=0,2===++s&&(t.pop(),t.pop())):"vertical"!==t[o]&&"verticalflip"!==t[o]||(s=0,i=0,e=0,2===++a&&(t.pop(),t.pop()));return t},e.prototype.popForDefaultFlipState=function(t){for(var e=0;e<t.length;e++)sf.base.isNullOrUndefined(t[e+3])||("horizontal"!==t[e]&&"horizontalFlip"!==t[e]||"vertical"!==t[e+1]&&"verticalFlip"!==t[e]||"horizontal"!==t[e+2]&&"horizontalFlip"!==t[e]||"vertical"!==t[e+3]&&"verticalFlip"!==t[e])&&("vertical"!==t[e]&&"verticalFlip"!==t[e]||"horizontal"!==t[e+1]&&"horizontalFlip"!==t[e+1]||"vertical"!==t[e+2]&&"verticalFlip"!==t[e]||"horizontal"!==t[e+3]&&"horizontalFlip"!==t[e])||(t.pop(),t.pop(),t.pop(),t.pop());return t},e.prototype.popForDefaultRotateState=function(t){for(var e=0;e<t.length;e++)sf.base.isNullOrUndefined(t[e+1])||(90!==t[e]&&"rotateRight"!==t[e]||-90!==t[e+1]&&"rotateLeft"!==t[e])&&(-90!==t[e]&&"rotateLeft"!==t[e]||90!==t[e+1]&&"rotateRight"!==t[e])||(t.pop(),t.pop());return t},e.prototype.alignRotateFlipColl=function(t,e){return t=this.popForDefaultTransformedState(t),t=this.popForDefaultFlipState(t),0===(t=this.popForDefaultRotateState(t)).length&&e&&(this.degree=0,this.currFlipState=""),t},e.prototype.updateFlipColl=function(t){if(0===this.flipColl.length?this.flipColl.push(t):"direction"===this.flipColl[this.flipColl.length-1]?this.flipColl.pop():this.flipColl.push(t),this.flipColl.length>=4)if("horizontal"===this.flipColl[this.flipColl.length-1]&&"vertical"===this.flipColl[this.flipColl.length-2]&&"horizontal"===this.flipColl[this.flipColl.length-3]&&"vertical"===this.flipColl[this.flipColl.length-4])for(var e=0;e<4;e++)this.flipColl.pop();else if("vertical"===this.flipColl[this.flipColl.length-1]&&"horizontal"===this.flipColl[this.flipColl.length-2]&&"vertical"===this.flipColl[this.flipColl.length-3]&&"horizontal"===this.flipColl[this.flipColl.length-4])for(e=0;e<4;e++)this.flipColl.pop()},e.prototype.horizontalFlip=function(){this.lowerContext.translate(this.lowerContext.canvas.width,0),this.lowerContext.scale(-1,1),this.upperContext.translate(this.upperContext.canvas.width,0),this.upperContext.scale(-1,1)},e.prototype.verticalFlip=function(){this.lowerContext.translate(0,this.lowerContext.canvas.height),this.lowerContext.scale(1,-1),this.upperContext.translate(0,this.upperContext.canvas.height),this.upperContext.scale(1,-1)},e.prototype.updateFlipState=function(t){"horizontal"===t&&this.degree%90==0&&this.degree%180!=0?this.verticalFlip():"vertical"===t&&this.degree%90==0&&this.degree%180!=0||"horizontal"===t?this.horizontalFlip():"vertical"===t&&this.verticalFlip()},e.prototype.setDestinationPoints=function(){var t;this.degree%90==0&&this.degree%180!=0?(t=this.calcMaxDimension(this.srcHeight,this.srcWidth),this.isRotateZoom&&(t.width+=t.width*this.zoomFactor,t.height+=t.height*this.zoomFactor,this.destWidth=t.height,this.destHeight=t.width),this.destLeft=(this.lowerCanvas.clientWidth-t.height)/2,this.destTop=(this.lowerCanvas.clientHeight-t.width)/2,this.destWidth=t.height,this.destHeight=t.width):(t=this.calcMaxDimension(this.srcWidth,this.srcHeight),this.isRotateZoom&&(t.width+=t.width*this.zoomFactor,t.height+=t.height*this.zoomFactor,this.destWidth=t.width,this.destHeight=t.height),this.destLeft=(this.lowerCanvas.clientWidth-t.width)/2,this.destTop=(this.lowerCanvas.clientHeight-t.height)/2,this.destWidth=t.width,this.destHeight=t.height)},e.prototype.rotatedFlip=function(){this.isReverseFlip=!0;var t=this.currFlipState,e=this.flipColl,i=sf.base.extend([],this.objColl,[],!0),s=sf.base.extend({},this.activeObj,{},!0);this.flipColl=[],this.objColl=[],this.refreshActiveObj(),this.currentTransformedState("initial");var a=this.lowerContext.filter;this.updateBrightnessFilter(),this.lowerContext.drawImage(this.baseImg,this.srcLeft,this.srcTop,this.srcWidth,this.srcHeight,this.destLeft,this.destTop,this.destWidth,this.destHeight),this.lowerContext.filter=a,this.currentTransformedState("reverse",!0),""===t&&""!==this.currFlipState&&(t=this.currFlipState),this.currFlipState=t,this.flipColl=e,this.objColl=sf.base.extend([],i,[],!0),this.lowerContext.filter="none",this.iterateObjColl(),this.lowerContext.filter=a,0!==s.activePoint.width&&(this.activeObj=sf.base.extend({},s,{},!0)),this.isReverseFlip=!1},e.prototype.getFilterValue=function(t){return 0===t?1:1+.5*t/100},e.prototype.setFilterValue=function(t){var e;return e=1===t?0:100*(t-1)/.5,Math.round(e)},e.prototype.getSaturationFilterValue=function(t){return 0===t?1:1+t/100},e.prototype.setSaturationFilterValue=function(t){var e;return e=1===t?0:100*(t-1),Math.round(e)},e.prototype.getBlackAndWhiteData=function(t){for(var e=0;e<t.data.length;e+=4){var i=0;t.data[e]+t.data[e+1]+t.data[e+2]>383&&(i=255),t.data[e]=i,t.data[e+1]=i,t.data[e+2]=i,t.data[e+3]=255}return t},e.prototype.setBrightness=function(t){this.applyPenDraw(),this.adjustmentLevel.brightness=t,t=this.getFilterValue(t);var e=sf.base.extend({},this.cropObj,{},!0),i=this.getCurrentObj();i.objColl=sf.base.extend([],this.objColl,[],!0),i.pointColl=sf.base.extend([],this.pointColl,[],!0),i.afterCropActions=sf.base.extend([],this.afterCropActions,[],!0),this.updateAdjustment("brightness",t),this.updateUndoRedoColl("brightness",i,i.objColl,i.pointColl,e)},e.prototype.setContrast=function(t){this.applyPenDraw(),this.adjustmentLevel.contrast=t,t=this.getFilterValue(t),t*=100;var e=sf.base.extend({},this.cropObj,{},!0),i=this.getCurrentObj();i.objColl=sf.base.extend([],this.objColl,[],!0),i.pointColl=sf.base.extend([],this.pointColl,[],!0),i.afterCropActions=sf.base.extend([],this.afterCropActions,[],!0),this.updateAdjustment("contrast",t),this.updateUndoRedoColl("contrast",i,i.objColl,i.pointColl,e)},e.prototype.setHue=function(t){this.applyPenDraw(),this.adjustmentLevel.hue=t,t*=3;var e=sf.base.extend({},this.cropObj,{},!0),i=this.getCurrentObj();i.objColl=sf.base.extend([],this.objColl,[],!0),i.pointColl=sf.base.extend([],this.pointColl,[],!0),i.afterCropActions=sf.base.extend([],this.afterCropActions,[],!0),this.updateAdjustment("hue",t),this.updateUndoRedoColl("hue",i,i.objColl,i.pointColl,e)},e.prototype.setSaturation=function(t){this.applyPenDraw(),this.adjustmentLevel.saturation=t,t=this.getSaturationFilterValue(t),t*=100;var e=sf.base.extend({},this.cropObj,{},!0),i=this.getCurrentObj();i.objColl=sf.base.extend([],this.objColl,[],!0),i.pointColl=sf.base.extend([],this.pointColl,[],!0),i.afterCropActions=sf.base.extend([],this.afterCropActions,[],!0),this.updateAdjustment("saturation",t),this.updateUndoRedoColl("saturation",i,i.objColl,i.pointColl,e)},e.prototype.setOpacity=function(t){this.applyPenDraw(),this.adjustmentLevel.opacity=t,t>=50?t/=100:40===t?t=.45:30===t?t=.4:20===t?t=.35:10===t?t=.3:0===t&&(t=.25);var e=sf.base.extend({},this.cropObj,{},!0),i=this.getCurrentObj();i.objColl=sf.base.extend([],this.objColl,[],!0),i.pointColl=sf.base.extend([],this.pointColl,[],!0),i.afterCropActions=sf.base.extend([],this.afterCropActions,[],!0),this.updateAdjustment("opacity",t),this.updateUndoRedoColl("opacity",i,i.objColl,i.pointColl,e)},e.prototype.setBlur=function(t){this.applyPenDraw(),this.adjustmentLevel.blur=t,t/=20,t+=.5;var e=sf.base.extend({},this.cropObj,{},!0),i=this.getCurrentObj();i.objColl=sf.base.extend([],this.objColl,[],!0),i.pointColl=sf.base.extend([],this.pointColl,[],!0),i.afterCropActions=sf.base.extend([],this.afterCropActions,[],!0),this.updateAdjustment("blur",t),this.updateUndoRedoColl("blur",i,i.objColl,i.pointColl,e)},e.prototype.setExposure=function(t){this.applyPenDraw(),this.adjustmentLevel.exposure=t,t=this.getFilterValue(t);var e=sf.base.extend({},this.cropObj,{},!0),i=this.getCurrentObj();i.objColl=sf.base.extend([],this.objColl,[],!0),i.pointColl=sf.base.extend([],this.pointColl,[],!0),i.afterCropActions=sf.base.extend([],this.afterCropActions,[],!0),this.updateAdjustment("exposure",t),this.updateUndoRedoColl("exposure",i,i.objColl,i.pointColl,e)},e.prototype.setFilter=function(t){t=t.toLowerCase(),this.applyPenDraw();var e=this.currentFilter,i=sf.base.extend({},this.cropObj,{},!0),s=this.getCurrentObj();s.objColl=sf.base.extend([],this.objColl,[],!0),s.pointColl=sf.base.extend([],this.pointColl,[],!0),s.afterCropActions=sf.base.extend([],this.afterCropActions,[],!0),this.updateAdjustment(t,null),this.updateUndoRedoColl(t,s,s.objColl,s.pointColl,i,null,null,e)},e.prototype.renderImage=function(t){var e=this.lowerContext.filter;this.applyActObj(),this.upperContext.clearRect(0,0,this.lowerCanvas.width,this.lowerCanvas.height),this.lowerContext.clearRect(0,0,this.lowerCanvas.width,this.lowerCanvas.height),t?this.iterateRotateFlipColl(this.lowerContext,"initial"):this.updateCurrentTransformedState("initial"),this.updateBrightnessFilter(),this.setDestPointsForFlipState(),this.lowerContext.drawImage(this.baseImg,this.srcLeft,this.srcTop,this.srcWidth,this.srcHeight,this.destLeft,this.destTop,this.destWidth,this.destHeight),this.setDestPointsForFlipState(),t?this.iterateRotateFlipColl(this.lowerContext,"reverse"):this.updateCurrentTransformedState("reverse"),this.lowerContext.filter="none",this.iterateObjColl(),this.freehandRedraw(this.lowerContext),this.lowerContext.filter=e,(this.isCircleCrop||!sf.base.isNullOrUndefined(this.currSelectionPoint)&&"crop-circle"===this.currSelectionPoint.shape)&&this.cropCircle(this.lowerContext)},e.prototype.updateTextBox=function(t){this.upperContext.clearRect(0,0,this.lowerCanvas.width,this.lowerCanvas.height),this.lowerContext.clearRect(0,0,this.lowerCanvas.width,this.lowerCanvas.height),this.redrawImgWithObj(),this.textArea.style.display="block",this.textArea.style.fontFamily=t.textSettings.fontFamily,this.textArea.style.fontSize=t.textSettings.fontSize+"px",this.textArea.style.color=t.strokeSettings.strokeColor,this.textArea.style.fontWeight=t.textSettings.bold?"bold":"normal",this.textArea.style.fontStyle=t.textSettings.italic?"italic":"normal",this.textArea.style.border="2px solid "+this.themeColl[this.theme].primaryColor,this.textArea.value=t.keyHistory,this.activeObj=sf.base.extend({},t,{},!0),this.updateFontStyles(),this.textArea.style.width=this.activeObj.activePoint.width+"px"},e.prototype.drawNewSelection=function(t,e,i,s,a){var o,r="crop-"+t;"crop-custom"===r.toLowerCase()?(""===this.currObjType.shape&&this.drawCustomSelection("crop-custom"),e&&i&&(this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),this.currObjType.shape=this.activeObj.shape=r.toLowerCase(),this.activeObj.activePoint.startX=e,this.activeObj.activePoint.startY=i,this.activeObj.activePoint.endX=this.lowerCanvas.width,this.activeObj.activePoint.endY=this.lowerCanvas.height,this.activeObj.activePoint.width=this.activeObj.activePoint.endX-this.activeObj.activePoint.startX,this.activeObj.activePoint.height=this.activeObj.activePoint.endY-this.activeObj.activePoint.startY,this.drawObject("duplicate"))):"crop-canvas"===r.toLowerCase()?(this.upperCanvas.style.display="none",this.dragCanvas=!0):(this.currObjType.isCustomCrop=!1,this.currObjType.shape=r.toLowerCase(),s&&a?o={startX:e,startY:i,endX:e+s,endY:i+a,width:s,height:a}:s&&"crop-circle"===r&&(o={startX:e,startY:i,endX:e+s,endY:i+s,width:s,height:s}),this.activeObj.shape=r.toLowerCase(),this.drawObject("duplicate",null,!0,o))},e.prototype.setDestPointsForFlipState=function(){""!==this.getCurrentPanRegion()&&("horizontal"===this.getCurrentPanRegion()?this.destLeft=this.lowerCanvas.clientWidth-(this.destWidth+this.destLeft):("vertical"===this.getCurrentPanRegion()||(this.destLeft=this.lowerCanvas.clientWidth-(this.destWidth+this.destLeft)),this.destTop=this.lowerCanvas.clientHeight-(this.destHeight+this.destTop)))},e.prototype.performUndoDefaultAction=function(t){this.lowerContext.filter=t.previousObj.filter,this.objColl=[],this.pointColl=[],this.freehandCounter=0,this.setCurrentObj(t.previousObj),this.destLeft=t.previousObj.destPoints.startX,this.destTop=t.previousObj.destPoints.startY;var e=sf.base.extend({},this.activeObj,{},!0);this.objColl=sf.base.extend([],t.previousObjColl,[],!0),this.pointColl=sf.base.extend([],t.previousPointColl,[],!0),this.freehandCounter=this.pointColl.length,this.lowerContext.filter="none",this.iterateObjColl(),this.freehandRedraw(this.lowerContext),this.lowerContext.filter=t.previousObj.filter,this.activeObj=e,this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),0!==this.activeObj.activePoint.width&&0!==this.activeObj.activePoint.height&&this.drawObject("duplicate")},e.prototype.setAdjustment=function(t){var e,i,s=this.lowerContext.filter.split(" ");switch(t){case"brightness":i=s[0].split("("),e=parseFloat(i[1].split(")")[0]),this.adjustmentLevel.brightness=this.setFilterValue(e);break;case"contrast":i=s[1].split("("),e=parseFloat(i[1].split(")")[0]),e/=100,this.adjustmentLevel.contrast=this.setFilterValue(e);break;case"hue":i=s[2].split("("),e=parseFloat(i[1].split(")")[0]),e/=3,this.adjustmentLevel.hue=e;break;case"saturation":i=s[3].split("("),e=parseFloat(i[1].split(")")[0]),e/=100,this.adjustmentLevel.saturation=this.setSaturationFilterValue(e);break;case"opacity":i=s[4].split("("),.45===(e=parseFloat(i[1].split(")")[0]))?e=40:.4===e?e=30:.35===e?e=20:.3===e?e=10:.25===e?e=0:e*=100,this.adjustmentLevel.opacity=e;break;case"blur":i=s[5].split("("),e=parseFloat(i[1].split(")")[0]),e*=20,this.adjustmentLevel.blur=e;break;case"exposure":i=s[0].split("("),e=parseFloat(i[1].split(")")[0]),this.adjustmentLevel.exposure=this.setFilterValue(e)}},e.prototype.updateFilter=function(t,e){if("default"===t||"chrome"===t||"cold"===t||"warm"===t||"grayscale"===t||"blackandwhite"===t||"sepia"===t||"invert"===t||"sharpen"===t){var i=this.element.querySelector(".e-contextual-toolbar-wrapper .e-toolbar-item.e-selected");i&&i.classList.remove("e-selected");var s=document.getElementById(this.element.id+"_"+t+"Canvas");s&&s.parentElement.classList.add("e-selected"),sf.base.isNullOrUndefined(e)?this.currentFilter=this.element.id+"_"+t:this.currentFilter=e}},e.prototype.clearSelection=function(){!this.disabled&&this.isImageLoaded&&(this.togglePen=!1,this.refreshActiveObj(),this.dragElement="",this.dragPoint.startX=this.dragPoint.startY=this.dragPoint.endX=this.dragPoint.endY=0,this.currObjType.shape="",this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),this.currObjType.isActiveObj=!0,this.currObjType.isCustomCrop=!1,this.upperCanvas.style.cursor="default")},e.prototype.crop=function(){var t=this,e=!1;if(!this.disabled&&this.isImageLoaded){var i;this.currObjType.isUndoAction&&this.refreshUndoRedoColl();var s={cancel:!1,startPoint:{x:this.activeObj.activePoint.startX,y:this.activeObj.activePoint.startY},endPoint:{x:this.activeObj.activePoint.endX,y:this.activeObj.activePoint.endY}};this.dotnetRef.invokeMethodAsync("CropEventAsync","OnCrop",s).then((function(){if(!s.cancel&&(void 0!==t.activeObj.shape&&(i=t.activeObj.shape.split("-")),!t.disabled&&void 0!==t.activeObj.horTopLine&&(t.currObjType.isCustomCrop||"crop"===i[0]))){e=!0;var a=sf.base.extend({},t.cropObj,{},!0),o=t.getCurrentObj();o.objColl=sf.base.extend([],t.objColl,[],!0),o.pointColl=sf.base.extend([],t.pointColl,[],!0),o.afterCropActions=sf.base.extend([],t.afterCropActions,[],!0),t.cropImg(),t.zoomFactor=0,t.enableDisableToolbarBtn(),t.updateUndoRedoColl("crop",o,o.objColl,o.pointColl,a)}}))}return e},e.prototype.flip=function(t){var e=this;if(!this.disabled&&this.isImageLoaded){var i={direction:t,cancel:!1};this.dotnetRef.invokeMethodAsync("FlipEventAsync","OnFlip",i).then((function(){if(!i.cancel){var s,a=sf.base.extend({},e.cropObj,{},!0);sf.base.isNullOrUndefined(e.transformCurrentObj)&&((s=e.getCurrentObj()).objColl=sf.base.extend([],e.objColl,null,!0),s.pointColl=sf.base.extend({},e.pointColl,null,!0),s.afterCropActions=sf.base.extend([],e.afterCropActions,[],!0)),e.afterCropActions.push("horizontal"===t.toLowerCase()?"horizontalflip":"verticalflip");var o,r=[];sf.base.isNullOrUndefined(e.activeObj.activePoint)||(void 0!==e.activeObj.shape&&(r=e.activeObj.shape.split("-")),(e.currObjType.isCustomCrop||"crop"===r[0])&&(o=e.currObjType.isCustomCrop?"custom":r[1],e.updateImageRatioForActObj(),e.objColl.push(e.activeObj),e.refreshActiveObj())),e.redrawActObj(),e.lowerContext.clearRect(0,0,e.lowerCanvas.height,e.lowerCanvas.width),e.lowerContext.clearRect(0,0,e.lowerCanvas.width,e.lowerCanvas.height),e.upperContext.clearRect(0,0,e.lowerCanvas.height,e.lowerCanvas.width),e.upperContext.clearRect(0,0,e.lowerCanvas.width,e.lowerCanvas.height);var n=sf.base.extend([],e.objColl,[],!0),h=sf.base.extend({},e.activeObj,{},!0);e.objColl=[],e.refreshActiveObj(),e.isReverseFlip||e.updateCurrentTransformedState("initial"),"horizontal"===t.toLowerCase()?(e.updateFlipState(t.toLowerCase()),"horizontal"===e.currFlipState.toLowerCase()?e.currFlipState="":e.currFlipState="horizontal"):(e.updateFlipState(t.toLowerCase()),"vertical"===e.currFlipState.toLowerCase()?e.currFlipState="":e.currFlipState="vertical"),e.rotatedFlipCropSelection&&(e.destLeft+=e.totalPannedInternalPoint.x,e.destTop+=e.totalPannedInternalPoint.y);var l=e.lowerContext.filter;e.updateBrightnessFilter(),e.lowerContext.drawImage(e.baseImg,e.srcLeft,e.srcTop,e.srcWidth,e.srcHeight,e.destLeft,e.destTop,e.destWidth,e.destHeight),e.lowerContext.filter=l,e.updateFlipState(t.toLowerCase()),e.isReverseFlip||(e.updateCurrentTransformedState("reverse"),e.updateFlipColl(t.toLocaleLowerCase()),e.rotateFlipColl.push(t.toLowerCase())),1===e.rotateFlipColl.length&&(""===e.getCurrentPanRegion()?e.setClientTransformedDimension():e.setDestPointsForFlipState()),e.isCircleCrop&&e.cropCircle(e.lowerContext),e.objColl=sf.base.extend([],n,[],!0),e.activeObj=sf.base.extend({},h,{},!0);for(var c=0,d=e.objColl.length;c<d;c++)0===e.objColl[c].flipObjColl.length?e.objColl[c].flipObjColl.push(t):e.objColl[c].flipObjColl[e.objColl[c].flipObjColl.length-1]===t?e.objColl[c].flipObjColl.pop():e.objColl[c].flipObjColl.push(t);e.redrawObj(t.toLowerCase());var p=e.lowerContext.filter;e.lowerContext.filter=e.getDefaultFilter(),e.iterateObjColl(),sf.base.isNullOrUndefined(e.currSelectionPoint)||(n=sf.base.extend([],e.objColl,[],!0),e.objColl=[],e.objColl.push(e.currSelectionPoint),e.redrawObj(t.toLowerCase()),e.currSelectionPoint=sf.base.extend({},e.objColl[0],{},!0),e.objColl=n),"horizontal"===t.toLowerCase()||"vertical"===t.toLowerCase()?(e.flipFreehandrawColl(t.toLowerCase()),e.freehandRedraw(e.lowerContext)):e.freehandRedraw(e.lowerContext),e.lowerContext.filter=p,e.refreshActiveObj(),e.updateCurrSelectionPoint(t.toLowerCase()),!e.isUndoRedo&&sf.base.isNullOrUndefined(e.transformCurrentObj)&&e.updateUndoRedoColl("flip",s,s.objColl,s.pointColl,a),e.isUndoRedo=!1,e.clearOuterCanvas(e.lowerContext),e.clearOuterCanvas(e.upperContext),sf.base.isNullOrUndefined(o)||(e.upperContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height),e.activeObj=sf.base.extend({},e.objColl[e.objColl.length-1],{},!0),e.objColl.pop(),e.drawObject("duplicate",e.activeObj)),e.rotateFlipColl=e.alignRotateFlipColl(e.rotateFlipColl,!0)}}))}},e.prototype.getImageData=function(){return this.lowerContext.getImageData(this.destLeft,this.destTop,this.destWidth,this.destHeight)},e.prototype.open=function(t){if(!this.disabled){sf.popups.showSpinner(this.element),this.element.style.opacity="0.5";var e=document.querySelector("#"+this.element.id+"_currPos");if(e&&(e.style.display="none"),0===this.defToolbarItems.length&&sf.base.isNullOrUndefined(document.getElementById(this.element.id+"_toolbar"))&&(this.toolbarHeight=0),sf.base.isNullOrUndefined(this.toolbarTemplate)&&(this.reset(),this.update()),this.degree=0,this.zoomFactor=0,this.isImageLoaded=!1,this.currSelectionPoint=null,"string"===i(t)){var s=t.split(".");s.length>1?(s=s[s.length-2].split("/"),this.fileName=s[s.length-1]):this.fileName="ImageEditor",this.imageOnLoad(t)}else this.fileName="ImageEditor",this.lowerCanvas=document.querySelector("#"+this.element.id+"_lowerCanvas"),this.upperCanvas=document.querySelector("#"+this.element.id+"_upperCanvas"),this.lowerContext=this.lowerCanvas.getContext("2d"),this.upperContext=this.upperCanvas.getContext("2d"),this.lowerContext.clearRect(0,0,this.lowerCanvas.width,this.lowerCanvas.height),this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),this.inMemoryContext.clearRect(0,0,this.inMemoryCanvas.width,this.inMemoryCanvas.height),this.inMemoryCanvas.width=this.baseImg.width=t.width,this.inMemoryCanvas.height=this.baseImg.height=t.height,this.inMemoryContext.putImageData(t,0,0),this.baseImg.src=this.inMemoryCanvas.toDataURL()}},e.prototype.reset=function(){this.disabled||(this.inMemoryContext.clearRect(0,0,this.lowerCanvas.width,this.lowerCanvas.height),this.inMemoryContext.clearRect(0,0,this.lowerCanvas.height,this.lowerCanvas.width),this.lowerContext.clearRect(0,0,this.lowerCanvas.width,this.lowerCanvas.height),this.lowerContext.clearRect(0,0,this.lowerCanvas.height,this.lowerCanvas.width),this.upperContext.clearRect(0,0,this.lowerCanvas.width,this.lowerCanvas.height),this.upperContext.clearRect(0,0,this.lowerCanvas.height,this.lowerCanvas.width),this.lowerContext.filter=this.getDefaultFilter(),this.refreshActiveObj(),this.objColl=[],this.isImageLoaded=!1,this.degree=this.undoRedoStep=0,this.keyHistory=this.currFlipState="",this.upperCanvas.style.display="none",this.togglePan=this.togglePen=!1,this.upperCanvas.style.cursor=this.lowerCanvas.style.cursor="default",this.undoRedoColl=[],this.dragCanvas=this.isUndoRedo=!1,this.tempKeyHistory="",this.lowerContext.lineWidth=this.upperContext.lineWidth=void 0,this.touchEndPoint={},this.currentToolbar="main",this.textStartPoints={x:0,y:0},this.fontSizeColl=[],this.textArea.value=this.textArea.textContent="",this.textArea.style.display="none",this.strokeSettings={strokeColor:"#fff",fillColor:"",strokeWidth:null},this.textSettings={text:"Enter Text",fontFamily:"Arial",fontSize:null,fontRatio:null,bold:!1,italic:!1,underline:!1},this.tempStrokeSettings={strokeColor:"#fff",fillColor:"",strokeWidth:null},this.tempTextSettings={text:"Enter Text",fontFamily:"Arial",fontSize:null,fontRatio:null,bold:!1,italic:!1,underline:!1},this.timer=void 0,this.penStrokeWidth=void 0,this.currObjType.isUndoAction=!1,this.undoRedoStep=0,this.tempObjColl=void 0,this.adjustmentLevel={brightness:0,contrast:0,hue:0,opacity:100,saturation:0,blur:0,exposure:0,sharpen:!1,bw:!1},this.tempAdjustmentLevel={brightness:0,contrast:0,hue:0,opacity:100,saturation:0,blur:0,exposure:0,sharpen:!1,bw:!1},this.canvasFilter=this.currentFilter=this.tempAdjustmentValue="",this.lowerContext.filter=this.initialAdjustmentValue=this.adjustmentValue=this.getDefaultFilter(),this.destLeft=this.destTop=this.srcLeft=this.srcTop=0,this.destWidth=this.destHeight=this.srcWidth=this.srcHeight=null,this.currSelectionPoint=null,this.cropDestPoints={startX:0,startY:0,width:0,height:0},this.panDown=null,this.panMove=null,this.tempPanMove=null,this.flipColl=[],this.freehandDrawObj.time=this.freehandDrawObj.lastVelocity=0,this.freehandDrawObj.pointX=this.freehandDrawObj.pointY=0,this.points=[],this.pointColl={},this.pointCounter=this.freehandCounter=this.tempFreehandCounter=this.tempCurrentFreehandDrawIndex=0,this.isFreehandDrawing=!1,this.isReverseRotate=this.isReverseFlip=this.isPreventDragging=this.isRotateZoom=!1,this.currentPannedPoint=null,this.fileType=void 0,this.rotateFlipColl=[],this.isCircleCrop=!1,this.isCropTab=!1,this.rotatedDestPoints={startX:0,startY:0,width:0,height:0},this.croppedDegree=0,this.freehandDrawHoveredIndex=this.freehandDrawSelectedIndex=null,this.isFreehandDrawingPoint=this.isFreehandDrawEditing=!1,this.tempFreeHandDrawEditingStyles={strokeColor:null,fillColor:null,strokeWidth:null},this.totalPannedInternalPoint={x:0,y:0},this.totalPannedClientPoint={x:0,y:0},this.lowerCanvas.style.left=this.upperCanvas.style.left="",this.lowerCanvas.style.top=this.upperCanvas.style.top="",this.lowerCanvas.style.maxWidth=this.upperCanvas.style.maxWidth="",this.lowerCanvas.style.maxHeight=this.upperCanvas.style.maxHeight="",this.currentSelectionPoint=null,this.totalPannedPoint={x:0,y:0},this.fileName="",this.isBrightnessAdjusted=this.isInitialLoading=!1,this.defaultZoomFactor=this.cropZoomFactor=this.zoomFactor=0,this.tempActObj=null,this.currentMouseMovePoint={x:0,y:0},this.selectedFreehandColor="#42a5f5",this.isFreehandDrawCustomized=!1,this.isShapeInserted=!1,this.isAllowCropPan=!1,this.currObjType={shape:"",isDragging:!1,isActiveObj:!1,isText:!1,isInitialText:!1,isLine:!1,isInitialLine:!1,isCustomCrop:!1,isZoomed:!1,isUndoZoom:!1,isUndoAction:!1,isFiltered:!1,isSave:!1},this.cropObj={cropZoom:0,defaultZoom:0,totalPannedPoint:{x:0,y:0},totalPannedClientPoint:{x:0,y:0},totalPannedInternalPoint:{x:0,y:0},tempFlipPanPoint:{x:0,y:0},activeObj:{},rotateFlipColl:[],degree:0,currFlipState:"",destPoints:{startX:0,startY:0,width:0,height:0},srcPoints:{startX:0,startY:0,width:0,height:0},filter:""},this.afterCropActions=[],this.isCancelAction=this.preventZoomBtn=this.isFreehandPointMoved=!1,this.isTouch=!1,this.freehandDownPoint={x:0,y:0},this.tempFlipPanPoint={x:0,y:0},this.currentFreehandDrawIndex=0,this.tempCurrentFreehandDrawIndex=0,this.cancelObjColl=[],this.cancelPointColl=[],this.freehandDrawSelectedId=null,this.transformCurrentObj=null,this.rotatedFlipCropSelection=!1,this.panStartObj=null,this.currDestinationPoint=null,this.updateCanvas(),this.enableDisableToolbarBtn())},e.prototype.rotate=function(t){var e=this,i=!1;if(!this.disabled&&this.isImageLoaded&&t%90==0){var s={degree:t,cancel:!1};this.dotnetRef.invokeMethodAsync("RotateEventAsync","OnRotate",s).then((function(){if(!s.cancel){i=!0;var a=sf.base.extend({},e.cropObj,{},!0),o=void 0;sf.base.isNullOrUndefined(e.transformCurrentObj)&&((o=e.getCurrentObj()).objColl=sf.base.extend([],e.objColl,null,!0),o.pointColl=sf.base.extend({},e.pointColl,null,!0),o.afterCropActions=sf.base.extend([],e.afterCropActions,[],!0)),e.afterCropActions.push(90===t?"rotateRight":"rotateLeft");var r=[],n=void 0;sf.base.isNullOrUndefined(e.activeObj.activePoint)||sf.base.isNullOrUndefined(e.activeObj.shape)||(void 0!==e.activeObj.shape&&(r=e.activeObj.shape.split("-")),(e.currObjType.isCustomCrop||"crop"===r[0])&&(n=e.currObjType.isCustomCrop?"custom":r[1],e.updateImageRatioForActObj(),e.objColl.push(e.activeObj),e.refreshActiveObj())),e.redrawActObj(),e.upperContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height),e.drawRotatedImage(t),e.clearOuterCanvas(e.lowerContext),e.clearOuterCanvas(e.upperContext),sf.base.isNullOrUndefined(n)||(e.upperContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height),e.activeObj=sf.base.extend({},e.objColl[e.objColl.length-1],{},!0),e.objColl.pop(),e.drawObject("duplicate",e.activeObj)),!e.isUndoRedo&&sf.base.isNullOrUndefined(e.transformCurrentObj)&&e.updateUndoRedoColl("rotate",o,o.objColl,o.pointColl,a),e.isUndoRedo=!1,e.rotateFlipColl=e.alignRotateFlipColl(e.rotateFlipColl,!0)}}))}return i},e.prototype.export=function(t,e){var i=this;if(!this.disabled&&this.isImageLoaded){this.isFreehandDrawEditing&&this.applyFreehandDraw(),this.togglePen&&(this.currObjType.isZoomed=!0,this.apply()),"block"===this.textArea.style.display&&this.redrawActObj(),this.applyActObj(),this.lowerContext.filter=this.canvasFilter,t=t||"Png",this.redrawActObj();var s={cancel:!1,fileName:e||this.fileName,fileType:t},a={fileName:e||this.fileName,fileType:t};this.trigger("beforeSave",s,(function(s){s.cancel||(i.currObjType.isSave=!0,e=s.fileName?s.fileName:e,"svg"===t.toLowerCase()?(e=e||i.fileName,i.toSVGImg(e)):(t.toLowerCase(),e=e||i.fileName,i.toBlobFn(e,t.toLowerCase())),i.dotnetRef.invokeMethodAsync("SavedEventAsync","Saved",a).then((function(){i.lowerCanvas.style.left=i.upperCanvas.style.left="",i.lowerCanvas.style.top=i.upperCanvas.style.top="",i.lowerCanvas.style.maxWidth=i.upperCanvas.style.maxWidth="",i.lowerCanvas.style.maxHeight=i.upperCanvas.style.maxHeight=""})))}))}},e.prototype.select=function(t,e,i,s,a){if(!this.disabled&&this.isImageLoaded){this.zoomFactor>0&&!sf.base.isNullOrUndefined(this.activeObj.shape)&&"crop"===this.activeObj.shape.split("-")[0]&&sf.base.isNullOrUndefined(this.currentSelectionPoint)&&(this.currentSelectionPoint=sf.base.extend({},this.activeObj,{},!0));var o=!1,r=void 0;void 0!==this.activeObj.shape&&(r=this.activeObj.shape.split("-")),(void 0===r&&this.currObjType.isCustomCrop||void 0!==r&&"crop"===r[0])&&(o=!0);var n=sf.base.extend({},this.cropObj,{},!0),h=this.getCurrentObj();if(h.objColl=sf.base.extend([],this.objColl,[],!0),h.pointColl=sf.base.extend([],this.pointColl,[],!0),h.afterCropActions=sf.base.extend([],this.afterCropActions,[],!0),this.redrawActObj(),this.refreshActiveObj(),this.keyHistory="",this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),this.upperCanvas.style.display="block",!sf.base.isNullOrUndefined(this.currSelectionPoint)||this.defaultZoomFactor>0||0!==this.degree&&0!==this.totalPannedInternalPoint.x&&0!==this.totalPannedInternalPoint.y&&!o){if(this.isCircleCrop=!1,this.defaultZoomFactor>0){var l=this.zoomFactor=this.defaultZoomFactor;this.isCropTab=!1;for(var c=this.isUndoRedo,d=0;d<10*l;d++)this.isUndoRedo=!0,this.zoom(-.1);this.isUndoRedo=c,this.resetPanPoints()}this.cancelObjColl=sf.base.extend([],this.objColl,[],!0),this.cancelPointColl=sf.base.extend([],this.pointColl,[],!0),this.updateObjAndFreeHandDrawColl(),this.isCropTab=!0,this.setCurrSelectionPoints(!0),this.zoomFactor=this.cropZoomFactor,sf.base.isNullOrUndefined(this.cropObj.activeObj.shape)?this.drawNewSelection(t,e,i,s,a):this.updateUndoRedoColl("crop-selection",h,h.objColl,h.pointColl,n)}else"custom"===t&&(this.currObjType.shape=""),this.drawNewSelection(t,e,i,s,a)}},e.prototype.freeHandDraw=function(t){t?(this.points=[],this.refreshActiveObj(),this.togglePen=!0,this.upperCanvas.style.cursor="crosshair",this.upperCanvas.style.display="block",sf.base.isNullOrUndefined(this.activeObj.strokeSettings)&&(this.activeObj.strokeSettings=this.strokeSettings),sf.base.isNullOrUndefined(this.activeObj.strokeSettings.strokeWidth)&&(this.activeObj.strokeSettings.strokeWidth=4)):(this.upperCanvas.style.cursor="default",this.apply(),this.currentToolbar="main",this.isFreehandDrawCustomized=!1)},e.prototype.freehandDraw=function(t){!this.disabled&&this.isImageLoaded&&this.freeHandDraw(t)},e.prototype.pan=function(t){!this.disabled&&this.isImageLoaded&&(t?(this.togglePan=!0,this.redrawActObj(),this.dragCanvas=!0,this.lowerCanvas.style.cursor=this.upperCanvas.style.cursor="grab",this.panDown=null):(this.dragCanvas=this.togglePan=this.currObjType.isCustomCrop=!1,this.lowerCanvas.style.cursor=this.upperCanvas.style.cursor="default"))},e.prototype.zoom=function(t){var e=this;if(!this.disabled&&this.isImageLoaded){if(0===this.zoomFactor&&t<0||this.zoomFactor>2&&t>0)return;var i,s;sf.base.isNullOrUndefined(this.pointZoom)||(i=(this.pointZoom.x-this.destLeft)/this.destWidth,s=(this.pointZoom.y-this.destTop)/this.destHeight);var a,o=void 0,r=!1;void 0!==this.activeObj.shape&&(o=this.activeObj.shape.split("-")),void 0!==o&&"crop"===o[0]?(a=sf.base.extend({},this.activeObj,{},!0),this.isCropTab=!0):sf.base.isNullOrUndefined(this.activeObj.shape)||"crop"===o[0]||(r=!0);var n=void 0,h=void 0;this.isCropTab&&!sf.base.isNullOrUndefined(a)?(h=this.cropZoomFactor,n={x:this.activeObj.activePoint.startX+this.activeObj.activePoint.width/2,y:this.activeObj.activePoint.startY+this.activeObj.activePoint.height/2}):(h=this.defaultZoomFactor,n={x:this.lowerCanvas.clientWidth/2,y:this.lowerCanvas.clientHeight/2});var l={zoomPoint:n,zoomLevel:h,cancel:!1};this.dotnetRef.invokeMethodAsync("ZoomEventAsync","OnZoom",l).then((function(){if(!l.cancel){var o=sf.base.extend({},e.cropObj,{},!0),n=e.getCurrentObj();n.objColl=sf.base.extend([],e.objColl,[],!0),n.pointColl=sf.base.extend([],e.pointColl,[],!0),n.afterCropActions=sf.base.extend([],e.afterCropActions,[],!0),e.redrawActObj(),e.refreshActiveObj(),e.upperContext.clearRect(0,0,e.lowerCanvas.width,e.lowerCanvas.height),e.lowerContext.filter=e.canvasFilter,e.upperCanvas.style.cursor="default";var h=sf.base.extend([],e.objColl,[],!0);if(e.isCropTab||(0!==e.degree&&(e.redrawActObj(),e.currentPannedPoint={x:0,y:0},e.rotatePan(!0,!0)),e.updateObjAndFreeHandDrawColl()),0===e.degree){if(e.drawZoomImgToCanvas(t,a),""!==e.getCurrentPanRegion()){e.tempFlipPanPoint.x+=e.totalPannedPoint.x,e.tempFlipPanPoint.y+=e.totalPannedPoint.y,h=sf.base.extend([],e.objColl,[],!0),e.objColl=[];var c=e.destLeft,d=e.destTop;e.setDestPointsForFlipState(),e.rotatedFlip(),e.destLeft=c,e.destTop=d,e.objColl=h,e.zoomObjColl(),e.zoomFreehandDrawColl(),e.updateObjAndFreeHandDrawColl()}0!==e.zoomFactor||e.isCropTab||(e.totalPannedPoint={x:0,y:0})}else if(e.updateObjAndFreeHandDrawColl(),e.totalPannedClientPoint={x:0,y:0},e.totalPannedInternalPoint={x:0,y:0},e.rotateZoom(t),""!==e.getCurrentPanRegion()){var p=e.lowerContext.filter;e.lowerContext.filter="none",e.zoomObjColl(),e.zoomFreehandDrawColl(),e.lowerContext.filter=p}if(""===e.getCurrentPanRegion()){p=e.lowerContext.filter;e.lowerContext.filter="none",e.zoomObjColl(),e.zoomFreehandDrawColl(),e.lowerContext.filter=p}(!sf.base.isNullOrUndefined(e.currSelectionPoint)&&"crop-circle"===e.currSelectionPoint.shape||e.isCircleCrop)&&e.cropCircle(e.lowerContext),e.clearOuterCanvas(e.lowerContext),e.refreshActiveObj(),sf.base.isNullOrUndefined(a)||(e.activeObj=sf.base.extend({},a,{},!0),e.drawObject("duplicate",e.activeObj),0===e.zoomFactor&&(e.currSelectionPoint=null)),!e.isUndoRedo&&sf.base.isNullOrUndefined(a)&&e.updateUndoRedoColl("zoom",n,n.objColl,n.pointColl,o),e.isUndoRedo=!1,e.autoEnablePan(),sf.base.isNullOrUndefined(a)||(e.activeObj=sf.base.extend({},a,{},!0)),"crop-custom"===e.activeObj.shape&&(e.currObjType.isCustomCrop=!0);var v=e.element.querySelector(".e-img-pan .e-btn");if(!sf.base.isNullOrUndefined(v)&&e.togglePan?v.classList.add("e-selected-btn"):sf.base.isNullOrUndefined(v)||v.classList.remove("e-selected-btn"),r&&(e.activeObj=sf.base.extend({},e.objColl[e.objColl.length-1],{},!0),e.objColl.pop(),e.drawObject("duplicate",e.activeObj)),e.enableDisableToolbarBtn(),!sf.base.isNullOrUndefined(e.pointZoom)){var b=e.isUndoRedo;if(e.isUndoRedo=!0,e.isUndoRedo=b,e.zoomFactor>0){c=e.destLeft,d=e.destTop;var u=sf.base.extend({},e.activeObj,{},!0);if(0===e.degree)e.destLeft=e.pointZoom.x-i*e.destWidth,e.destTop=e.pointZoom.y-s*e.destHeight,e.drawZoomPanImage(e.destLeft-c,e.destTop-d);else{var C=e.isCropTab;e.isCropTab=!0;var f=sf.base.extend([],e.objColl,[],!0),j=sf.base.extend([],e.pointColl,[],!0);e.objColl=[],e.pointColl=[],e.freehandCounter=0,e.currentPannedPoint={x:e.pointZoom.x-i*e.destWidth-c,y:e.pointZoom.y-s*e.destHeight-d},e.rotatePan(),e.isCropTab=C,e.objColl=f,e.pointColl=j,e.freehandCounter=e.pointColl.length,e.panObjColl(e.currentPannedPoint.x,e.currentPannedPoint.y,""),e.panFreehandDrawColl(e.currentPannedPoint.x,e.currentPannedPoint.y,"")}e.adjustPanning(u),e.activeObj=u,0!==e.activeObj.activePoint.width&&0!==e.activeObj.activePoint.height&&e.drawObject("duplicate",null,null,null,!0);var g,O=!1;void 0!==e.activeObj.shape&&(g=e.activeObj.shape.split("-")),void 0!==g&&"crop"===g[0]&&(O=!0),e.isUndoRedo||O||e.updateUndoRedoColl("zoom",n,n.objColl,n.pointColl,o),e.pointZoom=null}}}}))}},e.prototype.drawEllipse=function(t,e,i,s,a,o,r){var n=!1,h=this.isPointsInRange(t,e);if(!this.disabled&&this.isImageLoaded&&h){n=!0,this.redrawActObj(),this.activeObj.shape="ellipse","freehanddraw"===this.currObjType.shape&&(this.apply(),this.upperCanvas.style.cursor="default",this.currObjType.shape=""),this.currObjType.isCustomCrop=!1;var l={x:t,y:e};this.drawShape("ellipse",a,o,r,l,i,s)}return n},e.prototype.drawLine=function(t,e,i,s,a,o){var r=!1,n=this.isPointsInRange(t,e);if(!this.disabled&&this.isImageLoaded&&n){r=!0,this.redrawActObj(),this.activeObj.shape="line","freehanddraw"===this.currObjType.shape&&(this.apply(),this.upperCanvas.style.cursor="default",this.currObjType.shape=""),this.currObjType.isCustomCrop=!1;var h={x:t,y:e},l=i-t,c=s-e;this.drawShape("line",a,o,null,h,l,c)}return r},e.prototype.drawArrow=function(t,e,i,s,a,o){var r=!1,n=this.isPointsInRange(t,e);if(!this.disabled&&this.isImageLoaded&&n){r=!0,this.redrawActObj(),this.activeObj.shape="arrow","freehanddraw"===this.currObjType.shape&&(this.apply(),this.upperCanvas.style.cursor="default",this.currObjType.shape=""),this.currObjType.isCustomCrop=!1;var h={x:t,y:e},l=i-t,c=s-e;this.drawShape("arrow",a,o,null,h,l,c)}return r},e.prototype.drawRectangle=function(t,e,i,s,a,o,r){var n=!1,h=this.isPointsInRange(t,e);if(!this.disabled&&this.isImageLoaded&&h){n=!0,this.redrawActObj(),this.activeObj.shape="rectangle","freehanddraw"===this.currObjType.shape&&(this.apply(),this.upperCanvas.style.cursor="default",this.currObjType.shape=""),this.currObjType.isCustomCrop=!1;var l={x:t,y:e};this.drawShape("rectangle",a,o,r,l,i,s)}return n},e.prototype.drawText=function(t,e,i,s,a,o,r,n){var h=!1,l=this.isPointsInRange(t,e);return!this.disabled&&this.isImageLoaded&&l&&(h=!0,this.drawShapeText(i,s,a,o,r,n,t,e)),h},e.prototype.selectShape=function(t){var e=!1;if(!this.disabled&&this.isImageLoaded)if(this.applyActObj(),"shape"===t.split("_")[0]){for(var i=void 0,s=0;s<this.objColl.length;s++)if(this.objColl[s].currIndex===t){i=sf.base.extend({},this.objColl[s],{},!0);break}sf.base.isNullOrUndefined(i)?e=!1:(e=!0,this.activeObj=i,this.lowerContext.filter=this.canvasFilter,this.redrawShape(this.activeObj),"text"===this.activeObj.shape?this.updateToolbar(this.element.id,this.element,"text"):"pen"===this.activeObj.shape?this.updateToolbar(this.element.id,this.element,"pen"):"shapes"===this.activeObj.shape&&this.updateToolbar(this.element.id,this.element,"rectangle"))}else"pen"===t.split("_")[0]&&(this.isFreehandDrawEditing&&this.okBtn(),this.isFreehandDrawIndex(parseInt(t.split("_")[1],10)-1)?(e=!0,this.selectFreehandDraw(parseInt(t.split("_")[1],10)-1),this.updateToolbar(this.element.id,this.element,"pen")):e=!1);return e},e.prototype.deleteShape=function(t){if(!this.disabled&&this.isImageLoaded){if(this.applyActObj(),"shape"===t.split("_")[0]){for(var e=0;e<this.objColl.length;e++)if(this.objColl[e].currIndex===t){this.objColl.splice(e,1);break}}else"pen"===t.split("_")[0]&&this.isFreehandDrawIndex(parseInt(t.split("_")[1],10)-1)&&this.deleteFreehandDraw(parseInt(t.split("_")[1],10)-1,!0);this.lowerContext.filter=this.canvasFilter,this.lowerContext.clearRect(0,0,this.lowerCanvas.width,this.lowerCanvas.height),this.redrawImgWithObj(),this.updateToolbar(this.element.id,this.element,"imageLoaded")}},e.prototype.getShapeSetting=function(t){var e;if(!this.disabled&&this.isImageLoaded)if(this.applyActObj(),"shape"===t.split("_")[0]){for(var i=void 0,s=0;s<this.objColl.length;s++)if(this.objColl[s].currIndex===t){i=sf.base.extend({},this.objColl[s],{},!0);break}e=this.getObjDetails(i)}else"pen"===t.split("_")[0]&&(e=this.getFreehandDrawDetails(parseInt(t.split("_")[1],10)-1));return e},e.prototype.getShapeSettings=function(){var t=[];if(!this.disabled&&this.isImageLoaded){this.applyActObj();for(var e=0;e<this.objColl.length;e++){var i=this.getObjDetails(this.objColl[e]);t.push(i)}for(e=0;e<this.freehandCounter;e++){i=this.getFreehandDrawDetails(e);t.push(i)}}return t},e.prototype.update=function(){var t=document.querySelector("#"+this.element.id+"_canvasWrapper");sf.base.isNullOrUndefined(t)||(t.style.width=this.element.offsetWidth-2+"px"),this.lowerCanvas.width=this.upperCanvas.width=this.element.offsetWidth-2,sf.base.Browser.isDevice?(sf.base.isNullOrUndefined(t)||(t.style.height=this.element.offsetHeight-2*this.toolbarHeight-5+"px"),this.lowerCanvas.height=this.upperCanvas.height=this.element.offsetHeight-2*this.toolbarHeight-5):(sf.base.isNullOrUndefined(t)||(t.style.height=this.element.offsetHeight-this.toolbarHeight-3+"px"),this.lowerCanvas.height=this.upperCanvas.height=this.element.offsetHeight-this.toolbarHeight-3),this.lowerContext.filter=this.canvasFilter=this.initialAdjustmentValue=this.adjustmentValue=this.getDefaultFilter(),this.lowerContext.clearRect(0,0,this.lowerCanvas.width,this.lowerCanvas.height),this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height)},e.prototype.finetuneImage=function(t,e){if(!this.disabled&&this.isImageLoaded){switch(t.toLowerCase()){case"brightness":this.setBrightness(e);break;case"contrast":this.setContrast(e);break;case"hue":this.setHue(e);break;case"saturation":this.setSaturation(e);break;case"opacity":this.setOpacity(e);break;case"blur":this.setBlur(e);break;case"exposure":this.setExposure(e)}this.canvasFilter=this.lowerContext.filter}},e.prototype.applyImageFilter=function(t){!this.disabled&&this.isImageLoaded&&(this.setFilter(t.toString()),this.canvasFilter=this.lowerContext.filter)},e.prototype.undo=function(){if(!this.disabled&&this.isImageLoaded&&this.undoRedoStep>0){sf.base.isNullOrUndefined(this.activeObj.activePoint)||0===this.activeObj.activePoint.width||(this.tempActObj=this.activeObj),this.refreshActiveObj(),this.undoRedoStep--,this.enableDisableToolbarBtn(),this.isUndoRedo=!0;var t=this.undoRedoColl[this.undoRedoStep];this.undoRedoColl.length===this.undoRedoStep?this.currObjType.isUndoAction=!1:this.currObjType.isUndoAction=!0,"textAreaCustomization"!==t.operation&&"block"===this.textArea.style.display&&(this.textArea.style.display="none"),this.isCancelAction=!0;var e=void 0;switch(this.cropObj=sf.base.extend({},t.previousCropObj,{},!0),this.afterCropActions=t.previousObj.afterCropActions,this.lowerContext.filter=this.canvasFilter=t.previousObj.filter,t.operation){case"shapeTransform":this.objColl=sf.base.extend([],t.previousObjColl,[],!0),this.lowerContext.clearRect(0,0,this.lowerCanvas.width,this.lowerCanvas.height),this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),this.isUndoRedo=!0,this.redrawImgWithObj(),this.refreshActiveObj();break;case"freehanddraw":this.pointColl=t.previousPointColl,this.freehandCounter=this.pointColl.length,this.lowerContext.clearRect(0,0,this.lowerCanvas.width,this.lowerCanvas.height),this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),this.isUndoRedo=!0,this.redrawImgWithObj();break;case"freehanddrawCustomized":this.pointColl=t.previousPointColl,this.lowerContext.clearRect(0,0,this.lowerCanvas.width,this.lowerCanvas.height),this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),this.isUndoRedo=!0,this.redrawImgWithObj();break;case"deleteFreehandDrawing":case"deleteObj":"deleteFreehandDrawing"===t.operation?(this.pointColl=t.previousPointColl,this.freehandCounter=this.pointColl.length):"deleteObj"===t.operation&&(this.objColl=t.previousObjColl),this.lowerContext.clearRect(0,0,this.lowerCanvas.width,this.lowerCanvas.height),this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),this.isUndoRedo=!0,this.redrawImgWithObj();break;case"textAreaCustomization":this.objColl=sf.base.extend([],t.previousObjColl,[],!0);for(var i=0;i<t.previousObjColl.length;i++){if(sf.base.isNullOrUndefined(this.tempActObj)){e=sf.base.extend({},t.previousObjColl[t.previousObjColl.length-1],{},!0),this.objColl.splice(i,1);break}if(this.tempActObj.currIndex===t.previousObjColl[i].currIndex){e=sf.base.extend({},t.previousObjColl[i],{},!0),this.objColl.splice(i,1);break}}sf.base.isNullOrUndefined(e)||this.updateTextBox(e);break;case"text":if(sf.base.isNullOrUndefined(this.tempActObj)||(this.activeObj=sf.base.extend({},this.tempActObj,{},!0)),0===t.previousObjColl.length&&1===this.objColl.length)this.tempActObj=sf.base.extend({},this.objColl[0],{},!0);else for(i=0;i<this.objColl.length;i++){if(!sf.base.isNullOrUndefined(this.objColl[i])&&sf.base.isNullOrUndefined(t.previousObjColl[i])){this.tempActObj=sf.base.extend({},this.objColl[i],{},!0);break}if(t.previousObjColl[i].currIndex!==this.objColl[i].currIndex){this.tempActObj=sf.base.extend({},this.objColl[i],{},!0);break}}this.activeObj=sf.base.extend({},this.tempActObj,{},!0),this.objColl=sf.base.extend([],t.previousObjColl,[],!0),this.lowerContext.clearRect(0,0,this.lowerCanvas.width,this.lowerCanvas.height),this.isUndoRedo=!0,this.redrawImgWithObj(),sf.base.isNullOrUndefined(this.activeObj)||0===this.activeObj.activePoint.width||0===this.activeObj.activePoint.height?(this.textArea.style.display="block",this.textArea.value=t.previousText):this.drawObject("duplicate");break;default:this.performUndoDefaultAction(t),this.setAdjustment(t.operation),this.updateFilter(t.operation,t.filter)}this.clearOuterCanvas(this.lowerContext),this.isCircleCrop&&"crop"!==t.operation&&this.cropCircle(this.lowerContext),this.zoomFactor>0&&(this.dragCanvas=!0),this.isCancelAction=!1}},e.prototype.redo=function(){if(!this.disabled&&this.isImageLoaded&&this.undoRedoStep<this.undoRedoColl.length){this.undoRedoStep++,this.enableDisableToolbarBtn(),this.isUndoRedo=!0;var t=this.undoRedoColl[this.undoRedoStep-1];this.undoRedoColl.length===this.undoRedoStep?this.currObjType.isUndoAction=!1:this.currObjType.isUndoAction=!0,"textAreaCustomization"!==t.operation&&"block"===this.textArea.style.display&&(this.textArea.style.display="none"),this.isCancelAction=!0,this.cropObj=sf.base.extend({},t.currentCropObj,{},!0),this.afterCropActions=t.currentObj.afterCropActions,this.lowerContext.filter=this.canvasFilter=t.currentObj.filter;var e=void 0,i=void 0,s=void 0;switch(t.operation){case"shapeTransform":this.objColl=sf.base.extend([],t.currentObjColl,[],!0),this.lowerContext.clearRect(0,0,this.lowerCanvas.width,this.lowerCanvas.height),this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),this.isUndoRedo=!0,this.redrawImgWithObj(),this.refreshActiveObj();break;case"freehanddraw":this.pointColl=t.currentPointColl,this.freehandCounter=this.pointColl.length,this.lowerContext.clearRect(0,0,this.lowerCanvas.width,this.lowerCanvas.height),this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),this.isUndoRedo=!0,this.redrawImgWithObj();break;case"freehanddrawCustomized":this.pointColl=t.currentPointColl,this.lowerContext.clearRect(0,0,this.lowerCanvas.width,this.lowerCanvas.height),this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),this.isUndoRedo=!0,this.redrawImgWithObj();break;case"deleteFreehandDrawing":case"deleteObj":"deleteFreehandDrawing"===t.operation?(this.pointColl=t.currentPointColl,this.freehandCounter=this.pointColl.length):"deleteObj"===t.operation&&(this.objColl=t.currentObjColl),this.lowerContext.clearRect(0,0,this.lowerCanvas.width,this.lowerCanvas.height),this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),this.isUndoRedo=!0,this.redrawImgWithObj();break;case"textAreaCustomization":this.objColl=sf.base.extend([],t.currentObjColl,[],!0);for(var a=0;a<t.currentObjColl.length;a++){if(sf.base.isNullOrUndefined(this.tempActObj)){e=sf.base.extend({},t.currentObjColl[t.currentObjColl.length-1],{},!0),this.objColl.splice(a,1);break}if(this.tempActObj.currIndex===t.currentObjColl[a].currIndex){e=sf.base.extend({},t.currentObjColl[a],{},!0),this.objColl.splice(a,1);break}}sf.base.isNullOrUndefined(e)||this.updateTextBox(e);break;case"text":if(sf.base.isNullOrUndefined(this.tempActObj)||(this.activeObj=sf.base.extend({},this.tempActObj,{},!0)),0===t.previousObjColl.length&&1===this.objColl.length)this.tempActObj=sf.base.extend({},this.objColl[0],{},!0);else for(a=0;a<this.objColl.length;a++){if(!sf.base.isNullOrUndefined(this.objColl[a])&&sf.base.isNullOrUndefined(t.previousObjColl[a])){this.tempActObj=sf.base.extend({},this.objColl[a],{},!0);break}if(t.previousObjColl[a].currIndex!==this.objColl[a].currIndex){this.tempActObj=sf.base.extend({},this.objColl[a],{},!0);break}}this.objColl=sf.base.extend([],t.currentObjColl,[],!0),this.lowerContext.clearRect(0,0,this.lowerCanvas.width,this.lowerCanvas.height),this.isUndoRedo=!0,this.redrawImgWithObj(),sf.base.isNullOrUndefined(this.tempActObj)||(this.activeObj=sf.base.extend({},this.tempActObj,{},!0)),this.textArea.style.display="block",this.textArea.value=t.currentText,i=sf.base.extend([],this.undoRedoColl,[],!0),s=this.undoRedoStep,this.redrawActObj(),this.undoRedoColl=i,this.undoRedoStep=s,this.textArea.style.display="none",this.textArea.value="",this.redrawActObj();break;default:this.objColl=[],this.pointColl=[],this.freehandCounter=0,this.setCurrentObj(t.currentObj),this.destLeft=t.currentObj.destPoints.startX,this.destTop=t.currentObj.destPoints.startY,e=sf.base.extend({},this.activeObj,{},!0),this.objColl=sf.base.extend([],t.currentObjColl,[],!0),this.pointColl=sf.base.extend([],t.currentPointColl,[],!0),this.freehandCounter=this.pointColl.length,this.lowerContext.filter="none",this.iterateObjColl(),this.freehandRedraw(this.lowerContext),this.lowerContext.filter=t.currentObj.filter,this.activeObj=e,this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),0!==this.activeObj.activePoint.width&&0!==this.activeObj.activePoint.height&&this.drawObject("duplicate"),this.setAdjustment(t.operation),this.updateFilter(t.operation)}this.clearOuterCanvas(this.lowerContext),this.isCircleCrop&&this.cropCircle(this.lowerContext),this.zoomFactor>0&&(this.dragCanvas=!0),this.isCancelAction=!1,this.undoRedoStep===this.undoRedoColl.length&&(this.isUndoRedo=!1)}},e.prototype.updateToolbar=function(t,e,i){switch(i){case"initial":this.updateMainToolbar(e,!1),this.updateRightToolbar(e,!1),this.updateColorToolbar(this.element);break;case"imageLoaded":this.updateMainToolbar(e,!0),this.updateRightToolbar(e,!0),e.querySelector(".e-ie-toolbar-check-btn")&&(e.querySelector(".e-ie-toolbar-check-btn").classList.add("e-hidden"),e.querySelector(".e-ie-toolbar-close-btn").classList.add("e-hidden")),e.querySelector(".e-ie-toolbar-zoomin")&&(e.querySelector(".e-ie-toolbar-zoomin").classList.remove("e-hidden"),e.querySelector(".e-ie-toolbar-zoomout").classList.remove("e-hidden")),e.querySelector(".e-ie-toolbar-undo")&&(e.querySelector(".e-ie-toolbar-undo").classList.remove("e-hidden"),e.querySelector(".e-ie-toolbar-redo").classList.remove("e-hidden")),e.querySelector(".e-ie-toolbar-e-pen-color")&&(e.querySelector(".e-ie-toolbar-e-pen-color").classList.add("e-hidden"),e.querySelector(".e-ie-toolbar-e-pen-size").classList.add("e-hidden")),e.querySelector(".e-ie-toolbar-annotation")&&(this.updateTextToolbar(e,!1),this.updateLineToolbar(e,!1),this.updateRectangleToolbar(e,!1)),this.updateContextualToolbar(e,!1);break;case"line":this.updateMainToolbar(e,!1),this.updateRectangleToolbar(e,!1),this.updateTextToolbar(e,!1),this.updateLineToolbar(e,!0),e.querySelector(".e-ie-toolbar-check-btn").classList.remove("e-hidden"),e.querySelector(".e-ie-toolbar-close-btn").classList.remove("e-hidden");break;case"text":this.updateMainToolbar(e,!1),this.updateRectangleToolbar(e,!1),this.updateTextToolbar(e,!0),this.updateLineToolbar(e,!1),e.querySelector(".e-ie-toolbar-check-btn").classList.remove("e-hidden"),e.querySelector(".e-ie-toolbar-close-btn").classList.remove("e-hidden");break;case"rectangle":case"ellipse":this.updateMainToolbar(e,!1),this.updateLineToolbar(e,!1),this.updateTextToolbar(e,!1),this.updateRectangleToolbar(e,!0),this.updateColorToolbar(this.element,this.activeObj.strokeSettings),e.querySelector(".e-ie-toolbar-check-btn").classList.remove("e-hidden"),e.querySelector(".e-ie-toolbar-close-btn").classList.remove("e-hidden");break;case"CropToolbar":e.querySelector(".e-ie-toolbar-check-btn").classList.remove("e-hidden"),e.querySelector(".e-ie-toolbar-close-btn").classList.remove("e-hidden"),e.querySelector(".e-ie-toolbar-annotation")&&e.querySelector(".e-ie-toolbar-annotation").classList.add("e-overlay"),e.querySelector(".e-ie-toolbar-transform")&&e.querySelector(".e-ie-toolbar-transform").classList.add("e-overlay"),e.querySelector(".e-ie-toolbar-finetune-btn")&&e.querySelector(".e-ie-toolbar-finetune-btn").classList.add("e-overlay"),e.querySelector(".e-ie-toolbar-filter-btn")&&e.querySelector(".e-ie-toolbar-filter-btn").classList.add("e-overlay");break;case"pen":this.updateMainToolbar(e,!1),e.querySelector(".e-ie-toolbar-e-pen-color").classList.remove("e-hidden"),e.querySelector(".e-ie-toolbar-e-pen-size").classList.remove("e-hidden"),e.querySelector(".e-ie-toolbar-check-btn").classList.remove("e-hidden"),e.querySelector(".e-ie-toolbar-close-btn").classList.remove("e-hidden")}},e.prototype.updateMainToolbar=function(t,e){if(e){if(t.querySelector(".e-ie-toolbar-crop")&&t.querySelector(".e-ie-toolbar-crop").classList.remove("e-hidden"),t.querySelector(".e-ie-toolbar-annotation")&&(t.querySelector(".e-ie-toolbar-annotation").classList.contains("e-overlay")&&t.querySelector(".e-ie-toolbar-annotation").classList.remove("e-overlay"),t.querySelector(".e-ie-toolbar-annotation").classList.remove("e-hidden")),t.querySelector(".e-ie-toolbar-transform")&&(t.querySelector(".e-ie-toolbar-transform").classList.contains("e-overlay")&&t.querySelector(".e-ie-toolbar-transform").classList.remove("e-overlay"),t.querySelector(".e-ie-toolbar-transform").classList.remove("e-hidden")),t.querySelector(".e-ie-toolbar-finetune-btn")&&(t.querySelector(".e-ie-toolbar-finetune-btn").classList.contains("e-overlay")&&t.querySelector(".e-ie-toolbar-finetune-btn").classList.remove("e-overlay"),t.querySelector(".e-ie-toolbar-finetune-btn").classList.remove("e-hidden")),t.querySelector(".e-ie-toolbar-filter-btn")&&(t.querySelector(".e-ie-toolbar-filter-btn").classList.contains("e-overlay")&&t.querySelector(".e-ie-toolbar-filter-btn").classList.remove("e-overlay"),t.querySelector(".e-ie-toolbar-filter-btn").classList.remove("e-hidden")),t.querySelector(".e-ie-toolbar-custom"))for(var i=t.querySelectorAll(".e-ie-toolbar-custom"),s=0;s<i.length;s++)i[s].classList.remove("e-hidden")}else t.querySelector(".e-ie-toolbar-crop")&&t.querySelector(".e-ie-toolbar-crop").classList.add("e-hidden"),t.querySelector(".e-ie-toolbar-annotation")&&t.querySelector(".e-ie-toolbar-annotation").classList.add("e-hidden"),t.querySelector(".e-ie-toolbar-transform")&&t.querySelector(".e-ie-toolbar-transform").classList.add("e-hidden"),t.querySelector(".e-ie-toolbar-finetune-btn")&&t.querySelector(".e-ie-toolbar-finetune-btn").classList.add("e-hidden"),t.querySelector(".e-ie-toolbar-filter-btn")&&t.querySelector(".e-ie-toolbar-filter-btn").classList.add("e-hidden")},e.prototype.updateRightToolbar=function(t,e){e?(t.querySelector(".e-ie-toolbar-reset-btn")&&t.querySelector(".e-ie-toolbar-reset-btn").classList.remove("e-hidden"),t.querySelector(".e-ie-toolbar-save-btn")&&t.querySelector(".e-ie-toolbar-save-btn").classList.remove("e-hidden")):(t.querySelector(".e-ie-toolbar-reset-btn")&&t.querySelector(".e-ie-toolbar-reset-btn").classList.add("e-hidden"),t.querySelector(".e-ie-toolbar-save-btn")&&t.querySelector(".e-ie-toolbar-save-btn").classList.add("e-hidden"))},e.prototype.updateRectangleToolbar=function(t,e){e?(t.querySelector(".e-ie-toolbar-e-shape-fill-color").classList.remove("e-hidden"),t.querySelector(".e-ie-toolbar-e-shape-color").classList.remove("e-hidden"),t.querySelector(".e-ie-toolbar-e-shape-size").classList.remove("e-hidden")):(t.querySelector(".e-ie-toolbar-e-shape-fill-color").classList.add("e-hidden"),t.querySelector(".e-ie-toolbar-e-shape-color").classList.add("e-hidden"),t.querySelector(".e-ie-toolbar-e-shape-size").classList.add("e-hidden"))},e.prototype.updateLineToolbar=function(t,e){e?(t.querySelector(".e-ie-toolbar-e-line-color").classList.remove("e-hidden"),t.querySelector(".e-ie-toolbar-e-line-size").classList.remove("e-hidden")):(t.querySelector(".e-ie-toolbar-e-line-color").classList.add("e-hidden"),t.querySelector(".e-ie-toolbar-e-line-size").classList.add("e-hidden"))},e.prototype.updateTextToolbar=function(t,e){e?(t.querySelector(".e-ie-toolbar-e-font-family").classList.remove("e-hidden"),t.querySelector(".e-ie-toolbar-e-font-style").classList.remove("e-hidden"),t.querySelector(".e-ie-toolbar-e-font-size").classList.remove("e-hidden"),t.querySelector(".e-ie-toolbar-e-font-color").classList.remove("e-hidden")):(t.querySelector(".e-ie-toolbar-e-font-family").classList.add("e-hidden"),t.querySelector(".e-ie-toolbar-e-font-style").classList.add("e-hidden"),t.querySelector(".e-ie-toolbar-e-font-size").classList.add("e-hidden"),t.querySelector(".e-ie-toolbar-e-font-color").classList.add("e-hidden"))},e.prototype.updateColorToolbar=function(t,e){if(e){t.querySelector(".e-ie-toolbar-e-font-color .e-dropdownbtn-preview").style.background=e.strokeColor,t.querySelector(".e-ie-toolbar-e-shape-color .e-dropdownbtn-preview").style.background=e.strokeColor,t.querySelector(".e-ie-toolbar-e-pen-color .e-dropdownbtn-preview").style.background=e.strokeColor,t.querySelector(".e-ie-toolbar-e-line-color .e-dropdownbtn-preview").style.background=e.strokeColor,t.querySelector(".e-ie-toolbar-e-shape-fill-color .e-dropdownbtn-preview").style.background=e.fillColor;var i=this.getStrokeWidth(e.strokeWidth);this.dotnetRef.invokeMethodAsync("UpdateColorValue",e.strokeColor,e.fillColor,i)}else t.querySelector(".e-ie-toolbar-e-font-color .e-dropdownbtn-preview").style.background="#fff",t.querySelector(".e-ie-toolbar-e-shape-color .e-dropdownbtn-preview").style.background="#fff",t.querySelector(".e-ie-toolbar-e-pen-color .e-dropdownbtn-preview").style.background="#fff",t.querySelector(".e-ie-toolbar-e-line-color .e-dropdownbtn-preview").style.background="#fff",t.querySelector(".e-ie-toolbar-e-shape-fill-color .e-dropdownbtn-preview").classList.add("e-nocolor-item")},e.prototype.updateContextualToolbar=function(t,e){e?(this.updateMainToolbar(t,!1),t.querySelector(".e-ie-toolbar-check-btn")&&(t.querySelector(".e-ie-toolbar-check-btn").classList.remove("e-hidden"),t.querySelector(".e-ie-toolbar-close-btn").classList.remove("e-hidden")),t.querySelector(".e-contextual-toolbar-wrapper").classList.remove("e-hidden"),t.querySelector(".e-ie-contextual-toolbar").classList.add("e-hidden"),t.querySelector(".e-ie-contextual-slider").classList.remove("e-hidden"),t.querySelector(".e-ie-toolbar-finetune-btn")&&(t.querySelector(".e-ie-toolbar-brightness-btn").classList.remove("e-hidden"),t.querySelector(".e-ie-toolbar-contrast-btn").classList.remove("e-hidden"),t.querySelector(".e-ie-toolbar-hue-btn").classList.remove("e-hidden"),t.querySelector(".e-ie-toolbar-saturation-btn").classList.remove("e-hidden"),t.querySelector(".e-ie-toolbar-grain-btn").classList.remove("e-hidden"),t.querySelector(".e-ie-toolbar-opacity-btn").classList.remove("e-hidden"))):(t.querySelector(".e-contextual-toolbar-wrapper").classList.add("e-hidden"),t.querySelector(".e-ie-contextual-toolbar").classList.add("e-hidden"),t.querySelector(".e-ie-contextual-slider").classList.add("e-hidden"),t.querySelector(".e-ie-toolbar-finetune-btn")&&(t.querySelector(".e-ie-toolbar-brightness-btn").classList.add("e-hidden"),t.querySelector(".e-ie-toolbar-contrast-btn").classList.add("e-hidden"),t.querySelector(".e-ie-toolbar-hue-btn").classList.add("e-hidden"),t.querySelector(".e-ie-toolbar-saturation-btn").classList.add("e-hidden"),t.querySelector(".e-ie-toolbar-grain-btn").classList.add("e-hidden"),t.querySelector(".e-ie-toolbar-opacity-btn").classList.add("e-hidden")))},e.prototype.updateFilterToolBar=function(){this.element.querySelector(".e-contextual-toolbar-wrapper").classList.remove("e-hidden"),this.element.querySelector(".e-ie-contextual-toolbar").classList.remove("e-hidden"),this.element.querySelector(".e-ie-toolbar-close-btn").classList.remove("e-hidden"),this.element.querySelector(".e-ie-toolbar-check-btn").classList.remove("e-hidden"),this.setTempFilterProperties();var t=this.getCurrentCanvasData(),e=this.element.querySelector(".e-contextual-toolbar-wrapper .e-toolbar-item.e-selected");e&&e.classList.remove("e-selected"),this.inMemoryCanvas.width=t.width,this.inMemoryCanvas.height=t.height,this.inMemoryContext.putImageData(t,0,0);var i=this.element.querySelector("#e-ie-toolbar-default"),s=i.getContext("2d");s.filter=this.updateAdjustment("default",null,!0),s.drawImage(this.inMemoryCanvas,0,0,300,150),i.parentElement.parentElement.classList.add("e-selected"),(s=this.element.querySelector("#e-ie-toolbar-chrome").getContext("2d")).filter=this.updateAdjustment("chrome",null,!0),s.drawImage(this.inMemoryCanvas,0,0,300,150),(s=this.element.querySelector("#e-ie-toolbar-cold").getContext("2d")).filter=this.updateAdjustment("cold",null,!0),s.drawImage(this.inMemoryCanvas,0,0,300,150),(s=this.element.querySelector("#e-ie-toolbar-warm").getContext("2d")).filter=this.updateAdjustment("warm",null,!0),s.drawImage(this.inMemoryCanvas,0,0,300,150),(s=this.element.querySelector("#e-ie-toolbar-grayscale").getContext("2d")).filter=this.updateAdjustment("grayscale",null,!0),s.drawImage(this.inMemoryCanvas,0,0,300,150),(s=this.element.querySelector("#e-ie-toolbar-sepia").getContext("2d")).filter=this.updateAdjustment("sepia",null,!0),s.drawImage(this.inMemoryCanvas,0,0,300,150),(s=this.element.querySelector("#e-ie-toolbar-invert").getContext("2d")).filter=this.updateAdjustment("invert",null,!0),s.drawImage(this.inMemoryCanvas,0,0,300,150)},e.prototype.enableDisableToolbarBtn=function(){if(this.element.querySelector(".e-ie-toolbar-undo")){var t=this.element.querySelector("#undo");sf.base.isNullOrUndefined(t)||0!==this.undoRedoStep?sf.base.isNullOrUndefined(t)||(t.classList.remove("e-disabled"),t.classList.remove("e-overlay")):t.classList.add("e-overlay");var e=this.element.querySelector("#redo");sf.base.isNullOrUndefined(e)||this.undoRedoStep!==this.undoRedoColl.length?!sf.base.isNullOrUndefined(e)&&0===this.undoRedoStep&&this.undoRedoColl.length>0?e.classList.remove("e-overlay"):sf.base.isNullOrUndefined(e)||e.classList.remove("e-overlay"):e.classList.add("e-overlay")}var i=this.element.querySelector("#zoomout");sf.base.isNullOrUndefined(i)||0!==this.zoomFactor?sf.base.isNullOrUndefined(i)||i.classList.remove("e-overlay"):i.classList.add("e-overlay")},e.prototype.createToolbar=function(){var t=this.element.querySelector(".e-ie-toolbar-upload-div");if(t){var e=t.getElementsByTagName("input")[0],i=t.getElementsByTagName("button")[0];i.className="e-tbar-btn e-tbtn-txt e-btn top-icon",i.innerHTML="",i.appendChild(this.createElement("span",{className:"e-btn-icon e-icons e-upload-icon e-icon-left"})),e.onchange=this.fileSelect.bind(this,e)}this.updateToolbar(this.element.id,this.element,"initial")},e}(sf.base.Component)),o=(e=function(t,i){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,i)},function(t,i){function s(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(s.prototype=i.prototype,new s)}),r=function(t,e,i,s){this.dataId=t,this.element=e,this.element.id=i.id,window.sfBlazor.setCompInstance(this),this.dotnetRef=s,this.imageeditorBase=new n,this.imageeditorBase.cssClass=i.cssClass,this.imageeditorBase.disabled=i.disabled,this.imageeditorBase.height=i.height,this.imageeditorBase.theme=i.theme,this.imageeditorBase.width=i.width,this.imageeditorBase.allowUndoRedo=i.allowUndoRedo,this.imageeditorBase.isReadOnly=i.isReadOnly,this.imageeditorBase.enableRtl=i.enableRtl,this.imageeditorBase.enablePersistence=i.enablePersistence},n=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return o(e,t),e.prototype.onPropertyChanged=function(){},e.prototype.preRender=function(){},e.prototype.render=function(){},e}(a);return{initialize:function(t,e,i,s){new r(t,e,i,s);var a=window.sfBlazor.getCompInstance(t);a.imageeditorBase.initializeImageEditor(e,s),a.imageeditorBase.updateToolbar(t,e,"initial"),i.theme||(a.imageeditorBase.theme="Tailwind")},flip:function(t,e){window.sfBlazor.getCompInstance(t).imageeditorBase.flip(e)},rotate:function(t,e){window.sfBlazor.getCompInstance(t).imageeditorBase.rotate(e)},zoom:function(t,e){window.sfBlazor.getCompInstance(t).imageeditorBase.zoom(e)},reset:function(t){window.sfBlazor.getCompInstance(t).imageeditorBase.reset()},undo:function(t){window.sfBlazor.getCompInstance(t).imageeditorBase.undo()},redo:function(t){window.sfBlazor.getCompInstance(t).imageeditorBase.redo()},onPropertyChanged:function(t,e,i){window.sfBlazor.getCompInstance(t).imageeditorBase.propertyChanged(e,i)},destroy:function(t){window.sfBlazor.getCompInstance(t).imageeditorBase.destroy()},toolbarCreated:function(t){var e=window.sfBlazor.getCompInstance(t);e.element.querySelector(".e-ie-toolbar-upload-div").classList.remove("e-hide"),e.element.querySelector(".e-ie-toolbar-upload-btn").classList.add("e-hide"),e.imageeditorBase.createToolbar()},toolbarClicked:function(t,e,i){var s=window.sfBlazor.getCompInstance(t);switch(s.imageeditorBase.enableDisableToolbarBtn(),e){case"reset":s.imageeditorBase.reset(),s.imageeditorBase.updateColorToolbar(s.element),s.imageeditorBase.updateToolbar(t,s.element,"imageLoaded");break;case"undo":s.imageeditorBase.undo();break;case"redo":s.imageeditorBase.redo();break;case"zoomin":s.imageeditorBase.zoom(.1);break;case"zoomout":s.imageeditorBase.zoom(-.1);break;case"crop":sf.base.isNullOrUndefined(s.imageeditorBase.currSelectionPoint)||(s.imageeditorBase.select("Custom"),sf.base.isNullOrUndefined(s.imageeditorBase.activeObj.shape)||document.getElementById(s.imageeditorBase.activeObj.shape.split("-")[1]).classList.add("e-selected-btn"),s.imageeditorBase.updateToolbar(t,s.element,"CropToolbar"));break;case"ok":"CropToolbar"==i&&s.imageeditorBase.crop(),s.imageeditorBase.okBtn(),s.imageeditorBase.updateToolbar(t,s.element,"imageLoaded");break;case"cancel":s.element.querySelector(".e-contextual-toolbar-wrapper").classList.contains("e-hidden")?s.imageeditorBase.cancelItems():s.imageeditorBase.performCancel(!0),s.imageeditorBase.updateToolbar(t,s.element,"imageLoaded");break;case"finetune":s.imageeditorBase.currObjType.isFiltered=!0,s.imageeditorBase.updateContextualToolbar(s.element,!0);break;case"filter":s.imageeditorBase.updateFilterToolBar()}"finetune"!=e&&"filter"!=e&&"brightness"!=e&&"contrast"!=e&&"hue"!=e&&"saturation"!=e&&"opacity"!=e&&"blur"!=e&&"exposure"!=e&&s.imageeditorBase.updateContextualToolbar(s.element,!1)},contextualToolbarClicked:function(t,e){var i=window.sfBlazor.getCompInstance(t),s=i.element.querySelector(".e-contextual-toolbar-wrapper .e-toolbar-item.e-selected");s&&s.classList.remove("e-selected"),i.element.querySelector("#"+e).classList.add("e-selected"),i.imageeditorBase.currObjType.isFiltered=!0;var a={filter:i.imageeditorBase.toPascalCase(e),cancel:!1};i.dotnetRef.invokeMethodAsync("OnImageFilterEventAsync",a).then((function(){a.cancel||(i.imageeditorBase.setFilter(e.toLowerCase()),i.imageeditorBase.currentFilter=e,i.imageeditorBase.enableDisableToolbarBtn())}))},updateSliderValue:function(t,e,i){var s=window.sfBlazor.getCompInstance(t);s.imageeditorBase.setCurrAdjustmentValue(e.toLowerCase(),i),s.imageeditorBase.enableDisableToolbarBtn()},select:function(t,e,i,s,a,o,r){var n=window.sfBlazor.getCompInstance(t);n.imageeditorBase.select(e,s,a,o,r),i&&n.imageeditorBase.updateToolbar(t,n.element,"CropToolbar")},clearSelection:function(t){window.sfBlazor.getCompInstance(t).imageeditorBase.clearSelection()},crop:function(t){window.sfBlazor.getCompInstance(t).imageeditorBase.crop()},open:function(t,e){window.sfBlazor.getCompInstance(t).imageeditorBase.open(e)},pan:function(t,e){window.sfBlazor.getCompInstance(t).imageeditorBase.pan(e)},save:function(t,e,i){e=e||"Png",i=i||"",window.sfBlazor.getCompInstance(t).imageeditorBase.export(e,i)},update:function(t){window.sfBlazor.getCompInstance(t).imageeditorBase.update()},fineTuneImage:function(t,e,i){var s=window.sfBlazor.getCompInstance(t);switch(e.toLowerCase()){case"brightness":s.imageeditorBase.setBrightness(i);break;case"contrast":s.imageeditorBase.setContrast(i);break;case"hue":s.imageeditorBase.setHue(i);break;case"saturation":s.imageeditorBase.setSaturation(i);break;case"opacity":s.imageeditorBase.setOpacity(i);break;case"blur":s.imageeditorBase.setBlur(i);break;case"exposure":s.imageeditorBase.setExposure(i)}},applyImageFilter:function(t,e){window.sfBlazor.getCompInstance(t).imageeditorBase.applyImageFilter(e)},drawEllipse:function(t,e,i,s,a,o,r,n){window.sfBlazor.getCompInstance(t).imageeditorBase.drawEllipse(e,i,s,a,o,r,n)},drawLine:function(t,e,i,s,a,o,r){window.sfBlazor.getCompInstance(t).imageeditorBase.drawLine(e,i,s,a,o,r)},drawRectangle:function(t,e,i,s,a,o,r,n){window.sfBlazor.getCompInstance(t).imageeditorBase.drawRectangle(e,i,s,a,o,r,n)},drawText:function(t,e,i,s,a,o,r){window.sfBlazor.getCompInstance(t).imageeditorBase.drawText(e,i,s,a,o,r)},selectShape:function(t,e){window.sfBlazor.getCompInstance(t).imageeditorBase.selectShape(e)},deleteShape:function(t,e){window.sfBlazor.getCompInstance(t).imageeditorBase.deleteShape(e)},getShapeSetting:function(t,e){return window.sfBlazor.getCompInstance(t).imageeditorBase.getShapeSetting(e)},getShapeSettings:function(t,e){return window.sfBlazor.getCompInstance(t).imageeditorBase.getShapeSettings(e)},drawShapeText:function(t,e){var i=window.sfBlazor.getCompInstance(t);i.imageeditorBase.drawShapeText(),i.imageeditorBase.getFontSizes(),i.imageeditorBase.updateToolbar(t,i.element,e)},drawShape:function(t,e){var i=window.sfBlazor.getCompInstance(t);i.imageeditorBase.drawShape(e),i.imageeditorBase.updateToolbar(t,i.element,e)},freehandDraw:function(t,e){var i=window.sfBlazor.getCompInstance(t);i.imageeditorBase.freehandDraw(e),e&&i.imageeditorBase.updateToolbar(t,i.element,"pen")},updateToolbar:function(t,e,i){window.sfBlazor.getCompInstance(t).imageeditorBase.updateToolbar(t,e,i);for(var s=0;s<Object.keys(window.sfBlazor.instances).length;s++)if(Object.keys(window.sfBlazor.instances)[s].includes("sfToolbar")){var a=Object.keys(window.sfBlazor.instances)[s];window.sfBlazor.getCompInstance(a).refreshOverflow(a)}},updateFillColor:function(t,e,i){var s=window.sfBlazor.getCompInstance(t);if(e.querySelector(".e-fill")){""===s.imageeditorBase.activeObj.strokeSettings.fillColor&&(document.querySelector(".sf-colorpicker .e-nocolor-item").classList.remove("e-selected"),e.querySelector(".e-ie-toolbar-e-shape-fill-color .e-dropdownbtn-preview").classList.remove("e-nocolor-item")),e.querySelector(".e-ie-toolbar-e-shape-fill-color .e-dropdownbtn-preview").style.background=i,s.imageeditorBase.pushActItemIntoObj();var a=sf.base.extend([],s.imageeditorBase.objColl,[],!0);s.imageeditorBase.objColl.pop(),s.imageeditorBase.activeObj.strokeSettings.fillColor=i,s.imageeditorBase.strokeSettings.fillColor=s.imageeditorBase.activeObj.strokeSettings.fillColor,s.imageeditorBase.objColl.push(s.imageeditorBase.activeObj),s.imageeditorBase.undoRedoColl.push({operation:"shapeTransform",value:null,currentObj:sf.base.extend([],s.imageeditorBase.objColl,[],!0),previousObj:a,zoomFactor:s.imageeditorBase.zoomFactor,sharpen:s.imageeditorBase.adjustmentLevel.sharpen,bw:s.imageeditorBase.adjustmentLevel.bw}),s.imageeditorBase.undoRedoStep++,s.imageeditorBase.redrawShape(s.imageeditorBase.objColl[s.imageeditorBase.objColl.length-1])}},selFillColor:function(t,e){""===window.sfBlazor.getCompInstance(t).imageeditorBase.activeObj.strokeSettings.fillColor&&e.querySelector(".e-nocolor-item").classList.add("e-selected")},updateStrokeColor:function(t,e,i){var s=window.sfBlazor.getCompInstance(t);if(s.element.querySelector(e)){s.imageeditorBase.pushActItemIntoObj();var a=sf.base.extend([],s.imageeditorBase.objColl,[],!0);s.imageeditorBase.objColl.pop(),s.imageeditorBase.activeObj.strokeSettings.strokeColor=i,s.imageeditorBase.strokeSettings.strokeColor=s.imageeditorBase.activeObj.strokeSettings.strokeColor,s.imageeditorBase.updateColorToolbar(s.element,s.imageeditorBase.strokeSettings),s.imageeditorBase.togglePen||(s.imageeditorBase.objColl.push(s.imageeditorBase.activeObj),s.imageeditorBase.undoRedoColl.push({operation:"shapeTransform",value:null,currentObj:sf.base.extend([],s.imageeditorBase.objColl,[],!0),previousObj:a,zoomFactor:s.imageeditorBase.zoomFactor,sharpen:s.imageeditorBase.adjustmentLevel.sharpen,bw:s.imageeditorBase.adjustmentLevel.bw}),s.imageeditorBase.undoRedoStep++,s.imageeditorBase.redrawShape(s.imageeditorBase.objColl[s.imageeditorBase.objColl.length-1]))}},updateStrokeWidth:function(t,e){var i=window.sfBlazor.getCompInstance(t);i.imageeditorBase.pushActItemIntoObj();var s=sf.base.extend([],i.imageeditorBase.objColl,[],!0);i.imageeditorBase.objColl.pop(),i.imageeditorBase.activeObj.strokeSettings.strokeWidth=parseInt(e,10),i.imageeditorBase.activeObj.strokeSettings.strokeWidth*=2,i.imageeditorBase.strokeSettings.strokeWidth=i.imageeditorBase.activeObj.strokeSettings.strokeWidth,i.imageeditorBase.objColl.push(i.imageeditorBase.activeObj),i.imageeditorBase.undoRedoColl.push({operation:"shapeTransform",value:null,currentObj:sf.base.extend([],i.imageeditorBase.objColl,[],!0),previousObj:s,zoomFactor:i.imageeditorBase.zoomFactor,sharpen:i.imageeditorBase.adjustmentLevel.sharpen,bw:i.imageeditorBase.adjustmentLevel.bw}),i.imageeditorBase.undoRedoStep++,i.imageeditorBase.redrawShape(i.imageeditorBase.objColl[i.imageeditorBase.objColl.length-1])},updateShapeStroke:function(t,e){t.querySelector('[id = "'+e+'"]').classList.add("e-selected-btn")},updateFontFamily:function(t,e){var i=window.sfBlazor.getCompInstance(t);i.imageeditorBase.pushActItemIntoObj();var s=sf.base.extend([],i.imageeditorBase.objColl,[],!0);if(i.imageeditorBase.objColl.pop(),"block"===i.imageeditorBase.textArea.style.display){i.imageeditorBase.updateFontRatio(i.imageeditorBase.activeObj,!0);var a=i.imageeditorBase.activeObj.textSettings.fontFamily;i.imageeditorBase.activeObj.textSettings.fontFamily=i.imageeditorBase.toPascalCase(e),i.imageeditorBase.redrawText(),i.imageeditorBase.objColl.push(i.imageeditorBase.activeObj),i.imageeditorBase.undoRedoColl.push({operation:"textTransform",value:null,currentObj:sf.base.extend([],i.imageeditorBase.objColl,[],!0),previousObj:s,zoomFactor:i.imageeditorBase.zoomFactor,sharpen:i.imageeditorBaseadjustmentLevel.sharpen,bw:i.imageeditorBaseadjustmentLevel.bw}),i.imageeditorBase.undoRedoStep++,i.imageeditorBase.objColl.pop(),i.imageeditorBase.upperContext.clearRect(0,0,i.imageeditorBase.upperCanvas.width,i.imageeditorBase.upperCanvas.height);var o=i.imageeditorBase.activeObj.activePoint.width+.25*i.imageeditorBase.activeObj.textSettings.fontSize;i.imageeditorBase.textArea.style.width=o+"px",i.imageeditorBase.textArea.style.fontFamily=i.imageeditorBase.toPascalCase(e),i.imageeditorBase.activeObj.textSettings.fontFamily=a,i.imageeditorBase.updateFontStyles()}else i.imageeditorBase.updateFontRatio(i.imageeditorBase.activeObj),i.imageeditorBase.textSettings.fontFamily=i.imageeditorBase.activeObj.textSettings.fontFamily=i.imageeditorBase.toPascalCase(e),i.imageeditorBase.redrawText(),i.imageeditorBase.objColl.push(i.imageeditorBase.activeObj),i.imageeditorBase.undoRedoColl.push({operation:"shapeTransform",value:null,currentObj:sf.base.extend([],i.imageeditorBase.objColl,[],!0),previousObj:s,zoomFactor:i.imageeditorBase.zoomFactor,sharpen:i.imageeditorBase.adjustmentLevel.sharpen,bw:i.imageeditorBase.adjustmentLevel.bw}),i.imageeditorBase.undoRedoStep++,i.imageeditorBase.redrawShape(i.imageeditorBase.objColl[i.imageeditorBase.objColl.length-1])},updateFontStyleFamily:function(t,e){window.sfBlazor.getCompInstance(t).imageeditorBase.applyFontStyle(e)},updateFontSizeFamily:function(t,e){var i=window.sfBlazor.getCompInstance(t);i.imageeditorBase.pushActItemIntoObj();var s=sf.base.extend([],i.imageeditorBase.objColl,[],!0);if(i.imageeditorBase.objColl.pop(),"block"===i.imageeditorBase.textArea.style.display){i.imageeditorBase.updateFontRatio(i.imageeditorBase.activeObj,!0);var a=i.imageeditorBase.activeObj.textSettings.fontSize;i.imageeditorBase.activeObj.textSettings.fontSize=parseInt(i.imageeditorBase.fontSizeColl[parseInt(e,10)-1].text,10),i.imageeditorBase.objColl.push(i.imageeditorBase.activeObj),i.imageeditorBase.undoRedoColl.push({operation:"textTransform",value:null,currentObj:sf.base.extend([],i.imageeditorBase.objColl,[],!0),previousObj:s,zoomFactor:i.imageeditorBase.zoomFactor,sharpen:i.imageeditorBase.adjustmentLevel.sharpen,bw:i.imageeditorBase.adjustmentLevel.bw}),i.imageeditorBase.undoRedoStep++,i.imageeditorBase.objColl.pop();var o="";"bold"===i.imageeditorBase.textArea.style.fontWeight&&(o="bold "),"italic"===i.imageeditorBase.textArea.style.fontStyle&&(o="italic "),"bold"===i.imageeditorBase.textArea.style.fontWeight&&"italic"===i.imageeditorBase.textArea.style.fontStyle&&(o="italic bold "),i.imageeditorBase.upperContext.font=o+i.imageeditorBase.activeObj.textSettings.fontSize+"px "+i.imageeditorBase.textArea.style.fontFamily;var r=i.imageeditorBase.textArea.value.split("\n"),n=i.imageeditorBase.getMaxText(!0),h=i.imageeditorBase.upperContext.measureText(n).width+.5*i.imageeditorBase.activeObj.textSettings.fontSize;i.imageeditorBase.textArea.style.width=h+"px",i.imageeditorBase.textArea.style.height=r.length*(i.imageeditorBase.activeObj.textSettings.fontSize+.25*i.imageeditorBase.activeObj.textSettings.fontSize)+"px",i.imageeditorBase.activeObj.textSettings.fontSize=a,i.imageeditorBase.upperContext.font=i.imageeditorBase.activeObj.textSettings.fontSize+"px "+i.imageeditorBase.activeObj.textSettings.fontFamily,i.imageeditorBase.textArea.style.fontSize=parseInt(i.imageeditorBase.fontSizeColl[parseInt(e,10)-1].text,10)+"px","georgia"===i.imageeditorBase.textArea.style.fontFamily&&(i.imageeditorBase.textArea.style.width=parseFloat(i.imageeditorBase.textArea.style.width)+parseFloat(i.imageeditorBase.textArea.style.fontSize)+"px")}else{i.imageeditorBase.updateFontRatio(i.imageeditorBase.activeObj),i.imageeditorBase.textSettings.fontSize=i.imageeditorBase.activeObj.textSettings.fontSize=parseInt(i.imageeditorBase.fontSizeColl[parseInt(e,10)-1].text,10),i.imageeditorBase.upperContext.font=i.imageeditorBase.activeObj.textSettings.fontSize+"px "+i.imageeditorBase.activeObj.textSettings.fontFamily;r=i.imageeditorBase.activeObj.keyHistory.split("\n"),n=i.imageeditorBase.getMaxText(),h=i.imageeditorBase.upperContext.measureText(n).width+.5*i.imageeditorBase.activeObj.textSettings.fontSize;var l=r.length*(i.imageeditorBase.activeObj.textSettings.fontSize+.25*i.imageeditorBase.activeObj.textSettings.fontSize);i.imageeditorBase.setTextSelection(h,l),i.imageeditorBase.updateActiveObject(i.imageeditorBase.activeObj.activePoint,i.imageeditorBase.activeObj),i.imageeditorBase.redrawText(),i.imageeditorBase.objColl.push(i.imageeditorBase.activeObj),i.imageeditorBase.undoRedoColl.push({operation:"shapeTransform",value:null,currentObj:sf.base.extend([],i.imageeditorBase.objColl,[],!0),previousObj:s,zoomFactor:i.imageeditorBase.zoomFactor,sharpen:i.imageeditorBase.adjustmentLevel.sharpen,bw:i.imageeditorBase.adjustmentLevel.bw}),i.imageeditorBase.undoRedoStep++,i.imageeditorBase.redrawShape(i.imageeditorBase.objColl[i.imageeditorBase.objColl.length-1])}}}}()}}]);(async()=>{await import(`${document.baseURI}_content/Syncfusion.Blazor/scripts/syncfusion-blazor-base.min.js?v=21.1.undefined`).then(()=>{})})();